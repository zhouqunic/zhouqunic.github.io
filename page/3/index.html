<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Joking的Linux世界" type="application/atom+xml">






<meta name="description" content="个人Linux学习和工作记录的小地方">
<meta name="keywords" content="linux">
<meta property="og:type" content="website">
<meta property="og:title" content="Joking的Linux世界">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Joking的Linux世界">
<meta property="og:description" content="个人Linux学习和工作记录的小地方">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joking的Linux世界">
<meta name="twitter:description" content="个人Linux学习和工作记录的小地方">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>Joking的Linux世界</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Joking的Linux世界</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">念念不忘，必有回响</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/2.1-2.2 系统目录结构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/2.1-2.2 系统目录结构/" itemprop="url">3.1 - 3.3 用户文件及管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="3-1-用户配置文件和密码配置文件"><a href="#3-1-用户配置文件和密码配置文件" class="headerlink" title="3.1 用户配置文件和密码配置文件"></a>3.1 用户配置文件和密码配置文件</h1><h2 id="1-etc-passwd-文件解释"><a href="#1-etc-passwd-文件解释" class="headerlink" title="1. /etc/passwd 文件解释"></a>1. /etc/passwd 文件解释</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zhouqunic-01 ~]# cat /etc/passwd | head</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin</span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin</span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin</span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync</span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown</span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin</span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br></pre></td></tr></table></figure>

<ul>
<li>/etc/passwd 文件分7个字段</li>
</ul>
<ol>
<li>用户名(login_name)</li>
<li>密码(passwd)  实际密码数据放在/etc/shadow 中，所以此处显示为×</li>
<li>UID  用户标识符</li>
<li>GID  组名</li>
<li>用户名(user_name)</li>
<li>用户主目录(home_directory)</li>
<li>命令解释程序(Shell)</li>
</ol>
<h1 id="2-etc-shadow-文件解释"><a href="#2-etc-shadow-文件解释" class="headerlink" title="2. /etc/shadow 文件解释"></a>2. /etc/shadow 文件解释</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zhouqunic-01 ~]# cat /etc/shadow | head</span><br><span class="line">root:$6$s8WMXWea$YBPEIrOm8djENWPVaXQizcZ5..aQkMn3r/tbeQLitob.p/4YyHN54FD9AJeCwfiS0a2wK8aubDrM7j1LZrpTj1:17318:0:99999:7:::</span><br><span class="line">bin:*:17110:0:99999:7:::</span><br><span class="line">daemon:*:17110:0:99999:7:::</span><br><span class="line">adm:*:17110:0:99999:7:::</span><br><span class="line">lp:*:17110:0:99999:7:::</span><br><span class="line">sync:*:17110:0:99999:7:::</span><br><span class="line">shutdown:*:17110:0:99999:7:::</span><br><span class="line">halt:*:17110:0:99999:7:::</span><br><span class="line">mail:*:17110:0:99999:7:::</span><br><span class="line">operator:*:17110:0:99999:7:::</span><br></pre></td></tr></table></figure>

<ul>
<li>/etc/shadow 文件分为9个字段</li>
</ul>
<ol>
<li>用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的；</li>
<li>密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的；</li>
<li>上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化；</li>
<li>两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义；</li>
<li>两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义；</li>
<li>提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义；</li>
<li>在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用；</li>
<li>用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），如果这个字段的值为空，帐号永久可用；</li>
<li>保留字段，目前为空，以备将来Linux发展之用。</li>
</ol>
<h1 id="3-2-用户组管理"><a href="#3-2-用户组管理" class="headerlink" title="3.2 用户组管理"></a>3.2 用户组管理</h1><h2 id="groupadd-用户组管理命令"><a href="#groupadd-用户组管理命令" class="headerlink" title="groupadd 用户组管理命令"></a>groupadd 用户组管理命令</h2><ul>
<li><p>groupadd 增加组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# groupadd grouptest1</span><br><span class="line">[root@localhost ~]# tail -n1 /etc/group</span><br><span class="line">grouptest1:x:501:</span><br></pre></td></tr></table></figure>
</li>
<li><p>groupadd -g uid groupname -g 指定所增加组的uid </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# groupadd -g 520 grouptest2</span><br><span class="line">[root@localhost ~]# tail -n1 /etc/group</span><br><span class="line">grouptest2:x:520:</span><br></pre></td></tr></table></figure>
</li>
<li><p>groupdel 删除组<br>若组里含有用户则不可以删除该组。</p>
</li>
</ul>
<h1 id="3-3-用户管理"><a href="#3-3-用户管理" class="headerlink" title="3.3 用户管理"></a>3.3 用户管理</h1><h2 id="1-useradd-增加用户命令"><a href="#1-useradd-增加用户命令" class="headerlink" title="1. useradd 增加用户命令"></a>1. useradd 增加用户命令</h2><p>-u  自定义UID<br>-g  使其属于已经存在的某个组，后面可跟组名or组id号<br>-d  自定义用户的家目录<br>-M  不建立家目录<br>-s  自定义shell  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@zhouqunic-01 ~]# useradd user2</span><br><span class="line">[root@zhouqunic-01 ~]# tail -n2 /etc/passwd</span><br><span class="line">zhouqunic:x:1000:1000:zhouqunic:/home/zhouqunic:/bin/bash</span><br><span class="line">user2:x:1001:1001::/home/user2:/bin/bash</span><br><span class="line">[root@zhouqunic-01 ~]# groupadd grp2</span><br><span class="line">[root@zhouqunic-01 ~]# useradd -u 1004 -g grp2  user3</span><br><span class="line">[root@zhouqunic-01 ~]# tail -n3 /etc/passwd</span><br><span class="line">zhouqunic:x:1000:1000:zhouqunic:/home/zhouqunic:/bin/bash</span><br><span class="line">user2:x:1001:1001::/home/user2:/bin/bash</span><br><span class="line">user3:x:1004:1002::/home/user3:/bin/bash</span><br><span class="line">[root@zhouqunic-01 ~]# useradd -u 1009 -g grp2 -d /home/aming/ -s /sbin/nologin  user5</span><br><span class="line">[root@zhouqunic-01 ~]# tail -n5 /etc/passwd</span><br><span class="line">zhouqunic:x:1000:1000:zhouqunic:/home/zhouqunic:/bin/bash</span><br><span class="line">user2:x:1001:1001::/home/user2:/bin/bash</span><br><span class="line">user3:x:1004:1002::/home/user3:/bin/bash</span><br><span class="line">user4:x:1008:1002::/home/zhouqunic/:/sbin/nologin</span><br><span class="line">user5:x:1009:1002::/home/aming/:/sbin/nologin</span><br></pre></td></tr></table></figure>

<h2 id="2-userdel-删除用户"><a href="#2-userdel-删除用户" class="headerlink" title="2. userdel 删除用户"></a>2. userdel 删除用户</h2><p>-r 删除账户的时候，连带账户的家目录一起删除</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现/" itemprop="url">19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="19-7-主动模式和被动模式"><a href="#19-7-主动模式和被动模式" class="headerlink" title="19.7 主动模式和被动模式"></a>19.7 主动模式和被动模式</h1><p>主动模式和被动模式所针对的对象是客户端。<br>意思是客户端主动向服务端上报数据和由服务端到客户端采集数据。<br>数据的提交时间在监控中心设置。</p>
<h2 id="配置建议"><a href="#配置建议" class="headerlink" title="配置建议"></a>配置建议</h2><ul>
<li>当客户端数量非常多时，建议使用主动模式，这样可以降低服务端的压力。</li>
<li>当服务端有公网IP，客户端只有内网IP但是可以连接外网（使用iptables的nat表规则实现），这种场景适合使用主动模式</li>
<li>如果server量不是太多的话，两种模式都可。</li>
</ul>
<h1 id="19-8-添加监控主机"><a href="#19-8-添加监控主机" class="headerlink" title="19.8 添加监控主机"></a>19.8 添加监控主机</h1><ul>
<li>主机群组：在此先创建主机群组，然后再添加要监控的机器到已有群组中。这样做的好处是，在不同的主机群组设置不同监控规则，然后可以把想要使用同样规则的主机添加到指定群组进行管理，避免为每台主机去配置规则。</li>
<li>模板：预设的监控项目集合（监控规则末班）</li>
<li>主机：在监控中的所有机器</li>
</ul>
<h2 id="1-添加主机组"><a href="#1-添加主机组" class="headerlink" title="1 添加主机组"></a>1 添加主机组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">配置 → 主机群组 → 创建主机群组（添加主机前先要创建组）</span><br><span class="line"></span><br><span class="line">组名：yt-test → 添加即可。</span><br><span class="line"></span><br><span class="line">配置 → 主机 → 创建主机</span><br><span class="line"></span><br><span class="line">主机名称：yt-02（在被监控主机内有配置Hostname，此处填写这个）</span><br><span class="line">可见名称：yt-02（与上面保持一致即可）</span><br><span class="line"></span><br><span class="line">添加刚刚创建的组</span><br><span class="line"></span><br><span class="line">IP 地址：192.168.122.131（客户端的IP）</span><br><span class="line">DNS名称：目前用不到，不用写，如果该IP有对应的域名，则需要添加到“DNS名称”中</span><br><span class="line">端口：10050（默认，或填写自定义的）</span><br><span class="line"></span><br><span class="line">第二个选项 模板 稍后讲，其他不用管</span><br><span class="line">点击最后的 添加 即可！</span><br></pre></td></tr></table></figure>

<h2 id="2-参数解析"><a href="#2-参数解析" class="headerlink" title="2 参数解析"></a>2 参数解析</h2><ul>
<li>应用集：监控项目的组集合</li>
<li>监控项：所有的监控项目</li>
<li>触发器：针对某一个监控项的监控规则（不填级别的规则颜色不同，会显示在首页主机状态中）</li>
<li>图形：根据监控历史数据绘制的图标</li>
<li>自动发现规则：zabbix自动监控系统文件，磁盘分区，网卡流量等，该部分自定义比较繁琐，所以使用自动发现规则</li>
<li>Web场景：在此可设置对主机上的某个站点进行监控，监控站点的任何非200页面的状态，并报警。</li>
</ul>
<h1 id="19-9-添加自定义模板"><a href="#19-9-添加自定义模板" class="headerlink" title="19.9 添加自定义模板"></a>19.9 添加自定义模板</h1><p>在“模板”中自定义监控规则，然后应用到监控主机中，方便个性化管理。<br>在模板里面我们可以增加很多自定义监控的项目，然后再次把模板链接到一个组内，当我们在组内增加了新的客户端就不需要我们再次去配置监控项目，直接加入组就ok了。</p>
<h2 id="1-创建自定义模版"><a href="#1-创建自定义模版" class="headerlink" title="1 创建自定义模版"></a>1 创建自定义模版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">配置 → 模板 → 创建模版</span><br><span class="line">模板名称：yuntai（自定义即可）</span><br><span class="line">群组：Templetes</span><br><span class="line">简单设置，添加即可。</span><br></pre></td></tr></table></figure>

<h2 id="2-快速的添加监控模板"><a href="#2-快速的添加监控模板" class="headerlink" title="2 快速的添加监控模板"></a>2 快速的添加监控模板</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 选择预设的一个模板（Template OS Linux）</span><br><span class="line">2. 点击“监控” → 选择一些我们需要的监控项 → 点击最下面的“复制” → 选择模板 → 找到刚刚创建的模板zhdy_monitor → 再次点击最下面的 “复制” 即可。</span><br><span class="line">3. 使用同样的方法，把其它的监控项完成。</span><br><span class="line">但是我们发现，其它选项都可以按照之前的步骤去操作，但是“自动发现”选项却没有“复制”这个选项。</span><br></pre></td></tr></table></figure>

<h2 id="3-复制其它模板的“自动发现”选项"><a href="#3-复制其它模板的“自动发现”选项" class="headerlink" title="3 复制其它模板的“自动发现”选项"></a>3 复制其它模板的“自动发现”选项</h2><ul>
<li><p>方案1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">导出有“自动发现”选项,模版的配置文件xxx.xml。用编辑器打开，删除其他多余的选项代码，再导入到自定义的模版里面</span><br><span class="line"># 工作量比较大，也容易出错，不推荐</span><br></pre></td></tr></table></figure>
</li>
<li><p>方案2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把已有的模版链接到自定义模版上，然后 取消链接，更新规则后，删除 不需要的监控项，删除 多余的应用集，就可以保留“自动发现”选项</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="19-10-处理图形中的乱码"><a href="#19-10-处理图形中的乱码" class="headerlink" title="19.10 处理图形中的乱码"></a>19.10 处理图形中的乱码</h1><ol>
<li>点击刚刚创建的主机 → 点击上面的选项“模板” → “链接指示器” → “添加” → “更新” → 然后我们就会看到模板的中的监控项全部复制到了新添加的主机中。</li>
<li>点击“图形” → 点击任意一个 → “预览” → 我们会发现其中出现了乱码：</li>
</ol>
<p><strong>这种情况是因为我们虚拟主机中没有能够解析这个字体的字体库。如何能够解决问题呢？</strong><br>这种情况其实很容易去处理，直接copy windows中的一个字体，放在linux中指定的路径即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /usr/share/zabbix/include/defines.inc.php</span><br><span class="line"></span><br><span class="line"># 搜索ZBX_FONTPATH</span><br><span class="line"># 它定义的路径是“fonts”，它是一个相对路径</span><br><span class="line"># 绝对路径为/usr/share/zabbix/fonts</span><br><span class="line"># 而字体文件为“ZBX_GRAPH_FONT_NAME”所定义的“graphfont”</span><br><span class="line"># 它是一个文件，绝对路径为  /usr/share/zabbix/fonts/graphfont </span><br><span class="line"></span><br><span class="line">先把windows下面的字体上传到服务器，然后再次mv到/usr/share/zabbix/fonts/</span><br><span class="line">lrwxrwxrwx 1 root root 33 4月 2 11:12 graphfont.ttf -&gt; /etc/alternatives/zabbix-web-font</span><br><span class="line">[root@yt-01 ~]# mv STLITI.TTF /usr/share/zabbix/fonts/</span><br><span class="line"></span><br><span class="line">然后把原有的字体改个名字，再次把我们上传的字体做个软链接即可。 </span><br><span class="line">[root@yt-01 ~]# cd /usr/share/zabbix/fonts/</span><br><span class="line">[root@yt-01 fonts]# ls</span><br><span class="line">graphfont.ttf STLITI.TTF</span><br><span class="line">[root@yt-01 fonts]# mv graphfont.ttf graphfont.ttf.bak</span><br><span class="line">[root@yt-01 fonts]# ln -s STLITI.TTF graphfont.ttf</span><br><span class="line"></span><br><span class="line">zabbix web页刷新，就可以看不到乱码了</span><br></pre></td></tr></table></figure>

<h1 id="19-11-自动发现"><a href="#19-11-自动发现" class="headerlink" title="19.11 自动发现"></a>19.11 自动发现</h1><p>点击“自动发现规则” → 按理来说，我们已经配置了自动发现规则，为什么在图形中没有看到任何图表显示呢？ 其原因是 我们虽然配置了，但是自动发现规则是1小时候才可以显示，我们可以手动编辑调节“数据更新间隔”为10分钟或者为了让其快速显示，也可以临时设置1分钟，当出来图表再次把更新时间间隔调节为600秒即可。 点击“更新”即可。 至于说压力问题，只要不是监控太多的客户端，这个值还是可以的。</p>
<p>然后（重启服务器与客户端的zabbix服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server端：</span><br><span class="line"># systemctl restart zabbix-server</span><br><span class="line">client端：</span><br><span class="line"># systemctl restart zabbix-agent</span><br></pre></td></tr></table></figure>

<p>然后我们再次回到“图形”，我们就发现了被监控的网卡。<br>如果需要修改模板内的状态显示风格或者颜色，可以进入“模板” → “自定义的模板” → “自动发现” → “点击监控的名称即可进去修改”。</p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p>zabbix监控交换机（思科） <a href="http://tryrus.blog.51cto.com/10914693/1789847" target="_blank" rel="noopener">http://tryrus.blog.51cto.com/10914693/1789847</a><br>zabbix远程执行命令 <a href="http://www.ywnds.com/?p=6610" target="_blank" rel="noopener">http://www.ywnds.com/?p=6610</a><br>zabbix分布式部署 <a href="http://sfzhang88.blog.51cto.com/4995876/1364399" target="_blank" rel="noopener">http://sfzhang88.blog.51cto.com/4995876/1364399</a><br>zabbix监控tomcat（版本有点老，大家只需要参考步骤，不能照搬） <a href="http://www.jianshu.com/p/e3825a885a1b" target="_blank" rel="noopener">http://www.jianshu.com/p/e3825a885a1b</a> <a href="http://www.fblinux.com/?p=616" target="_blank" rel="noopener">http://www.fblinux.com/?p=616</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.1 - 20.4 shell脚本结构和执行、变量、date命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.1 - 20.4 shell脚本结构和执行、变量、date命令/" itemprop="url">20.1 - 20.4 shell脚本结构和执行、变量、date命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#20.1 shell脚本介绍</p>
<ul>
<li>shell是一种脚本语言</li>
<li>可以使用逻辑判断、循环等语法</li>
<li>可以自定义函数</li>
<li>shell是系统命令的集合</li>
<li>shell脚本可以实现自动化运维，能大大增加我们的运维效率</li>
</ul>
<p>#20.2 shell脚本结构和执行</p>
<ul>
<li>开头需要加#!/bin/bash，告诉系统该脚本是要以bin/bash文件解释器执行</li>
<li>以#开头的行作为解释说明</li>
<li>脚本的名字以.sh结尾，用于区分这是一个shell脚本</li>
<li>执行方法有两种<br>  chmod +x 1.sh; ./1.sh<br>  bash 1.sh</li>
<li>查看脚本执行过程 bash -x 1.sh</li>
<li>查看脚本是否语法错误  bash -n 1.sh</li>
</ul>
<p>#20.3 date命令用法</p>
<blockquote>
<p>很多shell脚本里面需要打印不同格式的时间或日期，以及要根据时间和日期执行操作。延时通常用于脚本执行过程中提供一段等待的时间。日期可以以多种格式去打印，也可以使用命令设置固定的格式。在类UNIX系统中，日期被存储为一个整数，其大小为自世界标准时间（UTC）1970年1月1日0时0分0秒起流逝的秒数。 </p>
</blockquote>
<p>date命令是显示或设置系统时间与日期。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date    //显示当前时区的当前时间</span><br><span class="line">Fri Sep 15 06:08:45 CST 2017</span><br></pre></td></tr></table></figure>

<p>##语法<br>date(选项)(参数)</p>
<p>##选项<br>-d&lt;字符串&gt;：显示字符串所指的日期与时间。字符串前后必须加上双引号；<br>-s&lt;字符串&gt;：根据字符串来设置日期与时间。字符串前后必须加上双引号；<br>-u：显示GMT；<br>–help：在线帮助；<br>–version：显示版本信息。</p>
<p>##参数<br>&lt;+时间日期格式&gt;：指定显示时使用的日期时间格式。</p>
<p>##用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- date  +%Y-%m-%d, date +%y-%m-%d 年月日</span><br><span class="line">- date  +%H:%M:%S = date +%T 时间</span><br><span class="line">- date +%s  时间戳</span><br><span class="line">- date -d @1504620492</span><br><span class="line">- date -d &quot;+1day&quot;  一天后</span><br><span class="line">- date -d &quot;-1 day&quot;  一天前</span><br><span class="line">- date -d &quot;-1 month&quot; 一月前</span><br><span class="line">- date -d &quot;-1 min&quot;  一分钟前</span><br><span class="line">- date +%w, date +%W 星期</span><br></pre></td></tr></table></figure>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><ul>
<li><p>查看系统日历</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cal</span><br><span class="line">  September 2017  </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">                1  2</span><br><span class="line">3  4  5  6  7  8  9</span><br><span class="line">10 11 12 13 14 15 16</span><br><span class="line">17 18 19 20 21 22 23</span><br><span class="line">24 25 26 27 28 29 30</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示年份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%Y   //以四位数显示年份</span><br><span class="line">2017</span><br><span class="line">[root@host ~]# date +%y   //以两位数显示年份</span><br><span class="line">17</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别显示：年、月、日、时、分、秒、星期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date &quot;+%Y-%m-%d %H:%M:%S %w&quot;</span><br><span class="line">2017-09-15 06:15:44 5</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示年月日</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%D</span><br><span class="line">09/15/17</span><br><span class="line">[root@host ~]# date +%Y%m%d</span><br><span class="line">20170915</span><br><span class="line">[root@host ~]# date +%F</span><br><span class="line">2017-09-15</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他时间显示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%h    //显示现在的月份</span><br><span class="line">Sep</span><br><span class="line">[root@host ~]# date +%W   //显示今年的第几周</span><br><span class="line">37</span><br><span class="line">[root@host ~]# date +%T   //显示当前时间几点几分几秒</span><br><span class="line">06:21:34</span><br><span class="line">[root@host ~]# date +%s   //显示时间戳，表示距离 从1970年1月1日00:00:00到现在 经历的秒数</span><br><span class="line">1505427580</span><br><span class="line"></span><br><span class="line">#时间戳换算</span><br><span class="line">[root@host ~]# date +%s -d &quot;2017-09-15 12:00:00&quot;</span><br><span class="line">1505448000</span><br><span class="line">[root@host ~]# date -d @1505448000</span><br><span class="line">Fri Sep 15 12:00:00 CST 2017</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>##打印指定日期&amp;时间<br>工作中，有时候需要使用N天前的日期或时间<br>格式是<code>date -d &quot;1 day&quot; +%d</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%F             //今天的日期</span><br><span class="line">2017-09-15</span><br><span class="line">[root@host ~]# date -d &quot;-2 day&quot; +%d   //两天前多少号</span><br><span class="line">13</span><br><span class="line">[root@host ~]# date -d &quot;1 day ago&quot; +&quot;%Y-%m-%d&quot;    （=date -d &quot;1 day ago&quot; +%F）   //1天前的日期</span><br><span class="line">2017-09-14</span><br><span class="line">[root@host ~]# date -d &quot;-1 year -1 month -1 day&quot; +%Y-%m-%d    //前一年一个月一天的日期</span><br><span class="line">2016-08-14</span><br></pre></td></tr></table></figure>

<p>#20.4 shell脚本中的变量</p>
<ul>
<li>当脚本中使用某个字符串较频繁并且字符串长度很长时就应该使用变量代替</li>
<li>使用条件语句时，常使用变量    if [ $a -gt 1 ]; then … ; fi</li>
<li>引用某个命令的结果时，用变量替代  n=<code>wc -l 1.txt</code></li>
<li>写和用户交互的脚本时，变量也是必不可少的  read -p “Input a number: “ n; echo $n  如果没写这个n，可以直接使用$REPLY</li>
<li>内置变量 $0, $1, $2…    $0表示脚本本身，$1 第一个参数，$2 第二个 ….      $#表示参数个数</li>
<li>数学运算a=1;b=2; c=$(($a+$b))或者$[$a+$b] </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/18.1-18.5 集群介绍、keepalived介绍和配置高可用集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/18.1-18.5 集群介绍、keepalived介绍和配置高可用集群/" itemprop="url">18.1-18.5 集群介绍、keepalived介绍和配置高可用集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="18-1-集群介绍"><a href="#18-1-集群介绍" class="headerlink" title="18.1 集群介绍"></a>18.1 集群介绍</h2><h3 id="Linux集群概述"><a href="#Linux集群概述" class="headerlink" title="Linux集群概述"></a>Linux集群概述</h3><ul>
<li>根据功能划分为两大类：高可用和负载均衡  </li>
<li>高可用集群通常为两台服务器，一台工作，另外一台作为冗余，当提供服务的机器宕机，冗余将接替继续提供服务  </li>
<li>实现高可用的开源软件有：heartbeat(由于版本不再更新，在CentOS 6上面Bug比较多，不推荐使用了)、keepalived （既可以实现高可用，又可以实现负载均衡） </li>
<li>负载均衡集群，需要有一台服务器作为分发器，它负责把用户的请求分发给后端的服务器处理，在这个集群里，除了分发器外，就是给用户提供服务的服务器了，这些服务器数量至少为2  </li>
<li>实现负载均衡的开源软件有LVS、keepalived、haproxy、nginx，商业的有F5、Netscaler 专用商业服务器，价格很高，从几万到几十万都有</li>
</ul>
<h2 id="18-2-keepalived介绍"><a href="#18-2-keepalived介绍" class="headerlink" title="18.2 keepalived介绍"></a>18.2 keepalived介绍</h2><ul>
<li>在这里我们使用keepalived来实现高可用集群，因为heartbeat在centos6上有一些问题，影响实验效果（比如，切换不及时）</li>
<li>keepalived通过 VRRP（Virtual Router Redundancy Protocl）虚拟路由冗余协议 来实现高可用。</li>
<li>在这个协议里会将多台功能相同的路由器组成一个小组，这个小组里会有1个master角色和N（N&gt;=1）个backup角色。</li>
<li>master会通过组播的形式向各个backup发送VRRP协议的数据包，当backup收不到master发来的VRRP数据包时，就会认为master宕机了。此时就需要根据各个backup的优先级来决定谁成为新的mater。</li>
<li>Keepalived要有三个模块，分别是core、check和vrrp。其中core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析，check模块负责健康检查，vrrp模块是来实现VRRP协议的。</li>
</ul>
<h2 id="18-3-18-4-18-5-用keepalived配置高可用集群"><a href="#18-3-18-4-18-5-用keepalived配置高可用集群" class="headerlink" title="18.3/18.4/18.5 用keepalived配置高可用集群"></a>18.3/18.4/18.5 用keepalived配置高可用集群</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul>
<li><p>两台机器 192.168.2.180（Master/yt-01）、192..168.2.183（backupyt-02）</p>
</li>
<li><p>keepalived的VIP设为192.168.2.100（在keepalived配置里面设置）。关于VIP，即Vitrual IP。当我们有主从两台机器，我们需要绑定域名到指定的IP，如果绑定在主上面。如果主宕机，我们就无法提供服务，所以Vitrual IP就起到了关键性作用。默认配置在主服务器上面，但是一旦宕机，从服务器就会立即启动，并且把这个IP绑定在从上面从而不会影响业务的状态！</p>
</li>
<li><p>机器都要联网</p>
</li>
<li><p>两台机器都要安装keepalived</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>两台机器都安装nginx<br>安装nginx作为实验对象，其中因为180上之前已经源码包安装过nginx，所以只需要181上安装就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install -y nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>两台机器都要关闭防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># iptables -nvL</span><br><span class="line"># systemctl stop firewalld</span><br><span class="line"># getenforce</span><br><span class="line"># setenforce 0</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="配置主keepalived服务器"><a href="#配置主keepalived服务器" class="headerlink" title="配置主keepalived服务器"></a>配置主keepalived服务器</h3><h4 id="更改配置文件"><a href="#更改配置文件" class="headerlink" title="更改配置文件"></a>更改配置文件</h4><ul>
<li>编辑180上keepalived配置文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># &gt; /etc/keepalived/keepalived.conf              #清空原始配置文件</span><br><span class="line"># vim /etc/keepalived/keepalived.conf          #复制下面代码，代替原配置文件</span><br><span class="line"></span><br><span class="line"># 全局定义参数</span><br><span class="line">global_defs &#123;         </span><br><span class="line">  notification_email &#123;                                      #出现问题后接收提示的邮箱</span><br><span class="line">    test@test.com</span><br><span class="line">  &#125;</span><br><span class="line">  notification_email_from test@test.com       #发件人邮箱</span><br><span class="line">  smtp_server 127.0.0.1                                #邮件服务器</span><br><span class="line">  smtp_connect_timeout 30                          #延时</span><br><span class="line">  router_id LVS_DEVEL                                #运行keepalived机器的一个标识</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;                                 #检测vrrp服务是否正常</span><br><span class="line">    script &quot;/usr/local/sbin/check_ng.sh&quot;          #检测脚本的路径</span><br><span class="line">    interval 3                                                   #检测间断是3s</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;                                     #定义相关Master的东西</span><br><span class="line">    state MASTER                                         #设定角色</span><br><span class="line">    interface ens33                                        #指定ens33这块网卡，通过vrrp协议去发广播</span><br><span class="line">    virtual_router_id 51                                  #指定虚拟路由器的ID，一定要和从上的保持一致</span><br><span class="line">    priority 100                                               #指定权重，数字越大优先级越高</span><br><span class="line">    advert_int 1                    </span><br><span class="line">    authentication &#123;                                       #认证的相关信息</span><br><span class="line">        auth_type PASS                                 #定义认证数据类型为密码</span><br><span class="line">        auth_pass 123456                              #密码暂定123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;                                  #定义VIP，VIP指的是高可用指定的固定IP地址，不论主从切换后IP都是这个</span><br><span class="line">        192.168.2.100</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx                                           #加载定义的chk_nginx脚本</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="写监控脚本"><a href="#写监控脚本" class="headerlink" title="写监控脚本"></a>写监控脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /usr/local/sbin/check_ng.sh     #keepalived的监控脚本，把下面代码粘贴进去</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#时间变量，用于记录日志</span><br><span class="line">d=`date --date today +%Y%m%d_%H:%M:%S`</span><br><span class="line">#计算nginx进程数量</span><br><span class="line">n=`ps -C nginx --no-heading|wc -l`</span><br><span class="line">#如果进程为0，则启动nginx，并且再次检测nginx进程数量，</span><br><span class="line">#如果还为0，说明nginx无法启动，此时需要关闭keepalived</span><br><span class="line">if [ $n -eq &quot;0&quot; ]; then</span><br><span class="line">        /etc/init.d/nginx start</span><br><span class="line">        n2=`ps -C nginx --no-heading|wc -l`</span><br><span class="line">        if [ $n2 -eq &quot;0&quot;  ]; then</span><br><span class="line">                echo &quot;$d nginx down,keepalived will stop&quot; &gt;&gt; /var/log/check_ng.log</span><br><span class="line">#杀掉keepalived，是为了防止脑裂。脑裂指的是高可用集群中，当主从切换时，主上的keepalived还在启动，会和从争抢VIP，导致后台链接服务器时，不知道连接哪台服务器好，导致出错。</span><br><span class="line">                systemctl stop keepalived</span><br><span class="line">        fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@yt-01 ~]# chmod 755  /usr/local/sbin/check_ng.sh      ##给脚本755权限</span><br></pre></td></tr></table></figure>

<p>脚本解读：<br>如果进程里面没发现nginx那就代表着服务宕机了，然后脚本自动的再次启动nginx服务。 如果服务还是不可以启动，就把启动报错日志输入到指定的位置，然后把keepalived也关闭。</p>
<p>为什么需要关闭keepalived呢？ 行业里面有个名词叫做“脑裂”，如果主服务宕机，从服务势必会马上启动顶替主服务再次服务，如果主服务的keepalived没有关闭，一定会造成混乱，两台机器都争抢服务。</p>
<p>在高可用（HA）系统中，当联系2个节点的“心跳线”断开时，本来为一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去了联系，都以为是对方出了故障。两个节点上的HA软件像“裂脑人”一样，争抢“共享资源”、争起“应用服务”，就会发生严重后果——或者共享资源被瓜分、2边服务都起不来了；或者2边服务都起来了，但同时读写“共享存储”，导致数据损坏。</p>
<p>高可用中，绝对不可以发生的脑裂问题！</p>
<h4 id="启动keepalived服务"><a href="#启动keepalived服务" class="headerlink" title="启动keepalived服务"></a>启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# systemctl start  keepalived</span><br><span class="line">[root@yt-01 ~]# ps aux |grep keep</span><br><span class="line">root      3887  0.0  0.1 120724  1400 ?        Ss  15:57  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      3888  0.0  0.2 120724  2748 ?        S    15:57  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      3889  0.0  0.2 124980  2744 ?        S    15:57  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      3914  0.0  0.0 112680  972 pts/1    R+  15:57  0:00 grep --color=auto keep</span><br><span class="line">[root@yt-01 ~]# ps aux |grep nginx</span><br><span class="line">root      3866  0.0  0.0  20500  628 ?        Ss  15:54  0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">nobody    3867  0.0  0.3  22944  3216 ?        S    15:54  0:00 nginx: worker process</span><br><span class="line">nobody    3868  0.0  0.3  22944  3216 ?        S    15:54  0:00 nginx: worker process</span><br><span class="line">root      3946  0.0  0.0 112680  972 pts/1    R+  15:57  0:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<h4 id="停掉keepalived，测试是否会重新加载"><a href="#停掉keepalived，测试是否会重新加载" class="headerlink" title="停掉keepalived，测试是否会重新加载"></a>停掉keepalived，测试是否会重新加载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# /etc/init.d/nginx stop</span><br><span class="line">[root@yt-01 ~]# ps aux |grep nginx</span><br><span class="line">root      4093  0.0  0.0  20500  628 ?        Ss  15:58  0:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">nobody    4097  0.0  0.3  22944  3216 ?        S    15:58  0:00 nginx: worker process</span><br><span class="line">nobody    4098  0.0  0.3  22944  3216 ?        S    15:58  0:00 nginx: worker process</span><br><span class="line">root      4106  0.0  0.0 112680  968 pts/1    R+  15:58  0:00 grep --color=auto nginx</span><br><span class="line">还是会再加载</span><br><span class="line"></span><br><span class="line">#查看日志#</span><br><span class="line">[root@yt-01 ~]# tail /var/log/messages</span><br><span class="line"></span><br><span class="line">[root@yt-01 ~]# ifconfig -a  ##这个命令查看不到VIP</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.2.180  netmask 255.255.255.0  broadcast 192.168.2.255</span><br><span class="line">        inet6 fe80::6b0e:c2eb:de7a:3662  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:14:f6:1b  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 16608  bytes 11284525 (10.7 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 10439  bytes 3068832 (2.9 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 617885  bytes 308269731 (293.9 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 617885  bytes 308269731 (293.9 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@yt-01 ~]# ip add         ##查看到的到VIP  xxx/32</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:14:f6:1b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.180/24 brd 192.168.2.255 scope global ens33</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.2.100/32 scope global ens33             ##VIP为192.168.2.100/32##</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6b0e:c2eb:de7a:3662/64 scope link </span><br><span class="line">      valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="配置keepalived从"><a href="#配置keepalived从" class="headerlink" title="配置keepalived从"></a>配置keepalived从</h3><h4 id="更改配置文件-1"><a href="#更改配置文件-1" class="headerlink" title="更改配置文件"></a>更改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# &gt; /etc/keepalived/keepalived.conf    ##清空原始配置文件</span><br><span class="line">[root@yt-02 ~]# vim /etc/keepalived/keepalived.conf  ##复制下面代码，代替原配置文件</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">    test@test.com</span><br><span class="line">  &#125;</span><br><span class="line">  notification_email_from test@test.com</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/usr/local/sbin/check_ng.sh&quot;</span><br><span class="line">    interval 3</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP               #指定角色为从</span><br><span class="line">    interface ens33              </span><br><span class="line">    virtual_router_id 51        </span><br><span class="line">    priority 90                       #指定权重为90，低于主</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.2.100</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编辑监控脚本"><a href="#编辑监控脚本" class="headerlink" title="编辑监控脚本"></a>编辑监控脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# vim /usr/local/sbin/check_ng.sh     ##keepalived监控脚本路径是在keepalived配置文件中指定的，把下面代码粘贴进去</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#时间变量，用于记录日志</span><br><span class="line">d=`date --date today +%Y%m%d_%H:%M:%S`</span><br><span class="line">#计算nginx进程数量</span><br><span class="line">n=`ps -C nginx --no-heading|wc -l`</span><br><span class="line">#如果进程为0，则启动nginx，并且再次检测nginx进程数量，</span><br><span class="line">#如果还为0，说明nginx无法启动，此时需要关闭keepalived</span><br><span class="line">if [ $n -eq &quot;0&quot; ]; then</span><br><span class="line">        systemctl start nginx    ##因为是yum安装，启动有点不一样</span><br><span class="line">        n2=`ps -C nginx --no-heading|wc -l`</span><br><span class="line">        if [ $n2 -eq &quot;0&quot;  ]; then</span><br><span class="line">                echo &quot;$d nginx down,keepalived will stop&quot; &gt;&gt; /var/log/check_ng.log</span><br><span class="line">                systemctl stop keepalived</span><br><span class="line">        fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@yt-02 ~]# chmod 755  /usr/local/sbin/check_ng.sh      ##给脚本755权限</span><br></pre></td></tr></table></figure>

<h4 id="启动keepalived"><a href="#启动keepalived" class="headerlink" title="启动keepalived"></a>启动keepalived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# systemctl start  keepalived</span><br><span class="line">[root@yt-02 ~]# ps aux |grep keep</span><br><span class="line">root      7174  0.0  0.1 120720  1404 ?        Ss  20:46  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      7175  0.0  0.2 120720  2752 ?        S    20:46  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      7176  0.0  0.2 124976  2740 ?        S    20:46  0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      7218  0.0  0.0 112632  660 pts/0    D+  20:46  0:00 grep --color=auto keep</span><br><span class="line">[root@yt-02 ~]# ps aux |grep nginx</span><br><span class="line">root      7199  0.0  0.2 122904  2108 ?        Ss  20:46  0:00 nginx: master process /usr/sbin/nginx</span><br><span class="line">nginx    7200  0.0  0.3 123368  3152 ?        S    20:46  0:00 nginx: worker process</span><br><span class="line">root      7232  0.0  0.0 112676  976 pts/0    S+  20:47  0:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<h4 id="停掉keepalived，测试是否会重新加载-1"><a href="#停掉keepalived，测试是否会重新加载-1" class="headerlink" title="停掉keepalived，测试是否会重新加载"></a>停掉keepalived，测试是否会重新加载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# systemctl stop nginx</span><br><span class="line">[root@yt-02 ~]# ps aux |grep nginx</span><br><span class="line">root      7413  0.0  0.2 122904  2108 ?        Ss  20:48  0:00 nginx: master process /usr/sbin/nginx</span><br><span class="line">nginx    7414  0.0  0.3 123368  3152 ?        S    20:48  0:00 nginx: worker process</span><br><span class="line">root      7485  0.0  0.0 112676  972 pts/0    S+  20:48  0:00 grep --color=auto nginx</span><br><span class="line">还是会再加载</span><br><span class="line"></span><br><span class="line">[root@yt-02 ~]# ifconfig -a  ##查看不到VIP</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.2.183  netmask 255.255.255.0  broadcast 192.168.2.255</span><br><span class="line">        inet6 fe80::62d6:aa12:bb83:d01a  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:0d:54:47  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 16098  bytes 18728112 (17.8 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 4869  bytes 499007 (487.3 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 16  bytes 1360 (1.3 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 16  bytes 1360 (1.3 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@yt-02 ~]# ip add        ##查看到的到VIP  xxx/32</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:0d:54:47 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.183/24 brd 192.168.2.255 scope global ens33</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.2.100/32 scope global ens33</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::62d6:aa12:bb83:d01a/64 scope link </span><br><span class="line">      valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="怎么区分主从上的nginx"><a href="#怎么区分主从上的nginx" class="headerlink" title="怎么区分主从上的nginx"></a>怎么区分主从上的nginx</h3><p>更改nginx默认主页的文件内容，比如：主上改成This is Master，从上改成This is backup。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx默认主页的文件地址</span><br><span class="line">主上：更改 /data/wwwroot/default/index.html 文件  （编译安装）</span><br><span class="line">                  如果找不到，就去/usr/local/nginx/html/index.html</span><br><span class="line">从上：/usr/share/nginx/html/index.html 文件            （yum安装）</span><br></pre></td></tr></table></figure>

<p>主：</p>
<p>从：</p>
<p>VIP：</p>
<h3 id="测试高可用"><a href="#测试高可用" class="headerlink" title="测试高可用"></a>测试高可用</h3><p>先确定好两台机器上nginx差异，比如可以通过curl -I 来查看nginx版本，通过浏览器访问各个IP测试。</p>
<ul>
<li><p>测试1：关闭master上的nginx服务<br>chkng脚本可以再次启动nginx的，我们上面测试过，无法关闭的</p>
</li>
<li><p>测试2：在master上增加iptabls规则 iptables -I OUTPUT -p vrrp -j DROP<br>用防火墙关闭vrrp协议，也不能让keepalived的主达到切换到从的目的。<br>我们还是恢复过来，iptables -F</p>
</li>
<li><p>测试3：关闭master上的keepalived服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# systemctl stop keepalived</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>访问VIP成功切换到从上。</p>
<ul>
<li>测试4：启动master上的keepalived服务<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# systemctl start keepalived</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>VIP马上有调到了主上面，这些过程，都可以在/var/log/messages日志里面看到。</p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><h3 id="高可用开源方案-Keepalived-VS-Heartbeat对比"><a href="#高可用开源方案-Keepalived-VS-Heartbeat对比" class="headerlink" title="高可用开源方案 Keepalived VS Heartbeat对比"></a>高可用开源方案 Keepalived VS Heartbeat对比</h3><p>出处：<a href="http://blog.csdn.net/yunhua_lee/article/details/9788433" target="_blank" rel="noopener">http://blog.csdn.net/yunhua_lee/article/details/9788433</a></p>
<h3 id="DRBD工作原理和配置"><a href="#DRBD工作原理和配置" class="headerlink" title="DRBD工作原理和配置"></a>DRBD工作原理和配置</h3><p>出处：<a href="http://502245466.blog.51cto.com/7559397/1298945" target="_blank" rel="noopener">http://502245466.blog.51cto.com/7559397/1298945</a></p>
<h3 id="mysql-keepalived"><a href="#mysql-keepalived" class="headerlink" title="mysql+keepalived"></a>mysql+keepalived</h3><p>出处：<a href="http://lizhenliang.blog.51cto.com/7876557/1362313" target="_blank" rel="noopener">http://lizhenliang.blog.51cto.com/7876557/1362313</a><br>环境描述：<br>OS：CentOS6.5_X64<br>MASTER：192.168.0.202<br>BACKUP：192.168.0.203<br>VIP：192.168.0.204<br>1、配置两台Mysql主主同步<br>[root@master ~]# yum install mysql-server mysql -y<br>[root@master ~]# service mysqld start<br>[root@master ~]# mysqladmin -u root password 123.com<br>[root@master ~]# vi /etc/my.cnf  #开启二进制日志，设置id<br>[mysqld]<br>server-id = 1                    #backup这台设置2<br>log-bin = mysql-bin<br>binlog-ignore-db = mysql,information_schema       #忽略写入binlog日志的库<br>auto-increment-increment = 2             #字段变化增量值<br>auto-increment-offset = 1              #初始字段ID为1<br>slave-skip-errors = all                       #忽略所有复制产生的错误<br>[root@master ~]# service mysqld restart</p>
<p>#先查看下log bin日志和pos值位置<br>wKiom1MJYSngwysqAADkFn9zcK8686.jpg<br>master配置如下：<br>[root@ master ~]# mysql -u root -p123.com<br>mysql&gt; GRANT  REPLICATION SLAVE ON <em>.</em> TO ‘replication’@’192.168.0.%’ IDENTIFIED  BY ‘replication’;<br>mysql&gt; flush  privileges;<br>mysql&gt; change  master to<br>    -&gt;  master_host=’192.168.0.203’,<br>    -&gt;  master_user=’replication’,<br>    -&gt;  master_password=’replication’,<br>    -&gt;  master_log_file=’mysql-bin.000002’,<br>    -&gt;  master_log_pos=106;  #对端状态显示的值<br>mysql&gt; start  slave;         #启动同步<br>backup配置如下：<br>[root@backup ~]#  mysql -u root -p123.com<br>mysql&gt; GRANT  REPLICATION SLAVE ON <em>.</em> TO ‘replication’@’192.168.0.%’ IDENTIFIED  BY ‘replication’;<br>mysql&gt; flush  privileges;<br>mysql&gt; change  master to<br>    -&gt;  master_host=’192.168.0.202’,<br>    -&gt;  master_user=’replication’,<br>    -&gt;  master_password=’replication’,<br>    -&gt;  master_log_file=’mysql-bin.000002’,<br>    -&gt;  master_log_pos=106;<br>mysql&gt; start  slave;</p>
<p>#主主同步配置完毕，查看同步状态Slave_IO和Slave_SQL是YES说明主主同步成功。<br>wKioL1MJYQ7QfZfXAAGQt0H1o1c742.jpg<br>在master插入数据测试下：<br>wKiom1MJYUCC0nlQAAEk4ruZ3ys652.jpg<br>在backup查看是否同步成功：<br>wKioL1MJYXyyChXUAADPZraUk3Y684.jpg<br>可以看到已经成功同步过去，同样在backup插入到user表数据，一样同步过去，双主就做成功了。<br>2、配置keepalived实现热备<br>[root@backup ~]# yum install -y pcre-devel openssl-devel popt-devel #安装依赖包<br>[root@master ~]# wget <a href="http://www.keepalived.org/software/keepalived-1.2.7.tar.gz" target="_blank" rel="noopener">http://www.keepalived.org/software/keepalived-1.2.7.tar.gz</a><br>[root@master ~]# tar zxvf keepalived-1.2.7.tar.gz<br>[root@master ~]# cd keepalived-1.2.7<br>[root@master ~]#./configure –prefix=/usr/local/keepalived<br>make &amp;&amp; make install</p>
<p>#将keepalived配置成系统服务<br>[root@master ~]# cp /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/<br>[root@master ~]# cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/<br>[root@master ~]# mkdir /etc/keepalived/<br>[root@master ~]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/<br>[root@master ~]# cp /usr/local/keepalived/sbin/keepalived /usr/sbin/<br>[root@master ~]# vi /etc/keepalived/keepalived.conf<br>! Configuration File forkeepalived<br>global_defs {<br>notification_email {<br><a href="mailto:test@sina.com" target="_blank" rel="noopener">test@sina.com</a><br> }<br>notification_email_from  <a href="mailto:admin@test.com" target="_blank" rel="noopener">admin@test.com</a><br>smtp_server 127.0.0.1<br>smtp_connect_timeout 30<br>router_id MYSQL_HA      #标识，双主相同<br> }<br>vrrp_instance VI_1 {<br> state BACKUP           #两台都设置BACKUP<br> interface eth0<br> virtual_router_id 51       #主备相同<br> priority 100           #优先级，backup设置90<br> advert_int 1<br> nopreempt             #不主动抢占资源，只在master这台优先级高的设置，backup不设置<br> authentication {<br> auth_type PASS<br> auth_pass 1111<br> }<br> virtual_ipaddress {<br> 192.168.0.204<br> }<br>}<br>virtual_server 192.168.0.204 3306 {<br> delay_loop 2</p>
<p> #lb_algo rr              #LVS算法，用不到，我们就关闭了</p>
<p> #lb_kind DR              #LVS模式，如果不关闭，备用服务器不能通过VIP连接主MySQL<br> persistence_timeout 50  #同一IP的连接60秒内被分配到同一台真实服务器<br> protocol TCP<br> real_server 192.168.0.202 3306 {   #检测本地mysql，backup也要写检测本地mysql<br> weight 3<br> notify_down /usr/local/keepalived/mysql.sh    #当mysq服down时，执行此脚本，杀死keepalived实现切换<br> TCP_CHECK {<br> connect_timeout 3    #连接超时<br> nb_get_retry 3       #重试次数<br> delay_before_retry 3 #重试间隔时间<br>  }<br>}<br>[root@master ~]# vi /usr/local/keepalived/mysql.sh</p>
<p>#!/bin/bash<br>pkill keepalived<br>[root@master ~]# chmod +x /usr/local/keepalived/mysql.sh<br>[root@master ~]# /etc/init.d/keepalived start</p>
<p>#backup服务器只修改priority为90、nopreempt不设置、real_server设置本地IP。</p>
<p>#授权两台Mysql服务器允许root远程登录，用于在其他服务器登陆测试！<br>mysql&gt; grant all on <em>.</em> to’root’@’192.168.0.%’ identified by ‘123.com’;<br>mysql&gt; flush privileges;<br>3、测试高可用性<br>1、通过Mysql客户端通过VIP连接，看是否连接成功。<br>2、停止master这台mysql服务，是否能正常切换过去，可通过ip addr命令来查看VIP在哪台服务器上。<br>wKiom1MJYbCBORSGAAHChWpI93k009.jpg<br>3、可通过查看/var/log/messges日志，看出主备切换过程<br>4、master服务器故障恢复后，是否主动抢占资源，成为活动服务器。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目/" itemprop="url">20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.19 告警系统需求分析</p>
<ul>
<li><p>需求：使用shell定制各种个性化告警工具，但需要统一化管理、规范化管理。</p>
</li>
<li><p>思路：指定一个脚本包，包含主程序、子程序、配置文件、邮件引擎、输出日志等。</p>
</li>
<li><p>主程序：作为整个脚本的入口，是整个系统的命脉。</p>
</li>
<li><p>配置文件：是一个控制中心，用它来开关各个子程序，指定各个相关联的日志文件。</p>
</li>
<li><p>子程序：这个才是真正的监控脚本，用来监控各个指标。</p>
</li>
<li><p>邮件引擎：是由一个python程序来实现，它可以定义发邮件的服务器、发邮件人以及发件人密码</p>
</li>
<li><p>输出日志：整个监控系统要有日志输出。</p>
</li>
<li><p>要求：我们的机器角色多种多样，但是所有机器上都要部署同样的监控系统，也就说所有机器不管什么角色，整个程序框架都是一致的，不同的地方在于根据不同的角色，定制不同的配置文件。</p>
</li>
<li><p>程序架构： </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin下是主程序</span><br><span class="line">conf下是配置文件</span><br><span class="line">shares下是各个监控脚本</span><br><span class="line">mail下是邮件引擎</span><br><span class="line">log下是日志。</span><br></pre></td></tr></table></figure>

<p>##20.20 告警系统主脚本</p>
<blockquote>
<p>主角本就是整个告警系统的入口，在使用中，我们直接执行它就可以了。</p>
</blockquote>
<p>###定义主角本的各个目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">以后工作中，我们就默认把脚本都放到/usr/local/sbin目录下，这样我们就可以轻松找到我们想要的脚本</span><br><span class="line">[root@host ~]# cd /usr/local/sbin     </span><br><span class="line"></span><br><span class="line">创建主目录和子目录</span><br><span class="line">[root@host sbin]# mkdir mon</span><br><span class="line">[root@host sbin]# cd mon</span><br><span class="line">[root@host mon]# mkdir mail log bin conf shares</span><br><span class="line">[root@host mon]# ls</span><br><span class="line">bin  conf  log  mail  shares</span><br><span class="line"></span><br><span class="line">把主脚本放大bin目录下</span><br><span class="line">[root@host mon]# cd bin</span><br></pre></td></tr></table></figure>

<p>###创建主脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@host bin]# vim main.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"># 是否发送邮件的开关</span><br><span class="line">export send=1</span><br><span class="line"># 过滤ip地址，关键词eth0可以根据主机网卡情况修改</span><br><span class="line">export addr=`/sbin/ifconfig |grep -A1 &quot;eth0: &quot;|awk &apos;/inet/ &#123;print $2&#125;&apos;`</span><br><span class="line">dir=`pwd`</span><br><span class="line"># 只需要最后一级目录名</span><br><span class="line">last_dir=`echo $dir|awk -F&apos;/&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class="line"># 下面的判断目的是，保证执行脚本的时候，我们在bin目录里，不然监控脚本、邮件和日志很有可能找不到</span><br><span class="line">if [ $last_dir == &quot;bin&quot; ] || [ $last_dir == &quot;bin/&quot; ]; then</span><br><span class="line">    conf_file=&quot;../conf/mon.conf&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;you shoud cd bin dir&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">exec 1&gt;&gt;../log/mon.log 2&gt;&gt;../log/err.log</span><br><span class="line">echo &quot;`date +&quot;%F %T&quot;` load average&quot;</span><br><span class="line">/bin/bash ../shares/load.sh</span><br><span class="line">#先检查配置文件中是否需要监控502</span><br><span class="line">if grep -q &apos;to_mon_502=1&apos; $conf_file; then</span><br><span class="line">    export log=`grep &apos;logfile=&apos; $conf_file |awk -F &apos;=&apos; &apos;&#123;print $2&#125;&apos; |sed &apos;s/ //g&apos;`</span><br><span class="line">    /bin/bash  ../shares/502.sh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>##20.21 告警系统配置文件</p>
<p>###配置文件的意义<br>主要是为了配合脚本的规范化，通过划分不同功能的文件，来方便查找、更改和控制脚本的各种参数。<br>我们可以在配置文件中统一定义一些开关参数、日志路径、用户名、密码、IP、端口等信息，主要是脚本中需要调用到的一些资源信息。</p>
<p>###创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host bin]# cd /usr/local/sbin/mon</span><br><span class="line"></span><br><span class="line">[root@host mon]# vim conf/mon.conf</span><br><span class="line">## to config the options if to monitor</span><br><span class="line">## 定义mysql的服务器地址、端口以及user、password</span><br><span class="line">to_mon_cdb=0  </span><br><span class="line">##是否监控数据库，0 or 1, 默认是0，如果是1则监控，为0不监控</span><br><span class="line">db_ip=10.20.3.13</span><br><span class="line">db_port=3315</span><br><span class="line">db_user=username</span><br><span class="line">db_pass=passwd</span><br><span class="line">## 监控httpd  如果是1则监控，为0不监控</span><br><span class="line">to_mon_httpd=0</span><br><span class="line">## 监控php 如果是1则监控，为0不监控</span><br><span class="line">to_mon_php_socket=0</span><br><span class="line">## 监控http_code_502  需要定义访问日志的路径</span><br><span class="line">to_mon_502=1</span><br><span class="line">logfile=/data/log/xxx.xxx.com/access.log</span><br><span class="line">#定义日子文件路径</span><br><span class="line">## 监控request_count  定义日志路径以及域名</span><br><span class="line">to_mon_request_count=0</span><br><span class="line">req_log=/data/log/www.discuz.net/access.log</span><br><span class="line">domainname=www.discuz.net</span><br></pre></td></tr></table></figure>

<p>##20.22 告警系统监控项目</p>
<p>###监控系统负载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host mon]# vim shares/load.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">##Writen by yuntai##</span><br><span class="line">load=`uptime |awk -F &apos;average:&apos; &apos;&#123;print $2&#125;&apos;|cut -d&apos;,&apos; -f1|sed &apos;s/ //g&apos; |cut -d. -f1`</span><br><span class="line">#获取负载值</span><br><span class="line">if [ $load -gt 10 ] &amp;&amp; [ $send -eq &quot;1&quot; ]</span><br><span class="line">#判断是否超负载，同时判断是否开启负载监控项</span><br><span class="line">then</span><br><span class="line">    echo &quot;$addr `date +%T` load is $load&quot; &gt;../log/load.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh yuntai_mail@163.com &quot;$addr\_load:$load&quot; `cat ../log/load.tmp`</span><br><span class="line">#超出设定的负载值后，发送邮件</span><br><span class="line">fi</span><br><span class="line">echo &quot;`date +%T` load is $load&quot;</span><br><span class="line">#日志文件（定义在系统配置脚本中）</span><br></pre></td></tr></table></figure>

<p>###监控web服务器502错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host mon]# cd shares/</span><br><span class="line">[root@host shares]# vim 502.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">d=`date -d &quot;-1 min&quot; +%H:%M`</span><br><span class="line">#因为监控主脚本一分钟执行一次，所以监控的内容为系统一分钟之前的状态</span><br><span class="line">c_502=`grep :$d:  $log  |grep &apos; 502 &apos;|wc -l`</span><br><span class="line">if [ $c_502 -gt 10 ] &amp;&amp; [ $send == 1 ]; then</span><br><span class="line">    echo &quot;$addr $d 502 count is $c_502&quot;&gt;../log/502.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh $addr\_502 $c_502  ../log/502.tmp</span><br><span class="line">fi</span><br><span class="line">echo &quot;`date +%T` 502 $c_502&quot;</span><br></pre></td></tr></table></figure>

<p>###监控磁盘使用率</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@host shares]# vim disk.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">##Writen by yuntai##</span><br><span class="line">rm -f ../log/disk.tmp</span><br><span class="line">for r in `df -h |awk -F &apos;[ %]+&apos; &apos;&#123;print $5&#125;&apos;|grep -v Use`</span><br><span class="line">##awk -F &apos;[ %]+&apos;  以一个或多个“[ %]”空格和百分号作为分隔符</span><br><span class="line">##即，awk可以一次指定多种分隔符（同时生效）</span><br><span class="line">do</span><br><span class="line">    if [ $r -gt 90 ] &amp;&amp; [ $send -eq &quot;1&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;$addr `date +%T` disk useage is $r&quot; &gt;&gt;../log/disk.tmp</span><br><span class="line">fi</span><br><span class="line">if [ -f ../log/disk.tmp ]</span><br><span class="line">#判断该文件是否存在</span><br><span class="line">then</span><br><span class="line">    df -h &gt;&gt; ../log/disk.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh $addr\_disk $r ../log/disk.tmp</span><br><span class="line">    echo &quot;`date +%T` disk useage is nook&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;`date +%T` disk useage is ok&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.16-20.18 shell中的函数、数组/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.16-20.18 shell中的函数、数组/" itemprop="url">20.16-20.17 shell中的函数、数组</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.16/20.17 shell中的函数、数组</p>
<p>函数就是把一段代码整理到了一个小单元中，并给这个小单元起一个名字，当用到这段代码时直接调用这个小单元的名字即可。</p>
<p>###格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function f_name() &#123;                      </span><br><span class="line">                 command            </span><br><span class="line"> &#125;</span><br><span class="line">#单词“function”可以省略，直接写函数的名字；函数必须放在脚本的最前面；调用函数的方法，是直接写函数名。</span><br></pre></td></tr></table></figure>

<p>###示例1 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /shell/</span><br><span class="line">#!/bin/bash</span><br><span class="line">input() &#123;</span><br><span class="line">    echo &quot;The first parameter is $1&quot;</span><br><span class="line">    echo &quot;The second parameter is $2&quot;</span><br><span class="line">    echo &quot;The third parameter is  $3&quot;</span><br><span class="line">    echo &quot;The number of parameter is $#&quot;</span><br><span class="line">    echo &quot;The script&apos;s name is $0&quot;</span><br><span class="line">#定义函数</span><br><span class="line">&#125;</span><br><span class="line">input    a b c asd  sdg</span><br><span class="line">#引用函数</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh func.sh</span><br><span class="line">The first parameter is a</span><br><span class="line">The second parameter is b</span><br><span class="line">The third parameter is  c</span><br><span class="line">The number of parameter is 5</span><br><span class="line">The script&apos;s name is func.sh</span><br></pre></td></tr></table></figure>

<h3 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">sum() &#123;</span><br><span class="line">    s=$[$1+$2]</span><br><span class="line">    echo $s</span><br><span class="line">&#125;</span><br><span class="line">sum 1 2</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh func2.sh</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h3 id="示例3"><a href="#示例3" class="headerlink" title="示例3"></a>示例3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">ip() &#123;</span><br><span class="line">    ifconfig|grep -A1 &quot;$e: &quot;|tail -1|awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line">&#125;</span><br><span class="line">read -p &quot;Please input the eth name: &quot; e</span><br><span class="line">myip=`ip $e`</span><br><span class="line">echo &quot;$e address is $myip&quot;</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh func3.sh </span><br><span class="line">Please input the eth name: eth0</span><br><span class="line">eth0 address is 172.18.192.237</span><br><span class="line"></span><br><span class="line">#知识点</span><br><span class="line">#grep -A1 keyword filename  找出filename中带有keyword的行，输出中除显示该行外，还显示之后的一行(After 1)</span><br><span class="line">#grep -B1 keyword filename  找出filename中带有keyword的行，输出中除显示该行外，还显示之前的一行(Before 1)</span><br><span class="line">#grep -1 keyword filename     找出filename中带有keyword的行，输出中除显示该行外，还显示之前的一行(After 1)和显示之后的一行(After 1）</span><br><span class="line">#awk &apos;&#123;pattern + action&#125;&apos; &#123;filenames&#125;</span><br><span class="line">#awk [-F  field-separator]  &apos;commands&apos;  input-file(s)</span><br><span class="line">#cat /etc/passwd |awk  -F &apos;:&apos;  &apos;&#123;print $1&quot;\t&quot;$7&#125;&apos;  </span><br><span class="line">#加-F &apos;.&apos; 是以.为分隔符，不加默认以空格或者tab为分隔符，$1为被分割的第一个域，$0为全部域，\t是tab键</span><br><span class="line">root    /bin/bash</span><br><span class="line">daemon  /bin/sh</span><br><span class="line">bin    /bin/sh</span><br><span class="line">sys    /bin/sh</span><br><span class="line">#cat /etc/passwd |awk  -F &apos;:&apos;  &apos;BEGIN &#123;print &quot;name,shell&quot;&#125;  &#123;print $1&quot;,&quot;$7&#125; END &#123;print &quot;blue,/bin/nosh&quot;&#125;&apos;</span><br><span class="line">name,shell</span><br><span class="line">root,/bin/bash</span><br><span class="line">daemon,/bin/sh</span><br><span class="line">bin,/bin/sh</span><br><span class="line">sys,/bin/sh</span><br><span class="line">....</span><br><span class="line">blue,/bin/nosh</span><br></pre></td></tr></table></figure>

<p>###改进例子3<br>加上2个判断，判定输入的是不是系统里面的网卡；判定如果输入的是系统里的网卡，那么到底有没有ip？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">这个细节错了，需要重新改进</span><br><span class="line">#!/bin/bash</span><br><span class="line">while</span><br><span class="line">    read -p &quot;Please input the eth name: &quot; e</span><br><span class="line">    if  [ -z  ifconfig|grep -w &quot;$e&quot; ]</span><br><span class="line">    then</span><br><span class="line">         echo &quot;The eth you typed is none, please type a right one&quot;</span><br><span class="line">         continue</span><br><span class="line">             if  [ -z ifconfig|grep -A1 &quot;$e: &quot;|tail -1|awk &apos;&#123;print $2&#125;&apos; ]</span><br><span class="line">             then </span><br><span class="line">                     echo &quot;The eth has no ip&quot; </span><br><span class="line">             fi</span><br><span class="line">    else</span><br><span class="line">           break           </span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line">ip() &#123;</span><br><span class="line">    ifconfig|grep -A1 &quot;$e: &quot;|tail -1|awk &apos;&#123;print $2&#125;&apos;</span><br><span class="line">&#125;</span><br><span class="line">myip=`ip $e`</span><br><span class="line">echo &quot;$e address is $myip&quot;</span><br></pre></td></tr></table></figure>

<p>##20.18 shell中的数组</p>
<p>平时工作中，很少用到过数组，到那时这个概念还是要弄明白。</p>
<p>###定义数组 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# vim shuzu.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">a=(1 2 3 4 5)</span><br><span class="line">echo $a</span><br><span class="line">echo $&#123;#a[@]&#125; </span><br><span class="line">#获取数组的元素个数 </span><br><span class="line">echo $&#123;a[2]&#125; </span><br><span class="line">#读取第三个元素，数组从0开始，a[0]是第一个元素</span><br><span class="line">echo $&#123;a[*]&#125; </span><br><span class="line">#等同于 $&#123;a[@]&#125;  显示整个数组的元素</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh shuzu.sh </span><br><span class="line">1</span><br><span class="line">5</span><br><span class="line">3</span><br><span class="line">1 2 3 4 5</span><br></pre></td></tr></table></figure>

<p>###数组赋值<br>直接通过  <code>数组名[下标]</code> 就可以对其进行引用赋值，如果下标不存在，那么自动添加新一个数组元素进去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# vim shuzu.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">a=(1 2 3 4 5)</span><br><span class="line">echo $a</span><br><span class="line">echo $&#123;#a[@]&#125;</span><br><span class="line">echo $&#123;a[2]&#125;</span><br><span class="line">echo $&#123;a[*]&#125;</span><br><span class="line"></span><br><span class="line">a[1]=100</span><br><span class="line">echo $&#123;a[@]&#125;</span><br><span class="line"></span><br><span class="line">a[5]=100</span><br><span class="line">echo $&#123;a[@]&#125; </span><br><span class="line"></span><br><span class="line">[root@host shell]# sh shuzu.sh </span><br><span class="line">1</span><br><span class="line">5</span><br><span class="line">3</span><br><span class="line">1 2 3 4 5</span><br><span class="line">1 100 3 4 5</span><br><span class="line">1 100 3 4 5 100</span><br></pre></td></tr></table></figure>

<p>###数组的删除<br>uset a; unset a[1]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# vim shuzudelete.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">a=(1 2 3 4 5)</span><br><span class="line">unset a</span><br><span class="line">echo $&#123;a[*]&#125; </span><br><span class="line">a=(1 2 3 4 5)</span><br><span class="line">unset a[1]</span><br><span class="line">echo $&#123;a[*]&#125; </span><br><span class="line">echo $&#123;#a[*]&#125;  </span><br><span class="line"></span><br><span class="line">[root@host shell]# sh shuzudelete.sh </span><br><span class="line"></span><br><span class="line">1 3 4 5</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<p>###数组的分片.<br>在某些特殊的复杂的情况下，会运用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># a=(`seq 1 5`)</span><br><span class="line"># echo $&#123;a[@]:0:3&#125;</span><br><span class="line">1 2 3</span><br><span class="line"></span><br><span class="line"># echo $&#123;a[@]:1:4&#125;</span><br><span class="line">2 3 4 5</span><br></pre></td></tr></table></figure>

<p>###数组替换，可以echo替换，也可以直接赋值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># a=(1 2 3 4 5)</span><br><span class="line">#echo $&#123;a[@/3/100]&#125;</span><br><span class="line">1 2 100 4 5</span><br><span class="line"></span><br><span class="line">#echo $&#123;a[@]&#125;</span><br><span class="line">1 2 3 4 5</span><br><span class="line"></span><br><span class="line">#a=($&#123;a[@]/3/100&#125;)</span><br><span class="line">#echo $&#123;a[@]&#125;</span><br><span class="line">1 2 100 4 5</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.23-20.26 告警系统邮件引擎、运行告警系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.23-20.26 告警系统邮件引擎、运行告警系统/" itemprop="url">20.23-20.26 告警系统邮件引擎、运行告警系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[toc]</p>
<p>##20.23/20.24/20.25 告警系统邮件引擎</p>
<p>mail.sh内容 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  log=$1</span><br><span class="line">t_s=`date +%s`</span><br><span class="line">t_s2=`date -d &quot;2 hours ago&quot; +%s`</span><br><span class="line">if [ ! -f /tmp/$log ]</span><br><span class="line">then</span><br><span class="line">    echo $t_s2 &gt; /tmp/$log</span><br><span class="line">fi</span><br><span class="line">t_s2=`tail -1 /tmp/$log|awk &apos;&#123;print $1&#125;&apos;`</span><br><span class="line">echo $t_s&gt;&gt;/tmp/$log</span><br><span class="line">v=$[$t_s-$t_s2]</span><br><span class="line">echo $v</span><br><span class="line">if [ $v -gt 3600 ]</span><br><span class="line">then</span><br><span class="line">    ./mail.py  $1  $2  $3</span><br><span class="line">    echo &quot;0&quot; &gt; /tmp/$log.txt</span><br><span class="line">else</span><br><span class="line">    if [ ! -f /tmp/$log.txt ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;0&quot; &gt; /tmp/$log.txt</span><br><span class="line">    fi</span><br><span class="line">    nu=`cat /tmp/$log.txt`</span><br><span class="line">    nu2=$[$nu+1]</span><br><span class="line">    echo $nu2&gt;/tmp/$log.txt</span><br><span class="line">    if [ $nu2 -gt 10 ]</span><br><span class="line">    then</span><br><span class="line">        ./mail.py  $1 &quot;trouble continue 10 min $2&quot; &quot;$3&quot;</span><br><span class="line">        echo &quot;0&quot; &gt; /tmp/$log.txt</span><br><span class="line">    fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>##20.26 运行告警系统<br>略</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本/" itemprop="url">20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.10 for循环</p>
<p>###语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for 变量名 in 条件; do …; done</span><br></pre></td></tr></table></figure>

<p>###案例1<br>计算1到100的和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">sum=0</span><br><span class="line">for i in `seq 1 100`</span><br><span class="line">do</span><br><span class="line">    echo &quot;$sum+$i&quot;</span><br><span class="line">    sum=$[$sum+$i]</span><br><span class="line">done</span><br><span class="line">echo $sum</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x for1.sh </span><br><span class="line">+ sum=0</span><br><span class="line">++ seq 1 100</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 0+1</span><br><span class="line">0+1</span><br><span class="line">+ sum=1</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 1+2</span><br><span class="line">1+2</span><br><span class="line">+ sum=3</span><br><span class="line">... ...</span><br><span class="line">+ sum=4851</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 4851+99</span><br><span class="line">4851+99</span><br><span class="line">+ sum=4950</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 4950+100</span><br><span class="line">4950+100</span><br><span class="line">+ sum=5050</span><br><span class="line">+ echo 5050</span><br><span class="line">5050</span><br></pre></td></tr></table></figure>

<p>###案例2<br>文件列表循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">cd /etc/</span><br><span class="line">for a in `ls /etc/`</span><br><span class="line">do</span><br><span class="line">    if [ -d $a ]</span><br><span class="line">    then</span><br><span class="line">      ls -d $a</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>###for循环的分隔符<br>for默认情况下会把空格或换行符（回车）作为分隔符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host /]# mkdir yuntai/</span><br><span class="line">[root@host /]# cd yuntai</span><br><span class="line">[root@host yuntai]# touch 1 2 3\ 4.txt</span><br><span class="line">[root@host yuntai]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 1</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 2</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 3 4.txt   </span><br><span class="line">#新建了一个名称中有空格的文件</span><br><span class="line">[root@host yuntai]# for i in `ls ./`; do echo $i ; done</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4.txt</span><br></pre></td></tr></table></figure>

<p>##20.11/20.12 while循环</p>
<p>###语法 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while 条件; do … ; done</span><br></pre></td></tr></table></figure>

<p>###案例1<br>当系统负载大于10的时候，发送邮件，每隔30秒执行一次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">while :</span><br><span class="line">#后面加冒号表示死循环的意思，也可以换成ture或者1</span><br><span class="line">do</span><br><span class="line">    load=`w|head -1|awk -F &apos;load average: &apos; &apos;&#123;print $2&#125;&apos;|cut -d. -f1`</span><br><span class="line">    if [ $load -gt 10 ]</span><br><span class="line">    then</span><br><span class="line">        top|mail -s &quot;load is high: $load&quot; xxxx@qq.com</span><br><span class="line">    fi</span><br><span class="line">    sleep 30</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>###案例2<br>一种交互模式，当用户输入对应内容，检测该字符是否符合条件，如：空、非数字、数字。分别对字符做出判断，然后做出不同的回应。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">while :</span><br><span class="line">do</span><br><span class="line">    read -p &quot;Please input a number: &quot; n</span><br><span class="line">    if [ -z &quot;$n&quot; ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;you need input sth.&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line">    n1=`echo $n|sed &apos;s/[0-9]//g&apos;`</span><br><span class="line">    if [ -n &quot;$n1&quot; ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;you just only input numbers.&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line">    break</span><br><span class="line">#continue: 中断本次while循环后重新开始；</span><br><span class="line">#break: 表示跳出本层循环，即该while循环结束</span><br><span class="line">done</span><br><span class="line">echo $n</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x while2.sh </span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number:  </span><br><span class="line">+ &apos;[&apos; -z &apos;&apos; &apos;]&apos;</span><br><span class="line">+ echo &apos;you need input sth.&apos;</span><br><span class="line">you need input sth.</span><br><span class="line">+ continue</span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number: z</span><br><span class="line">+ &apos;[&apos; -z z &apos;]&apos;</span><br><span class="line">++ sed &apos;s/[0-9]//g&apos;</span><br><span class="line">++ echo z</span><br><span class="line">+ n1=z</span><br><span class="line">+ &apos;[&apos; -n z &apos;]&apos;</span><br><span class="line">+ echo &apos;you just only input numbers.&apos;</span><br><span class="line">you just only input numbers.</span><br><span class="line">+ continue</span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number: 3</span><br><span class="line">+ &apos;[&apos; -z 3 &apos;]&apos;</span><br><span class="line">++ sed &apos;s/[0-9]//g&apos;</span><br><span class="line">++ echo 3</span><br><span class="line">+ n1=</span><br><span class="line">+ &apos;[&apos; -n &apos;&apos; &apos;]&apos;</span><br><span class="line">+ break</span><br><span class="line">+ echo 3</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>##20.13 break跳出循环<br>用于跳出循环语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line"># 数字最好用 -eq，如果是字符串，那么最好用 ==，这里用-eq更好</span><br><span class="line">    then</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x break1.sh </span><br><span class="line">++ seq 1 5</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 1</span><br><span class="line">1</span><br><span class="line">+ &apos;[&apos; 1 -eq 3 &apos;]&apos;</span><br><span class="line">+ echo 1</span><br><span class="line">1</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 2</span><br><span class="line">2</span><br><span class="line">+ &apos;[&apos; 2 -eq 3 &apos;]&apos;</span><br><span class="line">+ echo 2</span><br><span class="line">2</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 3</span><br><span class="line">3</span><br><span class="line">+ &apos;[&apos; 3 -eq 3 &apos;]&apos;</span><br><span class="line">+ break</span><br><span class="line">+ echo aaaaaaa</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>##20.14 continue结束本次循环<br>用于结束本次循环，直接进入下次循环语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line">    then</span><br><span class="line">        continue</span><br><span class="line">#忽略continue之下的代码，直接进行下一次循环</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo $i</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh  continue1.sh </span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">3    </span><br><span class="line">4</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">5</span><br><span class="line">5</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>##20.15 exit退出整个脚本<br>直接退出整个脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line">    then</span><br><span class="line">        exit</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh exit1.sh </span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>##扩展 select用法<br>select也是循环的一种，它比较适合用在用户选择的情况下。<br>比如，我们有一个这样的需求，运行脚本后，让用户去选择数字，选择1，会运行w命令，选择2运行top命令，选择3运行free命令，选择4退出。脚本这样实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">执行结果如下：</span><br><span class="line">sh select.sh</span><br><span class="line">Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit</span><br><span class="line"></span><br><span class="line">1) w</span><br><span class="line">2) top</span><br><span class="line">3) free</span><br><span class="line">4) quit</span><br><span class="line">#? 1</span><br><span class="line">16:03:40 up 32 days,  2:42,  1 user,  load average: 0.01, 0.08, 0.08</span><br><span class="line">USER    TTY      FROM              LOGIN@  IDLE  JCPU  PCPU WHAT</span><br><span class="line">root    pts/0    61.135.172.68    15:33    0.00s  0.02s  0.00s sh select.sh</span><br><span class="line"></span><br><span class="line">#? 3</span><br><span class="line">            total      used      free    shared    buffers    cached</span><br><span class="line">Mem:      1020328    943736      76592          0      86840    263624</span><br><span class="line">-/+ buffers/cache:    593272    427056</span><br><span class="line">Swap:      2097144      44196    2052948</span><br><span class="line">#?</span><br></pre></td></tr></table></figure>

<p>我们发现，select会默认把序号对应的命令列出来，每次输入一个数字，则会执行相应的命令，命令执行完后并不会退出脚本。它还会继续让我们再次输如序号。序号前面的提示符，我们也是可以修改的，利用变量PS3即可，再次修改脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">PS3=&quot;Please select a number: &quot;</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;</span><br><span class="line">    esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>如果想要脚本每次输入一个序号后就自动退出，则需要再次更改脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">PS3=&quot;Please select a number: &quot;</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w;exit</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top;exit</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free;exit</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;;exit</span><br><span class="line">    esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断/" itemprop="url">20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.5 shell脚本中的if逻辑判断<br>Shell脚本中，充满着各种逻辑判断，是脚本中必备的。</p>
<p>###逻辑判断表达式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-gt (&gt;);    大于    great than</span><br><span class="line">-lt(&lt;);      小于     less than</span><br><span class="line">-ge(&gt;=);  大于或等于   </span><br><span class="line">-le(&lt;=);   小于或等于</span><br><span class="line">-eq(==);  等于     equal</span><br><span class="line">-ne(!=)    不等于  not equa</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">if [ $a -gt $b ]; </span><br><span class="line">if [ $a -lt 5 ]; </span><br><span class="line">if [ $b -eq 10 ]等</span><br></pre></td></tr></table></figure>

<p>###if逻辑判断格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">格式1：if 条件 ; then 语句; fi</span><br><span class="line">格式2：if 条件; then 语句; else 语句; fi</span><br><span class="line">格式3：if …; then … ;elif …; then …; else …; fi</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">可以使用 &amp;&amp; || 结合多个条件</span><br><span class="line">条件A&amp;&amp;条件B：A并且B</span><br><span class="line">条件A||条件B：A或者B</span><br><span class="line">if [ $a -gt 5 ] &amp;&amp; [ $a -lt 10 ]; then</span><br><span class="line">if [ $b -gt 5 ] || [ $b -lt 3 ]; then</span><br></pre></td></tr></table></figure>

<p>###if逻辑判断例子<br>格式1：if 条件 ; then 语句; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=5</span><br><span class="line">if [ $a -gt 3 ]</span><br><span class="line">#注意[]里面有大量空格</span><br><span class="line">then</span><br><span class="line">       echo &quot;ok&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>格式2：if 条件; then 语句; else 语句; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=5</span><br><span class="line">if [ $a -gt 3 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ok&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;nook&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>格式3：if …; then … ;elif …; then …; else …; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=3</span><br><span class="line">if [ $a -gt 4 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;&gt;1&quot;</span><br><span class="line">elif [ $a -gt 6 ]</span><br><span class="line">#注意elif可以嵌套多次的</span><br><span class="line">then</span><br><span class="line">    echo &quot;&lt;6 &amp;&amp; &gt;1&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;nook&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>##20.6 文件目录属性判断<br>在shell中通常要和文件或者目录打交道，那么对于他们的属性判断十分重要。</p>
<p>###文件目录属性判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ -f file ]判断是否是普通文件，且存在     [ -f /usr/bin/grep ]</span><br><span class="line">[ -d file ] 判断是否是目录，且存在   [ -d /tmp/mydir ]</span><br><span class="line">[ -e file ] 判断文件或目录是否存在   [ -e /var/log/syslog ]</span><br><span class="line">[ -r file ] 判断文件是否可读   [ -r /var/log/syslog ]</span><br><span class="line">[ -w file ] 判断文件是否可写  [ -w /var/mytmp.txt ]</span><br><span class="line">[ -x file ] 判断文件是否可执行  [ -x /usr/bin/grep ]</span><br></pre></td></tr></table></figure>

<p>###例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">f=&quot;/tmp/zhouquniclinux&quot;</span><br><span class="line">if [ -e $f ]</span><br><span class="line">then </span><br><span class="line">       echo $f exist</span><br><span class="line">else</span><br><span class="line">      touch $f</span><br></pre></td></tr></table></figure>

<p>上例可以简化为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">[ -e $f ] ||  touch $f</span><br><span class="line">[ ! -e $f ] || echo $f exist   </span><br><span class="line"># || 当前面的执行成功后再执行后面的命令</span><br><span class="line"># 如果是&amp;&amp;，则不管前面的命令是否执行成功，都会执行后面的命令</span><br><span class="line"># ! 表示取反</span><br></pre></td></tr></table></figure>

<p>##20.7 if特殊用法</p>
<h3 id="if特殊用法"><a href="#if特殊用法" class="headerlink" title="if特殊用法"></a>if特殊用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if [ -z &quot;$a&quot; ]  这个表示当变量a的值为空时会怎么样</span><br><span class="line">if [ -n &quot;$a&quot; ]  表示当变量a的值不为空</span><br><span class="line">if grep -q &apos;123&apos; 1.txt; then  表示如果1.txt中含有&apos;123&apos;的行时会怎么样</span><br><span class="line">if [ ! -e file ]; then 表示文件不存在时会怎么样</span><br><span class="line">if (($a&lt;1)); then …等同于 if [ $a -lt 1 ]; then… </span><br><span class="line">[ ] 中不能使用&lt;,&gt;,==,!=,&gt;=,&lt;=这样的符号</span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>if [ -z “$a” ]  这个表示当变量a的值为空时会怎么样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">       echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br><span class="line"># 如果/tmp/lalala文件为空，或者被删除的话，脚本就会运行出错，出现bug</span><br><span class="line"></span><br><span class="line">应该加上一个判断条件</span><br><span class="line">#!/bin/bash</span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -z &quot;$n&quot; ]</span><br><span class="line"># [ $n -z &quot;$n&quot; ]  = [ ! $n -n &quot;$n&quot; ]，-z 和 -n 是一对相反的条件</span><br><span class="line">then</span><br><span class="line">       echo &quot;error&quot;</span><br><span class="line">       exit</span><br><span class="line">elif [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ ! -f /tmp/lalala ]</span><br><span class="line">then</span><br><span class="line">       echo &quot;/tmp/lalala is not exist&quot;</span><br><span class="line">       exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>if [ -n “$a” ]  表示当变量a的值不为空，也可以判断文件，判断文件时可以不加双引号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ -n 01.sh ]; then echo &quot;ok&quot;; fi</span><br><span class="line"></span><br><span class="line">另外</span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ -n &quot;$b&quot; ]</span><br><span class="line">then  </span><br><span class="line">       echo $b</span><br><span class="line">else</span><br><span class="line">        echo &quot;b is null&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>一条命令也可以作为判断条件。判断user1用户是否存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if grep -wq &apos;user1&apos;  /etc/passwd; then echo &quot;user1 is exist&quot;; else echo &quot;user1 is not exist&quot;; fi</span><br><span class="line">#grep -w 显示过滤信息，加-q可以不显示过滤信息</span><br></pre></td></tr></table></figure>

<p>##20.8/20.9 case判断</p>
<p>###case判断格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case 变量名 in</span><br><span class="line">    value1)</span><br><span class="line">      commond1</span><br><span class="line">      ;;</span><br><span class="line">    value2)</span><br><span class="line">      commod2</span><br><span class="line">      ;;</span><br><span class="line">    value3)</span><br><span class="line">      commod3</span><br><span class="line">      ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>###在case中，可以在条件中使用“|”，表示或的意思，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2|3)</span><br><span class="line">    commond</span><br><span class="line">    ;;</span><br></pre></td></tr></table></figure>

<p>###例子: 输入一个同学的分数，判断成绩是否及格，优秀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# vim case1.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">read -p &quot;Please input a number: &quot; n</span><br><span class="line"># read -p 是读取用户的输入数据，定义到变量里面</span><br><span class="line">if [ -z &quot;$n&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Please input a number.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">#“exit 1”表示非正常运行导致退出程序</span><br><span class="line">#退出之后，echo $?会返回1值，表示程序退出是因为出错了</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">n1=`echo $n|sed &apos;s/[0-9]//g&apos;`</span><br><span class="line">#判断用户输入的字符是否为纯数字</span><br><span class="line">#如果是数字，则将其替换为空，赋值给$n1</span><br><span class="line">if [ -n &quot;$n1&quot; ]</span><br><span class="line">then</span><br><span class="line">echo &quot;Please input a number.&quot;</span><br><span class="line">exit 1</span><br><span class="line">#判断$n1不为空时（即$n不是纯数字）再次提示用户输入数字并退出</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#如果用户输入的是纯数字则执行以下命令：</span><br><span class="line">if [ $n -lt 60 ] &amp;&amp; [ $n -ge 0 ]</span><br><span class="line">then</span><br><span class="line">    tag=1</span><br><span class="line">elif [ $n -ge 60 ] &amp;&amp; [ $n -lt 80 ]</span><br><span class="line">then</span><br><span class="line">    tag=2</span><br><span class="line">elif [ $n -ge 80 ]  &amp;&amp; [ $n -lt 90 ]</span><br><span class="line">then</span><br><span class="line">    tag=3</span><br><span class="line">elif [ $n -ge 90 ] &amp;&amp; [ $n -le 100 ]</span><br><span class="line">then</span><br><span class="line">    tag=4</span><br><span class="line">else</span><br><span class="line">    tag=0</span><br><span class="line">fi</span><br><span class="line">#tag的作用是为判断条件设定标签，方便后面引用</span><br><span class="line">case $tag in</span><br><span class="line">    1)</span><br><span class="line">        echo &quot;not ok&quot;</span><br><span class="line">        ;;</span><br><span class="line">    2)</span><br><span class="line">        echo &quot;ok&quot;</span><br><span class="line">        ;;</span><br><span class="line">    3)</span><br><span class="line">        echo &quot;ook&quot;</span><br><span class="line">        ;;</span><br><span class="line">    4)</span><br><span class="line">        echo &quot;oook&quot;</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;The number range is 0-100.&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>###运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 45</span><br><span class="line">not ok</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 66</span><br><span class="line">ok</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 80</span><br><span class="line">ook</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 99</span><br><span class="line">oook</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: xxx</span><br><span class="line">Please input a number.</span><br><span class="line">[root@host shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 120</span><br><span class="line">The number range is 0-100.</span><br><span class="line">[root@host shell]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/21.18-21.21 redis慢查询日志、php安装redis扩展、存储session、主从配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/21.18-21.21 redis慢查询日志、php安装redis扩展、存储session、主从配置/" itemprop="url">21.18-21.21 redis慢查询日志、php安装redis扩展、存储session、主从配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="21-18-redis慢查询日志"><a href="#21-18-redis慢查询日志" class="headerlink" title="21.18 redis慢查询日志"></a>21.18 redis慢查询日志</h1><p>针对慢查询日志可以设置两个参数，一个是执行时长，单位是微妙，另一个是慢查询日志的长度。当一个新的命令被写入日志时，最老的一条会从命令日志队列被移除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /etc/redis.conf</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">#单位：微秒</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">#定义日志长度，表示最多存128条</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">列出所有慢查询日志：</span><br><span class="line">[root@yt-01 ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; slowlog get</span><br><span class="line">(empty list or set)</span><br><span class="line">列出两条慢查询日志：</span><br><span class="line">127.0.0.1:6379&gt; slowlog get 2</span><br><span class="line">(empty list or set)</span><br><span class="line">查看慢查询日志条数：</span><br><span class="line">127.0.0.1:6379&gt; slowlog len</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h1 id="21-19-21-20-php安装redis扩展，redis存储php的session"><a href="#21-19-21-20-php安装redis扩展，redis存储php的session" class="headerlink" title="21.19-21.20 php安装redis扩展，redis存储php的session"></a>21.19-21.20 php安装redis扩展，redis存储php的session</h1><p>PHP和Redis通过模块相结合，使用前先查看PHP是否有Redis模块，如果没有，按如下方式安装并配置。</p>
<h2 id="1-安装php-redis扩展模块"><a href="#1-安装php-redis扩展模块" class="headerlink" title="1 安装php-redis扩展模块"></a>1 安装php-redis扩展模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 src]# wget https://coding.net/u/aminglinux/p/yuanke_centos7/git/raw/master/21NOSQL/phpredis.zip</span><br><span class="line">[root@yt-01 src]# unzip phpredis.zip</span><br><span class="line">[root@yt-01 src]# cd phpredis-develop/</span><br><span class="line">[root@yt-01 phpredis-develop]# /usr/local/php/bin/phpize</span><br><span class="line">[root@yt-01 phpredis-develop]# ./configure --with-php-config=/usr/local/php/bin/php-config</span><br><span class="line">[root@yt-01 phpredis-develop]# make &amp;&amp; make install</span><br><span class="line">增加如下配置：</span><br><span class="line">[root@yt-01 phpredis-develop]# vim /usr/local/php/etc/php.ini</span><br><span class="line">extension=redis.so</span><br><span class="line">[root@yt-01 phpredis-develop]# /usr/local/php/bin/php -m</span><br><span class="line">redis</span><br></pre></td></tr></table></figure>

<h2 id="2-Redis和PHP连接"><a href="#2-Redis和PHP连接" class="headerlink" title="2 Redis和PHP连接"></a>2 Redis和PHP连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">方法1：编辑php.ini</span><br><span class="line">[root@yt-01 www]# vim /usr/local/php/etc/php.ini</span><br><span class="line">session.save_handler = redis</span><br><span class="line">session.save_path = &quot;tcp://127.0.0.1:6379&quot;</span><br><span class="line">方法2：编辑pool文件：</span><br><span class="line">[root@yt-01 ~]# vim /usr/local/php-fpm/etc/php-fpm.d/www.conf</span><br><span class="line">php_value[session.save_handler] = redis</span><br><span class="line">php_value[session.save_path] = &quot;tcp://127.0.0.1:6379&quot;</span><br></pre></td></tr></table></figure>

<h2 id="3-测试"><a href="#3-测试" class="headerlink" title="3 测试"></a>3 测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 www]# pwd</span><br><span class="line">/data/wwwroot/111.com</span><br><span class="line">[root@yt-01 www]# ls</span><br><span class="line">index.php</span><br><span class="line">#1.php为测试文件</span><br><span class="line">[root@yt-01 www]# vim 1.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;TEST&apos;])) &#123;</span><br><span class="line">$_SESSION[&apos;TEST&apos;] = time();</span><br><span class="line">&#125;</span><br><span class="line">$_SESSION[&apos;TEST3&apos;] = time();</span><br><span class="line">print $_SESSION[&apos;TEST&apos;];</span><br><span class="line">print &quot;&lt;br&gt;&lt;br&gt;&quot;;</span><br><span class="line">print $_SESSION[&apos;TEST3&apos;];</span><br><span class="line">print &quot;&lt;br&gt;&lt;br&gt;&quot;;</span><br><span class="line">print session_id();</span><br><span class="line">?&gt;</span><br><span class="line">[root@yt-01 www]# curl localhost/1.php</span><br><span class="line">1523162689&lt;br&gt;&lt;br&gt;1523162689&lt;br&gt;&lt;br&gt;0fp6g1hi1q6ktdoogfplvlpo91</span><br><span class="line">[root@yt-01 www]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">10) &quot;PHPREDIS_SESSION:6rtu66hia6rjq9rpadstnsqb61&quot;</span><br><span class="line">11) &quot;PHPREDIS_SESSION:hdi4f5r122gg1n9sj5lllbqf42&quot;</span><br><span class="line">12) &quot;PHPREDIS_SESSION:8tf4q887ti8m11sknl5oto82m4&quot;</span><br><span class="line">13) &quot;PHPREDIS_SESSION:hc1h18jtkrvk3secno4nmk7km2&quot;</span><br></pre></td></tr></table></figure>

<p>这样就配置完成了。</p>
<p><strong>注意</strong>： 注： 如果是在集群架构中，需要使用predis扩展模块，扩展地址 <a href="https://github.com/nrk/predis" target="_blank" rel="noopener">https://github.com/nrk/predis</a> 。</p>
<h1 id="21-21-redis主从配置"><a href="#21-21-redis主从配置" class="headerlink" title="21.21 redis主从配置"></a>21.21 redis主从配置</h1><p>为了节省资源，本实验在一台机器进行。即，在一台机器上启动两个端口，模拟两台机器。</p>
<h2 id="1-redis主从搭建"><a href="#1-redis主从搭建" class="headerlink" title="1 redis主从搭建"></a>1 redis主从搭建</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">准备</span><br><span class="line">还是之前的yt-01主机，环境是LAMP+redis</span><br><span class="line"></span><br><span class="line">复制redis配置文件</span><br><span class="line">[root@adailinux ~]# cp /etc/redis.conf /etc/redis2.conf</span><br><span class="line"></span><br><span class="line">配置redis从的配置文件</span><br><span class="line">[root@adailinux ~]# vim /etc/redis2.conf    //需要修改port,dir,pidfile,logfile</span><br><span class="line">port 6380   //因为是同一台服务器，2个进程，所以需要换一个端口</span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br><span class="line">logfile &quot;/tmp/logs/redis2.log&quot;</span><br><span class="line">dir /data/redis2</span><br><span class="line"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">slaveof 127.0.0.1 6379        //添加这一行</span><br><span class="line">###指定主服务器IP和端口</span><br><span class="line"># masterauth passwd123</span><br><span class="line">###如果主服务器设定了密码，需要在从服务器上添加该参数</span><br><span class="line"></span><br><span class="line">创建redis从的库文件夹</span><br><span class="line">[root@adailinux ~]# mkdir /data/redis2</span><br><span class="line"></span><br><span class="line">启动Redis</span><br><span class="line">[root@adailinux ~]# redis-server /etc/redis.conf</span><br><span class="line">[root@adailinux ~]# redis-server /etc/redis2.conf </span><br><span class="line"></span><br><span class="line">[root@adailinux ~]# ps aux |grep redis</span><br><span class="line">root 2454 0.2 0.4 145244 2356 ? Ssl 17:18 0:00 redis-server 127.0.0.1:6379</span><br><span class="line">root 2459 0.3 0.4 145244 2332 ? Ssl 17:19 0:00 redis-server 127.0.0.1:6380</span><br><span class="line">[root@adailinux ~]# netstat -lntp |grep redis</span><br><span class="line">tcp 0 0 127.0.0.1:6379 0.0.0.0:* LISTEN 2454/redis-server 1</span><br><span class="line">tcp 0 0 127.0.0.1:6380 0.0.0.0:* LISTEN 2459/redis-server 1</span><br><span class="line">启动成功，redis主从搭建完毕！</span><br></pre></td></tr></table></figure>

<h2 id="2-查看slave上的数据"><a href="#2-查看slave上的数据" class="headerlink" title="2 查看slave上的数据"></a>2 查看slave上的数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@adailinux ~]# redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line"> 1) &quot;list1&quot;</span><br><span class="line"> 2) &quot;hseta&quot;</span><br><span class="line"> 3) &quot;set1&quot;</span><br><span class="line"> 4) &quot;set3&quot;</span><br><span class="line"> 5) &quot;key2&quot;</span><br><span class="line"> 6) &quot;k1&quot;</span><br><span class="line"> 7) &quot;set4&quot;</span><br><span class="line"> 8) &quot;seta&quot;</span><br><span class="line"> 9) &quot;k2&quot;</span><br><span class="line">10) &quot;k3&quot;</span><br><span class="line">11) &quot;zseta&quot;</span><br><span class="line">12) &quot;setb&quot;</span><br><span class="line">13) &quot;hash1&quot;</span><br><span class="line">14) &quot;set5&quot;</span><br><span class="line">15) &quot;list2&quot;</span><br><span class="line">16) &quot;mykey&quot;</span><br></pre></td></tr></table></figure>

<h2 id="3-测试主从"><a href="#3-测试主从" class="headerlink" title="3 测试主从"></a>3 测试主从</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">在master上创建数据：</span><br><span class="line">[root@adailinux ~]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; del key</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; select 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; set test 00001</span><br><span class="line">OK</span><br><span class="line">在slave上查看：</span><br><span class="line">[root@adailinux ~]# redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; select 1</span><br><span class="line">127.0.0.1:6380[1]&gt; keys *</span><br><span class="line">1) &quot;test&quot;</span><br><span class="line">127.0.0.1:6380[1]&gt; get test</span><br><span class="line">&quot;00001&quot;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>： Redis主从和mysql主从不一样，Redis主从不用事先同步数据，它会自动同步。因为master上设置有参数“slave-read-only yes”，即该slave为只读数据库！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhouqun</p>
              <p class="site-description motion-element" itemprop="description">个人Linux学习和工作记录的小地方</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhouqun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
