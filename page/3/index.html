<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Joking的Linux世界" type="application/atom+xml">






<meta name="description" content="个人Linux学习和工作记录的小地方">
<meta name="keywords" content="linux">
<meta property="og:type" content="website">
<meta property="og:title" content="Joking的Linux世界">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Joking的Linux世界">
<meta property="og:description" content="个人Linux学习和工作记录的小地方">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joking的Linux世界">
<meta name="twitter:description" content="个人Linux学习和工作记录的小地方">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>Joking的Linux世界</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Joking的Linux世界</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">念念不忘，必有回响</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.10 - 11.13 LAMP架构-安装PHP5、PHP7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.10 - 11.13 LAMP架构-安装PHP5、PHP7/" itemprop="url">11.10 - 11.13 LAMP架构-安装PHP5、PHP7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>PHP官网<a href="http://www.php.net" target="_blank" rel="noopener">www.php.net</a><br>当前主流版本为5.6/7.1</p>
<h1 id="1-编译安装PHP5-6"><a href="#1-编译安装PHP5-6" class="headerlink" title="1. 编译安装PHP5.6"></a>1. 编译安装PHP5.6</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@host apache2.4]# cd /usr/local/src/ </span><br><span class="line">[root@host src]# wget http://cn2.php.net/distributions/php-5.6.30.tar.bz2    #下载PHP5.6源码包</span><br><span class="line">[root@host src]# tar jxf php-5.6.30.tar.bz2</span><br><span class="line">tar (child): bzip2: Cannot exec: No such file or directory</span><br><span class="line">tar (child): Error is not recoverable: exiting now</span><br><span class="line">tar: Child returned status 2</span><br><span class="line">tar: Error is not recoverable: exiting now     //说明没有安装bzip2这个软件包。解决方法：安装bzip2软件包</span><br><span class="line">[root@host src]# yum -y install bzip2</span><br><span class="line">[root@host src]# tar jxf php-5.6.30.tar.bz2</span><br><span class="line">[root@host src]# cd php-5.6.30  #</span><br><span class="line">[root@host php-5.6.30]# ./configure --prefix=/usr/local/php --with-apxs2=/usr/local/apache2.4/bin/apxs --with-config-file-path=/usr/local/php/etc  --with-mysql=/usr/local/mariadb --with-pdo-mysql=/usr/local/mariadb --with-mysqli=/usr/local/mariadb/bin/mysql_config --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-bz2 --with-openssl --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-mbstring --enable-sockets --enable-exif </span><br><span class="line">[root@host php-5.6.30]# ./configure --prefix=/usr/local/php --with-apxs2=/usr/local/apache2.4/bin/apxs --with-config-file-path=/usr/local/php/etc  --with-mysql=/usr/local/mysql --with-pdo-mysql=/usr/local/mysql --with-mysqli=/usr/local/mysql/bin/mysql_config --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-bz2 --with-openssl --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-mbstring --enable-sockets --enable-exif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 解释</span><br><span class="line"># --prefix 安装目录</span><br><span class="line">#--with-apxs2 apache的工具，能让我们不用人工干涉它，帮忙把扩展模块放到apache的modules目录里，并且在它的配置文件里加上一行mod-modules，自动的给你配置上这个模块，一般可以给你加上so文件，但是不会自动加载配置模块，这就是为什么要后安装PHP</span><br><span class="line">#--with-mysql  --with-pdo-mysql  --with-mysqli  定义给mysql通信的相关函数或者驱动，让php能和mysql交换数据</span><br><span class="line">#--with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-bz2 --with-openssl --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-mbstring --enable-sockets --enable-exif   这些都是一些必要的参数</span><br><span class="line">#在编译的过程中，会出现一些错误，往往是因为缺少相关的库文件</span><br><span class="line">1. configure: error: xml2-config not found. Please check your libxml2 installation.</span><br><span class="line">yum install libxml2-devel -y</span><br><span class="line">2. configure: error: Cannot find OpenSSL&apos;s &lt;evp.h&gt;</span><br><span class="line">yum install -y openssl openssl-devel</span><br><span class="line">3. configure: error: Please reinstall the BZip2 distribution</span><br><span class="line">yum install -y bzip2 bzip2-devel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4. configure: error: jpeglib.h not found.</span><br><span class="line">yum install -y libjpeg-devel</span><br><span class="line">5. configure: error: png.h not found.</span><br><span class="line">yum install -y libpng-devel</span><br><span class="line">6. configure: error: freetype-config not found.</span><br><span class="line">yum install -y freetype-devel</span><br><span class="line">7. configure: error: mcrypt.h not found. Please reinstall libmcrypt.</span><br><span class="line">(centos源不能安装libmcrypt-devel，由于版权的原因没有自带mcrypt的包rpm -qa|grep limcrypt limcrypt-devel,此源为rethot社区版的源)</span><br><span class="line">安装第三方yum源</span><br><span class="line">wget http://www.atomicorp.com/installers/atomic</span><br><span class="line">sh ./atomic</span><br><span class="line"></span><br><span class="line">yum  install  php-mcrypt  libmcrypt  libmcrypt-devel</span><br><span class="line">---</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo $?</span><br><span class="line">0</span><br><span class="line">cp php.ini-production  /usr/local/php/etc/php.ini   #把参考配置文件拷贝到定义的路径</span><br><span class="line">#也可以自己找一下， /usr/local/php/bin/php -i | less  查看一些php的参数</span><br><span class="line"># php.ini-production  使用于生产环境的配置文件，还有适用于开发和实验环境的配置文件php.ini-development</span><br></pre></td></tr></table></figure>

<h1 id="2-查看PHP的目录"><a href="#2-查看PHP的目录" class="headerlink" title="2. 查看PHP的目录"></a>2. 查看PHP的目录</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/local/php/</span><br><span class="line">ls /usr/local/php/bin/     #php核心的二进制文件在这个文件夹里面</span><br><span class="line">du -sh   /usr/local/php/bin/php</span><br><span class="line">36M      /usr/local/php/bin/php</span><br><span class="line">du -sh   /usr/local/apache2.4/modules/libphp.so    #PHP和Apache结合的模块</span><br><span class="line">37M      /usr/local/apache2.4/modules/libphp.so</span><br><span class="line">/usr/local/php/bin/php -m  #查看php加载的模块（静态）</span><br><span class="line">/usr/local/apache2.4/bin/httpd  -M  #查看apache加载的模块</span><br><span class="line">vi  /usr/local/apache2.4/conf/httpd.conf    #apache配置文件</span><br></pre></td></tr></table></figure>

<h1 id="3-安装PHP7"><a href="#3-安装PHP7" class="headerlink" title="3. 安装PHP7"></a>3. 安装PHP7</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/ </span><br><span class="line">wget http://cn2.php.net/distributions/php-7.1.6.tar.bz2</span><br><span class="line">tar zxf php-7.1.6.tar.bz2</span><br><span class="line">cd php-7.1.6</span><br><span class="line">./configure --prefix=/usr/local/php7 --with-apxs2=/usr/local/apache2.4/bin/apxs --with-config-file-path=/usr/local/php7/etc  --with-pdo-mysql=/usr/local/mysql --with-mysqli=/usr/local/mysql/bin/mysql_config --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-bz2 --with-openssl --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-mbstring --enable-sockets --enable-exif</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">ls /usr/local/apache2.4/modules/libphp7.so</span><br><span class="line">cp php.ini-production  /usr/local/php7/etc/php.ini</span><br></pre></td></tr></table></figure>

<h1 id="4-php中mysql-mysqli-mysqlnd-pdo到底是什么"><a href="#4-php中mysql-mysqli-mysqlnd-pdo到底是什么" class="headerlink" title="4. php中mysql,mysqli,mysqlnd,pdo到底是什么"></a>4. php中mysql,mysqli,mysqlnd,pdo到底是什么</h1><p><a href="http://blog.csdn.net/u013785951/article/details/60876816" target="_blank" rel="noopener">http://blog.csdn.net/u013785951/article/details/60876816</a></p>
<h1 id="5-查看编译参数"><a href="#5-查看编译参数" class="headerlink" title="5. 查看编译参数"></a>5. 查看编译参数</h1><p><a href="http://ask.apelearn.com/question/1295" target="_blank" rel="noopener">http://ask.apelearn.com/question/1295</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.14 - 11.17 LAMP架构-Apache和PHP结合、Apache默认虚拟主机/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.14 - 11.17 LAMP架构-Apache和PHP结合、Apache默认虚拟主机/" itemprop="url">11.14 - 11.17 LAMP架构-Apache和PHP结合、Apache默认虚拟主机</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="11-14-11-15-Apache和PHP结合"><a href="#11-14-11-15-Apache和PHP结合" class="headerlink" title="11.14/11.15 Apache和PHP结合"></a>11.14/11.15 Apache和PHP结合</h1><h2 id="1-配置Apache"><a href="#1-配置Apache" class="headerlink" title="1. 配置Apache"></a>1. 配置Apache</h2><p>Apache(httpd) 的主配置文件： /usr/local/apache2.4/conf/httpd.conf<br>需要修改以下4个地方</p>
<ul>
<li>ServerName localhost:80</li>
<li>Require all denied  修改为 Require all granted</li>
<li>AddType application/x-httpd-php .php</li>
<li>DirectoryIndex index.html index.php</li>
</ul>
<h3 id="1-1-选择要调用的PHP"><a href="#1-1-选择要调用的PHP" class="headerlink" title="1.1 选择要调用的PHP"></a>1.1 选择要调用的PHP</h3><p>因为本来安装了PHP5 和PHP7 两个版本的PHP，需要配置一下，一次只加载一个PHP模块（我们选择PHP5），而不是2个一起调用，否则，会出现错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line">LoadModule php5_module        modules/libphp5.so</span><br><span class="line">#LoadModule php7_module        modules/libphp7.so    #加上 “#” 注释掉php7，只加载PHP5 模块</span><br></pre></td></tr></table></figure>

<h3 id="1-2-物理机启用win7中telnet命令"><a href="#1-2-物理机启用win7中telnet命令" class="headerlink" title="1.2 物理机启用win7中telnet命令"></a>1.2 物理机启用win7中telnet命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">开始 --&gt; 控制面板 --&gt; 程序 --&gt; 打开或关闭Windows功能 --&gt; 选择telnet客户端 (注意不要勾选 telnet服务端)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置Apache"><a href="#1-3-配置Apache" class="headerlink" title="1.3 配置Apache"></a>1.3 配置Apache</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- 更改配置文件：将配置中 “Require all denied” 改为 “Require all granted”</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line">&lt;Directory /&gt;</span><br><span class="line">    AllowOverride none</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">- 检测配置是否存在语法错误：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line"></span><br><span class="line">- 重新加载服务：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line">注：该命令不会使服务重启，只是加载配置文件的内容。</span><br></pre></td></tr></table></figure>

<h3 id="1-4-添加监听80端口的规则"><a href="#1-4-添加监听80端口的规则" class="headerlink" title="1.4 添加监听80端口的规则"></a>1.4 添加监听80端口的规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>说明： 至此，物理机可以使用浏览器直接访问本地虚拟机IP了。</p>
<h3 id="1-5-添加PHP服务"><a href="#1-5-添加PHP服务" class="headerlink" title="1.5 添加PHP服务"></a>1.5 添加PHP服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- 授权PHP服务解析本机服务器：添加 “AddType application/x-httpd-php .php”</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line">    #</span><br><span class="line">    AddType application/x-compress .Z</span><br><span class="line">    AddType application/x-gzip .gz .tgz</span><br><span class="line">    AddType application/x-httpd-php .php  # 添加 “AddType application/x-httpd-php .php”</span><br><span class="line">    #</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">- 增加索引页：添加 “index.php” 变为 “DirectoryIndex index.html index.php”</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line">&lt;IfModule dir_module&gt;</span><br><span class="line">    DirectoryIndex index.html index.php   # 添加“index.php”</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">- 检测语法：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">- 重新加载</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br></pre></td></tr></table></figure>

<h3 id="1-6-检测服务器是否支持PHP解析"><a href="#1-6-检测服务器是否支持PHP解析" class="headerlink" title="1.6 检测服务器是否支持PHP解析"></a>1.6 检测服务器是否支持PHP解析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/htdocs/1.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();         #该参数的含义是PHP的信息</span><br><span class="line">?&gt;                   #该命令的含义是：在访问该地址时，直接打印PHP的相关信息</span><br><span class="line"></span><br><span class="line">- 在物理机浏览器输入 虚拟机ip+1.php ：192.168.2.130/1.php </span><br><span class="line">1. 返回下面结果，表示已经支持PHP解析</span><br><span class="line"></span><br><span class="line">2. 返回下面结果，表示还不支持PHP解析，需要查找原因</span><br><span class="line"></span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -M</span><br><span class="line">检查有没有加载 php5_module 模块,如果没找到</span><br><span class="line">ls /usr/local/apache2.4/modules/libphp5.so 看有没有这个文件</span><br><span class="line">如果有文件，检查配置文件</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">/libphp5.so      #看配置文件里有没有加载这个配置文件</span><br><span class="line">/Addtype         #检查是否有 AddType application/x-httpd-php .php 这一行（注意中间有个空格）</span><br><span class="line">/index.php       #检查是否有 DirectoryIndex index.html index.php</span><br></pre></td></tr></table></figure>

<h3 id="1-7-切换使用PHP7-0"><a href="#1-7-切换使用PHP7-0" class="headerlink" title="1.7 切换使用PHP7.0"></a>1.7 切换使用PHP7.0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line">#LoadModule php5_module        modules/libphp5.so</span><br><span class="line">LoadModule php7_module        modules/libphp7.so     # 注释掉5，去掉7前面的 #</span><br><span class="line"></span><br><span class="line">检测、加载：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host  ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br></pre></td></tr></table></figure>

<h1 id="11-16-11-17-Apache默认虚拟主机"><a href="#11-16-11-17-Apache默认虚拟主机" class="headerlink" title="11.16/11.17 Apache默认虚拟主机"></a>11.16/11.17 Apache默认虚拟主机</h1><p>一台服务器可以访问多个网站，每个网站都是一个虚拟主机<br>概念：域名（主机名）、DNS、解析域名、hosts<br>任何一个域名解析到这台机器，都可以访问的虚拟主机就是默认虚拟主机</p>
<h2 id="1-Windows的hosts文件"><a href="#1-Windows的hosts文件" class="headerlink" title="1. Windows的hosts文件"></a>1. Windows的hosts文件</h2><p>hosts文件路径：C:\Windows\System32\drivers\etc\hosts</p>
<p>在该文件中可添加DNS解析<br><code>192.168.2.130   www.abc.com   www.123.com</code><br>修改之后，当我们访问<a href="http://www.abc.com和www.123.com时就会解析到我们的Linux服务器（192.168.2.130），" target="_blank" rel="noopener">www.abc.com和www.123.com时就会解析到我们的Linux服务器（192.168.2.130），</a><br>访问该域名时会自动解析到本地默认虚拟主机“ServerName <a href="http://www.example.com:80”" target="_blank" rel="noopener">www.example.com:80”</a></p>
<h2 id="2-Linux的虚拟主机"><a href="#2-Linux的虚拟主机" class="headerlink" title="2. Linux的虚拟主机"></a>2. Linux的虚拟主机</h2><p>在物理机访问的域名“<a href="http://www.abc.com”并未在虚拟机Apache配置文件中定义，虚拟机中只定义了“ServerName" target="_blank" rel="noopener">www.abc.com”并未在虚拟机Apache配置文件中定义，虚拟机中只定义了“ServerName</a> <a href="http://www.example.com:80”一个域名，" target="_blank" rel="noopener">www.example.com:80”一个域名，</a><br>该域名即为Apache的默认主机，此时通过任何一个绑定该虚拟机IP的域名进行访问都会跳转到该主机。<br>因为一台服务器可以跑多个域名，为了方便管理，需要对虚拟主机配置文件进行配置：</p>
<h3 id="2-1-启用虚拟主机配置文件"><a href="#2-1-启用虚拟主机配置文件" class="headerlink" title="2.1  启用虚拟主机配置文件"></a>2.1  启用虚拟主机配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">……</span><br><span class="line"># Virtual hosts</span><br><span class="line">Include conf/extra/httpd-vhosts.conf    #去掉前面的#，就可以启用了</span><br><span class="line">……</span><br><span class="line">- 检测，加载</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line">注意： 重新加载配置文件后，之前定义的默认虚拟主机www.example.com:80将失效。</span><br></pre></td></tr></table></figure>

<h3 id="2-2-编辑虚拟主机配置文件，配置如下："><a href="#2-2-编辑虚拟主机配置文件，配置如下：" class="headerlink" title="2.2 编辑虚拟主机配置文件，配置如下："></a>2.2 编辑虚拟主机配置文件，配置如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">... ...    #每一个&lt;VirtualHost *:80&gt;代表一个虚拟主机，一个主机就是一个网站</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerAdmin zhouqunic@qq.com</span><br><span class="line">    DocumentRoot&quot;/data/wwwroot/abc.com&quot;          #指定网站根目录</span><br><span class="line">    ServerName abc.com                                        #定义网站域名</span><br><span class="line">    ServerAlias www.abc.com  www.123.com         #设置别名（可设置多个）</span><br><span class="line">    ErrorLog &quot;logs/abc.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/abc.com-error_log&quot; common  #指定错误日志和访问日志文件</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot&quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/111.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-添加虚拟主机相应目录"><a href="#2-3-添加虚拟主机相应目录" class="headerlink" title="2.3 添加虚拟主机相应目录"></a>2.3 添加虚拟主机相应目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mkdir /data/wwwroot/</span><br><span class="line">[root@host ~]# mkdir /data/wwwroot/abc.com</span><br><span class="line">[root@host ~]# mkdir /data/wwwroot/111.com</span><br></pre></td></tr></table></figure>

<h2 id="3-添加测试文件"><a href="#3-添加测试文件" class="headerlink" title="3. 添加测试文件"></a>3. 添加测试文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- 在相应目录创建PHP文件</span><br><span class="line">[root@host ~]# vim /data/wwwroot/abc.com/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">echo &quot;welcome to  aaa.com&quot;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[root@host ~]# vim /data/wwwroot/111.com/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">echo &quot;welcome to  111.com&quot;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">- 检测、重加载Apache配置文件</span><br><span class="line">[root@host~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br></pre></td></tr></table></figure>

<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h2><p>在此使用物理机的浏览器和虚拟机的curl命令分别进行测试</p>
<ul>
<li><p>虚拟机上测试<br>如果不在虚拟机中进行本地域名配置（hosts），在进行ping命令测试虚拟主机域名时会访问到外网。<br>如果想在访问“abc.com”时指向到本地虚拟机IP，可以在/etc/hosts文件中指定域名，或者使用curl命令进行访问，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl  -x 192.168.2.130:80  abc.com</span><br><span class="line">welcome to  aaa.com</span><br><span class="line">[root@host ~]# curl  -x 192.168.2.130:80  111.com</span><br><span class="line">welcome to  111.com</span><br><span class="line">[root@host ~]# curl  -x 192.168.2.130:80  123.com</span><br><span class="line">welcome to  aaa.com</span><br><span class="line">[root@host ~]# curl  -x 192.168.2.130:80 www.example.com</span><br><span class="line">welcome to  111.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用物理机浏览器访问<br>使用浏览器访问，可以直接输入 192.168.2.130，或者修改hosts： 192.168.2.130  abc.com  111.com  abcde.com   <a href="http://www.example.com，然后输入" target="_blank" rel="noopener">www.example.com，然后输入</a> 域名访问。<br>如果不改hosts文件的话，输入域名，会默认使用DNS解析到外网网址去。</p>
</li>
</ul>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="apache所有的主机都指向第一个虚拟主机"><a href="#apache所有的主机都指向第一个虚拟主机" class="headerlink" title="apache所有的主机都指向第一个虚拟主机"></a>apache所有的主机都指向第一个虚拟主机</h2><p><a href="http://www.aminglinux.com/bbs/thread-491-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-491-1-1.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.25 - 11.27 LAMP架构-apache配置防盗链，访问控制Directory，访问控制FilesMatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.25 - 11.27 LAMP架构-apache配置防盗链，访问控制Directory，访问控制FilesMatch/" itemprop="url">11.25 - 11.27 LAMP架构-apache配置防盗链，访问控制Directory，访问控制FilesMatch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#11.25 配置防盗链</p>
<p>编辑虚拟主机配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf </span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/123.com&quot;</span><br><span class="line">    ServerName 123.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    &lt;Directory /data/wwwroot/123.com&gt;</span><br><span class="line">        SetEnvIfNoCase Referer &quot;http://123.com&quot; local_ref</span><br><span class="line">        SetEnvIfNoCase Referer &quot;http://ask.apelearn.com&quot; local_ref</span><br><span class="line">        SetEnvIfNoCase Referer &quot;^$&quot; local_ref  #定义referer白名单</span><br><span class="line">        &lt;FilesMatch &quot;\.(txt|doc|mp3|zip|rar|jpg|gif|png)&quot;&gt;</span><br><span class="line">            Order Allow,Deny</span><br><span class="line">            Allow from env=local_ref  #定义规则：允许变量local_ref指定的referer访问，拒绝其他所有访问。  </span><br><span class="line">        &lt;/FilesMatch&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    ErrorLog &quot;logs/123.com-error_log&quot;</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.gif$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.jpg$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.png$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.bmp$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.swf$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.js$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.css$&quot; img</span><br><span class="line">    CustomLog &quot;|/usr/local/apache2.4/bin/rotatelogs -l logs/123.com-access_%Y%m%d.log 86400&quot; combined env=!img</span><br><span class="line">    #CustomLog &quot;logs/123.com-access_log&quot; combined env=!img</span><br><span class="line">&lt;/VirtualHost&gt;  </span><br><span class="line"></span><br><span class="line">检测语法错误并重加载：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line">注： 如果在referer白名单中不加“^$”（空值），那么直接访问指定内容将会被拒绝。</span><br><span class="line"></span><br><span class="line">curl命令</span><br><span class="line"></span><br><span class="line">curl -e 指定referer</span><br><span class="line"></span><br><span class="line">[root@host ~]# curl -e &quot;http://www.aminglinux.com/123.html&quot; -x192.168.2.130:80 123.com/baidu.png -I</span><br></pre></td></tr></table></figure>

<h1 id="11-26-访问控制Directory"><a href="#11-26-访问控制Directory" class="headerlink" title="11.26 访问控制Directory"></a>11.26 访问控制Directory</h1><p>编辑虚拟主机配置文件：</p>
<p>在配置文件加入如下参数：这是用于设定指定IP访问指定目录的权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host admin]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">......</span><br><span class="line">    &lt;Directory /data/wwwroot/123.com/admin/&gt;</span><br><span class="line">        Order deny,allow</span><br><span class="line">        Deny from all</span><br><span class="line">        Allow from 127.0.0.1</span><br><span class="line">        #只允许IP--127.0.0.1访问“/data/wwwroot/123.com/admin/”目录中的内容</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">[root@host admin]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host admin]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line">[root@host admin]# curl -x127.0.0.1:80 123.com/admin/index.php</span><br><span class="line">121212</span><br><span class="line"></span><br><span class="line">更换IP访问：</span><br><span class="line">[root@host admin]# curl -x192.168.2.130:80 123.com/admin/index.php -I</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Fri, 25 Aug 2017 23:55:38 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1  #因为只有指定IP：127.0.0.1可以访问该目录，所以才会报错：403</span><br></pre></td></tr></table></figure>

<p>#11.27 访问控制FilesMatch</p>
<p>使用FilesMatch参数：  这里是应用于对某些请求设定权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@host admin]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">......</span><br><span class="line">    &lt;Directory /data/wwwroot/123.com&gt;</span><br><span class="line">        &lt;FilesMatch admin.php(.*)&gt;</span><br><span class="line">        Order deny,allow</span><br><span class="line">        Deny from all</span><br><span class="line">        Allow from 127.0.0.1</span><br><span class="line">        &lt;/FilesMatch&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">[root@host admin]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host admin]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@host admin]# curl -x127.0.0.1:80 123.com/admin.php -I</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Fri, 25 Aug 2017 23:43:14 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1    #访问的文件不存在，所以才会报错：404</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<p>##几种限制ip的方法<br><a href="http://www.lishiming.net/thread-6519-1-1.html" target="_blank" rel="noopener">http://www.lishiming.net/thread-6519-1-1.html</a></p>
<p>##apache 自定义header<br><a href="http://www.aminglinux.com/bbs/thread-830-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-830-1-1.html</a></p>
<p>##apache的keepalive和keepalivetimeout<br><a href="http://www.aminglinux.com/bbs/thread-556-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-556-1-1.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.32 LAMP架构-php扩展模块安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.32 LAMP架构-php扩展模块安装/" itemprop="url">11.32 LAMP架构-php扩展模块安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#11.32 php扩展模块安装</p>
<p>有时候，编译好PHP后，发现还有其他模块需要添加进去，那么就需要安装php扩展模块安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php/bin/php -m //查看模块</span><br></pre></td></tr></table></figure>

<p>下面安装一个redis的模块，当做php中的缓存来用</p>
<h2 id="1-下载redis的安装包到src目录"><a href="#1-下载redis的安装包到src目录" class="headerlink" title="1. 下载redis的安装包到src目录"></a>1. 下载redis的安装包到src目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget https://codeload.github.com/phpredis/phpredis/zip/develop</span><br></pre></td></tr></table></figure>

<h2 id="2-把包改名字并解压"><a href="#2-把包改名字并解压" class="headerlink" title="2. 把包改名字并解压"></a>2. 把包改名字并解压</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv develop phpredis-develop.zip</span><br><span class="line">unzip phpredis-develop.zip</span><br></pre></td></tr></table></figure>

<h2 id="3-编译并安装"><a href="#3-编译并安装" class="headerlink" title="3. 编译并安装"></a>3. 编译并安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd phpredis-develop</span><br><span class="line">/usr/local/php/bin/phpize      //为了生成configure文件 </span><br><span class="line">./configure --with-php-config=/usr/local/php/bin/php-config</span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="4-加载redis模块"><a href="#4-加载redis模块" class="headerlink" title="4. 加载redis模块"></a>4. 加载redis模块</h2><p>现在php还是不支持redis的，需要编辑php的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php/bin/php -i |grep extension_dir     //查看扩展模块存放目录，我们可以在php.ini中去自定义该路径 </span><br><span class="line">vim /usr/local/php/etc/php.ini              //增加一行配置（可以放到文件最后一行）</span><br><span class="line">extension = redis.so  //添加进去</span><br></pre></td></tr></table></figure>

<h3 id="5-关于扩展模块"><a href="#5-关于扩展模块" class="headerlink" title="5. 关于扩展模块"></a>5. 关于扩展模块</h3><p>除了像redis这种第三方模块，在php的源码包里的ext目录下，有很多这种本地已经存在的模块，我们可以直接编译安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/php-7.1.6/ext</span><br><span class="line">ls</span><br><span class="line">cd zip/</span><br><span class="line">ls</span><br><span class="line">cd /usr/local/src/phpize</span><br><span class="line">./configure --with-php-config=/usr/local/php/bin/php-config</span><br><span class="line">make </span><br><span class="line">make install</span><br><span class="line">vim /usr/local/php/etc/php.ini              //增加一行配置（可以放到文件最后一行）</span><br><span class="line">extension = zip.so  //添加进去</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<h2 id="apache-rewrite教程"><a href="#apache-rewrite教程" class="headerlink" title="apache rewrite教程"></a>apache rewrite教程</h2><p><a href="http://coffeelet.blog.163.com/blog/static/13515745320115842755199/" target="_blank" rel="noopener">http://coffeelet.blog.163.com/blog/static/13515745320115842755199/</a>  <a href="http://www.cnblogs.com/top5/archive/2009/08/12/1544098.html" target="_blank" rel="noopener">http://www.cnblogs.com/top5/archive/2009/08/12/1544098.html</a></p>
<h2 id="apache-rewrite-出现死循环"><a href="#apache-rewrite-出现死循环" class="headerlink" title="apache rewrite 出现死循环"></a>apache rewrite 出现死循环</h2><p><a href="http://ask.apelearn.com/question/1043" target="_blank" rel="noopener">http://ask.apelearn.com/question/1043</a></p>
<h2 id="php错误日志级别参考"><a href="#php错误日志级别参考" class="headerlink" title="php错误日志级别参考"></a>php错误日志级别参考</h2><p><a href="http://ask.apelearn.com/question/6973" target="_blank" rel="noopener">http://ask.apelearn.com/question/6973</a></p>
<h2 id="php开启短标签"><a href="#php开启短标签" class="headerlink" title="php开启短标签"></a>php开启短标签</h2><p><a href="http://ask.apelearn.com/question/120" target="_blank" rel="noopener">http://ask.apelearn.com/question/120</a></p>
<h2 id="php-ini详解"><a href="#php-ini详解" class="headerlink" title="php.ini详解"></a>php.ini详解</h2><p><a href="http://legolas.blog.51cto.com/2682485/493917" target="_blank" rel="noopener">http://legolas.blog.51cto.com/2682485/493917</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.28 - 11.30 LAMP架构-apache限定某个目录禁止解析php、限制user_agent、php相关配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.28 - 11.30 LAMP架构-apache限定某个目录禁止解析php、限制user_agent、php相关配置/" itemprop="url">11.28 - 11.30 LAMP架构-apache限定某个目录禁止解析php、限制user_agent、php相关配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#11.28 限定某个目录禁止解析php</p>
<p>如果有一个目录是允许上传图片的，保不准有些人通过手段上传了php文件，那么就有可能被运行，造成安全隐患，被拿到root权限。</p>
<h2 id="1-编辑虚拟主机配置文件"><a href="#1-编辑虚拟主机配置文件" class="headerlink" title="1. 编辑虚拟主机配置文件"></a>1. 编辑虚拟主机配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host 111.com]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf </span><br><span class="line">    &lt;Directory /data/wwwroot/111.com/upload&gt;</span><br><span class="line">        php_admin_flag engine off</span><br><span class="line">    &lt;/Directory&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-创建相应的目录"><a href="#2-创建相应的目录" class="headerlink" title="2. 创建相应的目录"></a>2. 创建相应的目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host 111.com]# mkdir upload</span><br><span class="line">……</span><br><span class="line">[root@host 111.com]# ls upload/</span><br><span class="line">123.php  qq.png</span><br></pre></td></tr></table></figure>

<h2 id="3-测试"><a href="#3-测试" class="headerlink" title="3. 测试"></a>3. 测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host 111.com]# curl -x127.0.0.1:80 111.com/upload/123.php -I</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Mon, 04 Sep 2017 22:31:52 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1</span><br></pre></td></tr></table></figure>

<p>#11.29 限制user_agent</p>
<blockquote>
<p>User Agent中文名为用户代理，简称 UA，它是一个特殊字符串头，使得服务器能够识别客户使用的操作系统及版本、CPU 类型、浏览器及版本、浏览器渲染引擎、浏览器语言、浏览器插件等。user_agent可以理解为浏览器标识。</p>
</blockquote>
<p>CC攻击（Challenge Collapsar）是DDOS（分布式拒绝服务）的一种，攻击者通过代理服务器或者肉鸡向向受害主机不停地发大量数据包，造成对方服务器资源耗尽，一直到宕机崩溃，我们可以通过限制攻击者useragent的方法来阻断其攻击（这只是初级的防御方法）。</p>
<p>核心配置文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">      RewriteEngine on</span><br><span class="line">      RewriteCond %&#123;HTTP_USER_AGENT&#125;  .*curl.* [NC,OR]</span><br><span class="line">      RewriteCond %&#123;HTTP_USER_AGENT&#125;  .*baidu.com.* [NC]</span><br><span class="line">      RewriteRule  .*  -  [F]</span><br><span class="line">  &lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>

<p>curl -A “123123” 指定user_agent</p>
<p>#11.30/11.31 php相关配置</p>
<h2 id="查看php配置文件位置"><a href="#查看php配置文件位置" class="headerlink" title="查看php配置文件位置"></a>查看php配置文件位置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/php/bin/php -i | grep -i &quot;loaded configuration file&quot;</span><br></pre></td></tr></table></figure>

<h2 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">date.timezone=Asia/Shanghai     #设定时区,设定到上海或者重庆都可以</span><br><span class="line"></span><br><span class="line">disable_functions  # 限制安全函数</span><br><span class="line">disable_functions=eval,assert,popen,passthru,escapeshellarg,escapeshellcmd,passthru,exec,system,chroot,scandir,chgrp,chown,escapeshellcmd,escapeshellarg,shell_exec,proc_get_status,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,readlink,symlink,leak,popepassthru,stream_socket_server,popen,proc_open,proc_close #某些生产环境有时会禁掉phpinfo</span><br><span class="line">eval,assert,popen,passthru,escapeshellarg,escapeshellcmd,passthru,exec,system,chroot,scandir,chgrp,chown,escapeshellcmd,escapeshellarg,shell_exec,proc_get_status,ini_alter,ini_restore,dl,pfsockopen,openlog,syslog,readlink,symlink,leak,popepassthru,stream_socket_server,popen,proc_open,proc_close  #这些都是比较危险的函数，这样设置 </span><br><span class="line"></span><br><span class="line">error_log, log_errors, display_errors, error_reporting   # 日志相关</span><br><span class="line">display_errors=On/Off   #设定是否显示错误原因，一般关掉，防止用户看到。但是配置Off后，必须设置错误日志的的路径和错误日志的级别，否则后面无法查找出错的原因。</span><br><span class="line">log_errors=On/Off 开启/关闭错误日志</span><br><span class="line">error_log=/tmp/php_errors.log   #设定错误日志的保存路径。如果定义好路径后无法生产日志，此时需要检查日志文件所在目录是否有写（w）权限</span><br><span class="line">error_reporting = E_ ALL &amp; ~E_ NOTICE                        #设定错误日志级别，级别有：E_ ALL 、~E_ NOTICE 、~E_ STRICT 、~E_DEPRECATED（可以自由组合）。生产环境使用：E_ ALL &amp; ~E_ NOTICE就可以。</span><br><span class="line"></span><br><span class="line">open_basedir =  /data/wwwroot/111.com:/tmp/  #安全参数选项，设置了open_basedir选项，将会把所有关于文件的操作限制在指定目录及其子目录</span><br><span class="line"># 一台服务器运行着不止一台虚拟主机，所以在该文件下设置该选项并不合适。那么，该如何设定该配置呢？</span><br><span class="line"></span><br><span class="line">答案是分别在每个虚拟主机的配置文件进行相关设置</span><br><span class="line">php_admin_value open_basedir &quot;/data/wwwroot/111.com:/tmp/&quot;  # “php_admin_value”可以定义php.ini中的参数。分别在每个虚拟主机设定相关的“open_basedir”即可。</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<p>##apache开启压缩<br><a href="http://www.aminglinux.com/bbs/thread-5528-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-5528-1-1.html</a></p>
<p>##apache2.2到2.4配置文件变更<br><a href="http://www.aminglinux.com/bbs/thread-7292-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-7292-1-1.html</a></p>
<p>##apache options参数<br><a href="http://www.aminglinux.com/bbs/thread-1051-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-1051-1-1.html</a></p>
<p>##apache禁止trace或track防止xss<br><a href="http://www.aminglinux.com/bbs/thread-1045-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-1045-1-1.html</a></p>
<p>##apache 配置https 支持ssl<br><a href="http://www.aminglinux.com/bbs/thread-1029-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-1029-1-1.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/12.10 - 12.12 Nginx访问日志、Nginx日志切割、静态文件不记录日志和过期时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/12.10 - 12.12 Nginx访问日志、Nginx日志切割、静态文件不记录日志和过期时间/" itemprop="url">12.10 - 12.12 Nginx访问日志、Nginx日志切割、静态文件不记录日志和过期时间</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#12.10 Nginx访问日志</p>
<p>##日志格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/nginx/conf/nginx.conf   //搜索log_format</span><br><span class="line">... ...</span><br><span class="line">log_format combined_realip &apos;$remote_addr $http_x_forwarded_for [$time_local]&apos;</span><br><span class="line">    &apos; $host &quot;$request_uri&quot; $status&apos;</span><br><span class="line">    &apos; &quot;$http_referer&quot; &quot;$http_user_agent&quot;&apos;;</span><br><span class="line">#combined_realip是日志名称 </span><br><span class="line"># 后面带引号和$的是日志内容</span><br></pre></td></tr></table></figure>

<p>##日志格式参数注释</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>客户端IP（公网IP）</td>
</tr>
<tr>
<td>$http_x_forwarded_for</td>
<td>代理服务器的IP</td>
</tr>
<tr>
<td>$time_local</td>
<td>服务器本地时间</td>
</tr>
<tr>
<td>$host</td>
<td>访问主机名（域名）</td>
</tr>
<tr>
<td>$request_uri</td>
<td>访问的URL地址</td>
</tr>
<tr>
<td>$status</td>
<td>状态码</td>
</tr>
<tr>
<td>$http_referer</td>
<td>referer</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>user_agent</td>
</tr>
</tbody></table>
<p>##定义虚拟主机日志格式（一定要先定义nginx.conf中的日志格式，才能在这里调用和再定义）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/nginx/conf/vhost/</span><br><span class="line">[root@host vhost]# ls</span><br><span class="line">aaa.com.conf  test.com.conf</span><br><span class="line"></span><br><span class="line">[root@host vhost]# vim aaa.com.conf     //定义aaa.com.conf日志格式 </span><br><span class="line">……</span><br><span class="line">access_log /tmp/aaa.com.log combined_realip;</span><br><span class="line">#指定日志位置和格式</span><br><span class="line"></span><br><span class="line">检查错误：</span><br><span class="line">[root@host vhost]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<p>##检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# curl -x127.0.0.1:80 aaacom </span><br><span class="line">This is aaa.com</span><br><span class="line">[root@host vhost]# cat /tmp/aaa.com.log </span><br><span class="line">127.0.0.1 - [8/Sep/2017:22:39:68 +0800] aaa.com &quot;/&quot; 200 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br></pre></td></tr></table></figure>

<p>#12.11 Nginx日志切割<br>因为Nginx没有自带的日志切割工具，所以需要借助系统日志切割命令或自己编写日志切割脚本。</p>
<h2 id="日志切割脚本"><a href="#日志切割脚本" class="headerlink" title="日志切割脚本"></a>日志切割脚本</h2><p>以后把所有哦的shell脚本统一保存位置：/usr/local/sbin/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim /usr/local/sbin/nginx_log_rotate.sh</span><br><span class="line"></span><br><span class="line">#! /bin/bash</span><br><span class="line">d=`date -d &quot;-1 day&quot; +%Y%m%d` </span><br><span class="line">#定义切割时间（切割一天前的日志）</span><br><span class="line">logdir=&quot;/tmp/&quot;</span><br><span class="line">#此处指定要切割的日志路径（该路径来自虚拟主机配置文件）</span><br><span class="line">nginx_pid=&quot;/usr/local/nginx/logs/nginx.pid&quot;</span><br><span class="line">#调用pid的目的是为了执行命令：/bin/kill -HUP `cat $nginx_pid`</span><br><span class="line">#该命令相当于命令：nginx -s reload（重新加载文件），确保与虚拟主机配置文件变更保持同步</span><br><span class="line">#该地址来自nginx配置文件</span><br><span class="line">cd $logdir</span><br><span class="line">for log in `ls *.log`</span><br><span class="line">do</span><br><span class="line">    mv $log $log-$d</span><br><span class="line">done</span><br><span class="line">#这里使用通配进行循环，对所有符合条件的日志文件进行切割</span><br><span class="line">/bin/kill -HUP `cat $nginx_pid`</span><br><span class="line">#执行此命令进行重新加载生成新的日志文件来记录新的日志</span><br></pre></td></tr></table></figure>

<h2 id="执行该脚本"><a href="#执行该脚本" class="headerlink" title="执行该脚本"></a>执行该脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# sh -x /usr/local/sbin/nginx_log_rotate.sh</span><br><span class="line">++ date -d &apos;-1 day&apos; +%Y%m%d</span><br><span class="line">+ d=20170909</span><br><span class="line">+ logdir=/tmp/</span><br><span class="line">+ nginx_pid=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">+ cd /tmp/</span><br><span class="line">++ ls test.com.log yum.log</span><br><span class="line">+ for log in &apos;`ls *.log`&apos;</span><br><span class="line">+ mv test.com.log test.com.log-20170909</span><br><span class="line">+ for log in &apos;`ls *.log`&apos;</span><br><span class="line">+ mv yum.log yum.log-20170909</span><br><span class="line">++ cat /usr/local/nginx/logs/nginx.pid</span><br><span class="line">+ /bin/kill -HUP 59154</span><br></pre></td></tr></table></figure>

<h2 id="添加到系统任务计划"><a href="#添加到系统任务计划" class="headerlink" title="添加到系统任务计划"></a>添加到系统任务计划</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim /etc/crontab</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"># For details see man 4 crontabs</span><br><span class="line"># Example of job definition:</span><br><span class="line"># .---------------- minute (0 - 59)</span><br><span class="line"># | .------------- hour (0 - 23)</span><br><span class="line"># | | .---------- day of month (1 - 31)</span><br><span class="line"># | | | .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"># | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="line"># | | | | |</span><br><span class="line"># * * * * * user-name command to be executed</span><br><span class="line"></span><br><span class="line">0 3 * * * /bin/bash/ /usr/local/sbin/nginx_log_rotate.sh</span><br><span class="line">#每天凌晨3点切割一次前一天日志</span><br><span class="line"></span><br><span class="line">[root@host vhost]# chmod +x /usr/local/sbin/nginx_log_rotate.sh  //加上可执行权限</span><br></pre></td></tr></table></figure>

<p>#12.12 静态文件不记录日志和过期时间</p>
<p>##核心配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim test.com.conf</span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">    #匹配文件类型</span><br><span class="line">    &#123;</span><br><span class="line">          expires      7d;</span><br><span class="line">          #过期时间为7天</span><br><span class="line">          access_log off;</span><br><span class="line">          #不记录该类型文件的访问日志</span><br><span class="line">    &#125;</span><br><span class="line">location ~ .*\.(js|css)$</span><br><span class="line">    &#123;</span><br><span class="line">          expires      12h;</span><br><span class="line">          #过期时间为12小时</span><br><span class="line">          access_log off;</span><br><span class="line">          #不记录该类型文件的访问日志</span><br><span class="line">    &#125;</span><br><span class="line">    access_log /tmp/test.com.log combined_realip;</span><br><span class="line">    #指定日志位置及格式</span><br></pre></td></tr></table></figure>

<p>##检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@host vhost]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line">访问index.html文件</span><br><span class="line">[root@host vhost]# !curl</span><br><span class="line">curl -x127.0.0.1:80 test.com</span><br><span class="line">This is test.com</span><br><span class="line"></span><br><span class="line">[root@host vhost]# !cat</span><br><span class="line">cat /tmp/test.com.log </span><br><span class="line">127.0.0.1 - [9/Sep/2017:00:12:26 +0800] test.com &quot;/&quot; 200 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">#有日志</span><br><span class="line"></span><br><span class="line">访问baidu.png文件</span><br><span class="line">[root@host test.com]# curl -x127.0.0.1:80 test.com/baidu.png -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.12.1</span><br><span class="line">Date: Sat, 9 Aug 2017 09:47:57 GMT</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Content-Length: 3706</span><br><span class="line">Last-Modified: Sat, 09 Sep 2017 01:13:35 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59805459-e7a&quot;</span><br><span class="line">Expires: Sat, 09 Sep 2017 00:47:46 GMT</span><br><span class="line">Cache-Control: max-age=604800</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">#max-age=604800s=7天，即该文件缓存的过期时间为7天！</span><br><span class="line"></span><br><span class="line">[root@host test.com]# cat /tmp/test.com.log </span><br><span class="line">127.0.0.1 - [9/Sep/2017:00:13:39+0800] test.com &quot;/&quot; 200 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br><span class="line">#无该文件的访问日志！！！</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/12.21 - 12.24 php-fpm的pool、php-fpm慢执行日志、open_basedir、php-fpm进程管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/12.21 - 12.24 php-fpm的pool、php-fpm慢执行日志、open_basedir、php-fpm进程管理/" itemprop="url">12.21 - 12.24 php-fpm的pool、php-fpm慢执行日志、open_basedir、php-fpm进程管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#12.21 php-fpm的pool</p>
<p>为了避免因多站点使用同一个pool时，因为一个站点故障导致pool出问题，进而影响使用同一个pool的其他站点的正常运行，我们有必要对每一个站点设置一个单独的pool。</p>
<p>##为php-fpm配置多个pool</p>
<p>###编辑php-fpm配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@host etc]# vim /usr/local/php-fpm/etc/php-fpm.conf  </span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">listen = /tmp/php-fcgi.sock</span><br><span class="line">#listen = 127.0.0.1:9000</span><br><span class="line">listen.mode = 666</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">rlimit_files = 1024</span><br><span class="line">……</span><br><span class="line">[zhouqun.com]      //添加新的pool</span><br><span class="line">listen = /tmp/zhouqun.sock</span><br><span class="line">listen.mode = 666</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">rlimit_files = 1024</span><br></pre></td></tr></table></figure>

<p>###语法检测：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host etc]# /usr/local/php-fpm/sbin/php-fpm -t</span><br><span class="line">[12-Sep-2017 23:26:57] NOTICE: configuration file /usr/local/php-fpm/etc/php-fpm.conf test is successful</span><br></pre></td></tr></table></figure>

<p>###重新加载配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host etc]# /etc/init.d/php-fpm reload</span><br><span class="line">Reload service php-fpm  done</span><br></pre></td></tr></table></figure>

<p>###查看进程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host etc]# ps aux |grep php-fpm</span><br><span class="line"></span><br><span class="line">php-fpm  6222  0.0  0.4 226640  4716 ?        S    16:10  0:00 php-fpm: pool www</span><br><span class="line">php-fpm  6223  0.0  0.4 226640  4712 ?        S    16:10  0:00 php-fpm: pool zhouqun.com</span><br></pre></td></tr></table></figure>

<p>###为站点设置pool</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim /usr/local/nginx/conf/vhost/aaa.com.conf</span><br><span class="line"></span><br><span class="line">location ~ \.php$</span><br><span class="line">    &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_pass unix:/tmp/zhouqun.sock;    //把fastcgi_pass地址改为和php-fpm.conf中一样的地址就可以</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /data/wwwroot/default$fastcgi_script_name;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>###添加php-fpm.conf子配置文件</p>
<p>为了便于管理，可以将php-fpm中的每个pool单独进行管理。进行如下操作，添加php-fpm子配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim /usr/local/php-fpm/etc/php-fpm.conf</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">pid = /usr/local/php-fpm/var/run/php-fpm.pid</span><br><span class="line">error_log = /usr/local/php-fpm/var/log/php-fpm.log</span><br><span class="line">include = etc/php-fpm.d/*.conf   //添加</span><br><span class="line">#在全局变量版块添加参数“include = etc/php-fpm.d/*.conf”。然后可以清除php-fpm配置文件中其他参数，再到php-fpm.d目录下进行单独设置。</span><br></pre></td></tr></table></figure>

<p>###创建指定目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# cd /usr/local/php-fpm/etc/</span><br><span class="line">[root@host etc]# mkdir php-fpm.d</span><br><span class="line"></span><br><span class="line">[root@host etc]# cd php-fpm.d/</span><br></pre></td></tr></table></figure>

<p>###创建php-fpm子配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# vim www.conf</span><br><span class="line">[www]</span><br><span class="line">listen = /tmp/php-fcgi.sock</span><br><span class="line">listen.mode = 666</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">rlimit_files = 1024</span><br><span class="line"></span><br><span class="line">[root@host php-fpm.d]# vim zhouqun.conf</span><br><span class="line">[zhouqun.com]</span><br><span class="line">listen = /tmp/zhouqun.sock</span><br><span class="line">listen.mode = 666</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">rlimit_files = 1024</span><br></pre></td></tr></table></figure>

<p>###检查语法错误并重启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# /usr/local/php-fpm/sbin/php-fpm -t</span><br><span class="line">[16-Aug-2017 16:49:17] NOTICE: configuration file /usr/local/php-fpm/etc/php-fpm.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@host php-fpm.d]# /etc/init.d/php-fpm reload</span><br><span class="line">Reload service php-fpm  done</span><br></pre></td></tr></table></figure>

<p>查看php-fpm进程信息还是使用ps命令。</p>
<p>#12.22 php-fpm慢执行日志</p>
<p>php网站莫名的访问很慢，可以通过慢执行日志找到症结所在，所以满日志非常重要，php网站强烈推荐使用LNMP架构搭建。</p>
<p>##开启慢执行日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# vim /usr/local/php-fpm/etc/php-fpm.d/www.conf</span><br><span class="line">……</span><br><span class="line">request_slowlog_timeout = 1                //当请求超过1秒开始记录日志</span><br><span class="line">slowlog = /usr/local/php-fpm/var/log/www-slow.log           //日志存放地址</span><br><span class="line">检测并重加载</span><br><span class="line">[root@host php-fpm.d]# /usr/local/php-fpm/sbin/php-fpm -t</span><br><span class="line">[root@host php-fpm.d]# /etc/init.d/php-fpm reload</span><br></pre></td></tr></table></figure>

<p>##试验</p>
<p>在使用www pool的站点添加文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# vim /data/wwwroot/test.com/sleep.php   //创建一个.php文件，故意让它休眠2秒，让它运行缓慢</span><br><span class="line">&lt;?php</span><br><span class="line">echo &quot;test slow log&quot;;</span><br><span class="line">sleep(2);     </span><br><span class="line">echo &quot;done&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>##检测：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# curl -x127.0.0.1:80 test.com/sleep.php </span><br><span class="line">test slow log done</span><br></pre></td></tr></table></figure>

<p>##查看慢日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# tail /usr/local/php-fpm/var/log/www-slow.log </span><br><span class="line"></span><br><span class="line">[12-Sep-2017 23:42:23]  [pool www] pid 4236</span><br><span class="line">script_filename = /data/wwwroot/test.com/sleep.php</span><br><span class="line">[0x00007fe027r0e2f5] sleep() /data/wwwroot/test.com/sleep.php:3      //显示文件的第三行导致的访问慢，因为第三行就是sleep命令</span><br></pre></td></tr></table></figure>

<p>#12.23 php-fpm定义open_basedir</p>
<p>在php-fpm服务中，当一台服务器跑多个网站时，用open_basedir限定各个站点所能访问的服务器上的目录的范围，可以针对每个pool设定open _ basedir。</p>
<p>##核心配置参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/php-fpm/etc/php-fpm.d/www.conf  </span><br><span class="line">……</span><br><span class="line">php_admin_value[open_basedir]=/data/wwwroot/test.com:/tmp/     //修改</span><br></pre></td></tr></table></figure>

<p>##创建测试PHP脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# vim /data/wwwroot/test.com/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">echo &quot;This is a test php of open_basedir&quot;;</span><br></pre></td></tr></table></figure>

<p>##测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# curl -x127.0.0.1:80 test.com/1.php</span><br><span class="line">This is a test php of open_basedir</span><br></pre></td></tr></table></figure>

<p>#12.24 php-fpm进程管理</p>
<p>php-fpm中pool配置参数解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-fpm.d]# vim www.conf</span><br><span class="line">[www]</span><br><span class="line">listen = /tmp/php-fcgi.sock</span><br><span class="line">listen.mode = 666</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">pm = dynamic</span><br><span class="line">#设置进程启动方式（dynamic表示动态，static表示静态）</span><br><span class="line">#只有此处设置为dynamic，下面的配置才生效</span><br><span class="line">pm.max_children = 50   //最多可启动的子进程数量</span><br><span class="line">pm.start_servers = 20    //设定初始启动的进程数量</span><br><span class="line">pm.min_spare_servers = 5      //表示php-fpm空闲时最少要有几个子进程</span><br><span class="line">pm.max_spare_servers = 35   //表示php-fpm空闲时最多要有几个子进程</span><br><span class="line">pm.max_requests = 500          //表示一个子进程最多可接受多少个请求</span><br><span class="line">rlimit_files = 1024                     //表示每个子进程打开的多少个文件句柄</span><br><span class="line">request_slowlog_timeout = 1    //当请求超过1秒开始记录日志</span><br><span class="line">slowlog = /usr/local/php-fpm/var/log/www-slow.log      //日志存放地址</span><br><span class="line">php_admin_value[open_basedir]=/data/wwwroot/test.com:/tmp/</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/12.13 - 12.16 Nginx的防盗链、访问控制、解析php相关配置、代理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/12.13 - 12.16 Nginx的防盗链、访问控制、解析php相关配置、代理/" itemprop="url">12.13 - 12.16 Nginx的防盗链、访问控制、解析php相关配置、代理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#12.13 Nginx防盗链<br>Nginx防盗链可结合日志管理一起配置，因为该配置也要使用location板块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/nginx/conf/vhost/test.com.conf</span><br><span class="line">……</span><br><span class="line">location ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip|doc|pdf|gz|bz2|jpeg|bmp|xls)$</span><br><span class="line">&#123;</span><br><span class="line">    expires 7d;</span><br><span class="line">    valid_referers none blocked server_names  *.test.com ;</span><br><span class="line">    #定义referer白名单</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 403;</span><br><span class="line">    #if函数的意思是：如果不是白名单内的域名，返回值：403</span><br><span class="line">    &#125;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line">检查</span><br><span class="line">[root@host ~]# curl -e &quot;http://www.baidu.com/1.txt&quot; -x127.0.0.1:80 -I test.com/baidu.png</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Server: nginx/1.12.1</span><br><span class="line">Date: Mon, 11 Sep 2017 11:25:47 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 169</span><br><span class="line">Connection: keep-alive</span><br><span class="line">访问被拒绝，防盗链生效</span><br></pre></td></tr></table></figure>

<p>#12.14 Nginx访问控制</p>
<p>只允许几个指定IP通过访问/admin/目录的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/nginx/conf/vhost/test.com.conf </span><br><span class="line">……</span><br><span class="line">location /admin/</span><br><span class="line">    &#123;</span><br><span class="line">#设置IP白名单</span><br><span class="line">    allow 192.168.8.132;</span><br><span class="line">    allow 127.0.0.1;</span><br><span class="line">    deny all;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>

<p>创建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mkdir /data/wwwroot/test.com/admin</span><br><span class="line">[root@host ~]#  echo “test,test”&gt;/data/wwwroot/test.com/admin/1.html</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x127.0.0.1:80  test.com/admin/1.html</span><br><span class="line">“test,test”</span><br><span class="line">[root@host ~]# curl -x192.168.2.107:80  test.com/admin/1.html</span><br><span class="line">“test,test”</span><br></pre></td></tr></table></figure>

<p>访问控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#正则匹配</span><br><span class="line">location ~ .*(abc|image)/.*\.php$</span><br><span class="line">&#123;</span><br><span class="line">        deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#user_agent限制</span><br><span class="line">if ($http_user_agent ~ &apos;Spider/3.0|YoudaoBot|Tomato&apos;)</span><br><span class="line">&#123;</span><br><span class="line">      return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#deny all和return 403效果一样</span><br></pre></td></tr></table></figure>

<p>#12.15 Nginx解析php相关配置<br>核心配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/nginx/conf/vhost/test.com.conf</span><br><span class="line">……</span><br><span class="line">location ~ \.php$</span><br><span class="line">    &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">#fastcgi_pass 127.0.0.1:9000</span><br><span class="line">        fastcgi_pass unix:/tmp/php-fcgi.sock;</span><br><span class="line">#fastcgi_pass 有两种监听格式，要保证Nginx和php-fpm中格式是一致的，否则会报502错误</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /data/wwwroot/test.com$fastcgi_script_name;</span><br><span class="line">#fastcgi _param SCRIPT _FILENAME所在行的路径要和root路径一致</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>#12.16 Nginx代理</p>
<blockquote>
<p>在计算机网络中，反向代理是代理服务器的一种。它根据客户端的请求，从后端的服务器上获取资源，然后再将这些资源返回给客户端。与前向代理不同，前向代理作为一个媒介将互联网上获取的资源返回给相关联的客户端，而反向代理是在服务器端作为代理使用，而不是客户端。</p>
</blockquote>
<p>##Nginx作为反向代理的特点</p>
<ul>
<li>接收用户请求是异步的，即先将用户请求全部接收下来，再一次性发送后后端web服务器，极大的减轻后端web服务器的压力；</li>
</ul>
<ul>
<li>nginx代理和后端web服务器间无需长连接；</li>
</ul>
<ul>
<li><p>发送响应报文时，是边接收来自后端web服务器的数据，边发送给客户端的；</p>
</li>
<li><p>调度灵活。NGINX工作在网络协议栈的第七层，能够对HTTP应用请求进行解析和分流，支持比较复杂的正则规则，具有更优化的负载均衡效果。</p>
</li>
<li><p>网络依赖型低。NGINX对网络的依赖程度非常低，理论上讲，只要能够ping通就可以实施负载均衡，而且可以有效区分内网和外网流量。</p>
</li>
<li><p>支持服务器检测。NGINX能够根据应用服务器处理页面返回的状态码、超时信息等检测服务器是否出现故障，并及时返回错误的请求重新提交到其它节点上。</p>
</li>
</ul>
<p>##工作原理</p>
<p>Nginx代理是在一台代理服务器中自定义一个域名，该域名指向一个IP，然后将用户的请求通过这台代理服务器访问指定的IP所对应的web服务器。</p>
<h2 id="进入虚拟主机目录"><a href="#进入虚拟主机目录" class="headerlink" title="进入虚拟主机目录"></a>进入虚拟主机目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/nginx/conf/vhost/</span><br></pre></td></tr></table></figure>

<p>##创建代理服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@host vhost]# vim proxy.conf</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ask.apelearn.com;</span><br><span class="line">#定义域名</span><br><span class="line">    location /</span><br><span class="line">    &#123;</span><br><span class="line">        proxy_pass      http://121.201.9.155/;</span><br><span class="line">#指定被代理（被访问）的IP（web服务器IP）</span><br><span class="line">        proxy_set_header Host  $host;</span><br><span class="line">#$host指的是代理服务器的servername（也是被代理IP的域名）</span><br><span class="line">        proxy_set_header X-Real-IP      $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">设置好以后，就可以访问aminglinux论坛了</span><br></pre></td></tr></table></figure>

<p>##检测验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#之前</span><br><span class="line">[root@host vhost]# curl -x127.0.0.1:80 ask.apelearn.com/robots.txt</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.12.1&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">#之后</span><br><span class="line">[root@host vhost]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@host vhost]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@host vhost]# curl -x127.0.0.1:80 ask.apelearn.com/robots.txt</span><br><span class="line">#</span><br><span class="line"># robots.txt for MiWen</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">User-agent: *</span><br><span class="line"></span><br><span class="line">Disallow: /?/admin/</span><br><span class="line">Disallow: /?/people/</span><br><span class="line">Disallow: /?/question/</span><br><span class="line">Disallow: /account/</span><br><span class="line">Disallow: /app/</span><br><span class="line">Disallow: /cache/</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<p>##502问题汇总<br><a href="http://ask.apelearn.com/question/9109" target="_blank" rel="noopener">http://ask.apelearn.com/question/9109</a></p>
<p>##location优先级<br><a href="http://blog.lishiming.net/?p=100" target="_blank" rel="noopener">http://blog.lishiming.net/?p=100</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/13.1 - 13.3 设置更改root密码、连接mysql、mysql常用命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/13.1 - 13.3 设置更改root密码、连接mysql、mysql常用命令/" itemprop="url">13.1 - 13.3 设置更改root密码、连接mysql、mysql常用命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#13.1 设置更改root密码<br>MySQL的root和Linux的root是不一样的，默认是没有密码的，需要设置。</p>
<p>##配置MySQL环境变量<br>首次直接使用mysql会提示‘未找到命令’，这是因为将该命令没有加入环境变量。如果要使用命令，需要使用它的绝对路径：/usr/local/mysql/bin/mysql。为了方便，建议将其加入系统的环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# export PATH=$PATH:/usr/local/mysql/bin/</span><br><span class="line">#这是将命令路径暂时加入环境变量，系但是统重启后该变量会失效，最好将其加入环境变量配置文件</span><br><span class="line"></span><br><span class="line">[root@host ~]# vim /etc/profile</span><br><span class="line">…… #添加</span><br><span class="line">export PATH=$PATH:/usr/local/mysql/bin/</span><br><span class="line"></span><br><span class="line">[root@host ~]# source /etc/profile   //刷新刚刚的配置文件，否则不生效</span><br></pre></td></tr></table></figure>

<p>##首次登陆mysql，root用户是没有密码的，可以直接登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot  //指定用户名</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">……</span><br><span class="line">mysql&gt; quit    //输入quit可以退出</span><br></pre></td></tr></table></figure>

<p>##设置密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysqladmin -uroot password &apos;123456&apos;  </span><br><span class="line"></span><br><span class="line">[root@host ~]# mysql -uroot    //设置好密码的话，再次登陆要加-p，不然报错</span><br><span class="line">ERROR 1045 (28000): Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</span><br><span class="line"></span><br><span class="line">[root@host ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt;</span><br><span class="line">注意： -p后面可以直接带密码，不用加空格，例如 -p&apos;123456&apos;，引号可以不加，但是密码如果是带有特殊符号的，就必须加引号，所以最好习惯加引号</span><br><span class="line">也可以在Enter后再输入密码，这样会不容易泄漏密码，更安全。</span><br></pre></td></tr></table></figure>

<p>##更改密码</p>
<ul>
<li><p>知道原密码的情况下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysqladmin -uroot -p&apos;123456&apos; password &apos;1234567&apos;</span><br><span class="line"></span><br><span class="line">[root@host ~]# mysql -uroot -p&apos;1234567&apos;</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>不知道原密码的情况下</p>
</li>
</ul>
<ol>
<li><p>编辑mysql配置文件，添加skip-grant </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant    //添加这一行，表示忽略授权</span><br><span class="line">datadir=/data/mysql</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启mysql服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL... SUCCESS! </span><br><span class="line">Starting MySQL..................... SUCCESS! </span><br><span class="line">#重启之后，登陆MySQL就不需要密码了</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接登陆MySQL，设置密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot</span><br><span class="line">Welcome to the MySQL monitor.  </span><br><span class="line">mysql&gt; use mysql;      //切换到mysql库</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user\G;    //查看用户的表信息（密码，授权等等）</span><br><span class="line">(/G: 使输出信息有序显示，不然显示内容会很乱  )</span><br><span class="line"></span><br><span class="line">mysql&gt; select password from user;   //查看用户密码，显示结果Wie加密字符串！  </span><br><span class="line">mysql&gt; update user set password=password(&apos;123456&apos;) where user=&apos;root&apos;;    //用123456代替原密码（将密码设置为123456）</span><br><span class="line">Query OK, 4 rows affected (0.11 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>#13.2 连接mysql</p>
<p>##远程连接：使用IP&amp;port</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p123456 -h127.0.0.1 -P3306   //-p=password   -h=host  -P=port</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>##本机连接：使用socket</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p123456 -S/tmp/mysql.sock   //-S 制定socket</span><br><span class="line">#只适用于本机连接，等同于“mysql -uroot -p123456”</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>##显示数据库信息，一般用于脚本中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p&apos;123456&apos; -e &quot;show databases&quot;  //-e 可以执行一些命令</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------+</span><br><span class="line">| Database          |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test              |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>

<p>#13.3 mysql常用命令</p>
<p>##查看库的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;</span><br><span class="line"></span><br><span class="line">查询库 show databases;</span><br><span class="line">切换库 use mysql;</span><br></pre></td></tr></table></figure>

<p>##这些命令需要在切换库之后执行</p>
<p>#mysql&gt; use mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看库里的表 show tables;</span><br><span class="line">查看表里的字段 desc tb_name;</span><br><span class="line">查看建表语句 show create table tb_name\G;</span><br><span class="line">查看当前用户 select user();</span><br><span class="line">查看当前使用的数据库 select databsase();</span><br></pre></td></tr></table></figure>

<p>#扩展 </p>
<p>##mysql5.7 root密码更改<br><a href="http://www.apelearn.com/bbs/thread-7289-1-1.html" target="_blank" rel="noopener">http://www.apelearn.com/bbs/thread-7289-1-1.html</a></p>
<p>##myisam 和innodb引擎对比<br><a href="http://www.pureweber.com/article/myisam-vs-innodb/" target="_blank" rel="noopener">http://www.pureweber.com/article/myisam-vs-innodb/</a></p>
<p>##mysql 配置详解<br><a href="http://blog.linuxeye.com/379.html" target="_blank" rel="noopener">http://blog.linuxeye.com/379.html</a></p>
<p>##mysql调优<br><a href="http://www.aminglinux.com/bbs/thread-5758-1-1.html" target="_blank" rel="noopener">http://www.aminglinux.com/bbs/thread-5758-1-1.html</a></p>
<p>##亲身mysql调优经历<br><a href="http://www.apelearn.com/bbs/thread-11281-1-1.html" target="_blank" rel="noopener">http://www.apelearn.com/bbs/thread-11281-1-1.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/14.1 - 14.3 NFS的介绍、服务端安装配置、配置选项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/14.1 - 14.3 NFS的介绍、服务端安装配置、配置选项/" itemprop="url">14.1 - 14.3 NFS的介绍、服务端安装配置、配置选项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#14.1 NFS介绍</p>
<blockquote>
<p>NFS（Network File System）即网络文件系统，是FreeBSD支持的文件系统中的一种，它允许网络中的计算机之间通过TCP/IP网络共享资源。在NFS的应用中，本地NFS的客户端应用可以透明地读写位于远端NFS服务器上的文件，就像访问本地文件一样。</p>
</blockquote>
<ul>
<li>NFS是Network File System的缩写</li>
<li>NFS最早由Sun公司开发，分2,3,4三个版本，2和3由Sun起草开发，4.0开始Netapp公司参与并主导开发，最新为4.1版本</li>
<li>NFS数据传输基于RPC协议，RPC为Remote Procedure Call的简写。</li>
<li>NFS应用场景是：A,B,C三台机器上需要保证被访问到的文件是一样的，A共享数据出来，B和C分别去挂载A共享的数据目录，从而B和C访问到的数据和A上的一致</li>
</ul>
<p>#14.2 NFS服务端安装配置</p>
<p>准备两台虚拟机，一台作为服务端，一台作为客户端。</p>
<p>##服务端(IP：192.168.2.130)</p>
<p>###安装NFS工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum install -y nfs-utils rpcbind</span><br></pre></td></tr></table></figure>

<p>###配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/exports</span><br><span class="line">/home/nfstestdir 192.168.2.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000)</span><br><span class="line">#指定要进行分享的目录；指定要共享该目录的机器</span><br><span class="line"></span><br><span class="line">创建要分享的目录并设置好权限：</span><br><span class="line">[root@localhost ~]# mkdir /home/nfstestdir</span><br><span class="line">[root@localhost ~]# chmod 777 /home/nfstestdir</span><br></pre></td></tr></table></figure>

<p>###启动NFS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl start nfs</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# systemctl enable nfs   //把NFS服务加入开机启动项</span><br><span class="line">#NFS服务的后台服务进程为rpcbind服务（在服务端进程名称为systemd），默认的监听端口是111</span><br></pre></td></tr></table></figure>

<p>##客户端（IP：192.168.2.131）</p>
<p>###安装NFS工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum install -y nfs-utils</span><br></pre></td></tr></table></figure>

<p>###检查<br>检查客户端是否有权限访问服务端文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# showmount -e 192.168.2.130</span><br><span class="line">clnt_create: RPC: Port mapper failure - Unable to receive: errno 113 (No route to host)  //报错，无法连接到服务器</span><br><span class="line"></span><br><span class="line">解决办法</span><br><span class="line">1. 检查服务端rpcbind服务是否开启，111端口是否在监视</span><br><span class="line">2. 如果服务端rpcbind服务已经开启，那么一般都是防火墙的原因，关闭服务端和客户端firewalld和SELinux防火墙</span><br><span class="line"></span><br><span class="line">关闭防火墙后，再次检查</span><br><span class="line">[root@host ~]# showmount -e 192.168.2.130</span><br><span class="line">Export list for 192.168.2.130:</span><br><span class="line">/home/nfstestdir 192.168.2.0/24</span><br><span class="line">#检查链接OK，通过</span><br></pre></td></tr></table></figure>

<p>###挂载客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mount -t nfs 192.168.2.130:/home/nfstestdir /mnt/</span><br><span class="line"></span><br><span class="line">[root@host ~]# df -h</span><br><span class="line">文件系统                                     容量  已用  可用 已用% 挂载点</span><br><span class="line">192.168.2.130:/home/nfstestdir  18G  7.5G  11G  42% /mnt</span><br></pre></td></tr></table></figure>

<p>###测试<br>在客户端挂载目录，创建一个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /mnt/</span><br><span class="line">[root@host mnt]# ll</span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r-- 1 mysql mysql 0 9月  18 22:50 test000</span><br></pre></td></tr></table></figure>

<p>查看服务端的共享目录，是否同步了该文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ll /home/nfstestdir/</span><br><span class="line">总用量 0</span><br><span class="line">-rw-r--r-- 1 mysql mysql 0 9月  18 22:50 test000</span><br></pre></td></tr></table></figure>

<p>表示同步成功，实现了跨服务器的共享。</p>
<p>#14.3 NFS配置选项</p>
<p>##服务端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root[@localhost ~]# vim /etc/exports</span><br><span class="line">/home/nfstestdir 192.168.2.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000)</span><br><span class="line">#&#123;rw 读写</span><br><span class="line">ro 只读</span><br><span class="line">sync 同步模式，内存数据实时写入磁盘</span><br><span class="line">async 非同步模式</span><br><span class="line">no_root_squash 客户端挂载NFS共享目录后，root用户不受约束，权限很大</span><br><span class="line">root_squash 与上面选项相对，客户端上的root用户收到约束，被限定成某个普通用户</span><br><span class="line">all_squash 客户端上所有用户在使用NFS共享目录时都被限定为一个普通用户</span><br><span class="line">anonuid/anongid 和上面几个选项搭配使用，定义被限定用户的uid和gid&#125;</span><br></pre></td></tr></table></figure>

<h2 id="固定NFS启动端口，便于iptables设置"><a href="#固定NFS启动端口，便于iptables设置" class="headerlink" title="固定NFS启动端口，便于iptables设置"></a>固定NFS启动端口，便于iptables设置</h2><p>NFS 的防火墙特别难设定规则，为什么呢？因为除了固定的port 111, 2049 之外， 还有很多不固定的端口是由rpc.mountd, rpc.rquotad 等服务所开启的。因此我们需要在/etc/sysconfig/nfs 指定特定的端口，这样每次启动nfs 时，相关服务启动的端口就会固定，如此一来， 我们就能够设定正确的防火墙了！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs-01 ~]# rpcinfo -p localhost</span><br><span class="line">   program vers proto port service</span><br><span class="line">    100000 4 tcp 111 portmapper</span><br><span class="line">    100000 3 tcp 111 portmapper</span><br><span class="line">    100000 2 tcp 111 portmapper</span><br><span class="line">    100000 4 udp 111 portmapper</span><br><span class="line">    100000 3 udp 111 portmapper</span><br><span class="line">    100000 2 udp 111 portmapper</span><br><span class="line">    100024 1 udp 43265 status</span><br><span class="line">    100024 1 tcp 50310 status</span><br><span class="line">    100005 1 udp 20048 mountd</span><br><span class="line">    100005 1 tcp 20048 mountd</span><br><span class="line">    100005 2 udp 20048 mountd</span><br><span class="line">    100005 2 tcp 20048 mountd</span><br><span class="line">    100005 3 udp 20048 mountd</span><br><span class="line">    100005 3 tcp 20048 mountd</span><br><span class="line">    100003 3 tcp 2049 nfs</span><br><span class="line">    100003 4 tcp 2049 nfs</span><br><span class="line">    100227 3 tcp 2049 nfs_acl</span><br><span class="line">    100003 3 udp 2049 nfs</span><br><span class="line">    100003 4 udp 2049 nfs</span><br><span class="line">    100227 3 udp 2049 nfs_acl</span><br><span class="line">    100021 1 udp 46936 nlockmgr</span><br><span class="line">    100021 3 udp 46936 nlockmgr</span><br><span class="line">    100021 4 udp 46936 nlockmgr</span><br><span class="line">    100021 1 tcp 43528 nlockmgr</span><br><span class="line">    100021 3 tcp 43528 nlockmgr</span><br><span class="line">    100021 4 tcp 43528 nlockmgr</span><br></pre></td></tr></table></figure>

<p>只有固定端口nfs 2049、portmapper111 ，另外3个服务端口可设置为mountd 892、rpc.statd 662、 nlockmgr 32803、32769。我们为了好设置iptables规则，把它们设为10001 - 10005。</p>
<p>1.vim /etc/sysconfig/nfs文件，将下列内容的注释去掉，如果没有则添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Port rpc.mountd should listen on.</span><br><span class="line">MOUNTD_PORT=10001</span><br><span class="line">#</span><br><span class="line"># Optional arguments passed to rpc.statd. See rpc.statd(8)</span><br><span class="line">STATDARG=&quot;&quot;</span><br><span class="line"># Port rpc.statd should listen on.</span><br><span class="line">STATD_PORT=10002</span><br><span class="line"># Outgoing port statd should used. The default is port</span><br><span class="line"># is random</span><br><span class="line">STATD_OUTGOING_PORT=10003</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>vim /etc/modprobe.d/lockd.conf，去掉 #</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Set the TCP port that the NFS lock manager should use.</span><br><span class="line"># port must be a valid TCP port value (1-65535).</span><br><span class="line">options lockd nlm_tcpport=10004</span><br><span class="line">#</span><br><span class="line"># Set the UDP port that the NFS lock manager should use.</span><br><span class="line"># port must be a valid UDP port value (1-65535).</span><br><span class="line">options lockd nlm_udpport=10005</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置完成以后，重启服务器才可以重置端口。</p>
</li>
<li><p>设置iptables</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 111 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p udp --dport 111 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 2049 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p udp --dport 2049 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 10001:10005 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p udp --dport 10001:10005 -j ACCEPT</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>NFS iptables规则<br><a href="https://stackoverflow.com/questions/26187345/iptables-rules-for-nfs-server-and-nfs-client" target="_blank" rel="noopener">https://stackoverflow.com/questions/26187345/iptables-rules-for-nfs-server-and-nfs-client</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhouqun</p>
              <p class="site-description motion-element" itemprop="description">个人Linux学习和工作记录的小地方</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhouqun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
