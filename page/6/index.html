<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Joking的Linux世界" type="application/atom+xml">






<meta name="description" content="个人Linux学习和工作记录的小地方">
<meta name="keywords" content="linux">
<meta property="og:type" content="website">
<meta property="og:title" content="Joking的Linux世界">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Joking的Linux世界">
<meta property="og:description" content="个人Linux学习和工作记录的小地方">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joking的Linux世界">
<meta name="twitter:description" content="个人Linux学习和工作记录的小地方">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/">





  <title>Joking的Linux世界</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Joking的Linux世界</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">念念不忘，必有回响</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/new post/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/new post/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/9.9 正则拓展2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/9.9 正则拓展2/" itemprop="url">9.9 正则拓展2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1-awk-中使用外部shell变量"><a href="#1-awk-中使用外部shell变量" class="headerlink" title="1. awk 中使用外部shell变量"></a>1. awk 中使用外部shell变量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">如：</span><br><span class="line">A=44echo &quot;ABCD&quot; | awk -v GET_A=$A ’&#123;print GET_A&#125;’</span><br><span class="line">说明：-v选项用于定义参数，这里表示将变量A的值赋予GET_A。</span><br><span class="line">有多少个变量需要赋值，就需要多少个-v选项。与之等价的：应用于脚本中：</span><br><span class="line"></span><br><span class="line">#! /bin/bash</span><br><span class="line">sort -n filename |awk -F &apos;:&apos; &apos;&#123;print $1&#125;&apos;|uniq &gt;id.txt</span><br><span class="line">for id in `cat id.txt`; do</span><br><span class="line">        echo &quot;[$id]&quot;</span><br><span class="line">        awk -v id2=$id -F &apos;:&apos; &apos;$1==id2 &#123;print $2&#125;&apos; filename  // 另外的方式为: awk -F &apos;:&apos; &apos;$1==&quot;&apos;$id&apos;&quot; &#123;print $2&#125;&apos; filename  </span><br><span class="line">done</span><br><span class="line">附件：</span><br><span class="line">cat filename</span><br><span class="line">1111111:13443253456</span><br><span class="line">2222222:13211222122</span><br><span class="line">1111111:13643543544</span><br><span class="line">3333333:12341243123</span><br><span class="line">2222222:12123123123</span><br><span class="line">运行脚本后结果为：</span><br><span class="line">[1111111]</span><br><span class="line">13443253456</span><br><span class="line">13643543544</span><br><span class="line">[2222222]</span><br><span class="line">13211222122</span><br><span class="line">12123123123</span><br><span class="line">[3333333]</span><br><span class="line">12341243123</span><br></pre></td></tr></table></figure>

<h1 id="2-awk-合并一个文件"><a href="#2-awk-合并一个文件" class="headerlink" title="2. awk 合并一个文件"></a>2. awk 合并一个文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">需要把两个文件中，第一列相同的行合并到同一行中。举个例子，有两个文件，内容如下</span><br><span class="line">cat 1.txt</span><br><span class="line">1 aa</span><br><span class="line">2 bb</span><br><span class="line">3 ee</span><br><span class="line">4 ss</span><br><span class="line"></span><br><span class="line">cat 2.txt</span><br><span class="line">1 ab</span><br><span class="line">2 cd</span><br><span class="line">3 ad</span><br><span class="line">4 bd</span><br><span class="line">5 de</span><br><span class="line"></span><br><span class="line">合并后的结果为：</span><br><span class="line"></span><br><span class="line">1 ab aa</span><br><span class="line">2 cd bb</span><br><span class="line">3 ad ee</span><br><span class="line">4 bd ss</span><br><span class="line">5 de</span><br><span class="line"></span><br><span class="line">实现的命令为：</span><br><span class="line">awk &apos;NR==FNR&#123;a[$1]=$2&#125;NR&gt;FNR&#123;print $0,a[$1]&#125;&apos;  1.txt  2.txt</span><br><span class="line"></span><br><span class="line">解释：NR表示读取的行数，FNR表示读取的当前行数</span><br><span class="line">所以其实NR==FNR 就表示读取2.txt的时候。 同理NR&gt;FNR表示读取1.txt的时候</span><br><span class="line">数组a其实就相当于一个map</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">总结： 完全不懂</span><br><span class="line">$1 当前记录的第1个字段，比如n为1表示第一个字段，n为2表示第二个字段</span><br><span class="line">$0 这个变量包含执行过程中当前行的文本内容</span><br><span class="line">FNR 同NR，表示行号，但相对于当前文件</span><br></pre></td></tr></table></figure>

<h1 id="3-把一个文件多行连接成一行-不懂"><a href="#3-把一个文件多行连接成一行-不懂" class="headerlink" title="3. 把一个文件多行连接成一行 - 不懂"></a>3. 把一个文件多行连接成一行 - 不懂</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">例子1：</span><br><span class="line">a=`cat file`;echo $a </span><br><span class="line">awk &apos;&#123;printf(&quot;%s &quot;,$0)&#125;&apos; file  ## %s 后记得要有一空格，否则出来就是完全连在一起的，中间连空格都没有</span><br><span class="line">cat file |xargs</span><br><span class="line"></span><br><span class="line">例子2：</span><br><span class="line">一个文件每行都有一个数字，现在需要把每行的数字用“+”连接起来。</span><br><span class="line">cat a</span><br><span class="line">96</span><br><span class="line">1093</span><br><span class="line">1855</span><br><span class="line">1253</span><br><span class="line">1364</span><br><span class="line">1332</span><br><span class="line">2308</span><br><span class="line">2589</span><br><span class="line">2531</span><br><span class="line">1239</span><br><span class="line">2164</span><br><span class="line">2826</span><br><span class="line">2787</span><br><span class="line">2145</span><br><span class="line">2617</span><br><span class="line">4311</span><br><span class="line">1810</span><br><span class="line">2115</span><br><span class="line">1235</span><br><span class="line"></span><br><span class="line">awk &apos;&#123;printf (&quot;%s+&quot;,$0)&#125;&apos;  a; echo &quot;&quot;</span><br><span class="line">96+1093+1855+1253+1364+1332+2308+2589+2531+1239+2164+2826+2787+2145+2617+4311+1810+2115+1235+</span><br><span class="line">这里注意，最后一个是带“+”的。echo &quot;&quot;  的作用是换行。</span><br><span class="line"></span><br><span class="line">另外的方法是 </span><br><span class="line">cat a|xargs|sed &apos;s/ /+/g&apos;</span><br><span class="line">96+1093+1855+1253+1364+1332+2308+2589+2531+1239+2164+2826+2787+2145+2617+4311+1810+2115+1235</span><br></pre></td></tr></table></figure>

<h1 id="4-awk中gsub函数的使用"><a href="#4-awk中gsub函数的使用" class="headerlink" title="4. awk中gsub函数的使用"></a>4. awk中gsub函数的使用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">awk &apos;gsub(/www/,&quot;abc&quot;)&apos; /etc/passwd                      passwd文件中把所有www替换为abc</span><br><span class="line">awk -F &apos;:&apos; &apos;gsub(/www/,&quot;abc&quot;,$1) &#123;print $0&#125;&apos; /etc/passwd  替换$1中的www为abc</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">gsub函数则使得在所有正则表达式被匹配的时候都发生替换</span><br><span class="line">gsub匹配所有的符合模式的字符串，相当于 sed &apos;s//g&apos; 。</span><br></pre></td></tr></table></figure>

<h1 id="5-awk-截取指定多个域为一行"><a href="#5-awk-截取指定多个域为一行" class="headerlink" title="5. awk 截取指定多个域为一行"></a>5. awk 截取指定多个域为一行</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for j in `seq 0 20`; do</span><br><span class="line">        let x=100*$j</span><br><span class="line">        let y=$x+1</span><br><span class="line">        let z=$x+100</span><br><span class="line">        for i in `seq $y $z` ; do</span><br><span class="line">                awk  -v a=$i &apos;&#123;printf $a &quot; &quot;&#125;&apos; example.txt &gt;&gt;/tmp/test.txt</span><br><span class="line">                echo &quot; &quot; &gt;&gt;/tmp/test.txt</span><br><span class="line">        done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h1 id="6-过滤两个或多个关键词"><a href="#6-过滤两个或多个关键词" class="headerlink" title="6. 过滤两个或多个关键词"></a>6. 过滤两个或多个关键词</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -E &apos;123|abc&apos; filename  找出文件（filename）中包含123或者包含abc的行</span><br><span class="line">egrep &apos;123|abc&apos; filename    用egrep同样可以实现</span><br><span class="line">awk &apos;/123|abc/&apos;  filename    awk 的实现方式</span><br></pre></td></tr></table></figure>

<h1 id="7-用awk生成以下结构文件"><a href="#7-用awk生成以下结构文件" class="headerlink" title="7. 用awk生成以下结构文件"></a>7. 用awk生成以下结构文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">用awk编写生成以下结构文件的程序。( 最后列使用现在的时间，时间格式为YYYYMMDDHHMISS)  各列的值应如下所示，每增加一行便加1，共500万行。</span><br><span class="line"></span><br><span class="line">1,1,0000000001,0000000001,0000000001,0000000001,0000000001,0000000001,2005100110101</span><br><span class="line">2,2,0000000002,0000000002,0000000002,0000000002,0000000002,0000000002,2005100110101</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">用shell搞起。</span><br><span class="line">#! /bin/bash</span><br><span class="line"></span><br><span class="line">for i in `seq 1 5000000`; do</span><br><span class="line">    n=`echo &quot;$i&quot;|awk &apos;&#123;print length($0)&#125;&apos;`</span><br><span class="line">    export m=$[10-$n]</span><br><span class="line">    export o=`perl -e &apos;$a=&apos;0&apos;; $b=$a x $ENV&#123;&quot;m&quot;&#125;; print $b;&apos;`</span><br><span class="line">    export j=$i</span><br><span class="line">    p=`perl -e &apos;$c=$ENV&#123;&quot;o&quot;&#125;.$ENV&#123;&quot;j&quot;&#125;; print $c;&apos;`</span><br><span class="line">    echo &quot;$i,$i,$p,$p,$p,$p,$p,$p,`date +%Y%m%d%H%M%S`&quot;</span><br><span class="line">done</span><br><span class="line">其中用到了perl，所以脚本整体看起来比较啰嗦，希望能找到更好的解决办法。</span><br><span class="line">PS: shell 执行效率很低，so 该脚本运行时间会很漫长！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">awk搞起</span><br><span class="line">awk &apos;BEGIN&#123;for(i=1;i&lt;=10;i++)printf(&quot;%d,%d,%010d,%010d,%010d,%010d,%010d,%010d,%d\n&quot;,i,i,i,i,i,i,i,i,strftime(&quot;%Y%m%d%H%M&quot;))&#125;&apos;</span><br><span class="line"></span><br><span class="line">python搞起</span><br><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_data(num, time_now):</span><br><span class="line"></span><br><span class="line">    list_num = [num]*8</span><br><span class="line">    list_num.append(time_now)</span><br><span class="line">    return &quot;%d,%d,0d,0d,0d,0d,0d,0d,%s&quot; % tuple(list_num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loop_count(times):</span><br><span class="line"></span><br><span class="line">    for i in xrange(times):</span><br><span class="line">        time_now = datetime.datetime.now().strftime(&quot;%Y%m%d%H%M%S&quot;)</span><br><span class="line">        write_file(get_data(i+1, time_now))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def write_file(string):</span><br><span class="line">    with open(&quot;output&quot;, &apos;a+&apos;) as filename:</span><br><span class="line">        filename.write(string+&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line"></span><br><span class="line">    loop_count(1000*1000)</span><br></pre></td></tr></table></figure>

<h1 id="8-awk用print打印单引号"><a href="#8-awk用print打印单引号" class="headerlink" title="8. awk用print打印单引号"></a>8. awk用print打印单引号</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">awk &apos;&#123;print &quot;This is a &apos;&quot;&apos;&quot;&apos;&quot;$1&#125; filename </span><br><span class="line">解释一下：在awk中使用脱义字符\是起不到作用的，如果想打印特殊字符，只能使用&apos;&quot;&quot;&apos; 这样的组合才可以。</span><br><span class="line"></span><br><span class="line">这里自左至右为单引号 双引号 双引号</span><br><span class="line">单引号其中两个单引号为一对，两个双引号为一对。想脱义$那就是&apos;&quot;$&quot;&apos;</span><br><span class="line">脱义单引号那就是 &apos;&quot;&apos;&quot;&apos;</span><br></pre></td></tr></table></figure>

<h1 id="9-合并两个文件"><a href="#9-合并两个文件" class="headerlink" title="9. 合并两个文件"></a>9. 合并两个文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">paste  filename1  filename2 </span><br><span class="line"></span><br><span class="line">这样就可以实现了。举个例子。</span><br><span class="line">cat  a.txt</span><br><span class="line">1 2 3 </span><br><span class="line">4 5 6 </span><br><span class="line">a b c</span><br><span class="line"></span><br><span class="line">cat b.txt</span><br><span class="line">3 2 1 </span><br><span class="line">6 5 4 </span><br><span class="line">c b a </span><br><span class="line"></span><br><span class="line">则  paste  a.txt  b.txt  结果为</span><br><span class="line">1 2 3  3 2 1</span><br><span class="line">4 5 6  6 5 4</span><br><span class="line">a b c  c b a</span><br><span class="line"></span><br><span class="line">如果，你想在两个文件连接处用一个指定的字符连接，还可以用-d来指定</span><br><span class="line">paste -d &apos;+&apos;  a.txt b.txt</span><br><span class="line">结果为</span><br><span class="line">1 2 3+3 2 1</span><br><span class="line">4 5 6+6 5 4</span><br><span class="line">a b c+c b a</span><br></pre></td></tr></table></figure>

<h1 id="10-awk的参考教程"><a href="#10-awk的参考教程" class="headerlink" title="10. awk的参考教程"></a>10. awk的参考教程</h1><p>地址[<a href="http://www.cnblogs.com/emanlee/p/3327576.html]" target="_blank" rel="noopener">http://www.cnblogs.com/emanlee/p/3327576.html]</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#awk -F \| &apos;NR==FNR&#123;a[$2]=$0;next&#125;&#123;print a[$1]&quot;|&quot;$2&#125;&apos; account cdr</span><br><span class="line"></span><br><span class="line">注释:</span><br><span class="line"></span><br><span class="line">由NR=FNR为真时,判断当前读入的是第一个文件account,然后使用&#123;a[$2]=$0;next&#125;循环将account文件的每行记录都存入数组a,并使用$2第2个字段作为下标引用.</span><br><span class="line"></span><br><span class="line">由NR=FNR为假时,判断当前读入了第二个文件cdr,然后跳过&#123;a[$2]=$0;next&#125;,对第二个文件cdr的每一行都无条件执行 &#123;print a[$1]&quot;|&quot;$2&#125;,此时变量$1为第二个文件的第一个字段,与读入第一个文件时,采用第一个文件第二个字段$2为数组下标相同.因此可以在此使用 a[$1]引用数组。</span><br></pre></td></tr></table></figure>

<p>awk运算符</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>= += -= <em>= /= %= ^= *</em>=</td>
<td>赋值</td>
</tr>
<tr>
<td>?:</td>
<td>C条件表达式</td>
</tr>
<tr>
<td>双竖线</td>
<td>逻辑或</td>
</tr>
<tr>
<td>&amp;&amp;</td>
<td>逻辑与</td>
</tr>
<tr>
<td>~      ~!</td>
<td>匹配正则表达式和不匹配正则表达式</td>
</tr>
<tr>
<td>&lt; &lt;= &gt; &gt;= != ==</td>
<td>关系运算符</td>
</tr>
<tr>
<td>空格</td>
<td>连接</td>
</tr>
<tr>
<td>+ -</td>
<td>加，减</td>
</tr>
<tr>
<td>* / &amp;</td>
<td>乘，除与求余</td>
</tr>
<tr>
<td>+ - !</td>
<td>一元加，减和逻辑非</td>
</tr>
<tr>
<td>^ ***</td>
<td>求幂</td>
</tr>
<tr>
<td>++ –</td>
<td>增加或减少，作为前缀或后缀</td>
</tr>
<tr>
<td>$</td>
<td>字段引用</td>
</tr>
<tr>
<td>in</td>
<td>数组成员</td>
</tr>
</tbody></table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.22 - 11.24 LAMP架构-访问日志不记录静态文件，访问日志切割，静态元素过期时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.22 - 11.24 LAMP架构-访问日志不记录静态文件，访问日志切割，静态元素过期时间/" itemprop="url">11.22 - 11.24 LAMP架构-访问日志不记录静态文件，访问日志切割，静态元素过期时间</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#11.22 访问日志不记录静态文件<br>网站大多元素为静态文件，如图片、css、js等，这些元素可以不用记录，没有意义。限制访问日志，让系统不记录静态文件，可以有效的减少无用的日志的空间占用。<br>把虚拟主机配置文件 “httpd-vhosts.conf” 改成如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">......</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/www.123.com&quot;</span><br><span class="line">    ServerName www.123.com</span><br><span class="line">    ServerAlias 123.com</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.gif$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.jpg$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.png$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.bmp$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.swf$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.js$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.css$&quot; img </span><br><span class="line">#以上为定义变量：将所有关于图片的请求定义为变量img</span><br><span class="line">    CustomLog &quot;logs/123.com-access_log&quot; combined env=!img</span><br><span class="line"># “env=!img”表示非img变量。本行命令的含义是：不记录关于变量img的请求日志。</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">配置完成后重新检测和加载</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line">[root@host ~]# mkdir /data/wwwroot/www.123.com/images  #创建目录，并在这目录下上传一个图片</span><br><span class="line">[root@host ~]# curl -x127.0.0.1:80 -I 123.com/images/123.jpg </span><br><span class="line">[root@host ~]#tail /usr/local/apache2.4/logs/123.com-access_log  # 日志没有静态文件的记录了</span><br></pre></td></tr></table></figure>

<p>#11.23 访问日志切割<br>日志一直记录总有一天会把整个磁盘占满，所以有必要让它自动切割，并删除老的日志文件<br>把虚拟主机配置文件改成如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">......</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/www.123.com&quot;</span><br><span class="line">    ServerName www.123.com</span><br><span class="line">    ServerAlias 123.com</span><br><span class="line">  SetEnvIf Request_URI &quot;.*\.gif$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.jpg$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.png$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.bmp$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.swf$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.js$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.css$&quot; img </span><br><span class="line">    CustomLog &quot;|/usr/local/apache2.4/bin/rotatelogs -l logs/123.com-access_%Y%m%d.log 86400&quot; combined env=!img</span><br><span class="line"># 使用rotatelogs工具，以系统时间为基准，每天切割一次日志，并且日志名字格式为“123.com-access_%Y%m%d.log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">配置完成后重新检测和加载</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line">ls /usr/local/apache2.4/logs</span><br></pre></td></tr></table></figure>

<p>注： rotatelogs是Apache切割日志的工具，语法如下：<br>Rotatelogs的用法：<br>rotatelogs [ -l ] logfile [ rotationtime [ offset ]] | [ filesizeM ]<br>选项：</p>
<ul>
<li>-l    使用本地时间代替GMT时间作为时间基准。注意：在一个改变GMT偏移量(比如夏令时)的环境中使用-l会导致不可预料的结果。</li>
<li>logfile    它加上基准名就是日志文件名。如果logfile中包含”%”，则它会被视为用于strftime()的格式字符串；否则它会被自动加上以秒为单位的”.nnnnnnnnnn”后缀。这两种格式都表示新的日志开始使用的时间。</li>
<li>rotationtime    日志文件滚动的以秒为单位的间隔时间。</li>
<li>offset    相对于UTC的时差的分钟数。如果省略，则假定为”0”并使用UTC时间。比如，要指定UTC时差为”-5小时”的地区的当地时间，则此参数应为”-300”。</li>
<li>filesizeM    指定以filesizeM文件大小滚动，而不是按照时间或时差滚动。</li>
</ul>
<p>每小时切割一次日志<br><code>CustomLog &quot;|/usr/local/apache2.4/bin/rotatelogs logs/access_%Y%m%d%H.log 3600&quot; combined</code></p>
<p>#11.24 静态元素过期时间<br>浏览器访问网站的图片时会把静态的文件缓存在本地电脑里，这样下次再访问时就不用去远程下载了，<br>增加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">……</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    &lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">        RewriteEngine on</span><br><span class="line">        RewriteCond %&#123;HTTP_HOST&#125; !^111.com$</span><br><span class="line">        RewriteRule ^/(.*)$ http://111.com/$1 [R=301,L]</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line"></span><br><span class="line">&lt;IfModule mod_expires.c&gt;</span><br><span class="line">    ExpiresActive on  #打开该功能的开关 </span><br><span class="line">    ExpiresByType image/gif  &quot;access plus 1 days&quot;</span><br><span class="line">    ExpiresByType image/jpeg &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType image/png &quot;access plus 24 hours&quot;</span><br><span class="line">    ExpiresByType text/css &quot;now plus 2 hour&quot;</span><br><span class="line">    ExpiresByType application/x-javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/javascript &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresByType application/x-shockwave-flash &quot;now plus 2 hours&quot;</span><br><span class="line">    ExpiresDefault &quot;now plus 0 min&quot;    #以上是定义不同类型的文件缓存的时间</span><br><span class="line">&lt;/IfModule&gt;</span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.gif$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.jpg$&quot; img </span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.png$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.bmp$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.swf$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.js$&quot; img</span><br><span class="line">    SetEnvIf Request_URI &quot;.*\.css$&quot; img  </span><br><span class="line">    CustomLog &quot;|usr/local/apache2.4/bin/rotatelogs -l logs/111.com-access_%Y%m%d.log 86400&quot; combined env=!img</span><br><span class="line">#使用rotatelogs工具，以系统时间为基准，每天切割一次日志，并且日志名字格式为“111.com-access_%Y%m%d.log”。</span><br><span class="line"></span><br><span class="line">配置完成后重新检测和加载</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line"></span><br><span class="line">检测Apache配置文件是否开启expire模块：  </span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -M |grep expires</span><br><span class="line">未检测到expires模块，所以需要编辑Apache配置文件，加载expires模块</span><br><span class="line"></span><br><span class="line">配置Apache，加载expires模块</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf</span><br><span class="line">LoadModule expires_module modules/mod_expires.so</span><br><span class="line"></span><br><span class="line">加载配置文件：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line">检查模块是否开启：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -M |grep expires</span><br><span class="line">expires_module (shared)</span><br><span class="line"># 查找expires模块，并开启加载该模块的命令行（去掉#即可）。 </span><br><span class="line"></span><br><span class="line">再次检测</span><br><span class="line">[root@host ~]#  curl -x192.168.2.130:80 111.com/baidu.png -I</span><br></pre></td></tr></table></figure>

<p>在配置文件添加mod_expires.c模块内容，其余不变。  </p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="apache日志记录代理IP以及真实客户端IP"><a href="#apache日志记录代理IP以及真实客户端IP" class="headerlink" title="apache日志记录代理IP以及真实客户端IP"></a>apache日志记录代理IP以及真实客户端IP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认情况下log日志格式为：</span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br><span class="line">其中%h 是记录访问者的IP，如果在web的前端有一层代理，那么这个%h其实就是代理机器的IP，这不是我们想要的。在这种情况下，</span><br><span class="line">%&#123;X-FORWARDED-FOR&#125;i 字段会记录客户端真实的IP。所以log日志改为：</span><br><span class="line">LogFormat &quot;%h %&#123;X-FORWARDED-FOR&#125;i %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br></pre></td></tr></table></figure>

<h2 id="apache只记录指定URI的日志"><a href="#apache只记录指定URI的日志" class="headerlink" title="apache只记录指定URI的日志"></a>apache只记录指定URI的日志</h2><p>需求是，把类似请求 <a href="http://www.aaa.com/aaa/" target="_blank" rel="noopener">www.aaa.com/aaa/</a>… 这样的请求才记录日志。<br>在httpd.conf 或者 相关的虚拟主机配置文件中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SetEnvIf Request_URI &quot;^/aaa/.*&quot; aaa-request</span><br><span class="line">CustomLog &quot;|/usr/local/apache/bin/rotatelogs -l /usr/local/apache/logs/aaa-access_%Y%m%d.log 86400&quot; combined env=aaa-request</span><br><span class="line">这样就可以了。这个原理和不记录图片等静态访问的日志是一样的。</span><br></pre></td></tr></table></figure>

<p>##apache日志记录客户端请求的域名 </p>
<p>正常情况下，根本就没有必要记录这一项，毕竟咱们大都根据虚拟主机来设置相应的访问日志，但也有个别的情况，比如<br>ServerName *.abc.com<br>这样泛解析的形式，所以有必要记录一下用户请求的域名到底是哪个。<br>而apache的LogFormat 中正好有一项值满足了这个需求。即 %V 这里是大写的V ,小写的v 记录的是咱们在虚拟主机中设置的ServerName ，这个的确是没有必要记录的。</p>
<h2 id="apache-日志切割问题"><a href="#apache-日志切割问题" class="headerlink" title="apache 日志切割问题"></a>apache 日志切割问题</h2><p>apache的日志是可以自动切割的。<br>方法一： 使用 cronolog 为每一天建立一个新的日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomLog &quot;|bin/cronolog logs/access_%Y%m%d.log&quot; combined</span><br></pre></td></tr></table></figure>

<p>也可以按小时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomLog &quot;|bin/cronolog logs/access_%Y%m%d%h.log&quot; combined</span><br></pre></td></tr></table></figure>

<p>方法二：使用 rotatelogs 每一天记录一个日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomLog &quot;|bin/rotatelogs -l logs/access_%Y%m%d.log 86400&quot; combined</span><br></pre></td></tr></table></figure>

<p>每小时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomLog &quot;|bin/rotatelogs -l logs/access_%Y%m%d%H.log 3600&quot; combined</span><br></pre></td></tr></table></figure>

<p>再看apache rotatelogs语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rotatelogs [ -l ] logfile [ rotationtime [ offset ]] | [ filesizeM ]</span><br><span class="line"></span><br><span class="line">选项</span><br><span class="line">-l </span><br><span class="line">使用本地时间代替GMT时间作为时间基准。注意：在一个改变GMT偏移量(比如夏令时)的环境中使用-l会导致不可预料的结果。所以一定要加上-l 否则出现的日志时间和实际时间是相差8小时的。 </span><br><span class="line">logfile</span><br><span class="line">它加上基准名就是日志文件名。如果logfile中包含”%”，则它会被视为用于strftime()的格式字符串；否则它会被自动加上以秒为单位的”.nnnnnnnnnn”后缀。这两种格式都表示新的日志开始使用的时间。 </span><br><span class="line">rotationtime</span><br><span class="line">日志文件滚动的以秒为单位的间隔时间。 </span><br><span class="line">offset</span><br><span class="line">相对于UTC的时差的分钟数。如果省略，则假定为”0″并使用UTC时间。比如，要指定UTC时差为”-5小时”的地区的当地时间，则此参数应为”-300″。 </span><br><span class="line">filesizeM</span><br><span class="line">指定以filesizeM文件大小滚动，而不是按照时间或时差滚动。</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/10.23 - 10.27 linux任务计划和systemd管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/10.23 - 10.27 linux任务计划和systemd管理/" itemprop="url">10.23 - 10.27 linux任务计划和systemd管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="10-23-linux任务计划cron"><a href="#10-23-linux任务计划cron" class="headerlink" title="10.23 linux任务计划cron"></a>10.23 linux任务计划cron</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cat /etc/crontab  任务计划的配置文件</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"># For details see man 4 crontabs</span><br><span class="line"></span><br><span class="line"># Example of job definition:</span><br><span class="line"># .---------------- minute (0 - 59)      表示分钟</span><br><span class="line"># |  .------------- hour (0 - 23)        表示日</span><br><span class="line"># |  |  .---------- day of month (1 - 31) 表示月份</span><br><span class="line"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="line"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7)  OR sun,mon,tue,wed,thu,fri,sat    表示星期。0或者7都是表示周日</span><br><span class="line"># |  |  |  |  |</span><br><span class="line"># *  *  *  *  * user-name  command to be executed  最后一列是执行的命令</span><br><span class="line"></span><br><span class="line">[root@host ~]# crontab -e  定义任务计划配置，和vim使用方式差不多</span><br><span class="line"></span><br><span class="line">0 3 * * * /bin/bash  /usr/local/sbin/123.sh &gt;&gt;/tmp/123.log  2&gt;&gt;/tmp/123.log</span><br><span class="line">从凌晨的3点开始执行一个脚本，并把脚本的正确输出，与错误的输出重定向到123.log里去。</span><br><span class="line">格式解读：分,时，日，月，周，后跟执行的命令，*表示为所有的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 3 1-10  */2 2,5  /bin/bash  /usr/local/sbin/123.sh &gt;&gt;/tmp/123.log  2&gt;&gt;/tmp/123.log</span><br><span class="line">其中1-10表示1到10天，*/2 表示被2整除的数字比如月份就是双月的。2，5表示周二或周五开始执行命令，逗号表示或。</span><br><span class="line"></span><br><span class="line">[root@host ~]# systemctl start crond    启动服务</span><br><span class="line">[root@host ~]# systemctl status crond  查看crond的服务状态</span><br><span class="line">● crond.service - Command Scheduler</span><br><span class="line">  Loaded: loaded (/usr/lib/systemd/system/crond.service; enabled; vendor preset: enabled)</span><br><span class="line">  Active: active (running) since Sun 2017-07-16 23:39:04 EDT; 13h ago</span><br><span class="line">Main PID: 796 (crond)</span><br><span class="line">  CGroup: /system.slice/crond.service</span><br><span class="line">          └─796 /usr/sbin/crond -n</span><br><span class="line"></span><br><span class="line">Jul 16 23:39:04 host.localdomain crond[796]: (CRON) INFO (RANDOM_DELAY will be scaled with factor 35% if used.)</span><br><span class="line">Jul 16 23:39:04 host.localdomain crond[796]: (CRON) INFO (running with inotify support)</span><br><span class="line">Jul 16 23:39:04 host.localdomain systemd[1]: Started Command Scheduler.</span><br><span class="line">Jul 16 23:39:04 host.localdomain systemd[1]: Starting Command Scheduler...</span><br><span class="line"></span><br><span class="line">crontab -l  列出任务计划</span><br><span class="line">crontab -r  删除任务计划</span><br><span class="line">crontab -u root -l  制定一个用户，列出它的任务计划</span><br></pre></td></tr></table></figure>

<h1 id="10-24-chkconfig工具"><a href="#10-24-chkconfig工具" class="headerlink" title="10.24 chkconfig工具"></a>10.24 chkconfig工具</h1><blockquote>
<p>chkconfig命令检查、设置系统的各种服务。这是Red Hat公司遵循GPL规则所开发的程序，它可查询操作系统在每一个执行等级中会执行哪些系统服务，其中包括各类常驻服务。谨记chkconfig不是立即自动禁止或激活一个服务，它只是简单的改变了符号连接。 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">语法: chkconfig(选项)</span><br><span class="line">选项:</span><br><span class="line">--add：增加所指定的系统服务，让chkconfig指令得以管理它，并同时在系统启动的叙述文件内增加相关数据；</span><br><span class="line">--del：删除所指定的系统服务，不再由chkconfig指令管理，并同时在系统启动的叙述文件内删除相关数据；</span><br><span class="line">--level&lt;等级代号&gt;：指定读系统服务要在哪一个执行等级中开启或关毕。</span><br><span class="line"></span><br><span class="line">等级代号列表： </span><br><span class="line"></span><br><span class="line">等级0表示：表示关机 </span><br><span class="line">等级1表示：单用户模式 </span><br><span class="line">等级2表示：无网络连接的多用户命令行模式 </span><br><span class="line">等级3表示：有网络连接的多用户命令行模式 </span><br><span class="line">等级4表示：不可用 </span><br><span class="line">等级5表示：带图形界面的多用户模式 </span><br><span class="line">等级6表示：重新启动 </span><br><span class="line"></span><br><span class="line">需要说明的是，level选项可以指定要查看的运行级而不一定是当前运行级。对于每个运行级，只能有一个启动脚本或者停止脚本。当切换运行级时，init不会重新启动已经启动的服务，也不会再次去停止已经停止的服务。 </span><br><span class="line"></span><br><span class="line">运行级文件： </span><br><span class="line"></span><br><span class="line">每个被chkconfig管理的服务需要在对应的init.d下的脚本加上两行或者更多行的注释。第一行告诉chkconfig缺省启动的运行级以及启动和停止的优先级。如果某服务缺省不在任何运行级启动，那么使用-代替运行级。第二行对服务进行描述，可以用\跨行注释。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例如random.init包含三行： </span><br><span class="line"></span><br><span class="line"># chkconfig: 2345 20 80</span><br><span class="line"># description: Saves and restores system entropy pool for \</span><br><span class="line"># higher quality random number generation.</span><br></pre></td></tr></table></figure>

<p>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# chkconfig --list  列出所有的系统服务</span><br><span class="line"></span><br><span class="line">注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。 </span><br><span class="line">      如果您想列出 systemd 服务,请执行 &apos;systemctl list-unit-files&apos;。</span><br><span class="line">      欲查看对特定 target 启用的服务请执行</span><br><span class="line">      &apos;systemctl list-dependencies [target]&apos;。</span><br><span class="line"></span><br><span class="line">netconsole        0:off    1:off    2:off    3:off    4:off    5:off    6:off</span><br><span class="line">network            0:off    1:off    2:on    3:on    4:on    5:on    6:off</span><br><span class="line">qemukvmga          0:off    1:off    2:on    3:on    4:on    5:on    6:off</span><br><span class="line">shadowsocks        0:off    1:off    2:on    3:on    4:on    5:on    6:off</span><br><span class="line"></span><br><span class="line">[root@host ~]# ls /etc/init.d/    chkconfig 服务的脚本所在位置</span><br><span class="line">functions  netconsole  network  qemukvmga  README  shadowsocks</span><br><span class="line"></span><br><span class="line">chkconfig network off            chkconfig 关闭一个服务</span><br><span class="line">chkconfig --level 3 network off  关闭3级别的服务</span><br><span class="line"></span><br><span class="line">centos7之前系统的更改系统级别    vi /etc/inittab  centos7已不再使用</span><br><span class="line"></span><br><span class="line">chkconfig --level 345 network off 关闭3，4,5级别的服务</span><br><span class="line">chkconfig --del network          删除</span><br><span class="line">chkconfig --add network          增加</span><br></pre></td></tr></table></figure>

<h1 id="10-25-systemd管理服务"><a href="#10-25-systemd管理服务" class="headerlink" title="10.25 systemd管理服务"></a>10.25 systemd管理服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units-files                  把systemd下所有的socket，target，service都列出来</span><br><span class="line">systemctl list-units --all --type=service  把systemd下service都列出来</span><br><span class="line">systemctl list-units --type=service        把systemd下所有激活的service都列出来</span><br><span class="line"></span><br><span class="line">几个常用的服务相关的命令  @重点  需要记住</span><br><span class="line">systemctl enable crond.service              让服务开机启动（.service可以省略）</span><br><span class="line">systemctl disable crond                    不让开机启动</span><br><span class="line">systemctl status crond                      查看状态</span><br><span class="line">systemctl stop crond                        停止服务</span><br><span class="line">systemctl start crond                      启动服务</span><br><span class="line">systemctl restart crond                    重启服务</span><br><span class="line">systemctl is-enabled crond                  检查服务是否开机启动</span><br><span class="line"></span><br><span class="line">system的控制service的开机启动，实际是把service源路径的软连接，添加和删除到/etc/systemd/system/multi-user.target.wants/目录的的过程</span><br><span class="line">[root@host ~]# systemctl is-enabled crond</span><br><span class="line">enabled</span><br><span class="line">[root@host ~]# systemctl disable crond</span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/crond.service.</span><br><span class="line">[root@host ~]# systemctl enable crond</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/crond.service to /usr/lib/systemd/system/crond.service.</span><br><span class="line">[root@host ~]# ls -l /etc/systemd/system/multi-user.target.wants/crond.service to /usr/lib/systemd/system/crond.service.</span><br><span class="line">ls: cannot access to: No such file or directory</span><br><span class="line">ls: cannot access /usr/lib/systemd/system/crond.service.: No such file or directory</span><br><span class="line">lrwxrwxrwx 1 root root 37 Jul 18 10:04 /etc/systemd/system/multi-user.target.wants/crond.service -&gt; /usr/lib/systemd/system/crond.service</span><br><span class="line">[root@host ~]# ls -l /usr/lib/systemd/system/crond.service</span><br><span class="line">-rw-r--r--. 1 root root 284 Mar 31  2016 /usr/lib/systemd/system/crond.service</span><br></pre></td></tr></table></figure>

<h1 id="10-26-unit介绍"><a href="#10-26-unit介绍" class="headerlink" title="10.26 unit介绍"></a>10.26 unit介绍</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/lib/systemd/system      系统所有unit</span><br><span class="line">[root@host ~]# ls /usr/lib/systemd/system</span><br><span class="line">acpid.service                          dracut-pre-udev.service            machine.slice                      rhel-autorelabel-mark.service  sysinit.target                          systemd-readahead-done.service</span><br><span class="line">auditd.service                          dracut-shutdown.service            machines.target                    rhel-autorelabel.service      sysinit.target.wants                    systemd-readahead-done.timer</span><br><span class="line">autovt@.service                        ebtables.service                  messagebus.service                  rhel-configure.service        sys-kernel-config.mount                systemd-readahead-drop.service</span><br><span class="line">basic.target                            emergency.service                  microcode.service                  rhel-dmesg.service            sys-kernel-debug.mount                  systemd-readahead-replay.service</span><br><span class="line">basic.target.wants                      emergency.target                  multi-user.target                  rhel-domainname.service        syslog.socket                          systemd-reboot.service</span><br><span class="line">blk-availability.service                final.target                      multi-user.target.wants            rhel-import-state.service      syslog.target.wants                    systemd-remount-fs.service</span><br><span class="line">bluetooth.target                        firewalld.service                  NetworkManager-dispatcher.service  rhel-loadmodules.service      systemd-ask-password-console.path      systemd-rfkill@.service</span><br><span class="line">brandbot.path                          fstrim.service                    NetworkManager.service              rhel-readonly.service          systemd-ask-password-console.service    systemd-shutdownd.service</span><br><span class="line">brandbot.service                        fstrim.timer                      NetworkManager-wait-online.service  rpcbind.target                systemd-ask-password-plymouth.path      systemd-shutdownd.socket</span><br><span class="line">chrony-dnssrv@.service                  getty@.service                    network-online.target              rsyncd.service                systemd-ask-password-plymouth.service  systemd-suspend.service</span><br><span class="line">chrony-dnssrv@.timer                    getty.target                      network-online.target.wants        rsyncd@.service                systemd-ask-password-wall.path          systemd-sysctl.service</span><br><span class="line">chronyd.service                        graphical.target                  network-pre.target                  rsyncd.socket                  systemd-ask-password-wall.service      systemd-timedated.service</span><br><span class="line">chrony-wait.service                    graphical.target.wants            network.target                      rsyslog.service                systemd-backlight@.service              systemd-tmpfiles-clean.service</span><br><span class="line">console-getty.service                  halt-local.service                nss-lookup.target                  runlevel0.target              systemd-binfmt.service                  systemd-tmpfiles-clean.timer</span><br><span class="line">console-shell.service                  halt.target                        nss-user-lookup.target              runlevel1.target              systemd-bootchart.service              systemd-tmpfiles-setup-dev.service</span><br><span class="line">container-getty@.service                halt.target.wants                  paths.target                        runlevel1.target.wants        systemd-firstboot.service              systemd-tmpfiles-setup.service</span><br><span class="line">cpupower.service                        haveged.service                    plymouth-halt.service              runlevel2.target              systemd-fsck-root.service              systemd-udevd-control.socket</span><br><span class="line">crond.service                          hibernate.target                  plymouth-kexec.service              runlevel2.target.wants        systemd-fsck@.service                  systemd-udevd-kernel.socket</span><br><span class="line">cryptsetup-pre.target                  hybrid-sleep.target                plymouth-poweroff.service          runlevel3.target              systemd-halt.service                    systemd-udevd.service</span><br><span class="line">cryptsetup.target                      initrd-cleanup.service            plymouth-quit.service              runlevel3.target.wants        systemd-hibernate-resume@.service      systemd-udev-settle.service</span><br><span class="line">ctrl-alt-del.target                    initrd-fs.target                  plymouth-quit-wait.service          runlevel4.target              systemd-hibernate.service              systemd-udev-trigger.service</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">系统所有unit，分为以下类型:</span><br><span class="line">service    系统服务 </span><br><span class="line">target    多个unit组成的组</span><br><span class="line">device    硬件设备</span><br><span class="line">mount      文件系统挂载点</span><br><span class="line">automount  自动挂载点</span><br><span class="line">path      文件或路径</span><br><span class="line">scope      不是由systemd启动的外部进程</span><br><span class="line">slice      进程组</span><br><span class="line">snapshot  systemd快照</span><br><span class="line">socket    进程间通信套接字</span><br><span class="line">swap      swap文件</span><br><span class="line">timer      定时器</span><br></pre></td></tr></table></figure>

<ul>
<li>unit相关的命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-units            列出正在运行的unit</span><br><span class="line">systemctl list-units --all      列出所有，包括失败的或者inactive的</span><br><span class="line">systemctl list-units --all --state=inactive  列出inactive的unit</span><br><span class="line">systemctl list-units --type=service          列出状态为active的service</span><br><span class="line">systemct is-active crond.service            查看某个服务是否为active</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="10-27-target介绍"><a href="#10-27-target介绍" class="headerlink" title="10.27 target介绍"></a>10.27 target介绍</h1><ul>
<li><p>系统为了方便管理用target来管理unit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-unit-files --type=target        查看所有的target</span><br><span class="line">systemctl list-dependencies multi-user.target  查看指的定target下面有哪些unit（target下面还可以有target）</span><br><span class="line">systemctl get-default                          查看系统默认的target</span><br><span class="line">systemctl set-default multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>一个service属于一种类型的unit</p>
</li>
<li><p>多个unit组成了一个target</p>
</li>
<li><p>一个target里面包含了多个service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/lib/systemd/system/sshd.service    看[install]部分</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><ol>
<li>anacron <a href="http://blog.csdn.net/strikers1982/article/details/4787226" target="_blank" rel="noopener">http://blog.csdn.net/strikers1982/article/details/4787226</a></li>
<li>xinetd服(默认机器没有安装这个服务，需要yum install xinetd安装） <a href="http://blog.sina.com.cn/s/blog_465bbe6b010000vi.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_465bbe6b010000vi.html</a></li>
<li>systemd自定义启动脚本 <a href="http://www.jb51.net/article/100457.htm" target="_blank" rel="noopener">http://www.jb51.net/article/100457.htm</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.18 - 11.21 LAMP架构-Apache用户认证，域名跳转，Apache访问日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.18 - 11.21 LAMP架构-Apache用户认证，域名跳转，Apache访问日志/" itemprop="url">11.18 - 11.21 LAMP架构-Apache用户认证，域名跳转，Apache访问日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="11-18-Apache用户认证"><a href="#11-18-Apache用户认证" class="headerlink" title="11.18 Apache用户认证"></a>11.18 Apache用户认证</h1><blockquote>
<p>经常上网的读者会遇到这种情况：访问一些网站的某些资源时，浏览器弹出一个对话框，要求输入用户名和密码来获取对资源的访问。<br>这就是用户认证的一种技术。用户认证是保护网络系统资源的第一道防线，它控制着所有登录并检查访问用户的合法性，其目标是仅<br>让合法用户以合法的权限访问网络系统的资源。基本的用户认证技术是“用户名＋密码”。</p>
</blockquote>
<p>注意： 本章使用浏览器进行检测的前提是在物理机hosts文件添加虚拟机IP和虚拟主机域名。</p>
<h2 id="1-配置整个网站的用户认证"><a href="#1-配置整个网站的用户认证" class="headerlink" title="1. 配置整个网站的用户认证"></a>1. 配置整个网站的用户认证</h2><h3 id="1-1-编辑虚拟主机配置文件“httpd-vhosts-conf”"><a href="#1-1-编辑虚拟主机配置文件“httpd-vhosts-conf”" class="headerlink" title="1.1 编辑虚拟主机配置文件“httpd-vhosts.conf”"></a>1.1 编辑虚拟主机配置文件“httpd-vhosts.conf”</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">……</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    &lt;Directory /data/wwwroot/111.com&gt;</span><br><span class="line">    #指定认证的目录</span><br><span class="line">        Allowoverride AuthConfig               #该行相当于打开用户认证的开关</span><br><span class="line">        AuthName &quot;111.com user auth&quot;     #自定义认证的名字，作用不大</span><br><span class="line">        AuthType Basic                              #认证类型，一般为basic</span><br><span class="line">        AuthUserFile /data/.htpasswd        #指定密码文件所在位置（需要手动添加）</span><br><span class="line">        require valid-user                           #设定需要认证的用户为“AuthUserFile”中定义的所有可用用户</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/111.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-创建“httpd-vhosts-conf”中指定的密码文件"><a href="#1-2-创建“httpd-vhosts-conf”中指定的密码文件" class="headerlink" title="1.2 创建“httpd-vhosts.conf”中指定的密码文件"></a>1.2 创建“httpd-vhosts.conf”中指定的密码文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/apache2.4/bin/htpasswd -c -m /data/.htpasswd zhouqun</span><br><span class="line"># 在“/data/.htpasswd”为用户zhouqun创建一个使用MD5算法加密的密码文件</span><br><span class="line">New password: </span><br><span class="line">Re-type new password: </span><br><span class="line">Adding password for user zhouqun</span><br><span class="line"></span><br><span class="line">[root@adailinux ~]# cat /data/.htpasswd</span><br><span class="line">zhouqun:$apr1$F7lSqIT0$ksTH0NhusdaJK.7sgj/</span><br></pre></td></tr></table></figure>

<p>-c：为了创建文件以及第一个用户，文件存在或创建第二个用户时不需要使用<br>-m：表示密码使用MD5加密</p>
<h3 id="1-3-配置完成后重新加载"><a href="#1-3-配置完成后重新加载" class="headerlink" title="1.3 配置完成后重新加载"></a>1.3 配置完成后重新加载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br></pre></td></tr></table></figure>

<h3 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x192.168.2.130:80 111.com -I</span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">Date: Wed, 23 Aug 2017 00:32:50 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">WWW-Authenticate: Basic realm=&quot;111.com user auth&quot;</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1</span><br><span class="line">- 此时提示状态码为“401”，说明当前所访问的内容需要进行用户认证。</span><br><span class="line"></span><br><span class="line">- 使用 用户名和密码 访问</span><br><span class="line">[root@host ~]# curl -x192.168.2.130:80 -uzhouqun:123456 111.com -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 23 Aug 2017 00:34:26 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">X-Powered-By: PHP/5.6.30</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">- 状态码“200”，即访问成功。</span><br></pre></td></tr></table></figure>

<ul>
<li>用浏览器测试</li>
</ul>
<h2 id="2-配置单个文件的用户认证"><a href="#2-配置单个文件的用户认证" class="headerlink" title="2. 配置单个文件的用户认证"></a>2. 配置单个文件的用户认证</h2><h3 id="2-1-编辑虚拟主机配置文件“httpd-vhosts-conf”"><a href="#2-1-编辑虚拟主机配置文件“httpd-vhosts-conf”" class="headerlink" title="2.1 编辑虚拟主机配置文件“httpd-vhosts.conf”"></a>2.1 编辑虚拟主机配置文件“httpd-vhosts.conf”</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    #&lt;Directory /data/wwwroot/111.com&gt;   # 注释掉&lt; Directory &gt;，取消对目录设定的用户认证，更改为&lt; FilesMatch&gt;，即对文件设定用户认证</span><br><span class="line">&lt;FilesMatch admin.php&gt;          #因为是针对文件，所以使用&lt;FilesMatch&gt;，后面跟文件</span><br><span class="line">    AllowOverride AuthConfig    #表示开启认证</span><br><span class="line">    AuthName &quot;111.com user&quot;   #提示信息，可自定义</span><br><span class="line">    AuthType  Basic                   #认证类型，使用Basic即可</span><br><span class="line">    AuthUserFile  /data/wwwroot/.htpasswd       #认证密码文件位置</span><br><span class="line">    require valid-user                 #指定需要认证的用户为全部可用用户</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">    #&lt;/Directory&gt; </span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/111.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建“httpd-vhosts-conf”中指定的密码文件"><a href="#2-2-创建“httpd-vhosts-conf”中指定的密码文件" class="headerlink" title="2.2 创建“httpd-vhosts.conf”中指定的密码文件"></a>2.2 创建“httpd-vhosts.conf”中指定的密码文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/apache2.4/bin/htpasswd  -m /data/wwwroot/.htpasswd  zhouqun</span><br></pre></td></tr></table></figure>

<h3 id="2-3-配置完成后重新加载"><a href="#2-3-配置完成后重新加载" class="headerlink" title="2.3 配置完成后重新加载"></a>2.3 配置完成后重新加载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl  -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl  graceful</span><br></pre></td></tr></table></figure>

<h3 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4 测试"></a>2.4 测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x192.168.8.131:80  111.com </span><br><span class="line">welcome to 111.com  </span><br><span class="line"></span><br><span class="line">[root@host ~]# curl -x192.168.8.131:80  111.com/123.php -I</span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">Date: Wed, 23 Aug 2017 00:38:12 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">WWW-Authenticate: Basic realm=&quot;111.com user auth&quot;</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1</span><br><span class="line"></span><br><span class="line">- 此时可以自由访问“111.com”指定的目录，但是当访问目录下的“123.php”文件时会报错：401，即，需要进行用户认证。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用 用户名和密码 访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x192.168.2.130:80  -uadai:123456 111.com/123.php </span><br><span class="line">welcom to 123file    </span><br><span class="line">成功！</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用浏览器 访问</p>
</li>
</ul>
<h1 id="11-19-11-20-域名跳转"><a href="#11-19-11-20-域名跳转" class="headerlink" title="11.19/11.20 域名跳转"></a>11.19/11.20 域名跳转</h1><h2 id="1-域名跳转分类及区别"><a href="#1-域名跳转分类及区别" class="headerlink" title="1. 域名跳转分类及区别"></a>1. 域名跳转分类及区别</h2><h3 id="1-1-种类："><a href="#1-1-种类：" class="headerlink" title="1.1 种类："></a>1.1 种类：</h3><p>301表示永久跳转；302表示临时跳转。</p>
<h3 id="1-2-区别："><a href="#1-2-区别：" class="headerlink" title="1.2 区别："></a>1.2 区别：</h3><ul>
<li><p>使用效果不同</p>
<ul>
<li>302跳转是暂时的跳转，搜索引擎会抓取新的内容而保留旧的网址。因为服务器返回302代码，搜索引擎认为新的网址只是暂时的。</li>
<li>301重定向是永久的重定向，搜索引擎在抓取新内容的同时也将旧的网址替换为重定向之后的网址。</li>
</ul>
</li>
<li><p>SEO使用方式不同<br>在搜索引擎优化中302跳转被众多黑帽SEO优化人员追求，对网站进行恶意302跳转至非用户目标访问网站，因此搜索引擎对于网站的302跳转通常是比较不友好，所以要慎用302跳转！</p>
</li>
<li><p>SEO是什么？<br>SEO（Search Engine Optimization）搜索引擎优化，在了解搜索引擎自然排名机制的基础上，对网站进行内部及外部的调整优化，改进网站在搜索引擎中的关键词自然排名，获得更多流量，从而达成网站销售及品牌建设的预期目标。</p>
</li>
</ul>
<h2 id="2-域名跳转的作用"><a href="#2-域名跳转的作用" class="headerlink" title="2. 域名跳转的作用"></a>2. 域名跳转的作用</h2><ul>
<li>一个站点有多个域名会对SEO有影响，说白了就是百度搜索关键词的排名会收到影响，如果把多个域名全部跳转到指定的一个域名，这样以这个域名为中心，就可以吧权重集中在这个域名上，这样搜索关键词的排名也就靠前。</li>
<li>如果之前的某个域名不再使用了，但是搜索引擎还保留着之前老域名的连接，这以为着用户可能会搜到我们的网站并且点击老域名，固需要把老域名做个跳转跳到新域名。</li>
</ul>
<h2 id="3-域名跳转配置"><a href="#3-域名跳转配置" class="headerlink" title="3. 域名跳转配置"></a>3. 域名跳转配置</h2><h3 id="3-1-配置虚拟主机配置文件：httpd-vhosts-conf"><a href="#3-1-配置虚拟主机配置文件：httpd-vhosts-conf" class="headerlink" title="3.1 配置虚拟主机配置文件：httpd-vhosts.conf"></a>3.1 配置虚拟主机配置文件：httpd-vhosts.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">……</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    &lt;IfModule mod_rewrite.c&gt;                                             #需要mod_rewrite的支持</span><br><span class="line">        RewriteEngine on                                                      #开启rewrite功能</span><br><span class="line">        RewriteCond %&#123;HTTP_HOST&#125; !^111.com$               #Cond=condition，定义rewrite条件：所有非111.com的主机名（域名）</span><br><span class="line">        RewriteRule ^/(.*)$ http://111.com/$1 [R=301,L]        #定义rewrite规则：当满足上面条件时才执行当前规则，即跳转到111.com。</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/111.com-access_log&quot; common</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-检查系统配置并重新加载"><a href="#3-2-检查系统配置并重新加载" class="headerlink" title="3.2 检查系统配置并重新加载"></a>3.2 检查系统配置并重新加载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -M           #检查Apache是否加载了虚拟主机配置中调用的rewrite模块</span><br><span class="line"></span><br><span class="line">- 如果没有调用到，需要编辑Apache配置文件 “httpd.conf”</span><br><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf  </span><br><span class="line">……</span><br><span class="line">LoadModule rewrite_module modules/mod_rewrite.so    #去掉注释符号“#”，加载rewrite模块。</span><br><span class="line">LoadModule php5_module        modules/libphp5.so</span><br><span class="line">#LoadModule php7_module        modules/libphp7.so</span><br><span class="line"></span><br><span class="line">- 检测</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line">[root@host ~]#  /usr/local/apache2.4/bin/apachectl -M |grep rewrite</span><br><span class="line">rewrite_module (shared)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-使用curl检测"><a href="#3-3-使用curl检测" class="headerlink" title="3.3 使用curl检测"></a>3.3 使用curl检测</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x192.168.2.130:80 www.example.com -I</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Date: Wed, 23 Aug 2017 00:44:37 GMT</span><br><span class="line">Server: Apache/2.4.27 (Unix) PHP/5.6.30</span><br><span class="line">Location: http://111.com/</span><br><span class="line">Content-Type: text/html; charset=iso-8859-1</span><br><span class="line"></span><br><span class="line">状态码为301，即设定了域名永久跳转!</span><br><span class="line">在浏览器进行检测时，访问“www.example.com”会直接跳转到“111.com”。</span><br></pre></td></tr></table></figure>

<h1 id="11-21-Apache访问日志"><a href="#11-21-Apache访问日志" class="headerlink" title="11.21 Apache访问日志"></a>11.21 Apache访问日志</h1><p>访问日志记录用户的每一个请求</p>
<h2 id="1-设置Apache访问日志格式"><a href="#1-设置Apache访问日志格式" class="headerlink" title="1. 设置Apache访问日志格式"></a>1. 设置Apache访问日志格式</h2><h3 id="1-1-Apache访问日志位置"><a href="#1-1-Apache访问日志位置" class="headerlink" title="1.1 Apache访问日志位置"></a>1.1 Apache访问日志位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# ls /usr/local/apache2.4/logs</span><br><span class="line">111.com-access_log  abc.com-access_log  access_log  httpd.pid</span><br><span class="line">111.com-error_log  abc.com-error_log  error_log</span><br></pre></td></tr></table></figure>

<h3 id="1-2-系统自带日志格式"><a href="#1-2-系统自带日志格式" class="headerlink" title="1.2 系统自带日志格式"></a>1.2 系统自带日志格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/httpd.conf                 # 搜索LogFormat </span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br><span class="line">    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common</span><br><span class="line"># h表示host来源IP，l表示login用户，u表示user用户密码，t表示time时间，r表示request（行为），s表示status状态码，b表示byte大小</span><br><span class="line"># user-agent：用户代理</span><br><span class="line"># referer：跳转到当前位置的上一个网址（即：提供当前IP的网站）</span><br></pre></td></tr></table></figure>

<p>combinedio是combined的升级，一般我们使用combined格式就足够了。</p>
<h3 id="1-3-设置访问日志格式"><a href="#1-3-设置访问日志格式" class="headerlink" title="1.3 设置访问日志格式"></a>1.3 设置访问日志格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot &quot;/data/wwwroot/111.com&quot;</span><br><span class="line">    ServerName 111.com</span><br><span class="line">    ServerAlias www.example.com</span><br><span class="line">    &lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">        RewriteEngine on</span><br><span class="line">        RewriteCond %&#123;HTTP_HOST&#125; !^111.com$</span><br><span class="line">        RewriteRule ^/(.*)$ http://111.com/$1 [R=301,L]</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    ErrorLog &quot;logs/111.com-error_log&quot;</span><br><span class="line">    CustomLog &quot;logs/111.com-access_log&quot; combined     # 将comom修改为combined即可</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">- 重新加载：</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@host ~]# /usr/local/apache2.4/bin/apachectl graceful</span><br><span class="line"></span><br><span class="line">- 样式：</span><br><span class="line">[root@host ~]# cat /usr/local/apache2.4/logs/111.com-access_log</span><br></pre></td></tr></table></figure>




<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="apache虚拟主机开启php的短标签"><a href="#apache虚拟主机开启php的短标签" class="headerlink" title="apache虚拟主机开启php的短标签"></a>apache虚拟主机开启php的短标签</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/apache2.4/conf/extra/httpd-vhosts.conf</span><br><span class="line">php_admin_flag short_open_tag on    #这一行变为on就好了，默认是off的</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/11.6 - 11.9 LAMP架构-mariadb、apache httpd安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/11.6 - 11.9 LAMP架构-mariadb、apache httpd安装/" itemprop="url">11.6 - 11.9 LAMP架构-mariadb、apache httpd安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[toc]</p>
<h1 id="11-6-MariaDB安装"><a href="#11-6-MariaDB安装" class="headerlink" title="11.6 MariaDB安装"></a>11.6 MariaDB安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src    #进入制定目录</span><br><span class="line">wget https://downloads.mariadb.com/MariaDB/mariadb-10.2.6/bintar-linux-glibc_214-x86_64/mariadb-10.2.6-linux-glibc_214-x86_64.tar.gz  #到官网下载mariaDB二进制包</span><br><span class="line">tar zxvf mariadb-10.2.6-linux-glibc_214-x86_64.tar.gz    #将包解压到当前目录</span><br><span class="line">mv mariadb-10.2.6-linux-glibc_214-x86_64 /usr/local/mariadb  #将mariaDB的glibc文件移动到/usr/local/mariadb目录</span><br><span class="line">cd /usr/local/mariadb  #进入目录</span><br><span class="line">mkdir /data/</span><br><span class="line">useradd mysql  #添加mysql用户</span><br><span class="line">./scripts/mysql_install_db --user=mysql --basedir=/usr/local/mariadb --datadir=/data/mariadb  #执行mysql初始化命令</span><br><span class="line">/usr/local/mariadb//bin/mysqld: error while loading shared libraries: libaio.so.1: cannot open shared object file: No such file or directory #报错，缺少文件libaio</span><br><span class="line">yum list | grep libaio   #寻找libaio包，如下，一般我们缺少的包，安装devel或者deb的包就好</span><br><span class="line">libaio.i686                                0.3.109-13.el7              base    </span><br><span class="line">libaio.x86_64                              0.3.109-13.el7              base    </span><br><span class="line">libaio-devel.i686                          0.3.109-13.el7              base    </span><br><span class="line">libaio-devel.x86_64                        0.3.109-13.el7              base</span><br><span class="line">yum install libaio-devel.x86_64  #安装</span><br><span class="line">./scripts/mysql_install_db --user=mysql --basedir=/usr/local/mariadb  --datadir=/data/mariadb  #再次执行mysql初始化命令</span><br><span class="line">echo $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">cp support-files/my-small.cnf /usr/local/mariadb/my.cnf   #复制源配置文件到mariadb下面，在 [mysqld]里定义basedir</span><br><span class="line">和datadir，如果系统同时有mysql的话，可能或调用mysql的basedir和datadir</span><br><span class="line">vim /usr/local/mariadb/my.cnf </span><br><span class="line">  basedir=/usr/local/mariadb</span><br><span class="line">  datadir=/data/mariadb</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mariadb              #复制mysql服务配置文件到mariadb下面，需要修改参数</span><br><span class="line">vim /etc/init.d/mariadb //定义basedir、datadir、conf以及启动参数 </span><br><span class="line">  basedir=/usr/local/mariadb</span><br><span class="line">  datadir=/data/mariadb</span><br><span class="line">  conf=$basedir/my.cnf</span><br><span class="line">...  ...</span><br><span class="line"></span><br><span class="line">case &quot;$mode&quot; in</span><br><span class="line">  &apos;start&apos;)</span><br><span class="line">    # Start daemon</span><br><span class="line"></span><br><span class="line">    # Safeguard (relative paths, core dumps..)</span><br><span class="line">    cd $basedir</span><br><span class="line"></span><br><span class="line">    echo $echo_n &quot;Starting MySQL&quot;</span><br><span class="line">    if test -x $bindir/mysqld_safe</span><br><span class="line">    then</span><br><span class="line">      # Give extra arguments to mysqld with the my.cnf file. This script</span><br><span class="line">      # may be overwritten at next upgrade.</span><br><span class="line">      $bindir/mysqld_safe --defaults-file=&quot;$conf&quot; --datadir=&quot;$datadir&quot; --pid-file=&quot;$mysqld_pid_file_path&quot; &quot;$@&quot; &amp;</span><br><span class="line">      wait_for_ready; return_value=$?</span><br><span class="line"></span><br><span class="line">/etc/init.d/mariadb start   #启动</span><br><span class="line">ps aux | grep mariadb     #确认下是否正常启动，YES</span><br><span class="line">root    11492  0.0  0.6 115388  3308 ?        S    12:45  0:00 /bin/sh /usr/local/mariadb/bin/mysqld_safe --defaults-file=/usr/local/mariadb/my.cnf --datadir=/data/mariadb --pid-file=/data/mariadb/joking.pid</span><br><span class="line">mysql    11611  0.0 10.8 1125112 56148 ?      Sl  12:45  0:00 /usr/local/mariadb/bin/mysqld --defaults-file=/usr/local/mariadb/my.cnf --basedir=/usr/local/mariadb --datadir=/data/mariadb --plugin-dir=/usr/local/mariadb/lib/plugin --user=mysql --log-error=/data/mariadb/joking.err --pid-file=/data/mariadb/joking.pid --socket=/tmp/mysql.sock --port=3306</span><br><span class="line">root    11770  0.0  0.4 112656  2260 pts/0    S+  12:54  0:00 grep --color=auto mariadb</span><br><span class="line"></span><br><span class="line">netstat -ltnp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address          Foreign Address        State      PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*              LISTEN      1895/master        </span><br><span class="line">tcp        0      0 0.0.0.0:28206          0.0.0.0:*              LISTEN      1083/sshd          </span><br><span class="line">tcp6      0      0 ::1:25                  :::*                    LISTEN      1895/master        </span><br><span class="line">tcp6      0      0 :::3306                :::*                    LISTEN      11611/mysqld        </span><br><span class="line">tcp6      0      0 :::28206                :::*                    LISTEN      1083/sshd</span><br></pre></td></tr></table></figure>

<h1 id="11-7-11-8-11-9-Apache安装"><a href="#11-7-11-8-11-9-Apache安装" class="headerlink" title="11.7/11.8/11.9 Apache安装"></a>11.7/11.8/11.9 Apache安装</h1><p>Apache是一个基金会的名字，httpd才是我们要安装的软件包，早期它的名字就叫apache，现在主流版本是2.4<br>2.2和2.4的安装方法不同，涉及到依赖的APR通用函数库版本不同，我们的CentOS7自带的APR包是2.2的，而2.4的需要下载自己编译<br>Apache官网<a href="http://www.apache.org" target="_blank" rel="noopener">www.apache.org</a></p>
<h2 id="1-先下载下列这些包到-usr-local-src"><a href="#1-先下载下列这些包到-usr-local-src" class="headerlink" title="1. 先下载下列这些包到  /usr/local/src/"></a>1. 先下载下列这些包到  /usr/local/src/</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget http://mirrors.cnnic.cn/apache/httpd/httpd-2.4.27.tar.gz      #httpd的二进制包</span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/apr/apr-1.6.2.tar.gz         # APR库源码包</span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/apr/apr-util-1.6.0.tar.gz   # APR-util库源码包</span><br><span class="line"># apr和apr-util是一个通用的函数库，它让httpd可以不关心底层的操作系统平台，可以很方便地移植（从linux移植到windows）</span><br></pre></td></tr></table></figure>

<h2 id="2-解压这些包"><a href="#2-解压这些包" class="headerlink" title="2. 解压这些包"></a>2. 解压这些包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf httpd-2.4.27.tar.gz </span><br><span class="line">tar zxvf apr-1.6.2.tar.gz  </span><br><span class="line">tar zxvf apr-util-1.6.0.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="3-安装APR"><a href="#3-安装APR" class="headerlink" title="3.安装APR"></a>3.安装APR</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/apr-1.6.2</span><br><span class="line">./configure --prefix=/usr/local/apr</span><br><span class="line">echo $?  #检查安装是否成功</span><br><span class="line">0             # 0表示OK</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">报错</span><br><span class="line">rm: cannot remove &apos;libtoolT&apos;: No such file or directory</span><br><span class="line">解决：编辑 configure文件，查找 $RM &quot;$cfgfile&quot; 这个地方，用#注释掉</span><br><span class="line">vim configure   </span><br><span class="line">/$RM &quot;$cfgfile        //查找这个，并用#注释掉</span><br></pre></td></tr></table></figure>

<h2 id="4-安装APR-util"><a href="#4-安装APR-util" class="headerlink" title="4. 安装APR-util"></a>4. 安装APR-util</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/apr-util-1.6.0</span><br><span class="line">./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr   # 这个需要制定依赖apr</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">报错</span><br><span class="line">xml/apr_xml.c:35:19: fatal error: expat.h: No such file or directory</span><br><span class="line">解决：安装expat库</span><br><span class="line">yum install expat-devel</span><br></pre></td></tr></table></figure>

<h2 id="5-安装httpd-2-4"><a href="#5-安装httpd-2-4" class="headerlink" title="5. 安装httpd 2.4"></a>5. 安装httpd 2.4</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/httpd-2.4.27</span><br><span class="line">./configure \         #这里的反斜杠是脱义字符，加上它我们可以把一行命令写成多行</span><br><span class="line">--prefix=/usr/local/apache2.4 \</span><br><span class="line">--with-apr=/usr/local/apr \</span><br><span class="line">--with-apr-util=/usr/local/apr-util \</span><br><span class="line">--enable-so \       #表示开启支持动态扩展模块，PHP还有Appache都支持以模块的形式存在</span><br><span class="line">--enable-mods-shared=most  #表示开启大多数模块</span><br><span class="line"></span><br><span class="line">#如果输出错误，说缺少pcre包的话</span><br><span class="line">yum list | grep pcre</span><br><span class="line">yum install -y pcre-devel.x86_64</span><br><span class="line"></span><br><span class="line">./configure \ --prefix=/usr/local/apache2.4  --with-apr=/usr/local/apr  --with-apr-util=/usr/local/apr-util  --enable-so  --enable-mods-shared=most     这句是错了</span><br><span class="line">./configure --prefix=/usr/local/apache2.4 --with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-so --enable-mods-shared=most</span><br><span class="line">echo $?    #确认上条命令是都OK</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="6-Apache相关文件和模块"><a href="#6-Apache相关文件和模块" class="headerlink" title="6. Apache相关文件和模块"></a>6. Apache相关文件和模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@joking httpd-2.4.27]# cd /usr/local/apache2.4/</span><br><span class="line">[root@joking apache2.4]# ls</span><br><span class="line">bin  build  cgi-bin  conf  error  htdocs  icons  include  logs  man  manual  modules</span><br><span class="line">[root@joking apache2.4]# ls bin/httpd</span><br><span class="line">bin/httpd</span><br><span class="line">[root@joking apache2.4]# du -sh !$</span><br><span class="line">du -sh bin/httpd</span><br><span class="line">2.3M    bin/httpd</span><br><span class="line">[root@joking apache2.4]# ls conf/</span><br><span class="line">extra  httpd.conf  magic  mime.types  original</span><br><span class="line">[root@joking apache2.4]# ls htdocs/</span><br><span class="line">index.html</span><br><span class="line">[root@joking apache2.4]# ls logs/</span><br><span class="line">[root@joking apache2.4]# ls modules/</span><br><span class="line">httpd.exp            mod_authn_dbd.so        mod_authz_user.so    mod_deflate.so    mod_info.so                mod_negotiation.so    mod_proxy_scgi.so      mod_session_dbd.so      mod_substitute.so</span><br><span class="line">mod_access_compat.so  mod_authn_dbm.so        mod_autoindex.so      mod_dir.so        mod_lbmethod_bybusyness.so  mod_proxy_ajp.so      mod_proxy.so          mod_session.so          mod_unique_id.so</span><br><span class="line">mod_actions.so        mod_authn_file.so      mod_buffer.so        mod_dumpio.so      mod_lbmethod_byrequests.so  mod_proxy_balancer.so  mod_proxy_wstunnel.so  mod_setenvif.so          mod_unixd.so</span><br><span class="line">mod_alias.so          mod_authn_socache.so    mod_cache_disk.so    mod_env.so        mod_lbmethod_bytraffic.so  mod_proxy_connect.so  mod_ratelimit.so      mod_slotmem_shm.so      mod_userdir.so</span><br><span class="line">mod_allowmethods.so  mod_authz_core.so      mod_cache.so          mod_expires.so    mod_lbmethod_heartbeat.so  mod_proxy_express.so  mod_remoteip.so        mod_socache_dbm.so      mod_version.so</span><br><span class="line">mod_auth_basic.so    mod_authz_dbd.so        mod_cache_socache.so  mod_ext_filter.so  mod_log_config.so          mod_proxy_fcgi.so      mod_reqtimeout.so      mod_socache_memcache.so  mod_vhost_alias.so</span><br><span class="line">mod_auth_digest.so    mod_authz_dbm.so        mod_cgid.so          mod_file_cache.so  mod_log_debug.so            mod_proxy_fdpass.so    mod_request.so        mod_socache_shmcb.so    mod_watchdog.so</span><br><span class="line">mod_auth_form.so      mod_authz_groupfile.so  mod_dav_fs.so        mod_filter.so      mod_logio.so                mod_proxy_ftp.so      mod_rewrite.so        mod_speling.so</span><br><span class="line">mod_authn_anon.so    mod_authz_host.so      mod_dav.so            mod_headers.so    mod_macro.so                mod_proxy_hcheck.so    mod_sed.so            mod_ssl.so</span><br><span class="line">mod_authn_core.so    mod_authz_owner.so      mod_dbd.so            mod_include.so    mod_mime.so                mod_proxy_http.so      mod_session_cookie.so  mod_status.so</span><br><span class="line">[root@joking apache2.4]# du -sh modules/</span><br><span class="line">7.3M    modules/</span><br><span class="line">[root@joking apache2.4]# </span><br><span class="line">[root@joking apache2.4]# ls /usr/local/apache2.4/modules</span><br><span class="line">httpd.exp            mod_authn_dbd.so        mod_authz_user.so    mod_deflate.so    mod_info.so                mod_negotiation.so    mod_proxy_scgi.so      mod_session_dbd.so      mod_substitute.so</span><br><span class="line">mod_access_compat.so  mod_authn_dbm.so        mod_autoindex.so      mod_dir.so        mod_lbmethod_bybusyness.so  mod_proxy_ajp.so      mod_proxy.so          mod_session.so          mod_unique_id.so</span><br><span class="line">mod_actions.so        mod_authn_file.so      mod_buffer.so        mod_dumpio.so      mod_lbmethod_byrequests.so  mod_proxy_balancer.so  mod_proxy_wstunnel.so  mod_setenvif.so          mod_unixd.so</span><br><span class="line">mod_alias.so          mod_authn_socache.so    mod_cache_disk.so    mod_env.so        mod_lbmethod_bytraffic.so  mod_proxy_connect.so  mod_ratelimit.so      mod_slotmem_shm.so      mod_userdir.so</span><br><span class="line">mod_allowmethods.so  mod_authz_core.so      mod_cache.so          mod_expires.so    mod_lbmethod_heartbeat.so  mod_proxy_express.so  mod_remoteip.so        mod_socache_dbm.so      mod_version.so</span><br><span class="line">mod_auth_basic.so    mod_authz_dbd.so        mod_cache_socache.so  mod_ext_filter.so  mod_log_config.so          mod_proxy_fcgi.so      mod_reqtimeout.so      mod_socache_memcache.so  mod_vhost_alias.so</span><br><span class="line">mod_auth_digest.so    mod_authz_dbm.so        mod_cgid.so          mod_file_cache.so  mod_log_debug.so            mod_proxy_fdpass.so    mod_request.so        mod_socache_shmcb.so    mod_watchdog.so</span><br><span class="line">mod_auth_form.so      mod_authz_groupfile.so  mod_dav_fs.so        mod_filter.so      mod_logio.so                mod_proxy_ftp.so      mod_rewrite.so        mod_speling.so</span><br><span class="line">mod_authn_anon.so    mod_authz_host.so      mod_dav.so            mod_headers.so    mod_macro.so                mod_proxy_hcheck.so    mod_sed.so            mod_ssl.so</span><br><span class="line">mod_authn_core.so    mod_authz_owner.so      mod_dbd.so            mod_include.so    mod_mime.so                mod_proxy_http.so      mod_session_cookie.so  mod_status.so</span><br><span class="line">[root@joking apache2.4]# /usr/local/apache2.4/bin/httpd -M    #查看加载的模块</span><br><span class="line"># /usr/local/apache2.4/bin/apachectl -M   #同上，利用shell调用httpd</span><br><span class="line"></span><br><span class="line">AH00558: httpd: Could not reliably determine the server&apos;s fully qualified domain name, using 127.0.1.1. Set the &apos;ServerName&apos; directive globally to suppress this message</span><br><span class="line">Loaded Modules:</span><br><span class="line">core_module (static)</span><br><span class="line">so_module (static)</span><br><span class="line">http_module (static)</span><br><span class="line">mpm_event_module (static)</span><br><span class="line">authn_file_module (shared)</span><br><span class="line">authn_core_module (shared)</span><br><span class="line">authz_host_module (shared)</span><br><span class="line">authz_groupfile_module (shared)</span><br><span class="line">authz_user_module (shared)</span><br><span class="line">authz_core_module (shared)</span><br><span class="line">access_compat_module (shared)</span><br><span class="line">auth_basic_module (shared)</span><br><span class="line">reqtimeout_module (shared)</span><br><span class="line">filter_module (shared)</span><br><span class="line">mime_module (shared)</span><br><span class="line">log_config_module (shared)</span><br><span class="line">env_module (shared)</span><br><span class="line">headers_module (shared)</span><br><span class="line">setenvif_module (shared)</span><br><span class="line">version_module (shared)</span><br><span class="line">unixd_module (shared)</span><br><span class="line">status_module (shared)</span><br><span class="line">autoindex_module (shared)</span><br><span class="line">dir_module (shared)</span><br><span class="line">alias_module (shared)</span><br><span class="line"></span><br><span class="line">(static)    --原封模块</span><br><span class="line">(shared)  --扩展模块</span><br></pre></td></tr></table></figure>

<h2 id="7-启动apache"><a href="#7-启动apache" class="headerlink" title="7. 启动apache"></a>7. 启动apache</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@joking apache2.4]# /usr/local/apache2.4/bin/apachectl start  #有提示，但并不是错误的</span><br><span class="line">AH00558: httpd: Could not reliably determine the server&apos;s fully qualified domain name, using host.localdomain. Set the &apos;ServerName&apos; directive globally to suppress this message</span><br><span class="line">[root@joking apache2.4]# ps aux | grep httpd</span><br><span class="line">root    27772  0.0  0.8  95520  4364 ?        Ss  10:15  0:00 /usr/local/apache2.4/bin/httpd -k start</span><br><span class="line">daemon  27773  0.0  0.8 382348  4416 ?        Sl  10:15  0:00 /usr/local/apache2.4/bin/httpd -k start</span><br><span class="line">daemon  27774  0.0  0.8 382348  4416 ?        Sl  10:15  0:00 /usr/local/apache2.4/bin/httpd -k start</span><br><span class="line">daemon  27775  0.0  0.8 382348  4416 ?        Sl  10:15  0:00 /usr/local/apache2.4/bin/httpd -k start</span><br><span class="line">root    27858  0.0  0.4 112656  2312 pts/0    R+  10:16  0:00 grep --color=auto httpd</span><br><span class="line">[root@joking apache2.4]# netstat -lntp   #查看端口</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address          Foreign Address        State      PID/Program name    </span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*              LISTEN      1506/master        </span><br><span class="line">tcp        0      0 0.0.0.0:28206          0.0.0.0:*              LISTEN      1059/sshd          </span><br><span class="line">tcp6      0      0 ::1:25                  :::*                    LISTEN      1506/master        </span><br><span class="line">tcp6      0      0 :::3306                :::*                    LISTEN      2866/mysqld        </span><br><span class="line">tcp6      0      0 :::28206                :::*                    LISTEN      1059/sshd          </span><br><span class="line">tcp6      0      0 :::80                  :::*                    LISTEN      27772/httpd</span><br></pre></td></tr></table></figure>

<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="1-apache-dso"><a href="#1-apache-dso" class="headerlink" title="1. apache dso"></a>1. apache dso</h2><p><a href="https://yq.aliyun.com/articles/6298" target="_blank" rel="noopener">https://yq.aliyun.com/articles/6298</a></p>
<h2 id="2-apache-apxs"><a href="#2-apache-apxs" class="headerlink" title="2. apache apxs"></a>2. apache apxs</h2><p><a href="http://man.chinaunix.net/newsoft/ApacheMenual_CN_2.2new/programs/apxs.html" target="_blank" rel="noopener">http://man.chinaunix.net/newsoft/ApacheMenual_CN_2.2new/programs/apxs.html</a></p>
<h2 id="3-apache工作模式"><a href="#3-apache工作模式" class="headerlink" title="3. apache工作模式"></a>3. apache工作模式</h2><p><a href="http://www.cnblogs.com/fnng/archive/2012/11/20/2779977.html" target="_blank" rel="noopener">http://www.cnblogs.com/fnng/archive/2012/11/20/2779977.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/12.1 - 12.5 LNMP架构介绍、MySQL安装、PHP安装、Nginx介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/12.1 - 12.5 LNMP架构介绍、MySQL安装、PHP安装、Nginx介绍/" itemprop="url">12.1 - 12.5 LNMP架构介绍、MySQL安装、PHP安装、Nginx介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#12.1 LNMP架构介绍</p>
<blockquote>
<p> LNMP代表的就是：Linux系统下Nginx+MySQL+PHP这种网站服务器架构。</p>
</blockquote>
<ul>
<li>和LAMP不同的是，提供web服务的是Nginx</li>
<li>并且php是作为一个独立服务存在的，这个服务叫做php-fpm</li>
<li>Nginx直接处理静态请求，动态请求会转发给php-fpm。</li>
</ul>
<p>#12.2 MySQL安装</p>
<h2 id="卸载二进制包安装的MySQL"><a href="#卸载二进制包安装的MySQL" class="headerlink" title="卸载二进制包安装的MySQL"></a>卸载二进制包安装的MySQL</h2><p>确认MySQL服务运行状态，并停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# ps -ef | grep mysql</span><br><span class="line">[root@host ~]# /etc/init.d/mysql.server status</span><br><span class="line">[root@host ~]# /etc/init.d/mysql.server stop</span><br></pre></td></tr></table></figure>

<p>删除MySQL安装时的相关文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# rm -rf /usr/local/mysql </span><br><span class="line">[root@host ~]# rm -rf /etc/init.d/mysqld </span><br><span class="line">[root@host ~]# rm -rf /data/mysql</span><br></pre></td></tr></table></figure>

<h2 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h2><p>和之前LAMP环境安装MySQL的方法一样<br>11.1 LAMP架构介绍+11.2 MySQL_MariaDB介绍+11.3-11. 5MySQL安装.md</p>
<p>#12.3/12.4 PHP安装<br>和LAMP安装PHP有区别，需要开启php-fpm服务。</p>
<p>##准备PHP的包和用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/src/</span><br><span class="line">[root@host src]# wget http://cn2.php.net/distributions/php-5.6.30.tar.gz   //下载php二进制包</span><br><span class="line">[root@host src]# tar zxvf php-5.6.30.tar.gz   //解压缩</span><br><span class="line">[root@host  src]# useradd -s /sbin/nologin php-fpm   //创建专门账号用来运行php-fpm服务，因为在LNMP环境中，PHP是以一种服务的形式独立存在的</span><br></pre></td></tr></table></figure>

<p>##卸载之前编译安装的PHP（如果之前有安装的话）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/src</span><br><span class="line">[root@host src]# ls</span><br><span class="line">[root@host src]# cd php-5.6.30</span><br><span class="line">[root@host php-5.6.30]# ls</span><br><span class="line">[root@host php-5.6.30]# make clean</span><br></pre></td></tr></table></figure>

<p>##安装PHP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# cd php-5.6.30</span><br><span class="line">[root@host php-5.6.30]# ./configure --prefix=/usr/local/php-fpm --with-config-file-path=/usr/local/php-fpm/etc --enable-fpm --with-fpm-user=php-fpm --with-fpm-group=php-fpm --with-mysql=/usr/local/mysql --with-mysqli=/usr/local/mysql/bin/mysql_config --with-pdo-mysql=/usr/local/mysql --with-mysql-sock=/tmp/mysql.sock --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-ftp --enable-mbstring --enable-exif --with-pear --with-curl  --with-openssl   //初始化</span><br><span class="line"></span><br><span class="line">另外，附php7.1的./configure ，从lnmp.org的脚本copy来的。  </span><br><span class="line">[root@localhost php-7.1.6]#      </span><br><span class="line">./configure --prefix=/usr/local/php-fpm --with-config-file-path=/usr/local/php-fpm/etc --enable-fpm --with-fpm-user=php-fpm --with-fpm-group=php-fpm --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-mysql-sock=/tmp/mysql.sock --with-libxml-dir --with-gd --with-jpeg-dir --with-png-dir --with-freetype-dir --with-iconv-dir --with-zlib-dir --with-mcrypt --enable-soap --enable-gd-native-ttf --enable-ftp --enable-mbstring --enable-exif --with-pear --with-curl --with-openssl</span><br><span class="line"></span><br><span class="line">附php7.2的./configure</span><br><span class="line">[root@localhost php-7.2.10]# ./configure \</span><br><span class="line">--prefix=/usr/local/php \</span><br><span class="line">--with-config-file-path=/usr/local/php/etc \</span><br><span class="line">--with-config-file-scan-dir=/usr/local/php/conf.d \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--with-fpm-user=www \</span><br><span class="line">--with-fpm-group=www \</span><br><span class="line">--enable-mysqlnd \</span><br><span class="line">--with-mysqli=mysqlnd \</span><br><span class="line">--with-pdo-mysql=mysqlnd \</span><br><span class="line">--with-iconv-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-png-dir \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-libxml-dir \</span><br><span class="line">--enable-xml \</span><br><span class="line">--disable-rpath \</span><br><span class="line">--enable-bcmath \</span><br><span class="line">--enable-shmop \</span><br><span class="line">--enable-sysvsem \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--with-curl \</span><br><span class="line">--enable-mbregex \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--enable-intl \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-ftp \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-openssl \</span><br><span class="line">--with-mhash \</span><br><span class="line">--enable-pcntl \</span><br><span class="line">--enable-sockets \</span><br><span class="line">--with-xmlrpc \</span><br><span class="line">--enable-zip \</span><br><span class="line">--enable-soap \</span><br><span class="line">--with-gettext \</span><br><span class="line">--disable-fileinfo \</span><br><span class="line">--enable-opcache \</span><br><span class="line">--with-xsl</span><br></pre></td></tr></table></figure>

<p>##编译过程中的出错排查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">汇总</span><br><span class="line">yum install -y  libxml2 libxml2-devel openssl openssl-devel libcurl libcurl-devel  libjpeg libjpeg-turbo-devel libpng libpng-devel freetype freetype-devel libmcrypt libmcrypt-devel php-mcrypt  libmcrypt  libmcrypt-devel</span><br></pre></td></tr></table></figure>

<p>错误1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onfigure: error: xml2-config not found. Please check your libxml2 installation.</span><br></pre></td></tr></table></figure>

<p>解决办法1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum list |grep libxml2</span><br><span class="line">libxml2.x86_64                          2.9.1-6.el7_2.3                @anaconda</span><br><span class="line">libxml2.i686                            2.9.1-6.el7_2.3                base    </span><br><span class="line">libxml2-devel.i686                      2.9.1-6.el7_2.3                base    </span><br><span class="line">libxml2-devel.x86_64                    2.9.1-6.el7_2.3                base    </span><br><span class="line">libxml2-python.x86_64                  2.9.1-6.el7_2.3                base    </span><br><span class="line">libxml2-static.i686                    2.9.1-6.el7_2.3                base    </span><br><span class="line">libxml2-static.x86_64                  2.9.1-6.el7_2.3                base    </span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# yum install -y libxml2 libxml2-devel     //一般只需要安裝devel的庫文件就好了</span><br></pre></td></tr></table></figure>

<p>错误2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: Cannot find OpenSSL&apos;s &lt;evp.h&gt;</span><br></pre></td></tr></table></figure>

<p>解决办法2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>错误3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">configure: error: Please reinstall the libcurl distribution -</span><br><span class="line">    easy.h should be in &lt;curl-dir&gt;/include/curl/</span><br></pre></td></tr></table></figure>

<p>解决办法3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y libcurl libcurl-devel</span><br></pre></td></tr></table></figure>

<p>错误4：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: jpeglib.h not found.</span><br></pre></td></tr></table></figure>

<p>解决办法4：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y libjpeg libjpeg-turbo-devel</span><br></pre></td></tr></table></figure>

<p>错误5：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: png.h not found.</span><br></pre></td></tr></table></figure>

<p>解决办法5：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y libpng libpng-devel</span><br></pre></td></tr></table></figure>

<p>错误6：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: freetype-config not found.</span><br></pre></td></tr></table></figure>

<p>解决办法6：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y freetype freetype-devel</span><br></pre></td></tr></table></figure>

<p>错误7：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: mcrypt.h not found. Please reinstall libmcrypt.</span><br></pre></td></tr></table></figure>

<p>解决办法7：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# yum install -y libmcrypt libmcrypt-devel</span><br></pre></td></tr></table></figure>

<p>错误8：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">configure: error: mcrypt.h not found. Please reinstall libmcrypt.</span><br><span class="line">(centos源不能安装libmcrypt-devel，由于版权的原因没有自带mcrypt的包rpm -qa|grep limcrypt limcrypt-devel,此源为rethot社区版的源)</span><br></pre></td></tr></table></figure>

<p>解决办法8：安装第三方yum源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.atomicorp.com/installers/atomic</span><br><span class="line">sh ./atomic</span><br><span class="line"></span><br><span class="line">yum  install  php-mcrypt  libmcrypt  libmcrypt-devel</span><br></pre></td></tr></table></figure>

<p>检测、编译和安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# echo $?</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# make </span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# make install</span><br></pre></td></tr></table></figure>

<h2 id="配置PHP"><a href="#配置PHP" class="headerlink" title="配置PHP"></a>配置PHP</h2><p>添加配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# cp php.ini-production /usr/local/php-fpm/etc/php.ini</span><br></pre></td></tr></table></figure>

<p>配置文件编辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host php-5.6.30]# vi /usr/local/php-fpm/etc/php-fpm.conf   //写入如下内容</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">#定义全局参数</span><br><span class="line">pid = /usr/local/php-fpm/var/run/php-fpm.pid</span><br><span class="line">error_log = /usr/local/php-fpm/var/log/php-fpm.log</span><br><span class="line">[www]</span><br><span class="line">listen = /tmp/php-fcgi.sock</span><br><span class="line">#监听地址，也可以写：listen = 127.0.0.1：:9000，本地监听，也可以监听其他IP：port</span><br><span class="line">#此处格式会影响配置Nginx和PHP结合时Nginx寻址PHP的路径</span><br><span class="line">listen.mode = 666</span><br><span class="line">#当监听的为socket文件时该部分才生效，用于指定.sock文件的权限</span><br><span class="line">user = php-fpm</span><br><span class="line">group = php-fpm</span><br><span class="line">#定义php-fpm服务的用户</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">rlimit_files = 1024</span><br><span class="line">#以上部分为进程相关信息</span><br></pre></td></tr></table></figure>

<p>配置启动脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host etc]# cd /usr/local/src/php-5.6.30  //进入源码目录下来</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]#  cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm  //把启动脚本放到到系统配置</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# chmod 755 /etc/init.d/php-fpm  //修改权限</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# chkconfig --add php-fpm  //添加到开机启动项</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# chkconfig php-fpm on  //设置开机启动</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# service php-fpm start  //启动php-fpm服务</span><br><span class="line">Starting php-fpm  done</span><br><span class="line"></span><br><span class="line">[root@host php-5.6.30]# ps aux |grep php-fpm  //查看后台www的pool是否启动</span><br></pre></td></tr></table></figure>

<p>#12.5 Nginx介绍</p>
<blockquote>
<p>Nginx是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p>
</blockquote>
<ul>
<li>Nginx官网 nginx.org，最新版1.13，最新稳定版1.12 </li>
<li>Nginx应用场景：web服务、反向代理、负载均衡</li>
<li>Nginx著名分支，淘宝基于Nginx开发的Tengine，使用上和Nginx一致，服务名，配置文件名都一样，和Nginx的最大区别在于Tenging增加了一些定制化模块，在安全限速方面表现突出，另外它支持对js，css合并</li>
<li>Nginx核心+lua相关的组件和模块组成了一个支持lua的高性能web容器openresty。</li>
</ul>
<blockquote>
<p>1、Nginx优点<br>Nginx设计为一个主进程多个工作进程的工作模式，每个进程是单线程来处理多个连接，而且每个工作进程采用了非阻塞I/O来处理多个连接，从而减少了线程上下文切换，从而实现了公认的高性能、高并发；因此在生成环境中会通过把CPU绑定给Nginx工作进程从而提升其性能；另外因为单线程工作模式的特点，内存占用就非常少了。<br>Nginx更改配置重启速度非常快，可以毫秒级，而且支持不停止Nginx进行升级Nginx版本、动态重载Nginx配置。<br>Nginx模块也是非常多，功能也很强劲，不仅可以作为http负载均衡，Nginx发布1.9.0版本还支持TCP负载均衡，还可以很容易的实现内容缓存、web服务器、反向代理、访问控制等功能。</p>
</blockquote>
<blockquote>
<p>2、Lua的优点<br>Lua是一种轻量级、可嵌入式的脚本语言，这样可以非常容易的嵌入到其他语言中使用。另外Lua提供了协程并发，即以同步调用的方式进行异步执行，从而实现并发，比起回调机制的并发来说代码更容易编写和理解，排查问题也会容易。Lua还提供了闭包机制，函数可以作为First Class Value 进行参数传递，另外其实现了标记清除垃圾收集。<br>因为Lua的小巧轻量级，可以在Nginx中嵌入Lua VM，请求的时候创建一个VM，请求结束的时候回收VM。</p>
</blockquote>
<blockquote>
<p>3、什么是ngx_lua<br>ngx_lua是Nginx的一个模块，将Lua嵌入到Nginx中，从而可以使用Lua来编写脚本，这样就可以使用Lua编写应用脚本，部署到Nginx中运行，即Nginx变成了一个Web容器；这样开发人员就可以使用Lua语言开发高性能Web应用了。<br>ngx_lua提供了与Nginx交互的很多的API，对于开发人员来说只需要学习这些API就可以进行功能开发，而对于开发web应用来说，如果接触过Servlet的话，其开发和Servlet类似，无外乎就是知道接收请求、参数解析、功能处理、返回响应这几步的API是什么样子的。</p>
</blockquote>
<blockquote>
<p>4、开发环境<br>我们可以使用OpenResty来搭建开发环境，OpenResty将Nginx核心、LuaJIT、许多有用的Lua库和Nginx第三方模块打包在一起；这样开发人员只需要安装OpenResty，不需要了解Nginx核心和写复杂的C/C++模块就可以，只需要使用Lua语言进行Web应用开发了。</p>
</blockquote>
<p>参考<a href="http://jinnianshilongnian.iteye.com/blog/2280928" target="_blank" rel="noopener">http://jinnianshilongnian.iteye.com/blog/2280928</a></p>
<p>#扩展</p>
<p>##Nginx为什么比Apache Httpd高效：原理篇<br><a href="http://www.toxingwang.com/linux-unix/linux-basic/1712.html" target="_blank" rel="noopener">http://www.toxingwang.com/linux-unix/linux-basic/1712.html</a></p>
<p>##apache和nginx工作原理比较<br><a href="http://www.server110.com/nginx/201402/6543.html" target="_blank" rel="noopener">http://www.server110.com/nginx/201402/6543.html</a></p>
<p>##mod_php 和 mod_fastcgi以及php-fpm的比较<br><a href="http://dwz.cn/1lwMSd" target="_blank" rel="noopener">http://dwz.cn/1lwMSd</a></p>
<p>##概念了解：CGI，FastCGI，PHP-CGI与PHP-FPM<br><a href="http://www.nowamagic.net/librarys/veda/detail/1319/" target="_blank" rel="noopener">http://www.nowamagic.net/librarys/veda/detail/1319/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/12.17 - 12.20 Nginx负载均衡、ssl原理、生成ssl密钥对、Nginx配置ssl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/12.17 - 12.20 Nginx负载均衡、ssl原理、生成ssl密钥对、Nginx配置ssl/" itemprop="url">12.17 - 12.20 Nginx负载均衡、ssl原理、生成ssl密钥对、Nginx配置ssl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#12.17 Nginx负载均衡<br>Nginx负载均衡就是指 当代理服务器将自定义的域名解析到多个指定IP时，通过upstream模块来保证用户可以通过代理服务器正常访问各个IP（反向代理多台服务器就是负载均衡）。</p>
<p>##负载均衡配置</p>
<p>###配置参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /usr/local/nginx/conf/vhost/load.conf</span><br><span class="line">upstream qq</span><br><span class="line">#自定义域名</span><br><span class="line">&#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">#目的是为了保证同一个用户始终保持在同一台机器上</span><br><span class="line">#还有就是为了当域名指向多个IP时，保证每个用户始终解析到同一IP</span><br><span class="line">    server 61.135.157.156:80;</span><br><span class="line">    server 125.39.240.113:80;</span><br><span class="line">#指定web服务器的IP</span><br><span class="line">&#125;</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.qq.com;</span><br><span class="line">    location /</span><br><span class="line">    &#123;</span><br><span class="line">        proxy_pass      http://qq;</span><br><span class="line">        proxy_set_header Host  $host;</span><br><span class="line">        proxy_set_header X-Real-IP      $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###检测</p>
<p>代理前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# curl -x127.0.0.1:80 www.qq.com </span><br><span class="line">This is the default directory.</span><br><span class="line"></span><br><span class="line">#没使用代理时，会直接解析到默认的虚拟主机。</span><br></pre></td></tr></table></figure>

<p>代理后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line">[root@host ~]# /usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">[root@host ~]# curl -x127.0.0.1:80 www.qq.com</span><br><span class="line">……</span><br><span class="line">#使用代理后，会解析到代理服务器所指向的IP的网页代码</span><br></pre></td></tr></table></figure>

<p>##dig命令</p>
<p>dig命令是常用域名的解析工具，可以寻找域名的全部IP。</p>
<p>如果服务器中没有安装命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum install -y bind-utils</span><br></pre></td></tr></table></figure>

<p>解析qq网站的全部IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# dig www.qq.com</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.qq.com.        138    IN    A    61.135.157.156</span><br><span class="line">www.qq.com.        138    IN    A    125.39.240.113</span><br><span class="line"></span><br><span class="line">;; Query time: 12 msec</span><br><span class="line">;; SERVER: 119.29.29.29#53(119.29.29.29)</span><br><span class="line">;; WHEN: 二 9月 12 22:44:23 CST 2017</span><br><span class="line">;; MSG SIZE  rcvd: 61</span><br></pre></td></tr></table></figure>

<p>#12.18 ssl原理</p>
<blockquote>
<p>SSL(Secure Sockets Layer 安全套接层)协议,及其继任者TLS（Transport Layer Security传输层安全）协议，是为网络通信提供安全及数据完整性的一种安全协议。</p>
</blockquote>
<p>##http、https、tcp</p>
<ul>
<li>HTTP超文本传输协议（HyperText Transfer Protocol)是互联网上应用最为广泛的一种网络协议。</li>
<li>HTTPS(全称:Hyper Text Transfer Protocol over Secure Socket Layer)，简单讲是HTTP的安全加密版。</li>
<li>HTTP默认的端口号为80，HTTPS的端口号为443。</li>
<li>TCP(Transmission Control Protocol 传输控制协议)是一种面向连接的、可靠的、基于字节流的传输层通信协议。默认监听80端口。</li>
<li>http是应用层协议， tcp是传输层。 http使用tcp传输文本数据； http只是定义了tcp数据的解析方式</li>
</ul>
<p>##SSL工作流程</p>
<ul>
<li>浏览器发送一个https的请求给服务器；</li>
<li>服务器要有一套数字证书，可以自己制作（后面的操作就是阿铭自己制作的证书），也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出&gt;提示页面，这套证书其实就是一对公钥和私钥；</li>
<li>服务器会把公钥传输给客户端；</li>
<li>客户端（浏览器）收到公钥后，会验证其是否合法有效，无效会有警告提醒，有效则会生成一串随机数，并用收到的公钥加密；</li>
<li>客户端把加密后的随机字符串传输给服务器；</li>
<li>服务器收到加密随机字符串后，先用私钥解密（公钥加密，私钥解密），获取到这一串随机数后，再用这串随机字符串加密传输的数据（该加密为对称加密，所谓对称加密，就是将数据和私钥也就是这个随机字符串&gt;通过某种算法混合在一起，这样除非知道私钥，否则无法获取数据内容）；</li>
<li>服务器把加密后的数据传输给客户端；</li>
<li>客户端收到数据后，再用自己的私钥也就是那个随机字符串解密；</li>
</ul>
<p>#12.19 生成ssl密钥对</p>
<p>##SSL工作流程</p>
<p>如果虚拟机中没有此工具，手动安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum install -y openssl</span><br></pre></td></tr></table></figure>

<p>##SSL证书就是一对公钥和私钥。</p>
<p>###创建私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/nginx/conf/</span><br><span class="line"></span><br><span class="line">[root@host conf]# openssl genrsa -des3 -out tmp.key 2048  //生成SSL密钥</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">....................................................................................+++</span><br><span class="line">...............................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase for tmp.key:</span><br><span class="line">Verifying - Enter pass phrase for tmp.key:   //密钥需要我们设置密码，一般我们都不需要再设置密码，所以要转换一下key，取消密码</span><br><span class="line"></span><br><span class="line">[root@host conf]# openssl rsa -in tmp.key -out host.key  //转换一下key，将tmp.key 转换为没密码的host.key</span><br><span class="line"></span><br><span class="line">Enter pass phrase for tmp.key:</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line">[root@host conf]# rm -f tmp.key  //删除tmp.key</span><br></pre></td></tr></table></figure>

<p>##自己生成证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@host conf]# openssl req -new -key host.key -out host.csr   //自己生成证书请求文件，需要拿这个私钥一起生成证书</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:11</span><br><span class="line">State or Province Name (full name) []:BeiJing</span><br><span class="line">Locality Name (eg, city) [Default City]:BeiJing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:BeiJing</span><br><span class="line">Organizational Unit Name (eg, section) []:BeiJing</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:host</span><br><span class="line">Email Address []:zhouqunic@qq.com</span><br><span class="line">#以上是配置证书信息，因为是自己颁发给自己的证书，就随意瞎填或者干脆Enter跳过，如果是正式应用在自己的网站上，最好规范填写。</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:123456</span><br><span class="line">An optional company name []:123456</span><br></pre></td></tr></table></figure>

<p>创建公钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host conf]# openssl x509 -req -days 365 -in host.csr -signkey host.key -out host.crt  //这里的aminglinux.crt为公钥</span><br><span class="line"></span><br><span class="line">Signature ok</span><br><span class="line">subject=/C=11/ST=BeiJing/L=BeiJing/O=BeiJing/OU=BeiJing/CN=host/emailAddress=zhouqunic@qq.com</span><br><span class="line">Getting Private key</span><br></pre></td></tr></table></figure>

<p>#12.20 Nginx配置ssl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host conf]# cd vhost/</span><br><span class="line"></span><br><span class="line">[root@host vhost]# vim ssl.conf</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name zhouqun.com;</span><br><span class="line">    index index.html index.php;</span><br><span class="line">    root /data/wwwroot/zhouquncom;</span><br><span class="line">    ssl on;      //开启ssl</span><br><span class="line">    ssl_certificate host.crt;     //配置公钥</span><br><span class="line">    ssl_certificate_key host.key;        //配置私钥</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;      ///配置协议</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@host vhost]# mkdir /data/wwwroot/zhouqun.com</span><br></pre></td></tr></table></figure>

<p>检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host conf]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: [emerg] unknown directive &quot;ssl&quot; in /usr/local/nginx/conf/vhost/ssl.conf:7       //报错了</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test failed</span><br></pre></td></tr></table></figure>

<p>报错 unknown directive “ssl”   未识别ssl配置，需要重新编译nginx，加上–with-http_ssl_module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@host conf]# cd /usr/local/src/nginx-1.12.1/</span><br><span class="line"></span><br><span class="line">[root@host nginx-1.12.1]# ./configure --prefix=/usr/local/nginx --with-http_ssl_module  </span><br><span class="line"></span><br><span class="line">[root@host conf]# make</span><br><span class="line">[root@host conf]# make install</span><br><span class="line"></span><br><span class="line">[root@host nginx-1.12.1]# /usr/local/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@host nginx-1.12.1]# /etc/init.d/nginx restart</span><br><span class="line">Restarting nginx (via systemctl):                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@host nginx-1.12.1]# netstat -lntp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address          Foreign Address        State      PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*              LISTEN      5991/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*              LISTEN      1735/sshd          </span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*              LISTEN      2040/master        </span><br><span class="line">tcp        0      0 0.0.0.0:443            0.0.0.0:*              LISTEN      5991/nginx: master  </span><br><span class="line">tcp6      0      0 :::3306                :::*                    LISTEN      1990/mysqld        </span><br><span class="line">tcp6      0      0 :::22                  :::*                    LISTEN      1735/sshd          </span><br><span class="line">tcp6      0      0 ::1:25                  :::*                    LISTEN      2040/master</span><br></pre></td></tr></table></figure>

<p>nginx监听80和443端口。</p>
<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host nginx-1.12.1]# cd /data/wwwroot/zhouqun.com/</span><br><span class="line"></span><br><span class="line">[root@host adai.com]# vim index.html</span><br><span class="line"></span><br><span class="line">This is ssl.</span><br></pre></td></tr></table></figure>

<p>添加本地域名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@host adai.com]# vim /etc/hosts</span><br><span class="line">127.0.0.1  zhouqun.com</span><br><span class="line"></span><br><span class="line">[root@host vhost]# curl https://zhouqun.com/</span><br><span class="line">curl: (60) Peer&apos;s certificate issuer has been marked as not trusted by the user.</span><br><span class="line">More details here: http://curl.haxx.se/docs/sslcerts.html</span><br><span class="line"></span><br><span class="line">curl performs SSL certificate verification by default, using a &quot;bundle&quot;</span><br><span class="line">of Certificate Authority (CA) public keys (CA certs). If the default</span><br><span class="line">bundle file isn&apos;t adequate, you can specify an alternate file</span><br><span class="line">using the --cacert option.</span><br><span class="line">If this HTTPS server uses a certificate signed by a CA represented in</span><br><span class="line">the bundle, the certificate verification probably failed due to a</span><br><span class="line">problem with the certificate (it might be expired, or the name might</span><br><span class="line">not match the domain name in the URL).</span><br><span class="line">If you&apos;d like to turn off curl&apos;s verification of the certificate, use</span><br><span class="line">the -k (or --insecure) option.</span><br></pre></td></tr></table></figure>

<p>因为该证书是自己创建的，没有符合https组织的规范，不能被正确识别，如果换上正规的证书，就没问题了。</p>
<p>所以，如果要使用浏览器检测，那么进行该测试之前，需要更改Windows的hosts文件，不然就会证书出错的。</p>
<p>#扩展 </p>
<p>##针对请求的uri来代理<br><a href="http://ask.apelearn.com/question/1049" target="_blank" rel="noopener">http://ask.apelearn.com/question/1049</a></p>
<p>##根据访问的目录来区分后端的web<br><a href="http://ask.apelearn.com/question/920" target="_blank" rel="noopener">http://ask.apelearn.com/question/920</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/13.4 - 13.6 mysql用户管理、常用sql语句、mysql数据库备份恢复/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/13.4 - 13.6 mysql用户管理、常用sql语句、mysql数据库备份恢复/" itemprop="url">13.4 - 13.6 mysql用户管理、常用sql语句、mysql数据库备份恢复</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#13.4 mysql用户管理<br>因为日常使用中，需要给人员的权限进行限制，所以需要对用户进行管理。</p>
<p>##创建用户并授权</p>
<ul>
<li><p>指定登录IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; grant all on *.* to &apos;user1&apos;@&apos;127.0.0.1&apos; identified by &apos;123456&apos;;</span><br><span class="line">#创建user1用户并授予其所有权限“*.*”（通配符）</span><br><span class="line">#第一个*表示db_name；第二个*表示tb_name</span><br><span class="line">#同时指定其来源IP127.0.0.1（即，只可通过此IP登录）</span><br><span class="line">#此处可以使用通配符%，代表所有IP（一般不使用）</span><br><span class="line">#设定密码：identified by</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定登录socket</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; grant all on *.* to &apos;user2&apos;@&apos;localhost&apos; identified by &apos;123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>##用户登录</p>
<ul>
<li><p>指定的IP用户登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uuser1 -p123456 -h127.0.0.1</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定的socket登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uuser2 -p&apos;123456&apos;</span><br><span class="line">Welcome to the MySQL monitor. </span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>因为指定登录主机为localhost，所以该用户默认使用（监听）本地mysql.socket文件，不需要指定IP即可登录。</p>
<p>##针对具体的权限进行授权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p&apos;123456&apos;</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; create database db1;</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line">mysql&gt; grant SELECT,UPDATE,INSERT on db1.* to &apos;user2&apos;@&apos;113.83.64.114&apos; identified by &apos;123456&apos;;</span><br><span class="line">#创建user2用户，并授予其针对db1库SELECT,UPDATE,INSERT权限</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all on db1.* to &apos;user3&apos;@&apos;%&apos; identified by &apos;123456&apos;;</span><br><span class="line">#创建user3，并针对所有IP授予其db1库所有权限</span><br></pre></td></tr></table></figure>

<p>##查看授权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p&apos;123456&apos;</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; show grants;</span><br><span class="line">#查看当前用户的权限</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants for user2@113.83.64.114;</span><br><span class="line">#查看指定用户的权限</span><br></pre></td></tr></table></figure>

<p>##更改权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mysql -uroot -p&apos;123456&apos;</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; GRANT USAGE ON *.* TO &apos;user2&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY PASSWORD &apos;*6BB4837EB743291105EE4568DDA7DC67ED2CA2AD9&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT SELECT, INSERT, UPDATE ON `db1`.* TO &apos;user2&apos;@&apos;127.0.0.1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; show grants for user2@127.0.0.1;</span><br><span class="line">+--------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants for user2@127.0.0.1                                                                                  |</span><br><span class="line">+--------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &apos;user2&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY PASSWORD &apos;*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9&apos; |</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE ON `db1`.* TO &apos;user2&apos;@&apos;127.0.0.1&apos;                                              |</span><br><span class="line">+--------------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>#13.5 常用sql语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from mysql.user;    //查看指定库的内容的行数</span><br><span class="line">select * from mysql.db\G;                  //查看库的所有内容</span><br><span class="line">select db from mysql.db;               //查看库指定内容</span><br><span class="line">select db,user from mysql.db;       //</span><br><span class="line">select * from mysql.db where host like &apos;192.168.%&apos;\G;    //查看某些IP对应的库内容，like表示匹配 (模糊查询)</span><br><span class="line">insert into db1.t1 values (1, &apos;abc&apos;);      //在db1库t1表里插入内容（1,abc）</span><br><span class="line">update db1.t1 set name=&apos;aaa&apos; where id=1;      //更新表格里所有id为1的表，把name内容更改为aaa</span><br><span class="line">truncate table db1.t1;    //清空一个表，留下表的格子</span><br><span class="line">drop table db1.t1;         //删除一个表</span><br><span class="line">drop database db1;      //删除一个库</span><br></pre></td></tr></table></figure>

<p>#13.6 mysql数据库备份恢复</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">备份库  mysqldump -uroot -p123456 db1&gt; /tmp/db1.sql</span><br><span class="line">恢复库 mysql -uroot -p123456 db1 &lt; /tmp/db1.sql</span><br><span class="line">备份表 mysqldump -uroot -p123456 db1 t1 &gt; /tmp/user.sql</span><br><span class="line">恢复表 mysql -uroot -p123456 db1 &lt; /tmp/t1.sql</span><br><span class="line">备份所有库 mysqldump -uroot -p -A &gt;/tmp/123.sql</span><br><span class="line">只备份表结构 mysqldump -uroot -p123456 -d mysql &gt; /tmp/mysql.sql</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<p>##SQL语句教程<br><a href="http://blog.51cto.com/zt/206" target="_blank" rel="noopener">http://blog.51cto.com/zt/206</a> </p>
<hr>
<p>##什么是事务？事务的特性有哪些？ </p>
<p>###概念<br>事务(Transaction)是访问并可能更新数据库中各种数据项的一个程序执行单元(unit)。事务通常由高级数据库操纵语言或编程语言（如SQL，C++或Java）书写的用户程序的执行所引起，并用形如begin transaction和end transaction语句（或函数调用）来界定。事务由事务开始(begin transaction)和事务结束(end transaction)之间执行的全体操作组成。<br>例如：在关系数据库中，一个事务可以是一条SQL语句，一组SQL语句或整个程序。</p>
<p>###特性</p>
<ul>
<li>事务是恢复和并发控制的基本单位。 </li>
<li>事务应该具有4个属性：原子性、一致性、隔离性、持续性。这四个属性通常称为ACID特性。<br>　　原子性（atomicity）。一个事务是一个不可分割的工作单位，事务中包括的操作要么都做，要么都不做。<br>　　一致性（consistency）。事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。<br>　　隔离性（isolation）。一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。<br>　　持久性（durability）。持续性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</li>
</ul>
<hr>
<p>##根据binlog恢复指定时间段的数据<br>如果不小心对数据库进行误操作，而又没有及时备份怎么办？这恐怕是广大的coder经常遇到的一类问题。<br>我今天就因为不小心删除了某个数据库，但最后的备份是1个礼拜前的，唯一能解决的办法就是通过mysqlbinlog来恢复了。解决方案如下：</p>
<p>如果MySQL服务器启用了二进制日志，你可以使用mysqlbinlog工具来恢复从指定的时间点开始(例如，从你最后一次备份)直到现在或另一个指定的时间点的数据。<br>关于启用二进制日志的信息，参见5.11.3节，“二进制日志”。对于mysqlbinlog的详细信息，参见mysql手册8.6节，“mysqlbinlog：用于处理二进制日志文件的实用工具”。<br>要想从二进制日志恢复数据，你需要知道当前二进制日志文件的路径和文件名。<br>一般可以从配置文件(一般情况，Linux下为my.cnf ，windows系统下为my.ini，取决于你的系统)中找到路径。如果未包含在选项文件中，当服务器启动时，可以在命令行中以选项的形式给出。<br>启用二进制日志的选项为–log-bin。<br>要想确定当前的二进制日志文件的文件名，输入下面的MySQL语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW BINLOG EVENTS \G;</span><br></pre></td></tr></table></figure>

<p>或者还可以从命令行输入下面的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql –user=root -pmypasswd -e ‘SHOW BINLOG EVENTS \G’ 将密码mypasswd替换为你的MySQL服务器的root密码。</span><br></pre></td></tr></table></figure>

<p>比如得到的日志文件名为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql-bin.000001 1. 指定恢复时间 对于MySQL5.1.54，可以在mysqlbinlog语句中通过–start-date和–stop-date选项指定DATETIME格式的起止时间。</span><br></pre></td></tr></table></figure>

<p>举例说明，比如在今天下午14:02(今天是2012年3月15日)，不小心执行SQL语句删除了一个数据表，但发现没有最新的备份（当然，这只是开发环境，并不是正式的生产环境，正式环境还得定时做数据备份）。要想恢复表和数据，可以通过mysqlbinlog恢复指定时间的备份，输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog –stop-date=”2012-03-15 14:02:00″ /data1/log/mysql/mysql-bin.000001  | mysql -u root -pmypasswd</span><br></pre></td></tr></table></figure>

<p>该命令将恢复截止到在–stop-date选项中以DATETIME格式给出的日期和时间的所有数据。</p>
<p>如果你没有检测到输入的错误的SQL语句，可能你想要恢复后面发生的数据库活动。<br>根据这些，你可以用起使日期和时间再次运行mysqlbinlog：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog –start-date=”2012-03-15 00:01:00″ /data1/log/mysql/mysql-bin.000001  | mysql -u root -pmypasswd</span><br></pre></td></tr></table></figure>

<p>在该行中，从今天凌晨0:01登录的SQL语句将运行，组合执行前夜的转储文件和mysqlbinlog的两行可以将所有数据恢复到今天凌晨0:01前一秒钟。<br>你应检查日志以确保时间确切。下一节介绍如何实现。</p>
<ol start="2">
<li>指定时间段恢复 通过mysqlbinlog –start-date 和–stop-date恢复指定时间段的数据库活动记录，如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog –start-date=”2012-03-09 02:00:00″ –stop-date=”2012-03-15 14:00:00″ /data1/log/mysql/mysql-bin.000001 &gt; /tmp/mysql_restore_030915.sql</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>通过这种方式，就能获取最后一个备份的文件时间2012-03-09 02:00:00到今天删除数据库之前2012-03-15 14:02这段时间的数据库活动事务操作</p>
<hr>
<p>##mysql字符集调整<br><a href="http://xjsunjie.blog.51cto.com/999372/1355013" target="_blank" rel="noopener">http://xjsunjie.blog.51cto.com/999372/1355013</a></p>
<hr>
<p>##使用xtrabackup备份innodb引擎的数据库<br>innodb引擎的数据库可以使用mysqldump备份，如果表很大几十个G甚至上百G，显示用mysqldump备份会非常慢。然后使用xtrabackup 可以很快的在线备份innodb数据库。<br>InnoDB 有个商业的InnoDB Hotbackup，可以对InnoDB引擎的表实现在线热备。而 percona出品的Xtrabackup，是InnoDB Hotbackup的一个开源替代品，可以在线对InnoDB/XtraDB引擎的表进行物理备份。 innobackupex是参考了InnoDB Hotbackup的innoback脚本修改而来的，主要是为了方便的同时备份InnoDB和MyISAM引擎的表，并且加入了一些使用的选项，如 –slave-info可以记录备份恢复后，作为slave需要的一些信息，根据这些信息，可以很方便的利用备份来重做slave。<br>最新下载地址如下：<br><a href="http://www.percona.com/mysql/xtrabackup/0.7/" target="_blank" rel="noopener">http://www.percona.com/mysql/xtrabackup/0.7/</a><br>安装如下：<br>tar zxf xtrabackup-0.7.tar.gz<br>cd xtrabackup-0.7<br>./configure<br>make<br>千万不要make install  而是要接着下面的步骤操作。<br>cd innobase/xtrabackup/<br>make<br>make install </p>
<p>然后，就会在你的/usr/bin目录里安装上两个工具：xtrabackup，innobackupex-1.5.1 </p>
<p>xtrabackup可以在不加锁的情况下备份innodb数据表，不过此工具不能操作myisam。<br>innobackupex-1.5.1是一个脚本封装，能同时处理innodb和myisam，但在处理myisam时需要加一个读锁。 </p>
<p>/usr/bin/xtrabackup –backup –target-dir=/backup/mysqlbackup      这里的target-dir 就是要备份到的目录，这个工具不用指定数据库名的，默认会把所有innodb引擎的数据库全部备份。<br>等备份完了，你会看到 target-dir 下会有所有innodb引擎的库，但是奇怪的是并没有备份 .frm 的文件，这个没有关系，需要你手动拷贝一份即可。</p>
<p>至于恢复，拷贝回去就ok啦。</p>
<hr>
<p>##innobackupex 备份 Xtrabackup 增量备份<br>Mysql增量备份<br>Xtrabackup中包含两个工具：<br>•        xtrabackup - 用于热备份innodb, xtradb表的工具，不能备份其他表(MYISAM表)。<br>•        innobackupex - 对xtrabackup封装的perl脚本，提供了myisam表备份的能力。（能进行整库和数据表备份）。<br>*注：备份恢复之前请做好全库备份<br>安装Xtrabackup<br>官网网址<a href="http://www.percona.com/doc/percona-xtrabackup/index.html" target="_blank" rel="noopener">http://www.percona.com/doc/percona-xtrabackup/index.html</a><br>安装<br>配置文件中需要添加 datadir = /usr/local/mysql/datadir  //MYSQL数据文件目录<br>1、自动安装 YUM 源后，用YUM安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gnupg</span><br><span class="line">rpm -Uhv http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm</span><br><span class="line">  yum install -y percona-xtrabackup</span><br></pre></td></tr></table></figure>

<p>2、手动写入YUM源<br>新建文件 /etc/yum.repos.d/Percona.repo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[percona]</span><br><span class="line">name = CentOS $releasever - Percona</span><br><span class="line">baseurl=http://repo.percona.com/centos/$releasever/os/$basearch/</span><br><span class="line">enabled = 1</span><br><span class="line">gpgkey = file:///etc/pki/rpm-gpg/RPM-GPG-KEY-percona</span><br><span class="line">gpgcheck = 1</span><br></pre></td></tr></table></figure>

<p>之后YUM安装 ，安装后可执行xtrabackup -v 查看<br>之后可以用xtrabackup 备份</p>
<p>一、innobackupex 备份全库<br>备份主程序为 /usr/bin/innobackupex-1.5.1，其需要从 mysql 配置文件中读取相关信息，Mysql缺省配置文件 my.cnf 中未配置 datadir 选项，必须显性添加，否则备份程序会报错：</p>
<p>innobackupex:: Warning: Ignored unrecognized line 2 in options : ‘xtrabackup: Error: Please set parameter ‘datadir’<br>在论坛Mysql 配置文件 /etc/my.cnf 配置文件添加 datadir 内容：</p>
<p>在[mysqld]段加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datadir = /usr/local/mysql/var</span><br></pre></td></tr></table></figure>

<p>1、备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/innobackupex-1.5.1 --user=root --password=password --defaults-file=/etc/my.cnf /usr/local/bbsBackup</span><br></pre></td></tr></table></figure>

<p>2、恢复</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/innobackupex-1.5.1 --apply-log  /usr/local/bbsBackup/2011-09-26_02-00-01/</span><br><span class="line">#/usr/bin/innobackupex-1.5.1 --copy-back /usr/local/bbsBackup/2011-09-26_02-00-01/</span><br><span class="line">#chown -R mysql:mysql /usr/local/mysql/</span><br><span class="line">#/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>

<p>二、全量备份及恢复<br>备份<br>注：使用xtrabackup，仅限InnoDB和xtradb表，且注意mysql配置文件my.cnf中需设置“default_table_type = InnoDB”否则不成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup  --target-dir=/usr/local/bbsBackup/base/</span><br></pre></td></tr></table></figure>

<p>恢复时执行两次：<br>1、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/local/bbsBackup/base</span><br><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/local/bbsBackup/base</span><br></pre></td></tr></table></figure>

<p>2、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//将数据库停掉</span><br><span class="line">#/etc/init.d/mysqld stop</span><br><span class="line">//删除数据库目录下的ib*（ib开头的所有）文件。</span><br><span class="line">#rm  /usr/local/mysql/var/ib*</span><br><span class="line">//将/usr/local/bbsBackup/base目录下的ib*文件拷贝到数据库目录。</span><br><span class="line">#cd /usr/local/mysql/var/</span><br><span class="line">#cp /usr/local/bbsBackup/base/ib* ./</span><br></pre></td></tr></table></figure>

<p>3、设置权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#chown mysql:mysql ib*</span><br></pre></td></tr></table></figure>

<p>重启数据库后测试，是否成功。</p>
<p>三、增量备份及恢复<br>注：做增量前当然要先进行全量备份，在全量的基础上来进行增量。<br>首先进行全量备份。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup  --target-dir=/usr/local/bbsBackup/base/</span><br></pre></td></tr></table></figure>

<p>在全量备份的基础上进行增量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --backup --target-dir=/usr/local/bbsBackup/1 --incremental-basedir=/usr/local/bbsBackup/base/</span><br></pre></td></tr></table></figure>

<p>注：/usr/local/bbsBackup/1是每次都需修改的。比如第二次增量就改成/usr/local/bbsBackup/2增量恢复。（步骤同全量恢复，只是在执行恢复命令的时候中间多一步）<br>1、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/local/bbsBackup/base</span><br><span class="line">#/usr/bin/xtrabackup --target-dir=/usr/local/bbsBackup/base  --prepare --incremental-dir=/usr/local/bbsBackup/1</span><br><span class="line">#/usr/bin/xtrabackup --defaults-file=/etc/my.cnf --prepare --target-dir=/usr/local/bbsBackup/base</span><br></pre></td></tr></table></figure>

<p>2、</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//将数据库停掉</span><br><span class="line">#/etc/init.d/mysqld stop</span><br><span class="line">//删除数据库目录下的ib*（ib开头的所有）文件。</span><br><span class="line">#rm  /usr/local/mysql/var/ib*</span><br><span class="line">//将/usr/local/bbsBackup/base目录下的ib*文件拷贝到数据库目录。</span><br><span class="line">#cd /usr/local/mysql/var/</span><br><span class="line">#cp /usr/local/bbsBackup/base/ib* ./</span><br></pre></td></tr></table></figure>

<p>3、设置权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#chown mysql:mysql ib*</span><br></pre></td></tr></table></figure>

<p>重启数据库后测试，是否成功。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/18.11-18.12 LVS DR模式搭建、keepalived + LVS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/18.11-18.12 LVS DR模式搭建、keepalived + LVS/" itemprop="url">18.11-18.12 LVS DR模式搭建、keepalived + LV</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="18-11-LVS-DR模式搭建"><a href="#18-11-LVS-DR模式搭建" class="headerlink" title="18.11 LVS DR模式搭建"></a>18.11 LVS DR模式搭建</h2><p>为什么不使用IP TUNNEL模式呢？</p>
<p>在生产环境中用的比较多的情况就是DR模式，NAT模式用的也不是太多，因为我们也说到了NAT的瓶颈问题。</p>
<p>如果规模在10台以内访问量不是很大且硬件配置+网络环境都可以的话建议使用NAT模式，可以节省公网IP，因为公网IP的成本也比较高。</p>
<p>另外一种方案就是搭建内网的LVS，全部的server均使用内网IP，我们使用一个公网IP端口映射到内网VIP的80端口即可，从而达到节省IP资源。</p>
<h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3><h4 id="1-1-三台模拟服务器"><a href="#1-1-三台模拟服务器" class="headerlink" title="1.1 三台模拟服务器"></a>1.1 三台模拟服务器</h4><p>| 主机名 | IP地址 | 角色 |<br>| — | ———— | —– | ————– |<br>| yt-01 | 192.168.2.131  | Director |<br>| yt-02 | 192.168.2.132 |  Real server 1 |<br>| yt-03 | 192.168.2.133  |  Real server 2 |<br>|  | 192.168.2.200 |  VIP | </p>
<h4 id="1-2-确保每台机器已经安装了ipvsadm服务"><a href="#1-2-确保每台机器已经安装了ipvsadm服务" class="headerlink" title="1.2 确保每台机器已经安装了ipvsadm服务"></a>1.2 确保每台机器已经安装了ipvsadm服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# yum install -y ipvsadm</span><br><span class="line">[root@yt-02 ~]# yum install -y ipvsadm</span><br><span class="line">[root@yt-03 ~]# yum install -y ipvsadm</span><br></pre></td></tr></table></figure>

<h3 id="2-在Director上面编写脚本"><a href="#2-在Director上面编写脚本" class="headerlink" title="2. 在Director上面编写脚本"></a>2. 在Director上面编写脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /usr/local/sbin/lvs_dr.sh</span><br><span class="line"></span><br><span class="line">#! /bin/bash</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">    ipv=/usr/sbin/ipvsadm</span><br><span class="line">    vip=192.168.2.200</span><br><span class="line">    rs1=192.168.2.122</span><br><span class="line">    rs2=192.168.2.123</span><br><span class="line">#注意这里的网卡名字</span><br><span class="line">    ifdown ens33</span><br><span class="line">    ifup ens33</span><br><span class="line">    ifconfig ens33:2 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">    route add -host $vip dev ens33:2</span><br><span class="line">    $ipv -C</span><br><span class="line">    $ipv -A -t $vip:80 -s wrr</span><br><span class="line">    $ipv -a -t $vip:80 -r $rs1:80 -g -w 1</span><br><span class="line">    $ipv -a -t $vip:80 -r $rs2:80 -g -w 1</span><br></pre></td></tr></table></figure>

<h3 id="3-运行DR上lvs-dr脚本"><a href="#3-运行DR上lvs-dr脚本" class="headerlink" title="3. 运行DR上lvs_dr脚本"></a>3. 运行DR上lvs_dr脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# sh /usr/local/sbin/lvs_dr.sh</span><br><span class="line">成功断开设备 &apos;ens33&apos;。</span><br><span class="line">成功激活的连接（D-Bus 激活路径：/org/freedesktop/NetworkManager/ActiveConnection/3）</span><br></pre></td></tr></table></figure>

<h3 id="4-每台Real-Server上也编写脚本"><a href="#4-每台Real-Server上也编写脚本" class="headerlink" title="4. 每台Real Server上也编写脚本"></a>4. 每台Real Server上也编写脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# vim /usr/local/sbin/lvs_rs.sh</span><br><span class="line"></span><br><span class="line">#! /bin/bash</span><br><span class="line">vip=192.168.2.200</span><br><span class="line">#把vip绑定在lo上，是为了实现rs直接把结果返回给客户端</span><br><span class="line">ifdown lo</span><br><span class="line">ifup lo</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">#以下操作为更改arp内核参数，目的是为了让rs顺利发送mac地址给客户端</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

<h3 id="5-每台Real-Server上运行脚本"><a href="#5-每台Real-Server上运行脚本" class="headerlink" title="5. 每台Real Server上运行脚本"></a>5. 每台Real Server上运行脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# sh /usr/local/sbin/lvs_rs.sh</span><br><span class="line">[root@yt-03 ~]# sh /usr/local/sbin/lvs_rs.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看一下每台real server的router -n</span><br><span class="line">[root@zhdy-02 ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination    Gateway        Genmask        Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0        192.168.2.2    0.0.0.0        UG    100    0        0 ens33</span><br><span class="line">192.168.2.0    0.0.0.0        255.255.255.0  U    100    0        0 ens33</span><br><span class="line">192.168.2.200  0.0.0.0        255.255.255.255 UH    0      0        0 lo</span><br><span class="line"></span><br><span class="line"># 查看IP是否已经绑在lo卡上</span><br><span class="line">[root@yt-02 ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.2.200/32 brd 192.168.2.200 scope global lo:0</span><br></pre></td></tr></table></figure>

<h3 id="6-测试"><a href="#6-测试" class="headerlink" title="6. 测试"></a>6. 测试</h3><h4 id="6-1-测试前一定要全部关闭iptables"><a href="#6-1-测试前一定要全部关闭iptables" class="headerlink" title="6.1 测试前一定要全部关闭iptables"></a>6.1 测试前一定要全部关闭iptables</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl stop firewalld</span><br><span class="line"># systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<h4 id="6-2-修改2个RS的nginx主页内容，以便区分"><a href="#6-2-修改2个RS的nginx主页内容，以便区分" class="headerlink" title="6.2 修改2个RS的nginx主页内容，以便区分"></a>6.2 修改2个RS的nginx主页内容，以便区分</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# echo &quot;rs1rs1&quot; &gt;/usr/share/nginx/html/index.html</span><br><span class="line">[root@yt-03 ~]# echo &quot;rs2rs2&quot; &gt;/usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<h4 id="6-3-用浏览器测试VIP，多试几次"><a href="#6-3-用浏览器测试VIP，多试几次" class="headerlink" title="6.3 用浏览器测试VIP，多试几次"></a>6.3 用浏览器测试VIP，多试几次</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@zhdy-01 ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port          Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.2.200:80 wrr</span><br><span class="line">  -&gt; 192.168.2.122:80            Route  1      1          9        </span><br><span class="line">  -&gt; 192.168.2.123:80            Route  1      1          8</span><br></pre></td></tr></table></figure>

<h2 id="18-12-keepalived-LVS"><a href="#18-12-keepalived-LVS" class="headerlink" title="18.12 keepalived + LVS"></a>18.12 keepalived + LVS</h2><p>LVS有个关键的点，也是致命点。所有的请求都会通过Director去转发到Real server 如果Director宕机，我们的所有服务均会被停止掉。所以我们会把keepalived放在这儿，实现DR的高可用，这样就会完美的解决问题！</p>
<p>完整架构需要两台服务器（角色为dir）分别安装keepalived软件，目的是实现高可用，但keepalived本身也有负载均衡的功能，所以本次实验可以只安装一台keepalived。</p>
<h3 id="1-准备工作-1"><a href="#1-准备工作-1" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3><p>| 主机名 | IP地址 | 角色 |<br>| — | ———— | —– | ————– |<br>| yt-01 | 192.168.2.131  | Director，安装keepalived |<br>| yt-02 | 192.168.2.132 |  Real server 1 |<br>| yt-03 | 192.168.2.133  |  Real server 2 |<br>| 无 | 192.168.2.300 |  VIP | </p>
<h3 id="2-配置director"><a href="#2-配置director" class="headerlink" title="2. 配置director"></a>2. 配置director</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# yum install -y keepalived</span><br><span class="line"></span><br><span class="line"># 自定义Keepalived配置文件</span><br><span class="line">[root@yt-01 ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    #备用服务器上为 BACKUP</span><br><span class="line">    state MASTER</span><br><span class="line">    #绑定vip的网卡为ens33，你的网卡和阿铭的可能不一样，这里需要你改一下</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    #备用服务器上为90</span><br><span class="line">    priority 100</span><br><span class="line">   #设置为不抢占，只在优先级高的机器上设置即可，优先级低的机器不设置，如果高的被down掉后，又起来，这样不会抢占，形成脑裂。</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.2.300</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server 192.168.2.300 80 &#123;</span><br><span class="line">    #(每隔10秒查询realserver状态)</span><br><span class="line">    delay_loop 10</span><br><span class="line">    #(lvs 算法) </span><br><span class="line">    lb_algo wlc </span><br><span class="line">    #算法(DR模式)</span><br><span class="line">    lb_kind DR</span><br><span class="line">    #(同一IP的连接60秒内被分配到同一台realserver)</span><br><span class="line">    persistence_timeout 0 </span><br><span class="line">    #(用TCP协议检查realserver状态)</span><br><span class="line">    protocol TCP </span><br><span class="line">    real_server 192.168.2.132 80 &#123;</span><br><span class="line">        #(权重) </span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">        #(10秒无响应超时)</span><br><span class="line">        connect_timeout 10</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retry 3</span><br><span class="line">        connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">    real_server 192.1682.133 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">        connect_timeout 10</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retry 3</span><br><span class="line">        connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"># 启动Keepalived服务</span><br><span class="line">[root@yt-01 ~]# systemctl start keepalived</span><br><span class="line"></span><br><span class="line">查看网卡信息：</span><br><span class="line">[root@yt-01 ~]# ip add</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:be:0e:17 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.2.131/24 brd 192.168.2.255 scope global ens33</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.2.300/32 scope global ens33</span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::592f:39cc:1b50:1d07/64 scope link </span><br><span class="line">      valid_lft forever preferred_lft forever</span><br><span class="line">#虚拟IP（VIP）在ens33网卡上</span><br><span class="line"></span><br><span class="line"># 查看ipvsadm规则</span><br><span class="line">[root@director ~]# ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port          Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.2.300:80 wlc</span><br><span class="line">  -&gt; 192.168.2.132:80            Route  100    0          0        </span><br><span class="line">  -&gt; 192.168.2.133:80            Route  100    0          0</span><br></pre></td></tr></table></figure>

<h3 id="3-配置Real-Server"><a href="#3-配置Real-Server" class="headerlink" title="3. 配置Real Server"></a>3. 配置Real Server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 编辑路由转发脚本</span><br><span class="line">[root@yt-02 ~]# vim /usr/local/sbin/lvs_rs.sh</span><br><span class="line"></span><br><span class="line">#/bin/bash</span><br><span class="line">vip=192.168.2.300</span><br><span class="line">#把vip绑定在lo上，是为了实现rs直接把结果返回给客户端</span><br><span class="line">ifconfig lo:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line">route add -host $vip lo:0</span><br><span class="line">#以下操作为更改arp内核参数，目的是为了让rs顺利发送mac地址给客户端</span><br><span class="line">#参考文档www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line"># 运行脚本</span><br><span class="line">[root@yt-02 ~]# sh /usr/local/sbin/lvs_rs.sh</span><br><span class="line"></span><br><span class="line">RS3上同上</span><br></pre></td></tr></table></figure>

<p>配置完成</p>
<h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4. 测试"></a>4. 测试</h3><p>在浏览器访问VIP：192.168.2.300，刷新网页，访问结果由RS1、RS2交替回复，停掉任意一台RS服务器，网页不会中断。</p>
<h3 id="5-Keepalived-LVS作用"><a href="#5-Keepalived-LVS作用" class="headerlink" title="5. Keepalived+LVS作用"></a>5. Keepalived+LVS作用</h3><ul>
<li>Keepalived搭建高可用保证LVS中director宕机后服务器不瘫痪（用多台Director）</li>
<li>如果只使用LVS，那么当LVS架构中某个real server宕机后，director仍然会继续向其发送请求，添加Keepalived后会自动将宕机的real server清除出rs列表。</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>haproxy+keepalived<br><a href="http://blog.csdn.net/xrt95050/article/details/40926255" target="_blank" rel="noopener">http://blog.csdn.net/xrt95050/article/details/40926255</a></p>
<p>nginx、lvs、haproxy比较<br><a href="http://www.csdn.net/article/2014-07-24/2820837" target="_blank" rel="noopener">http://www.csdn.net/article/2014-07-24/2820837</a></p>
<p>keepalived中自定义脚本<br>vrrp_script <a href="http://my.oschina.net/hncscwc/blog/158746" target="_blank" rel="noopener">http://my.oschina.net/hncscwc/blog/158746</a></p>
<p>lvs dr模式只使用一个公网ip的实现方法<br><a href="http://storysky.blog.51cto.com/628458/338726" target="_blank" rel="noopener">http://storysky.blog.51cto.com/628458/338726</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhouqun</p>
              <p class="site-description motion-element" itemprop="description">个人Linux学习和工作记录的小地方</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhouqun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
