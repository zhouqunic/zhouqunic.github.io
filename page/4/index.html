<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Joking的Linux世界" type="application/atom+xml">






<meta name="description" content="个人Linux学习和工作记录的小地方">
<meta name="keywords" content="linux">
<meta property="og:type" content="website">
<meta property="og:title" content="Joking的Linux世界">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Joking的Linux世界">
<meta property="og:description" content="个人Linux学习和工作记录的小地方">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joking的Linux世界">
<meta name="twitter:description" content="个人Linux学习和工作记录的小地方">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>Joking的Linux世界</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Joking的Linux世界</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">念念不忘，必有回响</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/14.4 - 15.2 NFS的exportfs命令和客户端问题、FTP介绍、使用vsftpd搭建ftp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/14.4 - 15.2 NFS的exportfs命令和客户端问题、FTP介绍、使用vsftpd搭建ftp/" itemprop="url">14.4 - 15.2 NFS的exportfs命令和客户端问题、FTP介绍、使用vsftpd搭建ftp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#14.4 exportfs命令</p>
<blockquote>
<p>exportfs 命令用来管理当前NFS共享的文件系统列表。</p>
</blockquote>
<p>##常用参数<br>-a 全部挂载或者全部卸载<br>-r 重新挂载<br>-u 卸载某一个目录<br>-v 显示共享目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -arv    //服务端更改配置文件后，不重启服务，直接执行该命令就可以使更改后的配置文件生效。</span><br></pre></td></tr></table></figure>

<p>##以下操作在服务端上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/exports    //增加</span><br><span class="line">/tmp/ 192.168.2.0/24(rw,sync,no_root_squash)</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# exportfs -arv    //不用重启nfs服务，配置文件就会生效</span><br><span class="line">#在重启nfs服务之前，需要先把所有挂载点卸载，否则将发生严重的程序错误，甚至会拖垮系统。</span><br></pre></td></tr></table></figure>

<p>#14.5 NFS客户端问题</p>
<p>##NFS4版本在centos6中应用存在如下问题：<br>客户端挂载共享目录后，不管是root用户还是普通用户，创建的新文件的属主、数组都为nobody。</p>
<p>##解决方案<br>方法1：只在客户端进行挂载时加上选项-o nfsvers=3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# monunt -t nfs -o nfsvers=3 192.168.2.130:/tmp/ /mnt/</span><br></pre></td></tr></table></figure>

<p>方法2：修改客户端和服务端的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/idmapd.conf</span><br><span class="line">#把配置文件中的“Domain = local.domain.com”改为“Domain = xxx.com”（此处xxx.com是自己随意定义），然后重启rpcidmapd服务（在centos7中直接重启rpcbind服务）</span><br></pre></td></tr></table></figure>

<p>#15.1 FTP介绍</p>
<blockquote>
<p>FTP 是File Transfer Protocol（文件传输协议）的英文简称，而中文简称为“文传协议”。用于Internet上的控制文件的双向传输。同时，它也是一个应用程序（Application）。基于不同的操作系统有不同的FTP应用程序，而所有这些应用程序都遵守同一种协议以传输文件。在FTP的使用当中，用户经常遇到两个概念：”下载”（Download）和”上传”（Upload）。”下载”文件就是从远程主机拷贝文件至自己的计算机上；”上传”文件就是将文件从自己的计算机中拷贝至远程主机上。用Internet语言来说，用户可通过客户机程序向（从）远程主机上传（下载）文件。</p>
</blockquote>
<ul>
<li>FTP是File Transfer Protocol（文件传输协议，简称文传协议）的英文简称，用于在Internet上控制文件的双向传输。</li>
<li>FTP的主要作用就是让用户连接一个远程计算机（这些计算机上运行着FTP服务器程序），并查看远程计算机中的文件，然后把文件从远程计算机复制到本地计算机，或把本地计算机的文件传送到远程计算机。</li>
<li>小公司用的多，大企业不用FTP，因为不安全</li>
</ul>
<p>#15.2/15.3 使用vsftpd搭建ftp</p>
<p>##安装vsftpd工具<br>centos上自带vsftpd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum install -y vsftpd</span><br></pre></td></tr></table></figure>

<p>##创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# useradd -s /sbin/nologin virftp</span><br><span class="line">#创建一个vsftpd服务的普通用户进行传输数据，避免使用root用户导致安全问题。</span><br></pre></td></tr></table></figure>

<p>##配置虚拟用户密码文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# vim /etc/vsftpd/vsftpd_login   //内容如下,奇数行为用户名，偶数行为密码，多个用户就写多行</span><br><span class="line">testuser1</span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line">[root@host ~]# chmod 600 /etc/vsftpd/vsftpd_login   //更改文件的权限</span><br></pre></td></tr></table></figure>

<p>##密码转换<br>将密码转换成二进制文件，使电脑可以识别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# db_load -T -t hash -f /etc/vsftpd/vsftpd_login /etc/vsftpd/vsftpd_login.db</span><br></pre></td></tr></table></figure>

<p>##配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# mkdir /etc/vsftpd/vsftpd_user_conf    //创建存放目录</span><br><span class="line"></span><br><span class="line">[root@host ~]# cd /etc/vsftpd/vsftpd_user_conf    </span><br><span class="line"></span><br><span class="line">[root@host vsftpd_user_conf]# vim testuser1     //指定虚拟用户的 配置文件，虚拟用户配置文件和虚拟用户名称需要保持一致。</span><br><span class="line">local_root=/home/virftp/testuser1</span><br><span class="line">#定义虚拟用户家目录</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">#是否允许匿名用户登录</span><br><span class="line">write_enable=YES</span><br><span class="line">#是否可写</span><br><span class="line">local_umask=022</span><br><span class="line">#定义创建新文件时的默认权限</span><br><span class="line">anon_upload_enable=NO</span><br><span class="line">#是否允许匿名用户上传文件</span><br><span class="line">anon_mkdir_write_enable=NO</span><br><span class="line">#是否允许匿名用户创建目录文件</span><br><span class="line">idle_session_timeout=600</span><br><span class="line">#空闲用户保留时间</span><br><span class="line">data_connection_timeout=120</span><br><span class="line">#数据传输超时时间</span><br><span class="line">max_client=10</span><br><span class="line">#客户端最大连接数量</span><br></pre></td></tr></table></figure>

<p>##创建虚拟用户家目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host vsftpd_user_conf]# mkdir /home/virftp/testuser1</span><br><span class="line"></span><br><span class="line">创建一个文件：</span><br><span class="line">[root@host vsftpd_user_conf]# touch /home/virftp/testuser1/123.txt</span><br><span class="line">[root@host vsftpd_user_conf]# chown -R virftp:virftp /home/virftp</span><br></pre></td></tr></table></figure>

<p>##虚拟用户密码匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host vsftpd_user_conf]# vim /etc/pam.d/vsftpd    //添加这两行内容，用于指定用户的密码文件位置</span><br><span class="line">#%PAM-1.0</span><br><span class="line">auth sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_login</span><br><span class="line">account sufficient /lib64/security/pam_userdb.so db=/etc/vsftpd/vsftpd_login</span><br></pre></td></tr></table></figure>

<p>##编辑vsftpd主配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@host vsftpd_user_conf]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">……</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">anon_upload_enable=NO</span><br><span class="line">anon_mkdir_write_enable=NO</span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">在文件内容最后添加如下内容：  </span><br><span class="line">chroot_local_user=YES</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=virftp</span><br><span class="line">#开启虚拟用户和系统用户的映射</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">#使用虚拟用户</span><br><span class="line">user_config_dir=/etc/vsftpd_user_conf</span><br><span class="line">allow_writeable_chroot=YES</span><br></pre></td></tr></table></figure>

<p>##启动FTP服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host vsftpd_user_conf]# systemctl start vsftpd</span><br><span class="line"></span><br><span class="line">[root@host vsftpd_user_conf]# ps aux |grep vsftpd</span><br><span class="line">root      3671  0.0  0.0  52708  564 ?        Ss  18:40  0:00 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf</span><br><span class="line">[root@host vsftpd_user_conf]# netstat -lntp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address          Foreign Address        State      PID/Program name</span><br><span class="line">tcp6      0      0 :::21                  :::*                    LISTEN      3671/vsftpd</span><br></pre></td></tr></table></figure>

<p>##测试</p>
<ul>
<li>在Windows系统进行测试，需要安装filezilla软件。</li>
<li>在Linux中测试，安装lftp工具。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# yum install -y lftp</span><br></pre></td></tr></table></figure>

<p>用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# lftp testuser1@127.0.0.1</span><br><span class="line">口令: </span><br><span class="line">#登录</span><br><span class="line">lftp testuser1@127.0.0.1:~&gt; ls      </span><br><span class="line">drwxr-xr-x    2 1002    1002          22 Aug 24 10:19 testuser1</span><br><span class="line">lftp testuser1@127.0.0.1:/&gt; ?</span><br><span class="line">#查询在lftp中可执行的命令</span><br><span class="line">#常用命令：put、get</span><br><span class="line">lftp testuser1@127.0.0.1:/&gt; get testuser1/123.txt</span><br><span class="line">lftp testuser1@127.0.0.1:/&gt; quit</span><br><span class="line"></span><br><span class="line">[root@host ~]# ls</span><br><span class="line">123.txt  anaconda-ks.cfg     //下载文件成功</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/16.4-16.8 配置Tomcat监听80端口、配置Tomcat虚拟主机、Tomcat日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/16.4-16.8 配置Tomcat监听80端口、配置Tomcat虚拟主机、Tomcat日志/" itemprop="url">16.4-16.8 配置Tomcat监听80端口、配置Tomcat虚拟主机、Tomcat日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="16-4-配置Tomcat监听80端口"><a href="#16-4-配置Tomcat监听80端口" class="headerlink" title="16.4 配置Tomcat监听80端口"></a>16.4 配置Tomcat监听80端口</h1><h2 id="编辑Tomcat配置文件"><a href="#编辑Tomcat配置文件" class="headerlink" title="编辑Tomcat配置文件"></a>编辑Tomcat配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /usr/local/tomcat/conf/server.xml </span><br><span class="line">……#搜索8080，修改下面的内容位80</span><br><span class="line">&lt;Connector port=&quot;80&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">              connectionTimeout=&quot;20000&quot;</span><br><span class="line">              redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# /usr/local/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>

<h2 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps aux |grep tomcat</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# netstat -lntp |grep java</span><br><span class="line">tcp6      0      0 127.0.0.1:8005          :::*                    LISTEN      2716/java          </span><br><span class="line">tcp6      0      0 :::8009                :::*                    LISTEN      2716/java  </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# netstat -lntp |grep 80</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*              LISTEN      1825/nginx: master  </span><br><span class="line">tcp6      0      0 127.0.0.1:8005          :::*                    LISTEN      2716/java          </span><br><span class="line">tcp6      0      0 :::8009                :::*                    LISTEN      2716/java  </span><br><span class="line"></span><br><span class="line"># 这时的Tomcat服务正常运行，但是没有监听端口。因为监听80端口的是nginx服务，如果想让Tomcat监听80端口，需要关闭nginx服务，然后重启Tomcat服务。</span><br></pre></td></tr></table></figure>

<h2 id="关闭服务，重启"><a href="#关闭服务，重启" class="headerlink" title="关闭服务，重启"></a>关闭服务，重启</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl stop nginx.service </span><br><span class="line">[root@localhost ~]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">[root@localhost ~]# /usr/local/tomcat/bin/startup.sh </span><br><span class="line"></span><br><span class="line">检查</span><br><span class="line">[root@localhost ~]# netstat -lntp |grep java</span><br><span class="line">tcp6      0      0 :::80                  :::*                    LISTEN      2815/java          </span><br><span class="line">tcp6      0      0 :::8009                :::*                    LISTEN      2815/java</span><br></pre></td></tr></table></figure>

<h1 id="16-5-16-6-16-7-配置Tomcat虚拟主机"><a href="#16-5-16-6-16-7-配置Tomcat虚拟主机" class="headerlink" title="16.5/16.6/16.7 配置Tomcat虚拟主机"></a>16.5/16.6/16.7 配置Tomcat虚拟主机</h1><h2 id="每一个虚拟主机相当于一个域名，一个主机可以配置多个域名，多个网站。"><a href="#每一个虚拟主机相当于一个域名，一个主机可以配置多个域名，多个网站。" class="headerlink" title="每一个虚拟主机相当于一个域名，一个主机可以配置多个域名，多个网站。"></a>每一个虚拟主机相当于一个域名，一个主机可以配置多个域名，多个网站。</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /usr/local/tomcat/conf/server.xml     //Tomcat的配置文件格式是xml和Apache的不一样</span><br><span class="line">#搜索&lt;/Host&gt;,在&lt;/Host&gt;下面增加如下内容：</span><br><span class="line">... ...</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line"></span><br><span class="line">&lt;Host name=&quot;www.123.cn&quot; appBase=&quot;&quot;</span><br><span class="line">    unpackWARs= &quot;true&quot; autoDeploy=&quot;true&quot;</span><br><span class="line">    xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;</span><br><span class="line">    &lt;Context path=&quot;&quot; docBase=&quot;/data/wwwroot/123.cn/&quot; debug=&quot;0&quot; reloadable=&quot;true&quot; crossContext=&quot;true&quot;/&gt;</span><br><span class="line">#appbase是指定Tomcat的应用项目的位置（war文件：JAVA的应用）</span><br><span class="line">#unpackWARs是否自动解压WAR包</span><br><span class="line">#如果未使用appbase参数指定，可以使用docbase来指定应用存放目录</span><br><span class="line">#当这两个参数同时存在时，需要将其中一个写为空，以免相互干扰</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line"></span><br><span class="line">&lt;/engine&gt;</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>其中<host>和</host>之间的配置为虚拟主机配置部分，name定义域名，<br>appBase定义应用的目录，Java的应用通常是一个war的压缩包，你只需要将war的压缩包放到appBase目录下面即可。刚刚阿铭访问的Tomcat默认页其实就是在appBase目录下面，不过是在它子目录ROOT里。</p>
<ul>
<li>docBase，这个参数用来定义网站的文件存放路径，如果不定义，默认是在appBase/ROOT下面，定义了docBase就以该目录为主了，其中appBase和docBase可以一样。在这一步操作过程中很多同学遇到过访问404的问题，其实就是docBase没有定义对。</li>
<li>appBase为应用存放目录，通常是需要把war包直接放到该目录下面，它会自动解压成一个程序目录</li>
</ul>
<h2 id="部署java站点"><a href="#部署java站点" class="headerlink" title="部署java站点"></a>部署java站点</h2><h3 id="1-下载站点程序zrlog"><a href="#1-下载站点程序zrlog" class="headerlink" title="1.下载站点程序zrlog"></a>1.下载站点程序zrlog</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# wget http://dl.zrlog.com/release/zrlog-1.7.1-baaecb9-release.war</span><br></pre></td></tr></table></figure>

<h3 id="2-创建站点目录"><a href="#2-创建站点目录" class="headerlink" title="2.创建站点目录"></a>2.创建站点目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# mkdir -p /data/wwwroot/123.cn/</span><br></pre></td></tr></table></figure>

<h3 id="3-解压war包，并复制到自定义的站点目录"><a href="#3-解压war包，并复制到自定义的站点目录" class="headerlink" title="3.解压war包，并复制到自定义的站点目录"></a>3.解压war包，并复制到自定义的站点目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# cp zrlog-1.7.1-baaecb9-release.war   /usr/local/tomcat/webapps/</span><br><span class="line">#appbase支持自动解压war包的，将zrlog包放到appbase的指定目录下</span><br><span class="line"></span><br><span class="line">[root@localhost src]# ls /usr/local/tomcat/webapps/</span><br><span class="line">docs      host-manager  ROOT                        zrlog-1.7.1-baaecb9-release.war</span><br><span class="line">examples  manager      zrlog-1.7.1-baaecb9-release</span><br><span class="line">#拷贝过去后，zrlog包会自动被解压，解压后就可以直接访问该文件。  </span><br><span class="line"></span><br><span class="line">[root@localhost src]# cd /usr/local/tomcat/webapps/   </span><br><span class="line">[root@localhost webapps]# mv zrlog-1.7.1-baaecb9-release zrlog    //重命名</span><br></pre></td></tr></table></figure>

<p>注意：zrlog-1.7.1-baaecb9-release的名字太长，实际使用不方便，我们把它的名字改为zrlog。因为删除war包或者更改war包的名字，appbase的指定目录下的解压内容的名字也会随之删除和更改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost webapps]# mv zrlog/*  /data/wwwroot/123.cn/</span><br><span class="line">[root@localhost webapps]# cd  /data/wwwroot/123.cn/</span><br><span class="line">[root@localhost 123.cn]# ls</span><br><span class="line">admin  assets  error  favicon.ico  include  install  META-INF  WEB-INF</span><br></pre></td></tr></table></figure>

<h3 id="4-重启Tomcat"><a href="#4-重启Tomcat" class="headerlink" title="4.重启Tomcat"></a>4.重启Tomcat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 123.cn]# /usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">[root@localhost 123.cn]# /usr/local/tomcat/bin/startup.sh</span><br><span class="line">``` </span><br><span class="line">#### 5.配置外部电脑的hosts文件</span><br><span class="line">打开C:\Program Files\Git\etc\hosts，在最下面写入</span><br></pre></td></tr></table></figure>

<p>192.168.2.180   <a href="http://www.123.cn" target="_blank" rel="noopener">www.123.cn</a>   123.cn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">### 6.电脑浏览器访问，进入类似wordpress安装界面</span><br><span class="line"></span><br><span class="line">在浏览器输入IP：192.168.2.180或者www.123.cn进入安装向导</span><br><span class="line"> </span><br><span class="line">### 7.在MySQL中创建zrlog数据库</span><br></pre></td></tr></table></figure>

<p>[root@localhost ~]# mysql -uroot -p123456<br>Welcome to the MySQL monitor.<br>mysql&gt; create database zrlog;    //创建数据库zrlog<br>Query OK, 1 row affected (0.00 sec)</p>
<p>mysql&gt; grant all on zrlog.* to ‘zrlog’@’127.0.0.1’ identified by ‘123456’;    //给zrlog库授权<br>Query OK, 0 rows affected (0.00 sec)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">### 8.安装向导界面配置填写</span><br><span class="line"></span><br><span class="line">Zrlog - 安装向导</span><br><span class="line"></span><br><span class="line"> 1.数据库 --- 2.网站信息 --- 3.完成</span><br><span class="line"></span><br><span class="line"> 填写网站信息</span><br><span class="line">	管理员帐号：admin</span><br><span class="line">	管理员密码：123456</span><br><span class="line">	管理员邮箱：zhouqunic@qq.com</span><br><span class="line">	网站标题：yuntai linux zrlog</span><br><span class="line">	网站子标题：Are you OK?</span><br><span class="line">	</span><br><span class="line">下一步：完成</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 9.成功安装</span><br><span class="line">成功后，会显示网站主页面，有问题会报错，根据提示解决。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 16.8 Tomcat日志</span><br><span class="line">## 日志的位置和作用</span><br></pre></td></tr></table></figure>

<p>[root@host webapps]# ls /usr/local/tomcat/logs<br>catalina.2017-10-08.log  catalina.out  host-manager.2017-10-08.log  localhost.2017-10-08.log  localhost_access_log.2017-10-08.txt  manager.2017-10-08.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- 其中catalina开头的日志为Tomcat的综合日志，它记录Tomcat服务相关信息，也会记录错误日志。</span><br><span class="line">- 其中catalina.2017-xx-xx.log和catalina.out内容相同，前者会每天生成一个新的日志。</span><br><span class="line">- host-manager和manager为管理相关的日志，其中host-manager为虚拟主机的管理日志。</span><br><span class="line">- localhost和localhost_access为虚拟主机相关日志，其中带access字样的日志为访问日志，不带access字样的为默认虚拟主机的错误日志。</span><br><span class="line"></span><br><span class="line">## 开启生成 访问日志</span><br><span class="line">访问日志默认不会生成，需要在server.xml中配置一下。</span><br></pre></td></tr></table></figure>

<p>具体方法是在对应虚拟主机的<host></host>里面加入下面的配置（假如域名为123.cn）：<br><valve classname="org.apache.catalina.valves.AccessLogValve" directory="logs" prefix="123.cn_access" suffix=".log" pattern="%h %l %u %t &quot;%r&quot; %s %b"></valve></p>
<p>#prefix定义访问日志的前缀，</p>
<p>#suffix定义日志的后缀，</p>
<p>#pattern定义日志格式。</p>
<pre><code>新增加的虚拟主机默认并不会生成类似默认虚拟主机的那个localhost.日期.log日志，错误日志会统一记录到catalina.out中。


## 注意
关于Tomcat日志，最需要关注catalina.out，当出现问题时，我们应该第一想到去查看它。


#扩展

##JAR、WAR包区别 
http://blog.csdn.net/lishehe/article/details/41607725

##tomcat常见配置汇总 
http://blog.sina.com.cn/s/blog_4ab26bdd0100gwpk.html

##resin安装 
http://fangniuwa.blog.51cto.com/10209030/1763488/</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/16.1-16.3 Tomcat介绍、安装jdk、安装Tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/16.1-16.3 Tomcat介绍、安装jdk、安装Tomcat/" itemprop="url">16.1-16.3 Tomcat介绍、安装jdk、安装Tomcat</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#16.1 Tomcat介绍</p>
<blockquote>
<p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现，Tomcat 5 支持最新的Servlet 2.4 和JSP 2.0 规范。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。目前最新版本是8.0。</p>
</blockquote>
<ul>
<li>Tomcat是Apache软件基金会（Apache Software Foundation）的Jakarta项目中的一个核心项目，由Apache、Sun和其他一些公司及个人共同开发而成。</li>
<li>java程序写的网站用tomcat+jdk来运行</li>
<li>tomcat是一个中间件，真正起作用的，解析java脚本的是jdk</li>
<li>jdk（java development kit）是整个java的核心，它包含了java运行环境和一堆java相关的工具以及java基础库。</li>
<li>最主流的jdk为sun公司发布的jdk，除此之外，其实IBM公司也有发布JDK，CentOS上也可以用yum安装openjdk，我们这次要安装的是sun公司的jdk。</li>
</ul>
<p>#16.2 安装jdk<br>因为Tomcat的安装需要jdk里面的一些包的支持，所以先安装jdk。我们先到sun公司的jdk官网下载相应的版本到本地主机，再用xftp传输到虚拟机中的/usr/local/src目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdk版本1.6，1.7，1.8</span><br><span class="line">jdk-8u144-linux-x64.tar.gz</span><br><span class="line">官网下载地址 http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</span><br></pre></td></tr></table></figure>

<p>##准备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cd /usr/local/src/</span><br><span class="line">[root@host src]# wget http://download.oracle.com/otn-pub/java/jdk/8u144-b01/jdk-8u144-linux-x64.tar</span><br><span class="line">[root@host src]# tar zxvf jdk-8u144-linux-x64.gz    //解压</span><br><span class="line">……</span><br><span class="line">[root@host src]# mv jdk1.8.0_144 /usr/local/jdk1.8</span><br><span class="line">[root@host src]# cd /usr/local/jdk1.8/</span><br></pre></td></tr></table></figure>

<p>##编辑关于jdk的环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@host jdk1.8]# vim /etc/profile</span><br><span class="line">……#把下面几行添加到文件的最后面</span><br><span class="line">JAVA_HOME=/usr/local/jdk1.8/</span><br><span class="line">JAVA_BIN=/usr/local/jdk1.8/bin</span><br><span class="line">JRE_HOME=/usr/local/jdk1.8/jre</span><br><span class="line">PATH=$PATH:/usr/local/jdk1.8/bin:/usr/local/jdk1.8/jre/bin</span><br><span class="line">CLASSPATH=/usr/local/jdk1.8/jre/lib:/usr/local/jdk1.8/lib:/usr/local/jdk1.8/jre/lib/charset.jar</span><br><span class="line"></span><br><span class="line">刷新下环境变量：</span><br><span class="line">[root@host jdk1.8]# source /etc/profile</span><br></pre></td></tr></table></figure>

<p>##检测JDK是否安装成功：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host jdk1.8]# java -version</span><br><span class="line">java version &quot;1.8.0_144&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</span><br><span class="line">#若该命令执行成功，且执行结果和安装信息一致，说明配置成功。 </span><br><span class="line">#若反馈的不是该命令，则说明有问题，可以卸载（前提是空的主机，如果是工作中的服务器，系统里面有其他程序在运行，就需要注意了）</span><br></pre></td></tr></table></figure>

<p>#16.3 安装Tomcat</p>
<p>##准备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">下载Tomcat二进制包</span><br><span class="line">[root@host src]# cd /usr/local/src/</span><br><span class="line">[root@host src]# wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-8/v8.5.23/bin/apache-tomcat-8.5.23.tar.gz</span><br><span class="line">或者 wget http://archive.apache.org/dist/tomcat/tomcat-8/v8.5.23/bin/apache-tomcat-8.5.23.tar.gz</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">[root@host src]# tar zxf apache-tomcat-8.5.23.tar.gz</span><br><span class="line">[root@host src]# mv apache-tomcat-8.5.23  /usr/local/tomcat   //移动文件并改名</span><br><span class="line"></span><br><span class="line">关闭防火墙</span><br><span class="line">[root@localhost ~]# systemctl stop firewalld</span><br><span class="line">[root@localhost ~]# systemctl disable firewalld</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">Removed symlink /etc/systemd/system/basic.target.wants/firewalld.service.</span><br></pre></td></tr></table></figure>

<p>##启动Tomcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host src]# /usr/local/tomcat/bin/startup.sh </span><br><span class="line">Using CATALINA_BASE:  /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:  /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk1.8</span><br><span class="line">Using CLASSPATH:      /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure>

<p>##关闭Tomcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@host src]# /usr/local/tomcat/bin/shutdown.sh </span><br><span class="line">Using CATALINA_BASE:  /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:  /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk1.8</span><br><span class="line">Using CLASSPATH:      /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line"></span><br><span class="line">[root@host src]# ps aux|grep tomcat    //确认是否开启</span><br><span class="line">root      2692 47.4  7.6 2266388 77132 pts/0  Sl  11:44  0:02 /usr/local/jdk1.8/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root      2709  0.0  0.0 112680  976 pts/0    R+  11:44  0:00 grep --color=auto tomcat</span><br><span class="line"></span><br><span class="line">Tomcat服务不支持restart</span><br></pre></td></tr></table></figure>

<p>##查看是否有java进程启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host src]# netstat -lntp |grep java</span><br><span class="line">tcp6      0      0 :::8080                :::*                    LISTEN      2569/java          </span><br><span class="line">tcp6      0      0 127.0.0.1:8005          :::*                    LISTEN      2569/java          </span><br><span class="line">tcp6      0      0 :::8009                :::*                    LISTEN      2569/java </span><br><span class="line"></span><br><span class="line">#三个端口：8080；8005；8009</span><br><span class="line">#8080为提供web服务的端口</span><br><span class="line">#8005为管理端口</span><br><span class="line">#8009端口为第三方服务调用的端口（比如httpd和Tomcat结合时会用到）</span><br></pre></td></tr></table></figure>

<p>#扩展</p>
<p>##java容器比较<br><a href="http://my.oschina.net/diedai/blog/271367" target="_blank" rel="noopener">http://my.oschina.net/diedai/blog/271367</a><br><a href="http://www.360doc.com/content/11/0618/21/16915_127901371.shtml" target="_blank" rel="noopener">http://www.360doc.com/content/11/0618/21/16915_127901371.shtml</a></p>
<p>##j2ee、j2se、ejb、javabean、serverlet、jsp之间关系<br><a href="http://blog.csdn.net/ququhu/article/details/73470" target="_blank" rel="noopener">http://blog.csdn.net/ququhu/article/details/73470</a></p>
<p>##tomcat server.xml配置详解<br><a href="http://blog.csdn.net/yuanxuegui2008/article/details/6056754" target="_blank" rel="noopener">http://blog.csdn.net/yuanxuegui2008/article/details/6056754</a></p>
<p>##tomcat常用数据库连接的方法<br><a href="http://wjw7702.blog.51cto.com/5210820/1109263" target="_blank" rel="noopener">http://wjw7702.blog.51cto.com/5210820/1109263</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/19.12-19.16 Zabbix添加自定义监控项目、配置邮件告警、测试告警、不发邮件的问题处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/19.12-19.16 Zabbix添加自定义监控项目、配置邮件告警、测试告警、不发邮件的问题处理/" itemprop="url">19.12-19.16 Zabbix添加自定义监控项目、配置邮件告警、测试告警、不发邮件的问题处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="19-12-添加自定义监控项目"><a href="#19-12-添加自定义监控项目" class="headerlink" title="19.12 添加自定义监控项目"></a>19.12 添加自定义监控项目</h1><p>该配置的用途是监控模板中没有的监控项目。</p>
<h2 id="1-需求"><a href="#1-需求" class="headerlink" title="1 需求"></a>1 需求</h2><p>监控某台web的80端口连接数，并出图。<br>步骤：<br>1） zabbix监控中心创建监控项目<br>2） 针对该监控项目以图形展现</p>
<h2 id="2-配置客户端80端口的监控脚本"><a href="#2-配置客户端80端口的监控脚本" class="headerlink" title="2 配置客户端80端口的监控脚本"></a>2 配置客户端80端口的监控脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-02 ~]# vim /usr/local/sbin/estab.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"># 获取80端口并发连接数</span><br><span class="line">netstat -ant |grep &apos;:80 &apos; |grep -c ESTABLISHED</span><br><span class="line"># 注意：80后面跟一个空格，保证匹配更精确，如果不加空格，会把8080端口同时过滤出来。</span><br><span class="line"></span><br><span class="line">更改权限：</span><br><span class="line">[root@yt-02 ~]# chmod 755 /usr/local/sbin/estab.sh</span><br></pre></td></tr></table></figure>

<h2 id="3-打开zabbix客户端的自定义脚本开关："><a href="#3-打开zabbix客户端的自定义脚本开关：" class="headerlink" title="3 打开zabbix客户端的自定义脚本开关："></a>3 打开zabbix客户端的自定义脚本开关：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line"># 搜索 /UnsafeUserParameters和UserParameter</span><br><span class="line">……</span><br><span class="line">UnsafeUserParameters=1 #表示使用自定义脚本</span><br><span class="line"># 自定义监控项的key（监控web端“键值”）为my.estab.count，后面的[*]里面写的是脚本参数 </span><br><span class="line">UserParameter=my.estab.count[*],/usr/local/sbin/estab.sh</span><br><span class="line"># 如果没有参数则可以省略，脚本为/usr/local/sbin/estab.sh</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">找到 # Include=/usr/local/etc/zabbix_agentd.conf.d/ 在下面添加读取用户参数的文件路径</span><br><span class="line">Include=/usr/local/zabbix/conf/zabbix_agentd/</span><br><span class="line">然后在/usr/local/zabbix/conf/zabbix_agentd/下创建userparameter.conf 文件，编辑此文件</span><br><span class="line">vi /usr/local/zabbix/conf/zabbix_agentd/tomcat.conf</span><br><span class="line">添加想要监控的项，比如UserParameter=tomcat,/home/zabbix/monitor/java.sh</span><br><span class="line">多个自定义监控项都可写在这个文件里</span><br><span class="line"></span><br><span class="line">重启zabbix-agent服务</span><br><span class="line">[root@z2 ~]# systemctl restart zabbix-agent</span><br></pre></td></tr></table></figure>

<h2 id="4-服务端使用zabbix自带命令测试该脚本"><a href="#4-服务端使用zabbix自带命令测试该脚本" class="headerlink" title="4 服务端使用zabbix自带命令测试该脚本"></a>4 服务端使用zabbix自带命令测试该脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# zabbix_get -s 192.168.122.131 -p 10050 -k &apos;my.estab.count&apos;</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">-s：源地址</span><br><span class="line">-p： 端口</span><br><span class="line">-k： 键值</span><br><span class="line">如上显示0即为没有任何连接。</span><br></pre></td></tr></table></figure>

<p>出现的问题的话：</p>
<ul>
<li>关闭iptables</li>
<li>关闭selinux</li>
<li>检查脚本权限</li>
</ul>
<h2 id="5-配置web端参数"><a href="#5-配置web端参数" class="headerlink" title="5 配置web端参数"></a>5 配置web端参数</h2><h3 id="创建监控项"><a href="#创建监控项" class="headerlink" title="创建监控项"></a>创建监控项</h3><p>配置 → 主机 → 监控项 → 创建监控项</p>
<h3 id="创建图形"><a href="#创建图形" class="headerlink" title="创建图形"></a>创建图形</h3><p>“配置”→“主机” →“图形” → 创建图形”</p>
<p>添加该项目后，到“监测中” → “最新数据”查看刚添加的项目是否有数据出现 有了数据就可以添加图形了。</p>
<h3 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h3><h1 id="19-13-19-14-配置邮件告警"><a href="#19-13-19-14-配置邮件告警" class="headerlink" title="19.13/19.14 配置邮件告警"></a>19.13/19.14 配置邮件告警</h1><p>配置告警是目前绝大多数企业必须要有的一个状态，遇到问题第一时间获得警告大大提升了运维的高效性，如果没有配置任何告警，等待客户反应，这是一个非常不明智的选择。</p>
<h2 id="1-选择邮箱"><a href="#1-选择邮箱" class="headerlink" title="1 选择邮箱"></a>1 选择邮箱</h2><p>建议配置一个163邮箱、移动139邮箱或者QQ邮箱，然后邮箱绑定微信，在遇到故障的第一时间就可以收到告警邮件。<br>以163为例子，记得开启授权码和POP3/SMTP/IMAP服务。</p>
<h2 id="2-编辑zabbix报警媒介"><a href="#2-编辑zabbix报警媒介" class="headerlink" title="2 编辑zabbix报警媒介"></a>2 编辑zabbix报警媒介</h2><p>管理 → 报警媒介类型 → 创建媒体类型（不建议用自带的脚本，不好用）<br>脚本名称一定要用自己自定义的！！！ </p>
<p>脚本参数（不然不可以发邮件）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;ALERT.SENDTO&#125; //发给谁</span><br><span class="line">&#123;ALERT.SUBJECT&#125; //主题</span><br><span class="line">&#123;ALERT.MESSAGE&#125; //邮件内容</span><br></pre></td></tr></table></figure>

<h2 id="3-写一个报警的邮件脚本"><a href="#3-写一个报警的邮件脚本" class="headerlink" title="3 写一个报警的邮件脚本"></a>3 写一个报警的邮件脚本</h2><p>服务端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">查看报警脚本保存路径：</span><br><span class="line">[root@yt-01 ~]# vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">脚本位置 AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line"></span><br><span class="line">创建报警脚本mail.py：</span><br><span class="line"></span><br><span class="line">[root@z1 ~]# cd /usr/lib/zabbix/alertscripts</span><br><span class="line">[root@z1 alertscripts]# vim mail.py</span><br><span class="line"></span><br><span class="line">#!/usr/bin/env python</span><br><span class="line">#-*- coding: UTF-8 -*-</span><br><span class="line">import os,sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&apos;utf8&apos;)</span><br><span class="line">import getopt</span><br><span class="line">import smtplib</span><br><span class="line">from email.MIMEText import MIMEText</span><br><span class="line">from email.MIMEMultipart import MIMEMultipart</span><br><span class="line">from subprocess import *</span><br><span class="line">def sendqqmail(username,password,mailfrom,mailto,subject,content):</span><br><span class="line">    gserver = &apos;smtp.163.com&apos;     # smtp服务器</span><br><span class="line">    gport = 25                           # 默认端口是25</span><br><span class="line">    try:</span><br><span class="line">        msg = MIMEText(unicode(content).encode(&apos;utf-8&apos;))</span><br><span class="line">        msg[&apos;from&apos;] = mailfrom</span><br><span class="line">        msg[&apos;to&apos;] = mailto</span><br><span class="line">        msg[&apos;Reply-To&apos;] = mailfrom</span><br><span class="line">        msg[&apos;Subject&apos;] = subject</span><br><span class="line">        smtp = smtplib.SMTP(gserver, gport)</span><br><span class="line">        smtp.set_debuglevel(0)</span><br><span class="line">        smtp.ehlo()</span><br><span class="line">        smtp.login(username,password)</span><br><span class="line">        smtp.sendmail(mailfrom, mailto, msg.as_string())</span><br><span class="line">        smtp.close()</span><br><span class="line">    except Exception,err:</span><br><span class="line">        print &quot;Send mail failed. Error: %s&quot; % err</span><br><span class="line">def main():</span><br><span class="line">    to=sys.argv[1]</span><br><span class="line">    subject=sys.argv[2]</span><br><span class="line">    content=sys.argv[3]</span><br><span class="line">##定义163或者qq邮箱的账号和授权码，你需要修改成你自己的账号和密码（请不要把真实的用户名和密码放到网上公开，否则你会死的很惨）</span><br><span class="line">    sendqqmail(&apos;zhouqunic@163.com&apos;,&apos;zhouqun3&apos;,&apos;zhouqunic@163.com&apos;,to,subject,content)</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br><span class="line">#####脚本使用说明######</span><br><span class="line">#1. 首先定义好脚本中的邮箱账号和密码</span><br><span class="line">#2. 脚本执行命令为：python mail.py 目标邮箱 &quot;邮件主题&quot; &quot;邮件内容&quot;</span><br><span class="line"></span><br><span class="line">更改脚本权限</span><br><span class="line">[root@yt-01 alertscripts]# chmod 755 /usr/lib/zabbix/alertscripts/mail.py</span><br><span class="line">测试能否发邮件</span><br><span class="line">[root@yt-01 alertscripts]# python mail.py zhouqunic@163.com &quot;zhuti&quot; &quot;neirong&quot;</span><br><span class="line"># 用邮箱自己给自己发送邮件，保证其不出其他故障</span><br></pre></td></tr></table></figure>

<p>发送成功！</p>
<h2 id="4-配置用户"><a href="#4-配置用户" class="headerlink" title="4 配置用户"></a>4 配置用户</h2><p>创建一个接受告警邮件的用户，“管理”，“用户”，“创建用户”，“报警媒介”，类型选择“baojing”，注意用户的权限，如果没有需要到用户组去设置权限</p>
<h2 id="5-配置报警媒介"><a href="#5-配置报警媒介" class="headerlink" title="5 配置报警媒介"></a>5 配置报警媒介</h2><p>打开用户yuntai——报警媒介——添加报警媒介——更新</p>
<h2 id="6-配置权限"><a href="#6-配置权限" class="headerlink" title="6 配置权限"></a>6 配置权限</h2><p>需要到用户所在的“用户群组”更改用户的权限</p>
<h2 id="7-配置动作"><a href="#7-配置动作" class="headerlink" title="7 配置动作"></a>7 配置动作</h2><p>设置触发器被触发后所要执行的的操作！<br>“配置”——“动作”——“创建动作”</p>
<h1 id="19-15-测试告警"><a href="#19-15-测试告警" class="headerlink" title="19.15 测试告警"></a>19.15 测试告警</h1><p>配置 → 主机 → 触发器 → 创建触发器</p>
<p>条件改成，并发数小于5，咱们的虚拟机压根就没有任何人去访问，所以轻轻松松报警。 </p>
<p>反应很快：</p>
<p>把触发器改回 “&gt;200”，很快就好了，收到恢复邮件</p>
<h2 id="邮件乱码问题解决"><a href="#邮件乱码问题解决" class="headerlink" title="邮件乱码问题解决"></a>邮件乱码问题解决</h2><p>如上图，邮件中文都是方块的问题，有2个方案</p>
<ol>
<li>触发器和监控项都改为英文</li>
<li>更新mail.py告警邮件脚本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">#coding:utf-8</span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">import sys</span><br><span class="line">mail_host = &apos;smtp.163.com&apos;</span><br><span class="line">mail_user = &apos;abcdefg@xx.com&apos;</span><br><span class="line">mail_pass = &apos;1111111&apos;</span><br><span class="line">mail_postfix = &apos;163.com&apos;</span><br><span class="line">def send_mail(to_list,subject,content):</span><br><span class="line">    me = &quot;zabbix 监控告警平台&quot;+&quot;&lt;&quot;+mail_user+&quot;@&quot;+mail_postfix+&quot;&gt;&quot;</span><br><span class="line">    msg = MIMEText(content, &apos;plain&apos;, &apos;utf-8&apos;)</span><br><span class="line">    msg[&apos;Subject&apos;] = subject</span><br><span class="line">    msg[&apos;From&apos;] = me</span><br><span class="line">    msg[&apos;to&apos;] = to_list</span><br><span class="line">    try:</span><br><span class="line">        s = smtplib.SMTP()</span><br><span class="line">        s.connect(mail_host)</span><br><span class="line">        s.login(mail_user,mail_pass)</span><br><span class="line">        s.sendmail(me,to_list,msg.as_string())</span><br><span class="line">        s.close()</span><br><span class="line">        return True</span><br><span class="line">    except Exception,e:</span><br><span class="line">        print str(e)</span><br><span class="line">        return False</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    send_mail(sys.argv[1], sys.argv[2], sys.argv[3])</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="19-16-不发邮件的问题处理"><a href="#19-16-不发邮件的问题处理" class="headerlink" title="19.16 不发邮件的问题处理"></a>19.16 不发邮件的问题处理</h1><p>略</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现/" itemprop="url">19.7-19.11 Zabbix主动模式和被动模式、添加监控主机、添加自定义模板、处理图形中的乱码、自动发现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="19-7-主动模式和被动模式"><a href="#19-7-主动模式和被动模式" class="headerlink" title="19.7 主动模式和被动模式"></a>19.7 主动模式和被动模式</h1><p>主动模式和被动模式所针对的对象是客户端。<br>意思是客户端主动向服务端上报数据和由服务端到客户端采集数据。<br>数据的提交时间在监控中心设置。</p>
<h2 id="配置建议"><a href="#配置建议" class="headerlink" title="配置建议"></a>配置建议</h2><ul>
<li>当客户端数量非常多时，建议使用主动模式，这样可以降低服务端的压力。</li>
<li>当服务端有公网IP，客户端只有内网IP但是可以连接外网（使用iptables的nat表规则实现），这种场景适合使用主动模式</li>
<li>如果server量不是太多的话，两种模式都可。</li>
</ul>
<h1 id="19-8-添加监控主机"><a href="#19-8-添加监控主机" class="headerlink" title="19.8 添加监控主机"></a>19.8 添加监控主机</h1><ul>
<li>主机群组：在此先创建主机群组，然后再添加要监控的机器到已有群组中。这样做的好处是，在不同的主机群组设置不同监控规则，然后可以把想要使用同样规则的主机添加到指定群组进行管理，避免为每台主机去配置规则。</li>
<li>模板：预设的监控项目集合（监控规则末班）</li>
<li>主机：在监控中的所有机器</li>
</ul>
<h2 id="1-添加主机组"><a href="#1-添加主机组" class="headerlink" title="1 添加主机组"></a>1 添加主机组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">配置 → 主机群组 → 创建主机群组（添加主机前先要创建组）</span><br><span class="line"></span><br><span class="line">组名：yt-test → 添加即可。</span><br><span class="line"></span><br><span class="line">配置 → 主机 → 创建主机</span><br><span class="line"></span><br><span class="line">主机名称：yt-02（在被监控主机内有配置Hostname，此处填写这个）</span><br><span class="line">可见名称：yt-02（与上面保持一致即可）</span><br><span class="line"></span><br><span class="line">添加刚刚创建的组</span><br><span class="line"></span><br><span class="line">IP 地址：192.168.122.131（客户端的IP）</span><br><span class="line">DNS名称：目前用不到，不用写，如果该IP有对应的域名，则需要添加到“DNS名称”中</span><br><span class="line">端口：10050（默认，或填写自定义的）</span><br><span class="line"></span><br><span class="line">第二个选项 模板 稍后讲，其他不用管</span><br><span class="line">点击最后的 添加 即可！</span><br></pre></td></tr></table></figure>

<h2 id="2-参数解析"><a href="#2-参数解析" class="headerlink" title="2 参数解析"></a>2 参数解析</h2><ul>
<li>应用集：监控项目的组集合</li>
<li>监控项：所有的监控项目</li>
<li>触发器：针对某一个监控项的监控规则（不填级别的规则颜色不同，会显示在首页主机状态中）</li>
<li>图形：根据监控历史数据绘制的图标</li>
<li>自动发现规则：zabbix自动监控系统文件，磁盘分区，网卡流量等，该部分自定义比较繁琐，所以使用自动发现规则</li>
<li>Web场景：在此可设置对主机上的某个站点进行监控，监控站点的任何非200页面的状态，并报警。</li>
</ul>
<h1 id="19-9-添加自定义模板"><a href="#19-9-添加自定义模板" class="headerlink" title="19.9 添加自定义模板"></a>19.9 添加自定义模板</h1><p>在“模板”中自定义监控规则，然后应用到监控主机中，方便个性化管理。<br>在模板里面我们可以增加很多自定义监控的项目，然后再次把模板链接到一个组内，当我们在组内增加了新的客户端就不需要我们再次去配置监控项目，直接加入组就ok了。</p>
<h2 id="1-创建自定义模版"><a href="#1-创建自定义模版" class="headerlink" title="1 创建自定义模版"></a>1 创建自定义模版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">配置 → 模板 → 创建模版</span><br><span class="line">模板名称：yuntai（自定义即可）</span><br><span class="line">群组：Templetes</span><br><span class="line">简单设置，添加即可。</span><br></pre></td></tr></table></figure>

<h2 id="2-快速的添加监控模板"><a href="#2-快速的添加监控模板" class="headerlink" title="2 快速的添加监控模板"></a>2 快速的添加监控模板</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 选择预设的一个模板（Template OS Linux）</span><br><span class="line">2. 点击“监控” → 选择一些我们需要的监控项 → 点击最下面的“复制” → 选择模板 → 找到刚刚创建的模板zhdy_monitor → 再次点击最下面的 “复制” 即可。</span><br><span class="line">3. 使用同样的方法，把其它的监控项完成。</span><br><span class="line">但是我们发现，其它选项都可以按照之前的步骤去操作，但是“自动发现”选项却没有“复制”这个选项。</span><br></pre></td></tr></table></figure>

<h2 id="3-复制其它模板的“自动发现”选项"><a href="#3-复制其它模板的“自动发现”选项" class="headerlink" title="3 复制其它模板的“自动发现”选项"></a>3 复制其它模板的“自动发现”选项</h2><ul>
<li><p>方案1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">导出有“自动发现”选项,模版的配置文件xxx.xml。用编辑器打开，删除其他多余的选项代码，再导入到自定义的模版里面</span><br><span class="line"># 工作量比较大，也容易出错，不推荐</span><br></pre></td></tr></table></figure>
</li>
<li><p>方案2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把已有的模版链接到自定义模版上，然后 取消链接，更新规则后，删除 不需要的监控项，删除 多余的应用集，就可以保留“自动发现”选项</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="19-10-处理图形中的乱码"><a href="#19-10-处理图形中的乱码" class="headerlink" title="19.10 处理图形中的乱码"></a>19.10 处理图形中的乱码</h1><ol>
<li>点击刚刚创建的主机 → 点击上面的选项“模板” → “链接指示器” → “添加” → “更新” → 然后我们就会看到模板的中的监控项全部复制到了新添加的主机中。</li>
<li>点击“图形” → 点击任意一个 → “预览” → 我们会发现其中出现了乱码：</li>
</ol>
<p><strong>这种情况是因为我们虚拟主机中没有能够解析这个字体的字体库。如何能够解决问题呢？</strong><br>这种情况其实很容易去处理，直接copy windows中的一个字体，放在linux中指定的路径即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@yt-01 ~]# vim /usr/share/zabbix/include/defines.inc.php</span><br><span class="line"></span><br><span class="line"># 搜索ZBX_FONTPATH</span><br><span class="line"># 它定义的路径是“fonts”，它是一个相对路径</span><br><span class="line"># 绝对路径为/usr/share/zabbix/fonts</span><br><span class="line"># 而字体文件为“ZBX_GRAPH_FONT_NAME”所定义的“graphfont”</span><br><span class="line"># 它是一个文件，绝对路径为  /usr/share/zabbix/fonts/graphfont </span><br><span class="line"></span><br><span class="line">先把windows下面的字体上传到服务器，然后再次mv到/usr/share/zabbix/fonts/</span><br><span class="line">lrwxrwxrwx 1 root root 33 4月 2 11:12 graphfont.ttf -&gt; /etc/alternatives/zabbix-web-font</span><br><span class="line">[root@yt-01 ~]# mv STLITI.TTF /usr/share/zabbix/fonts/</span><br><span class="line"></span><br><span class="line">然后把原有的字体改个名字，再次把我们上传的字体做个软链接即可。 </span><br><span class="line">[root@yt-01 ~]# cd /usr/share/zabbix/fonts/</span><br><span class="line">[root@yt-01 fonts]# ls</span><br><span class="line">graphfont.ttf STLITI.TTF</span><br><span class="line">[root@yt-01 fonts]# mv graphfont.ttf graphfont.ttf.bak</span><br><span class="line">[root@yt-01 fonts]# ln -s STLITI.TTF graphfont.ttf</span><br><span class="line"></span><br><span class="line">zabbix web页刷新，就可以看不到乱码了</span><br></pre></td></tr></table></figure>

<h1 id="19-11-自动发现"><a href="#19-11-自动发现" class="headerlink" title="19.11 自动发现"></a>19.11 自动发现</h1><p>点击“自动发现规则” → 按理来说，我们已经配置了自动发现规则，为什么在图形中没有看到任何图表显示呢？ 其原因是 我们虽然配置了，但是自动发现规则是1小时候才可以显示，我们可以手动编辑调节“数据更新间隔”为10分钟或者为了让其快速显示，也可以临时设置1分钟，当出来图表再次把更新时间间隔调节为600秒即可。 点击“更新”即可。 至于说压力问题，只要不是监控太多的客户端，这个值还是可以的。</p>
<p>然后（重启服务器与客户端的zabbix服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server端：</span><br><span class="line"># systemctl restart zabbix-server</span><br><span class="line">client端：</span><br><span class="line"># systemctl restart zabbix-agent</span><br></pre></td></tr></table></figure>

<p>然后我们再次回到“图形”，我们就发现了被监控的网卡。<br>如果需要修改模板内的状态显示风格或者颜色，可以进入“模板” → “自定义的模板” → “自动发现” → “点击监控的名称即可进去修改”。</p>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p>zabbix监控交换机（思科） <a href="http://tryrus.blog.51cto.com/10914693/1789847" target="_blank" rel="noopener">http://tryrus.blog.51cto.com/10914693/1789847</a><br>zabbix远程执行命令 <a href="http://www.ywnds.com/?p=6610" target="_blank" rel="noopener">http://www.ywnds.com/?p=6610</a><br>zabbix分布式部署 <a href="http://sfzhang88.blog.51cto.com/4995876/1364399" target="_blank" rel="noopener">http://sfzhang88.blog.51cto.com/4995876/1364399</a><br>zabbix监控tomcat（版本有点老，大家只需要参考步骤，不能照搬） <a href="http://www.jianshu.com/p/e3825a885a1b" target="_blank" rel="noopener">http://www.jianshu.com/p/e3825a885a1b</a> <a href="http://www.fblinux.com/?p=616" target="_blank" rel="noopener">http://www.fblinux.com/?p=616</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.1 - 20.4 shell脚本结构和执行、变量、date命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.1 - 20.4 shell脚本结构和执行、变量、date命令/" itemprop="url">20.1 - 20.4 shell脚本结构和执行、变量、date命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#20.1 shell脚本介绍</p>
<ul>
<li>shell是一种脚本语言</li>
<li>可以使用逻辑判断、循环等语法</li>
<li>可以自定义函数</li>
<li>shell是系统命令的集合</li>
<li>shell脚本可以实现自动化运维，能大大增加我们的运维效率</li>
</ul>
<p>#20.2 shell脚本结构和执行</p>
<ul>
<li>开头需要加#!/bin/bash，告诉系统该脚本是要以bin/bash文件解释器执行</li>
<li>以#开头的行作为解释说明</li>
<li>脚本的名字以.sh结尾，用于区分这是一个shell脚本</li>
<li>执行方法有两种<br>  chmod +x 1.sh; ./1.sh<br>  bash 1.sh</li>
<li>查看脚本执行过程 bash -x 1.sh</li>
<li>查看脚本是否语法错误  bash -n 1.sh</li>
</ul>
<p>#20.3 date命令用法</p>
<blockquote>
<p>很多shell脚本里面需要打印不同格式的时间或日期，以及要根据时间和日期执行操作。延时通常用于脚本执行过程中提供一段等待的时间。日期可以以多种格式去打印，也可以使用命令设置固定的格式。在类UNIX系统中，日期被存储为一个整数，其大小为自世界标准时间（UTC）1970年1月1日0时0分0秒起流逝的秒数。 </p>
</blockquote>
<p>date命令是显示或设置系统时间与日期。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date    //显示当前时区的当前时间</span><br><span class="line">Fri Sep 15 06:08:45 CST 2017</span><br></pre></td></tr></table></figure>

<p>##语法<br>date(选项)(参数)</p>
<p>##选项<br>-d&lt;字符串&gt;：显示字符串所指的日期与时间。字符串前后必须加上双引号；<br>-s&lt;字符串&gt;：根据字符串来设置日期与时间。字符串前后必须加上双引号；<br>-u：显示GMT；<br>–help：在线帮助；<br>–version：显示版本信息。</p>
<p>##参数<br>&lt;+时间日期格式&gt;：指定显示时使用的日期时间格式。</p>
<p>##用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- date  +%Y-%m-%d, date +%y-%m-%d 年月日</span><br><span class="line">- date  +%H:%M:%S = date +%T 时间</span><br><span class="line">- date +%s  时间戳</span><br><span class="line">- date -d @1504620492</span><br><span class="line">- date -d &quot;+1day&quot;  一天后</span><br><span class="line">- date -d &quot;-1 day&quot;  一天前</span><br><span class="line">- date -d &quot;-1 month&quot; 一月前</span><br><span class="line">- date -d &quot;-1 min&quot;  一分钟前</span><br><span class="line">- date +%w, date +%W 星期</span><br></pre></td></tr></table></figure>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><ul>
<li><p>查看系统日历</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# cal</span><br><span class="line">  September 2017  </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">                1  2</span><br><span class="line">3  4  5  6  7  8  9</span><br><span class="line">10 11 12 13 14 15 16</span><br><span class="line">17 18 19 20 21 22 23</span><br><span class="line">24 25 26 27 28 29 30</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示年份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%Y   //以四位数显示年份</span><br><span class="line">2017</span><br><span class="line">[root@host ~]# date +%y   //以两位数显示年份</span><br><span class="line">17</span><br></pre></td></tr></table></figure>
</li>
<li><p>分别显示：年、月、日、时、分、秒、星期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date &quot;+%Y-%m-%d %H:%M:%S %w&quot;</span><br><span class="line">2017-09-15 06:15:44 5</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示年月日</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%D</span><br><span class="line">09/15/17</span><br><span class="line">[root@host ~]# date +%Y%m%d</span><br><span class="line">20170915</span><br><span class="line">[root@host ~]# date +%F</span><br><span class="line">2017-09-15</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他时间显示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%h    //显示现在的月份</span><br><span class="line">Sep</span><br><span class="line">[root@host ~]# date +%W   //显示今年的第几周</span><br><span class="line">37</span><br><span class="line">[root@host ~]# date +%T   //显示当前时间几点几分几秒</span><br><span class="line">06:21:34</span><br><span class="line">[root@host ~]# date +%s   //显示时间戳，表示距离 从1970年1月1日00:00:00到现在 经历的秒数</span><br><span class="line">1505427580</span><br><span class="line"></span><br><span class="line">#时间戳换算</span><br><span class="line">[root@host ~]# date +%s -d &quot;2017-09-15 12:00:00&quot;</span><br><span class="line">1505448000</span><br><span class="line">[root@host ~]# date -d @1505448000</span><br><span class="line">Fri Sep 15 12:00:00 CST 2017</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>##打印指定日期&amp;时间<br>工作中，有时候需要使用N天前的日期或时间<br>格式是<code>date -d &quot;1 day&quot; +%d</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@host ~]# date +%F             //今天的日期</span><br><span class="line">2017-09-15</span><br><span class="line">[root@host ~]# date -d &quot;-2 day&quot; +%d   //两天前多少号</span><br><span class="line">13</span><br><span class="line">[root@host ~]# date -d &quot;1 day ago&quot; +&quot;%Y-%m-%d&quot;    （=date -d &quot;1 day ago&quot; +%F）   //1天前的日期</span><br><span class="line">2017-09-14</span><br><span class="line">[root@host ~]# date -d &quot;-1 year -1 month -1 day&quot; +%Y-%m-%d    //前一年一个月一天的日期</span><br><span class="line">2016-08-14</span><br></pre></td></tr></table></figure>

<p>#20.4 shell脚本中的变量</p>
<ul>
<li>当脚本中使用某个字符串较频繁并且字符串长度很长时就应该使用变量代替</li>
<li>使用条件语句时，常使用变量    if [ $a -gt 1 ]; then … ; fi</li>
<li>引用某个命令的结果时，用变量替代  n=<code>wc -l 1.txt</code></li>
<li>写和用户交互的脚本时，变量也是必不可少的  read -p “Input a number: “ n; echo $n  如果没写这个n，可以直接使用$REPLY</li>
<li>内置变量 $0, $1, $2…    $0表示脚本本身，$1 第一个参数，$2 第二个 ….      $#表示参数个数</li>
<li>数学运算a=1;b=2; c=$(($a+$b))或者$[$a+$b] </li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本/" itemprop="url">20.10-20.15 for循环、while循环、break跳出循环、continue结束本次循环、exit退出整个脚本</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.10 for循环</p>
<p>###语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for 变量名 in 条件; do …; done</span><br></pre></td></tr></table></figure>

<p>###案例1<br>计算1到100的和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">sum=0</span><br><span class="line">for i in `seq 1 100`</span><br><span class="line">do</span><br><span class="line">    echo &quot;$sum+$i&quot;</span><br><span class="line">    sum=$[$sum+$i]</span><br><span class="line">done</span><br><span class="line">echo $sum</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x for1.sh </span><br><span class="line">+ sum=0</span><br><span class="line">++ seq 1 100</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 0+1</span><br><span class="line">0+1</span><br><span class="line">+ sum=1</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 1+2</span><br><span class="line">1+2</span><br><span class="line">+ sum=3</span><br><span class="line">... ...</span><br><span class="line">+ sum=4851</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 4851+99</span><br><span class="line">4851+99</span><br><span class="line">+ sum=4950</span><br><span class="line">+ for i in &apos;`seq 1 100`&apos;</span><br><span class="line">+ echo 4950+100</span><br><span class="line">4950+100</span><br><span class="line">+ sum=5050</span><br><span class="line">+ echo 5050</span><br><span class="line">5050</span><br></pre></td></tr></table></figure>

<p>###案例2<br>文件列表循环</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">cd /etc/</span><br><span class="line">for a in `ls /etc/`</span><br><span class="line">do</span><br><span class="line">    if [ -d $a ]</span><br><span class="line">    then</span><br><span class="line">      ls -d $a</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>###for循环的分隔符<br>for默认情况下会把空格或换行符（回车）作为分隔符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host /]# mkdir yuntai/</span><br><span class="line">[root@host /]# cd yuntai</span><br><span class="line">[root@host yuntai]# touch 1 2 3\ 4.txt</span><br><span class="line">[root@host yuntai]# ls -l</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 1</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 2</span><br><span class="line">-rw-r--r-- 1 root root 0 Oct 19 09:14 3 4.txt   </span><br><span class="line">#新建了一个名称中有空格的文件</span><br><span class="line">[root@host yuntai]# for i in `ls ./`; do echo $i ; done</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4.txt</span><br></pre></td></tr></table></figure>

<p>##20.11/20.12 while循环</p>
<p>###语法 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while 条件; do … ; done</span><br></pre></td></tr></table></figure>

<p>###案例1<br>当系统负载大于10的时候，发送邮件，每隔30秒执行一次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">while :</span><br><span class="line">#后面加冒号表示死循环的意思，也可以换成ture或者1</span><br><span class="line">do</span><br><span class="line">    load=`w|head -1|awk -F &apos;load average: &apos; &apos;&#123;print $2&#125;&apos;|cut -d. -f1`</span><br><span class="line">    if [ $load -gt 10 ]</span><br><span class="line">    then</span><br><span class="line">        top|mail -s &quot;load is high: $load&quot; xxxx@qq.com</span><br><span class="line">    fi</span><br><span class="line">    sleep 30</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>###案例2<br>一种交互模式，当用户输入对应内容，检测该字符是否符合条件，如：空、非数字、数字。分别对字符做出判断，然后做出不同的回应。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">while :</span><br><span class="line">do</span><br><span class="line">    read -p &quot;Please input a number: &quot; n</span><br><span class="line">    if [ -z &quot;$n&quot; ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;you need input sth.&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line">    n1=`echo $n|sed &apos;s/[0-9]//g&apos;`</span><br><span class="line">    if [ -n &quot;$n1&quot; ]</span><br><span class="line">    then</span><br><span class="line">        echo &quot;you just only input numbers.&quot;</span><br><span class="line">        continue</span><br><span class="line">    fi</span><br><span class="line">    break</span><br><span class="line">#continue: 中断本次while循环后重新开始；</span><br><span class="line">#break: 表示跳出本层循环，即该while循环结束</span><br><span class="line">done</span><br><span class="line">echo $n</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x while2.sh </span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number:  </span><br><span class="line">+ &apos;[&apos; -z &apos;&apos; &apos;]&apos;</span><br><span class="line">+ echo &apos;you need input sth.&apos;</span><br><span class="line">you need input sth.</span><br><span class="line">+ continue</span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number: z</span><br><span class="line">+ &apos;[&apos; -z z &apos;]&apos;</span><br><span class="line">++ sed &apos;s/[0-9]//g&apos;</span><br><span class="line">++ echo z</span><br><span class="line">+ n1=z</span><br><span class="line">+ &apos;[&apos; -n z &apos;]&apos;</span><br><span class="line">+ echo &apos;you just only input numbers.&apos;</span><br><span class="line">you just only input numbers.</span><br><span class="line">+ continue</span><br><span class="line">+ :</span><br><span class="line">+ read -p &apos;Please input a number: &apos; n</span><br><span class="line">Please input a number: 3</span><br><span class="line">+ &apos;[&apos; -z 3 &apos;]&apos;</span><br><span class="line">++ sed &apos;s/[0-9]//g&apos;</span><br><span class="line">++ echo 3</span><br><span class="line">+ n1=</span><br><span class="line">+ &apos;[&apos; -n &apos;&apos; &apos;]&apos;</span><br><span class="line">+ break</span><br><span class="line">+ echo 3</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>##20.13 break跳出循环<br>用于跳出循环语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line"># 数字最好用 -eq，如果是字符串，那么最好用 ==，这里用-eq更好</span><br><span class="line">    then</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh -x break1.sh </span><br><span class="line">++ seq 1 5</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 1</span><br><span class="line">1</span><br><span class="line">+ &apos;[&apos; 1 -eq 3 &apos;]&apos;</span><br><span class="line">+ echo 1</span><br><span class="line">1</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 2</span><br><span class="line">2</span><br><span class="line">+ &apos;[&apos; 2 -eq 3 &apos;]&apos;</span><br><span class="line">+ echo 2</span><br><span class="line">2</span><br><span class="line">+ for i in &apos;`seq 1 5`&apos;</span><br><span class="line">+ echo 3</span><br><span class="line">3</span><br><span class="line">+ &apos;[&apos; 3 -eq 3 &apos;]&apos;</span><br><span class="line">+ break</span><br><span class="line">+ echo aaaaaaa</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>##20.14 continue结束本次循环<br>用于结束本次循环，直接进入下次循环语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line">    then</span><br><span class="line">        continue</span><br><span class="line">#忽略continue之下的代码，直接进行下一次循环</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo $i</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh  continue1.sh </span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">3    </span><br><span class="line">4</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">5</span><br><span class="line">5</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>##20.15 exit退出整个脚本<br>直接退出整个脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">for i in `seq 1 5`</span><br><span class="line">do</span><br><span class="line">    echo $i</span><br><span class="line">    if [ $i == 3 ]</span><br><span class="line">    then</span><br><span class="line">        exit</span><br><span class="line">    fi</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo aaaaaaa</span><br><span class="line"></span><br><span class="line">[root@host shell]# sh exit1.sh </span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>##扩展 select用法<br>select也是循环的一种，它比较适合用在用户选择的情况下。<br>比如，我们有一个这样的需求，运行脚本后，让用户去选择数字，选择1，会运行w命令，选择2运行top命令，选择3运行free命令，选择4退出。脚本这样实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;</span><br><span class="line">        ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">执行结果如下：</span><br><span class="line">sh select.sh</span><br><span class="line">Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit</span><br><span class="line"></span><br><span class="line">1) w</span><br><span class="line">2) top</span><br><span class="line">3) free</span><br><span class="line">4) quit</span><br><span class="line">#? 1</span><br><span class="line">16:03:40 up 32 days,  2:42,  1 user,  load average: 0.01, 0.08, 0.08</span><br><span class="line">USER    TTY      FROM              LOGIN@  IDLE  JCPU  PCPU WHAT</span><br><span class="line">root    pts/0    61.135.172.68    15:33    0.00s  0.02s  0.00s sh select.sh</span><br><span class="line"></span><br><span class="line">#? 3</span><br><span class="line">            total      used      free    shared    buffers    cached</span><br><span class="line">Mem:      1020328    943736      76592          0      86840    263624</span><br><span class="line">-/+ buffers/cache:    593272    427056</span><br><span class="line">Swap:      2097144      44196    2052948</span><br><span class="line">#?</span><br></pre></td></tr></table></figure>

<p>我们发现，select会默认把序号对应的命令列出来，每次输入一个数字，则会执行相应的命令，命令执行完后并不会退出脚本。它还会继续让我们再次输如序号。序号前面的提示符，我们也是可以修改的，利用变量PS3即可，再次修改脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">PS3=&quot;Please select a number: &quot;</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;</span><br><span class="line">    esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>如果想要脚本每次输入一个序号后就自动退出，则需要再次更改脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">PS3=&quot;Please select a number: &quot;</span><br><span class="line">echo &quot;Please chose a number, 1: run w, 2: run top, 3: run free, 4: quit&quot;</span><br><span class="line">echo</span><br><span class="line">select command in w top free quit</span><br><span class="line">do</span><br><span class="line">    case $command in</span><br><span class="line">    w)</span><br><span class="line">        w;exit</span><br><span class="line">        ;;</span><br><span class="line">    top)</span><br><span class="line">        top;exit</span><br><span class="line">        ;;</span><br><span class="line">    free)</span><br><span class="line">        free;exit</span><br><span class="line">        ;;</span><br><span class="line">    quit)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please input a number:(1-4).&quot;;exit</span><br><span class="line">    esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目/" itemprop="url">20.19-20.22 告警系统需求分析、告警系统主脚本、配置文件、监控项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.19 告警系统需求分析</p>
<ul>
<li><p>需求：使用shell定制各种个性化告警工具，但需要统一化管理、规范化管理。</p>
</li>
<li><p>思路：指定一个脚本包，包含主程序、子程序、配置文件、邮件引擎、输出日志等。</p>
</li>
<li><p>主程序：作为整个脚本的入口，是整个系统的命脉。</p>
</li>
<li><p>配置文件：是一个控制中心，用它来开关各个子程序，指定各个相关联的日志文件。</p>
</li>
<li><p>子程序：这个才是真正的监控脚本，用来监控各个指标。</p>
</li>
<li><p>邮件引擎：是由一个python程序来实现，它可以定义发邮件的服务器、发邮件人以及发件人密码</p>
</li>
<li><p>输出日志：整个监控系统要有日志输出。</p>
</li>
<li><p>要求：我们的机器角色多种多样，但是所有机器上都要部署同样的监控系统，也就说所有机器不管什么角色，整个程序框架都是一致的，不同的地方在于根据不同的角色，定制不同的配置文件。</p>
</li>
<li><p>程序架构： </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin下是主程序</span><br><span class="line">conf下是配置文件</span><br><span class="line">shares下是各个监控脚本</span><br><span class="line">mail下是邮件引擎</span><br><span class="line">log下是日志。</span><br></pre></td></tr></table></figure>

<p>##20.20 告警系统主脚本</p>
<blockquote>
<p>主角本就是整个告警系统的入口，在使用中，我们直接执行它就可以了。</p>
</blockquote>
<p>###定义主角本的各个目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">以后工作中，我们就默认把脚本都放到/usr/local/sbin目录下，这样我们就可以轻松找到我们想要的脚本</span><br><span class="line">[root@host ~]# cd /usr/local/sbin     </span><br><span class="line"></span><br><span class="line">创建主目录和子目录</span><br><span class="line">[root@host sbin]# mkdir mon</span><br><span class="line">[root@host sbin]# cd mon</span><br><span class="line">[root@host mon]# mkdir mail log bin conf shares</span><br><span class="line">[root@host mon]# ls</span><br><span class="line">bin  conf  log  mail  shares</span><br><span class="line"></span><br><span class="line">把主脚本放大bin目录下</span><br><span class="line">[root@host mon]# cd bin</span><br></pre></td></tr></table></figure>

<p>###创建主脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@host bin]# vim main.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"># 是否发送邮件的开关</span><br><span class="line">export send=1</span><br><span class="line"># 过滤ip地址，关键词eth0可以根据主机网卡情况修改</span><br><span class="line">export addr=`/sbin/ifconfig |grep -A1 &quot;eth0: &quot;|awk &apos;/inet/ &#123;print $2&#125;&apos;`</span><br><span class="line">dir=`pwd`</span><br><span class="line"># 只需要最后一级目录名</span><br><span class="line">last_dir=`echo $dir|awk -F&apos;/&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class="line"># 下面的判断目的是，保证执行脚本的时候，我们在bin目录里，不然监控脚本、邮件和日志很有可能找不到</span><br><span class="line">if [ $last_dir == &quot;bin&quot; ] || [ $last_dir == &quot;bin/&quot; ]; then</span><br><span class="line">    conf_file=&quot;../conf/mon.conf&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;you shoud cd bin dir&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">exec 1&gt;&gt;../log/mon.log 2&gt;&gt;../log/err.log</span><br><span class="line">echo &quot;`date +&quot;%F %T&quot;` load average&quot;</span><br><span class="line">/bin/bash ../shares/load.sh</span><br><span class="line">#先检查配置文件中是否需要监控502</span><br><span class="line">if grep -q &apos;to_mon_502=1&apos; $conf_file; then</span><br><span class="line">    export log=`grep &apos;logfile=&apos; $conf_file |awk -F &apos;=&apos; &apos;&#123;print $2&#125;&apos; |sed &apos;s/ //g&apos;`</span><br><span class="line">    /bin/bash  ../shares/502.sh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>##20.21 告警系统配置文件</p>
<p>###配置文件的意义<br>主要是为了配合脚本的规范化，通过划分不同功能的文件，来方便查找、更改和控制脚本的各种参数。<br>我们可以在配置文件中统一定义一些开关参数、日志路径、用户名、密码、IP、端口等信息，主要是脚本中需要调用到的一些资源信息。</p>
<p>###创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@host bin]# cd /usr/local/sbin/mon</span><br><span class="line"></span><br><span class="line">[root@host mon]# vim conf/mon.conf</span><br><span class="line">## to config the options if to monitor</span><br><span class="line">## 定义mysql的服务器地址、端口以及user、password</span><br><span class="line">to_mon_cdb=0  </span><br><span class="line">##是否监控数据库，0 or 1, 默认是0，如果是1则监控，为0不监控</span><br><span class="line">db_ip=10.20.3.13</span><br><span class="line">db_port=3315</span><br><span class="line">db_user=username</span><br><span class="line">db_pass=passwd</span><br><span class="line">## 监控httpd  如果是1则监控，为0不监控</span><br><span class="line">to_mon_httpd=0</span><br><span class="line">## 监控php 如果是1则监控，为0不监控</span><br><span class="line">to_mon_php_socket=0</span><br><span class="line">## 监控http_code_502  需要定义访问日志的路径</span><br><span class="line">to_mon_502=1</span><br><span class="line">logfile=/data/log/xxx.xxx.com/access.log</span><br><span class="line">#定义日子文件路径</span><br><span class="line">## 监控request_count  定义日志路径以及域名</span><br><span class="line">to_mon_request_count=0</span><br><span class="line">req_log=/data/log/www.discuz.net/access.log</span><br><span class="line">domainname=www.discuz.net</span><br></pre></td></tr></table></figure>

<p>##20.22 告警系统监控项目</p>
<p>###监控系统负载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@host mon]# vim shares/load.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">##Writen by yuntai##</span><br><span class="line">load=`uptime |awk -F &apos;average:&apos; &apos;&#123;print $2&#125;&apos;|cut -d&apos;,&apos; -f1|sed &apos;s/ //g&apos; |cut -d. -f1`</span><br><span class="line">#获取负载值</span><br><span class="line">if [ $load -gt 10 ] &amp;&amp; [ $send -eq &quot;1&quot; ]</span><br><span class="line">#判断是否超负载，同时判断是否开启负载监控项</span><br><span class="line">then</span><br><span class="line">    echo &quot;$addr `date +%T` load is $load&quot; &gt;../log/load.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh yuntai_mail@163.com &quot;$addr\_load:$load&quot; `cat ../log/load.tmp`</span><br><span class="line">#超出设定的负载值后，发送邮件</span><br><span class="line">fi</span><br><span class="line">echo &quot;`date +%T` load is $load&quot;</span><br><span class="line">#日志文件（定义在系统配置脚本中）</span><br></pre></td></tr></table></figure>

<p>###监控web服务器502错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host mon]# cd shares/</span><br><span class="line">[root@host shares]# vim 502.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">d=`date -d &quot;-1 min&quot; +%H:%M`</span><br><span class="line">#因为监控主脚本一分钟执行一次，所以监控的内容为系统一分钟之前的状态</span><br><span class="line">c_502=`grep :$d:  $log  |grep &apos; 502 &apos;|wc -l`</span><br><span class="line">if [ $c_502 -gt 10 ] &amp;&amp; [ $send == 1 ]; then</span><br><span class="line">    echo &quot;$addr $d 502 count is $c_502&quot;&gt;../log/502.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh $addr\_502 $c_502  ../log/502.tmp</span><br><span class="line">fi</span><br><span class="line">echo &quot;`date +%T` 502 $c_502&quot;</span><br></pre></td></tr></table></figure>

<p>###监控磁盘使用率</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@host shares]# vim disk.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">##Writen by yuntai##</span><br><span class="line">rm -f ../log/disk.tmp</span><br><span class="line">for r in `df -h |awk -F &apos;[ %]+&apos; &apos;&#123;print $5&#125;&apos;|grep -v Use`</span><br><span class="line">##awk -F &apos;[ %]+&apos;  以一个或多个“[ %]”空格和百分号作为分隔符</span><br><span class="line">##即，awk可以一次指定多种分隔符（同时生效）</span><br><span class="line">do</span><br><span class="line">    if [ $r -gt 90 ] &amp;&amp; [ $send -eq &quot;1&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;$addr `date +%T` disk useage is $r&quot; &gt;&gt;../log/disk.tmp</span><br><span class="line">fi</span><br><span class="line">if [ -f ../log/disk.tmp ]</span><br><span class="line">#判断该文件是否存在</span><br><span class="line">then</span><br><span class="line">    df -h &gt;&gt; ../log/disk.tmp</span><br><span class="line">    /bin/bash ../mail/mail.sh $addr\_disk $r ../log/disk.tmp</span><br><span class="line">    echo &quot;`date +%T` disk useage is nook&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;`date +%T` disk useage is ok&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/17.1-17.5 MySQL主从配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/17.1-17.5 MySQL主从配置/" itemprop="url">17.1-17.5 MySQL主从配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="17-1-MySQL主从介绍"><a href="#17-1-MySQL主从介绍" class="headerlink" title="17.1 MySQL主从介绍"></a>17.1 MySQL主从介绍</h2><p>MySQL主从又叫做Replication、AB复制。简单讲就是A和B两台机器做主从后，在A上写数据，另外一台B也会跟着写数据，两者数据实时同步的。也就是说，当你在A机器写入一个表，再次查看B机器也会同步一个表。</p>
<h3 id="MySQL主从是基于binlog的，主上须开启binlog才能进行主从。"><a href="#MySQL主从是基于binlog的，主上须开启binlog才能进行主从。" class="headerlink" title="MySQL主从是基于binlog的，主上须开启binlog才能进行主从。"></a>MySQL主从是基于binlog的，主上须开启binlog才能进行主从。</h3><p>主从过程大致有3个步骤：</p>
<ul>
<li>主将更改操作记录到binlog里。</li>
<li>从将主的binlog事件(sql语句)同步到从本机上并记录在relaylog里。</li>
<li>从根据relaylog里面的sql语句按顺序执行 主上有一个log dump线程，用来和从的I/O线程传递binlog 从上有两个线程，其中I/O线程用来同步主的binlog并生成relaylog，另外一个SQL线程用来把relaylog里面的sql语句落地。</li>
</ul>
<h3 id="主从原理图："><a href="#主从原理图：" class="headerlink" title="主从原理图："></a>主从原理图：</h3><p>Master：主mysql<br>Slave：备mysql</p>
<blockquote>
<p>当有数据写进主mysql中的时候，就出自动生成一个log dump thread，记录到如上讲的binlog中，然后从数据库就会和主mysql有个线程进行交互，从服务器就会读取binlog日志到Slave，然后再次生成一个relay log（中继日志），然后再次和从服务器中的SQL thread线程进程交互执行。</p>
</blockquote>
<p>简单的说，就是<br>从服务器把主服务器上的binlog弄到自己服务器上去，然后根据这个binlog生成自己的relay日志，根据这个relay日志进行更改数据库，最终达到两边数据一致。</p>
<h3 id="主从的作用"><a href="#主从的作用" class="headerlink" title="主从的作用;"></a>主从的作用;</h3><h4 id="1-数据的备份；"><a href="#1-数据的备份；" class="headerlink" title="1.数据的备份；"></a>1.数据的备份；</h4><blockquote>
<p>假如A服务器（主）突然硬件问题，宕机了。但是线上跑了很多重要的数据，我们完全可以使用B服务器（从）直接顶上。</p>
</blockquote>
<h4 id="2-负载均衡；"><a href="#2-负载均衡；" class="headerlink" title="2. 负载均衡；"></a>2. 负载均衡；</h4><blockquote>
<p>我们线上的所有数据均是从A上面读取，由于压力比较大，我们可以使用B服务器分享一部分用户到自己的服务器，但是只是可以读，不可以写入数据。看图可知，数据的读取是有方向性的，如果首先从B上读取那就混乱了，数据肯定不一致了。就会导致主从失败！</p>
</blockquote>
<h2 id="17-2-准备工作"><a href="#17-2-准备工作" class="headerlink" title="17.2 准备工作"></a>17.2 准备工作</h2><p>因为是实验环境，直接准备了一台虚拟机，装好MYSQL后，再克隆一台虚拟机，避免其他变量影响。</p>
<h2 id="17-3-配置主"><a href="#17-3-配置主" class="headerlink" title="17.3 配置主"></a>17.3 配置主</h2><p>编辑配置文件添加如下参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/my.cnf</span><br><span class="line">……</span><br><span class="line">server-id=180</span><br><span class="line">#自定义</span><br><span class="line">log_bin=yuntai01</span><br><span class="line">#自定义定log前缀</span><br></pre></td></tr></table></figure>

<p>编辑完成后重启mysql服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL...... SUCCESS! </span><br><span class="line">Starting MySQL.................. SUCCESS!</span><br></pre></td></tr></table></figure>

<p>查看mysql库文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls -lt /data/mysql/</span><br><span class="line">总用量 110684</span><br><span class="line">-rw-rw----. 1 mysql mysql 50331648 12月 14 15:30 ib_logfile0</span><br><span class="line">-rw-rw----. 1 mysql mysql 12582912 12月 14 15:30 ibdata1</span><br><span class="line">-rw-rw----. 1 mysql mysql    56288 12月 14 15:30 localhost.localdomain.err</span><br><span class="line">-rw-rw----. 1 mysql mysql        5 12月 14 15:30 localhost.localdomain.pid</span><br><span class="line">drwx------. 2 mysql mysql    4096 12月 12 18:13 zrlog</span><br><span class="line">-rw-rw----. 1 mysql mysql      143 12月 12 17:45 yuntai.000001    #重要</span><br><span class="line">-rw-rw----. 1 mysql mysql      16 12月 12 12:07 yuntai.index         #重要</span><br><span class="line">-rw-rw----. 1 mysql mysql      56 11月  7 17:27 auto.cnf</span><br><span class="line">drwx------. 2 mysql mysql    4096 11月  7 17:24 mysql</span><br><span class="line">drwx------. 2 mysql mysql    4096 11月  7 17:24 performance_schema</span><br><span class="line">-rw-rw----. 1 mysql mysql 50331648 11月  7 17:24 ib_logfile1</span><br><span class="line">drwx------. 2 mysql mysql        6 11月  7 17:23 test</span><br></pre></td></tr></table></figure>

<p>说明： 重启后生成两个前缀为yuntai01的二进制文件是实现主从的重要文件。</p>
<p>新建一个数据库为试验做准备：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">备份一个数据库：</span><br><span class="line">[root@localhost ~]# mysqldump -uroot -p123456 zrlog &gt; /tmp/zrlog.sql</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">新建几个数据库：</span><br><span class="line">[root@localhost ~]# mysql -uroot -p123456</span><br><span class="line">mysql&gt; create database yuntai01;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; create database yuntai02;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line">将备份的数据恢复到新建的数据库中：</span><br><span class="line">[root@localhost mysql]# mysql -uroot -p123456 yuntaitest &lt; /tmp/test.sql</span><br></pre></td></tr></table></figure>

<p>创建一个用于同步数据的用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# mysql -uroot -p123456</span><br><span class="line">Welcome to the MySQL monitor.</span><br><span class="line">mysql&gt; grant replication slave on *.* to &apos;repl&apos;@&apos;192.168.2.181&apos; identified by &apos;123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">#IP 192.168.2.181 为“从”的IP</span><br><span class="line"></span><br><span class="line">mysql&gt; flush tables with read lock;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line">#锁定数据表（目的是暂时使其不能继续写，保持现有状态用于同步）</span><br><span class="line"></span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| yuntai01.000001 |      542 |              |                  |                  |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#记住file和position(设置主从同步时会使用)</span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<p>查看当前的数据库，准备备份</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /data/mysql</span><br><span class="line">[root@localhost mysql]# ls</span><br><span class="line">auto.cnf  ib_logfile0  localhost.localdomain.err  mysql              test          yuntai01        yuntai01.index  yuntai.index</span><br><span class="line">ibdata1  ib_logfile1  localhost.localdomain.pid  performance_schema  yuntai.000001  yuntai01.000001  yuntai02        zrlog</span><br><span class="line"></span><br><span class="line">#我们的数据库：yuntai01 yuntai02 zrlog，我们把这几个数据库全部备份并同步。</span><br></pre></td></tr></table></figure>

<p>备份主库中所有数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# mysqldump -uroot -p123456 zrlog &gt; /tmp/zrlog.sql</span><br><span class="line">[root@localhost mysql]# mysqldump -uroot -p123456 yuntai01 &gt; /tmp/yuntai01.sql</span><br><span class="line">[root@localhost mysql]# mysqldump -uroot -p123456 yuntai02 &gt; /tmp/yuntai02.sql</span><br></pre></td></tr></table></figure>

<p>数据对比</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# ls -lt /tmp/*.sql</span><br><span class="line">-rw-r--r--. 1 root root  1262 12月 14 15:54 /tmp/yuntai02.sql</span><br><span class="line">-rw-r--r--. 1 root root  1262 12月 14 15:54 /tmp/yuntai01.sql</span><br><span class="line">-rw-r--r--. 1 root root 10072 12月 14 15:53 /tmp/zrlog.sql</span><br><span class="line"></span><br><span class="line">[root@localhost mysql]# ls -lt</span><br><span class="line">总用量 110692</span><br><span class="line">......</span><br><span class="line">drwx------. 2 mysql mysql    4096 12月 14 15:50 zrlog</span><br><span class="line">drwx------. 2 mysql mysql      20 12月 14 15:38 yuntai02</span><br><span class="line">drwx------. 2 mysql mysql      20 12月 14 15:38 yuntai01</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="17-4-配置从"><a href="#17-4-配置从" class="headerlink" title="17.4 配置从"></a>17.4 配置从</h2><h3 id="编辑从MySQL的配置文件添加如下参数："><a href="#编辑从MySQL的配置文件添加如下参数：" class="headerlink" title="编辑从MySQL的配置文件添加如下参数："></a>编辑从MySQL的配置文件添加如下参数：</h3><p>配置server-id=181，要求和主不一样。bin_log就不需要配置了，二进制文件只需要在主服务器上面配置即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/my.cnf</span><br><span class="line">……</span><br><span class="line">server-id=181</span><br><span class="line">#添加到最后</span><br><span class="line"></span><br><span class="line">重启配置文件</span><br><span class="line">[root@localhost ~]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL...... SUCCESS! </span><br><span class="line">Starting MySQL.............................. SUCCESS!</span><br></pre></td></tr></table></figure>

<h3 id="将主中备份的数据发送到从中"><a href="#将主中备份的数据发送到从中" class="headerlink" title="将主中备份的数据发送到从中"></a>将主中备份的数据发送到从中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# scp 192.168.2.180:/tmp/*.sql /tmp/     ##此IP为MySQL主的IP地址</span><br><span class="line">The authenticity of host &apos;192.168.2.180 (192.168.2.180)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is 17:2a:d4:3f:ff:02:39:05:e4:c2:02:44:73:5e:88:64.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">#输入yes</span><br><span class="line">Warning: Permanently added &apos;192.168.2.180&apos; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.2.180&apos;s password: </span><br><span class="line">#输入180机器的root密码</span><br><span class="line">yuntai01.sql                                                                                                                                                100% 1262    1.2KB/s  00:00    </span><br><span class="line">yuntai02.sql                                                                                                                                                100% 1262    1.2KB/s  00:00    </span><br><span class="line">zrlog.sql                                                                                                                                                    100%  10KB  9.8KB/s  00:00</span><br></pre></td></tr></table></figure>

<h3 id="配置MySQL"><a href="#配置MySQL" class="headerlink" title="配置MySQL"></a>配置MySQL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">配置MySQL环境</span><br><span class="line">[root@localhost ~]# export PATH=$PATH:/usr/local/mysql/bin/</span><br><span class="line">#这是将命令路径暂时加入环境变量，系但是统重启后该变量会失效，最好将其加入环境变量配置文件</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vim /etc/profile</span><br><span class="line">…… #添加</span><br><span class="line">export PATH=$PATH:/usr/local/mysql/bin/</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# source /etc/profile  //刷新刚刚的配置文件，否则不生效</span><br><span class="line"></span><br><span class="line">制定账户，设置密码</span><br><span class="line">[root@localhost ~]# mysqladmin -uroot password &apos;123456&apos;</span><br></pre></td></tr></table></figure>

<h3 id="创建对应的MySQL库"><a href="#创建对应的MySQL库" class="headerlink" title="创建对应的MySQL库"></a>创建对应的MySQL库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.6.35 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; create database yuntai01;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database yuntai02;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zrlog;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<h3 id="恢复数据库"><a href="#恢复数据库" class="headerlink" title="恢复数据库"></a>恢复数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uroot -p123456 zrlog&lt; /tmp/zrlog.sql </span><br><span class="line">[root@localhost ~]# mysql -uroot -p123456 yuntai01&lt; /tmp/yuntai01.sql </span><br><span class="line">[root@localhost ~]# mysql -uroot -p123456 yuntai02&lt; /tmp/yuntai02.sql </span><br><span class="line"></span><br><span class="line">[root@localhost mysql]# mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database          |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test              |</span><br><span class="line">| yuntai01          |</span><br><span class="line">| yuntai02          |</span><br><span class="line">| zrlog              |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.08 sec)</span><br></pre></td></tr></table></figure>

<h3 id="配置从服务器"><a href="#配置从服务器" class="headerlink" title="配置从服务器"></a>配置从服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">重要步骤</span><br><span class="line">mysql&gt; change master to master_host=&apos;192.168.2.180&apos;, master_user=&apos;repl&apos;, master_password=&apos;123456&apos;, master_log_file=&apos;yuntai01.000001&apos;, master_log_pos=542;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.06 sec)</span><br><span class="line"># master_host：主MySQL IP、master_user：主MySQL上交互用的用户名</span><br><span class="line"># master_log_file：主服务器上面show master status的文件名、master_log_pos：show master status的position值</span><br></pre></td></tr></table></figure>

<p>检测主从是否建立成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status\G     #成功的话会显示如下内容</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.2.180</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: yuntai01.000002</span><br><span class="line">          Read_Master_Log_Pos: 120</span><br><span class="line">              Relay_Log_File: localhost-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 282</span><br><span class="line">        Relay_Master_Log_File: yuntai01.000002</span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">          Replicate_Do_Table: </span><br><span class="line">      Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                  Last_Errno: 0</span><br><span class="line">                  Last_Error: </span><br><span class="line">                Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 120</span><br><span class="line">              Relay_Log_Space: 11178</span><br><span class="line">              Until_Condition: None</span><br><span class="line">              Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">          Master_SSL_Allowed: No</span><br><span class="line">          Master_SSL_CA_File: </span><br><span class="line">          Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">              Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">              Last_SQL_Errno: 0</span><br><span class="line">              Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">            Master_Server_Id: 180</span><br><span class="line">                  Master_UUID: d14c4924-c39d-11e7-93c6-000c2914f61b</span><br><span class="line">            Master_Info_File: /data/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">          Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">    Last_SQL_Error_Timestamp: </span><br><span class="line">              Master_SSL_Crl: </span><br><span class="line">          Master_SSL_Crlpath: </span><br><span class="line">          Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G  看是否有</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">还需关注</span><br><span class="line">Seconds_Behind_Master: 0  //为主从延迟的时间</span><br><span class="line">Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br></pre></td></tr></table></figure>

<p>配置中出现过的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">            Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 1593</span><br><span class="line">                Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.</span><br><span class="line">#报错中也有显示</span><br><span class="line"></span><br><span class="line">主要原因是5.6中引入了UUID的概念，各个mysql service的uuid要保证不能一样。</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# cd /data/mysql/</span><br><span class="line">[root@localhost mysql]# ls</span><br><span class="line">auto.cnf  ib_logfile0  localhost.localdomain.err  localhost-relay-bin.000002  master.info  performance_schema  test      yuntai02</span><br><span class="line">ibdata1  ib_logfile1  localhost.localdomain.pid  localhost-relay-bin.index  mysql        relay-log.info      yuntai01  zrlog</span><br><span class="line">[root@localhost mysql]# vim auto.cnf </span><br><span class="line">[auto]</span><br><span class="line">server-uuid=d14c4924-c39d-11e7-93c6-000c2914f68b     #随意改动2个字母或数字后保存</span><br><span class="line"></span><br><span class="line">[root@localhost mysql]# /etc/init.d/mysqld restart</span><br></pre></td></tr></table></figure>

<h3 id="到主服务器解开锁表"><a href="#到主服务器解开锁表" class="headerlink" title="到主服务器解开锁表"></a>到主服务器解开锁表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]#  mysql -uroot -p123456</span><br><span class="line">mysql&gt; unlock tables;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>到这里，MySQL的主从配置就完成了。</p>
<p>##17.5 测试主从同步</p>
<h3 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">主服务器:</span><br><span class="line">binlog-do-db=     //仅同步指定的库</span><br><span class="line">binlog-ignore-db=    //忽略指定的库</span><br><span class="line"></span><br><span class="line">从服务器：</span><br><span class="line">replicate_do_db=    //同步指定的库</span><br><span class="line">replicate_ignore_db=  //忽略指定的库</span><br><span class="line">replicate_do_table=    //同步指定的表</span><br><span class="line">replicate_ignore_table=  //忽略指定的表</span><br><span class="line">#建议只使用下面2个语句，使用参数“replicate_wild_”，使匹配更精确，提升使用性能。</span><br><span class="line">replicate_wild_do_table=  如yuntai.%，支持通配符    </span><br><span class="line">replicate_wild_ignore_table=    </span><br><span class="line"></span><br><span class="line">#如果想定义的话，将上面语句写入Mysql的my.cnf配置文件中</span><br></pre></td></tr></table></figure>

<ul>
<li><p>假如在主服务器上面有很多数据库，但是我只想同步yuntai01这个库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br><span class="line">......</span><br><span class="line">binlog-do-db=yuntai01</span><br><span class="line">要是多个的话就用英文状态下的逗号去分隔；</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者有时候数据库比较多，我就一个yuntai02库不需要同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br><span class="line">......</span><br><span class="line">binlog-ignore-db=yuntai02</span><br></pre></td></tr></table></figure>
</li>
<li><p>有时候我们需要在同步的时候忽略一些临时的表，这些表对我们的用处不大。我们可以在从服务器上编辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br><span class="line">......</span><br><span class="line">replicate_wild_do_table=yuntai01.%,yuntai02.%</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h3><h4 id="主操作"><a href="#主操作" class="headerlink" title="主操作"></a>主操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database          |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test              |</span><br><span class="line">| yuntai01          |</span><br><span class="line">| yuntai02          |</span><br><span class="line">| zrlog              |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use yuntai01</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="从操作，查看相同数据情况"><a href="#从操作，查看相同数据情况" class="headerlink" title="从操作，查看相同数据情况"></a>从操作，查看相同数据情况</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">同上，略</span><br><span class="line"></span><br><span class="line">mysql&gt; use yuntai01</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="主上，尝试往yuntai01库导入内容"><a href="#主上，尝试往yuntai01库导入内容" class="headerlink" title="主上，尝试往yuntai01库导入内容"></a>主上，尝试往yuntai01库导入内容</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br><span class="line">[root@localhost mysql]# mysql -uroot -p123456 yuntai01 &lt; /tmp/zrlog.sql</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">[root@localhost mysql]# mysql -uroot -p123456</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9398</span><br><span class="line">Server version: 5.6.35-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; use yuntai01;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+--------------------+</span><br><span class="line">| Tables_in_yuntai01 |</span><br><span class="line">+--------------------+</span><br><span class="line">| comment            |</span><br><span class="line">| link              |</span><br><span class="line">| log                |</span><br><span class="line">| lognav            |</span><br><span class="line">| plugin            |</span><br><span class="line">| tag                |</span><br><span class="line">| type              |</span><br><span class="line">| user              |</span><br><span class="line">| website            |</span><br><span class="line">+--------------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select count(*) plugin;</span><br><span class="line">+--------+</span><br><span class="line">| plugin |</span><br><span class="line">+--------+</span><br><span class="line">|      1 |</span><br><span class="line">+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="再次去从上查看"><a href="#再次去从上查看" class="headerlink" title="再次去从上查看"></a>再次去从上查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">同上，略</span><br><span class="line">mysql&gt; select count(*) plugin;</span><br><span class="line">+--------+</span><br><span class="line">| plugin |</span><br><span class="line">+--------+</span><br><span class="line">|      1 |</span><br><span class="line">+--------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<h4 id="主上删除表格plugin"><a href="#主上删除表格plugin" class="headerlink" title="主上删除表格plugin"></a>主上删除表格plugin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop table plugin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="从上查看表格plugin"><a href="#从上查看表格plugin" class="headerlink" title="从上查看表格plugin"></a>从上查看表格plugin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+--------------------+</span><br><span class="line">| Tables_in_yuntai01 |</span><br><span class="line">+--------------------+</span><br><span class="line">| comment            |</span><br><span class="line">| link              |</span><br><span class="line">| log                |</span><br><span class="line">| lognav            |</span><br><span class="line">| tag                |</span><br><span class="line">| type              |</span><br><span class="line">| user              |</span><br><span class="line">| website            |</span><br><span class="line">+--------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">plugin表格果然没有了！</span><br></pre></td></tr></table></figure>

<p>表示测试成功，mysql的确同步了。</p>
<h2 id="千万别在从server上面删除任何数据，一旦删除也就意味着数据不是一致的，主从就失败了！"><a href="#千万别在从server上面删除任何数据，一旦删除也就意味着数据不是一致的，主从就失败了！" class="headerlink" title="千万别在从server上面删除任何数据，一旦删除也就意味着数据不是一致的，主从就失败了！"></a>千万别在从server上面删除任何数据，一旦删除也就意味着数据不是一致的，主从就失败了！</h2><h3 id="如果主从这么失败了，如何再次恢复呢？"><a href="#如果主从这么失败了，如何再次恢复呢？" class="headerlink" title="如果主从这么失败了，如何再次恢复呢？"></a>如果主从这么失败了，如何再次恢复呢？</h3><ol>
<li><p>先把主server上面的数据与从server上面的数据保持一致，刚刚从server删除了什么数据，现在也需要把主server上面的数据也删除，为的就是数据一致！</p>
</li>
<li><p>首先主server上面操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File            | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| yuntai01.000001 |    10863 |              |                  |                  |</span><br><span class="line">+-----------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">记住Position值</span><br></pre></td></tr></table></figure>
</li>
<li><p>从server上操作使用新的Postion值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">mysql&gt; change master to master_host=&apos;192.168.2.180&apos;, master_user=&apos;repl&apos;, master_password=&apos;123456&apos;, master_log_file=&apos;yuntai01.000001&apos;, master_log_pos=10863;</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次启动从，查看状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status\G</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="具体思路"><a href="#具体思路" class="headerlink" title="具体思路"></a>具体思路</h3><ul>
<li>保证数据一致性的前提下，如上操作，如果主表格还在写入导致的数据不符，在不影响业务的情况下，可以锁主表</li>
<li>实在是数据不一致的前提下，建议直接重新备份，然后再次导入，再次change master即可</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/linux入门笔记/20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zhouqun">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Joking的Linux世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux入门笔记/20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断/" itemprop="url">20.5 - 20.9 shell脚本中的if逻辑判断、文件目录属性判断、if特殊用法、case判断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T12:49:11+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux入门笔记/" itemprop="url" rel="index">
                    <span itemprop="name">linux入门笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##20.5 shell脚本中的if逻辑判断<br>Shell脚本中，充满着各种逻辑判断，是脚本中必备的。</p>
<p>###逻辑判断表达式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-gt (&gt;);    大于    great than</span><br><span class="line">-lt(&lt;);      小于     less than</span><br><span class="line">-ge(&gt;=);  大于或等于   </span><br><span class="line">-le(&lt;=);   小于或等于</span><br><span class="line">-eq(==);  等于     equal</span><br><span class="line">-ne(!=)    不等于  not equa</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">if [ $a -gt $b ]; </span><br><span class="line">if [ $a -lt 5 ]; </span><br><span class="line">if [ $b -eq 10 ]等</span><br></pre></td></tr></table></figure>

<p>###if逻辑判断格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">格式1：if 条件 ; then 语句; fi</span><br><span class="line">格式2：if 条件; then 语句; else 语句; fi</span><br><span class="line">格式3：if …; then … ;elif …; then …; else …; fi</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">可以使用 &amp;&amp; || 结合多个条件</span><br><span class="line">条件A&amp;&amp;条件B：A并且B</span><br><span class="line">条件A||条件B：A或者B</span><br><span class="line">if [ $a -gt 5 ] &amp;&amp; [ $a -lt 10 ]; then</span><br><span class="line">if [ $b -gt 5 ] || [ $b -lt 3 ]; then</span><br></pre></td></tr></table></figure>

<p>###if逻辑判断例子<br>格式1：if 条件 ; then 语句; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=5</span><br><span class="line">if [ $a -gt 3 ]</span><br><span class="line">#注意[]里面有大量空格</span><br><span class="line">then</span><br><span class="line">       echo &quot;ok&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>格式2：if 条件; then 语句; else 语句; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=5</span><br><span class="line">if [ $a -gt 3 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;ok&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;nook&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>格式3：if …; then … ;elif …; then …; else …; fi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">a=3</span><br><span class="line">if [ $a -gt 4 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;&gt;1&quot;</span><br><span class="line">elif [ $a -gt 6 ]</span><br><span class="line">#注意elif可以嵌套多次的</span><br><span class="line">then</span><br><span class="line">    echo &quot;&lt;6 &amp;&amp; &gt;1&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;nook&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>##20.6 文件目录属性判断<br>在shell中通常要和文件或者目录打交道，那么对于他们的属性判断十分重要。</p>
<p>###文件目录属性判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ -f file ]判断是否是普通文件，且存在     [ -f /usr/bin/grep ]</span><br><span class="line">[ -d file ] 判断是否是目录，且存在   [ -d /tmp/mydir ]</span><br><span class="line">[ -e file ] 判断文件或目录是否存在   [ -e /var/log/syslog ]</span><br><span class="line">[ -r file ] 判断文件是否可读   [ -r /var/log/syslog ]</span><br><span class="line">[ -w file ] 判断文件是否可写  [ -w /var/mytmp.txt ]</span><br><span class="line">[ -x file ] 判断文件是否可执行  [ -x /usr/bin/grep ]</span><br></pre></td></tr></table></figure>

<p>###例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">f=&quot;/tmp/zhouquniclinux&quot;</span><br><span class="line">if [ -e $f ]</span><br><span class="line">then </span><br><span class="line">       echo $f exist</span><br><span class="line">else</span><br><span class="line">      touch $f</span><br></pre></td></tr></table></figure>

<p>上例可以简化为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">[ -e $f ] ||  touch $f</span><br><span class="line">[ ! -e $f ] || echo $f exist   </span><br><span class="line"># || 当前面的执行成功后再执行后面的命令</span><br><span class="line"># 如果是&amp;&amp;，则不管前面的命令是否执行成功，都会执行后面的命令</span><br><span class="line"># ! 表示取反</span><br></pre></td></tr></table></figure>

<p>##20.7 if特殊用法</p>
<h3 id="if特殊用法"><a href="#if特殊用法" class="headerlink" title="if特殊用法"></a>if特殊用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if [ -z &quot;$a&quot; ]  这个表示当变量a的值为空时会怎么样</span><br><span class="line">if [ -n &quot;$a&quot; ]  表示当变量a的值不为空</span><br><span class="line">if grep -q &apos;123&apos; 1.txt; then  表示如果1.txt中含有&apos;123&apos;的行时会怎么样</span><br><span class="line">if [ ! -e file ]; then 表示文件不存在时会怎么样</span><br><span class="line">if (($a&lt;1)); then …等同于 if [ $a -lt 1 ]; then… </span><br><span class="line">[ ] 中不能使用&lt;,&gt;,==,!=,&gt;=,&lt;=这样的符号</span><br></pre></td></tr></table></figure>

<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>if [ -z “$a” ]  这个表示当变量a的值为空时会怎么样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">       echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br><span class="line"># 如果/tmp/lalala文件为空，或者被删除的话，脚本就会运行出错，出现bug</span><br><span class="line"></span><br><span class="line">应该加上一个判断条件</span><br><span class="line">#!/bin/bash</span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -z &quot;$n&quot; ]</span><br><span class="line"># [ $n -z &quot;$n&quot; ]  = [ ! $n -n &quot;$n&quot; ]，-z 和 -n 是一对相反的条件</span><br><span class="line">then</span><br><span class="line">       echo &quot;error&quot;</span><br><span class="line">       exit</span><br><span class="line">elif [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ ! -f /tmp/lalala ]</span><br><span class="line">then</span><br><span class="line">       echo &quot;/tmp/lalala is not exist&quot;</span><br><span class="line">       exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">n=&apos;wc -l /tmp/lalala&apos;</span><br><span class="line">if [ $n -lt 100 ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;line num less than 100&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>if [ -n “$a” ]  表示当变量a的值不为空，也可以判断文件，判断文件时可以不加双引号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ -n 01.sh ]; then echo &quot;ok&quot;; fi</span><br><span class="line"></span><br><span class="line">另外</span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ -n &quot;$b&quot; ]</span><br><span class="line">then  </span><br><span class="line">       echo $b</span><br><span class="line">else</span><br><span class="line">        echo &quot;b is null&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>一条命令也可以作为判断条件。判断user1用户是否存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if grep -wq &apos;user1&apos;  /etc/passwd; then echo &quot;user1 is exist&quot;; else echo &quot;user1 is not exist&quot;; fi</span><br><span class="line">#grep -w 显示过滤信息，加-q可以不显示过滤信息</span><br></pre></td></tr></table></figure>

<p>##20.8/20.9 case判断</p>
<p>###case判断格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case 变量名 in</span><br><span class="line">    value1)</span><br><span class="line">      commond1</span><br><span class="line">      ;;</span><br><span class="line">    value2)</span><br><span class="line">      commod2</span><br><span class="line">      ;;</span><br><span class="line">    value3)</span><br><span class="line">      commod3</span><br><span class="line">      ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>###在case中，可以在条件中使用“|”，表示或的意思，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2|3)</span><br><span class="line">    commond</span><br><span class="line">    ;;</span><br></pre></td></tr></table></figure>

<p>###例子: 输入一个同学的分数，判断成绩是否及格，优秀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# vim case1.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">read -p &quot;Please input a number: &quot; n</span><br><span class="line"># read -p 是读取用户的输入数据，定义到变量里面</span><br><span class="line">if [ -z &quot;$n&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Please input a number.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">#“exit 1”表示非正常运行导致退出程序</span><br><span class="line">#退出之后，echo $?会返回1值，表示程序退出是因为出错了</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">n1=`echo $n|sed &apos;s/[0-9]//g&apos;`</span><br><span class="line">#判断用户输入的字符是否为纯数字</span><br><span class="line">#如果是数字，则将其替换为空，赋值给$n1</span><br><span class="line">if [ -n &quot;$n1&quot; ]</span><br><span class="line">then</span><br><span class="line">echo &quot;Please input a number.&quot;</span><br><span class="line">exit 1</span><br><span class="line">#判断$n1不为空时（即$n不是纯数字）再次提示用户输入数字并退出</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#如果用户输入的是纯数字则执行以下命令：</span><br><span class="line">if [ $n -lt 60 ] &amp;&amp; [ $n -ge 0 ]</span><br><span class="line">then</span><br><span class="line">    tag=1</span><br><span class="line">elif [ $n -ge 60 ] &amp;&amp; [ $n -lt 80 ]</span><br><span class="line">then</span><br><span class="line">    tag=2</span><br><span class="line">elif [ $n -ge 80 ]  &amp;&amp; [ $n -lt 90 ]</span><br><span class="line">then</span><br><span class="line">    tag=3</span><br><span class="line">elif [ $n -ge 90 ] &amp;&amp; [ $n -le 100 ]</span><br><span class="line">then</span><br><span class="line">    tag=4</span><br><span class="line">else</span><br><span class="line">    tag=0</span><br><span class="line">fi</span><br><span class="line">#tag的作用是为判断条件设定标签，方便后面引用</span><br><span class="line">case $tag in</span><br><span class="line">    1)</span><br><span class="line">        echo &quot;not ok&quot;</span><br><span class="line">        ;;</span><br><span class="line">    2)</span><br><span class="line">        echo &quot;ok&quot;</span><br><span class="line">        ;;</span><br><span class="line">    3)</span><br><span class="line">        echo &quot;ook&quot;</span><br><span class="line">        ;;</span><br><span class="line">    4)</span><br><span class="line">        echo &quot;oook&quot;</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;The number range is 0-100.&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>###运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 45</span><br><span class="line">not ok</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 66</span><br><span class="line">ok</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 80</span><br><span class="line">ook</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 99</span><br><span class="line">oook</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: xxx</span><br><span class="line">Please input a number.</span><br><span class="line">[root@host shell]# echo $?</span><br><span class="line">1</span><br><span class="line">[root@host shell]# sh case1.sh</span><br><span class="line">Please input a number: 120</span><br><span class="line">The number range is 0-100.</span><br><span class="line">[root@host shell]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zhouqun</p>
              <p class="site-description motion-element" itemprop="description">个人Linux学习和工作记录的小地方</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">109</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhouqun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
